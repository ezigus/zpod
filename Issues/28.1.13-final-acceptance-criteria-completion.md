# Issue 28.1.13 - Final Acceptance Criteria Completion

**Status:** In Progress (~35% Complete, Corrected 2026-02-14)
**Priority:** High
**Category:** Testing / Infrastructure
**Created:** 2026-02-10
**Updated:** 2026-02-14
**Parent Issue:** 28.1
**GitHub Issue:** [#403](https://github.com/ezigus/zpod/issues/403)
**Pull Request:** [#404](https://github.com/ezigus/zpod/pull/404)

## Progress Summary (Corrected After Static Analysis)

- ‚úÖ **AC9**: Siri Snapshots - COMPLETE (100%)
- üî¥ **AC10**: Offline Playback Tests - 4/12 Complete, 6/12 Partial, 2/12 Missing (33%)
- üî¥ **AC10**: Streaming Tests - 0/7 Complete, 2/7 Partial, 5/7 Missing (14%)
- **Overall**: ~7/19 scenarios complete (37%), 8/19 partial (42%), 4/19 missing (21%)

**Legend:**
- ‚úÖ **Complete (C)**: Test exists with strong assertions validating real behavior
- ‚ö†Ô∏è **Partial (P)**: Test exists but has placeholder assertions or depends on unimplemented infrastructure
- ‚ùå **Missing (M)**: No test exists for this scenario

## Description

Complete the remaining acceptance criteria for Issue 28.1 (Offline and Streaming Playback Infrastructure). Core download, local playback, and streaming infrastructure are implemented and wired end-to-end. This issue tracks the final gaps in test coverage and metadata persistence.

## Background

Static code review (2026-02-10) confirmed:
- ‚úÖ Manual download flows wired end-to-end (EpisodeListView ‚Üí DownloadCoordinator)
- ‚úÖ Playback prefers local files, falls back to streaming (EnhancedEpisodePlayer + localFileProvider)
- ‚úÖ Network interruption handling tested (StreamingInterruptionUITests - 9 tests)
- ‚úÖ Download status/progress/deletion surfaced in UI (EpisodeRowView, StorageManagementView)
- ‚ùå Siri snapshots rely on transient `podcastManager.all()` - episodes evaporate after restart
- ‚ùå Some UI tests remain skipped pending dependencies

## Acceptance Criteria

### AC9: Siri Snapshots Include Episodes After Restart ‚úÖ

- [x] Episode metadata (id, title, duration, pubDate, playbackPosition, isPlayed, podcastID) persisted to SwiftData or JSON cache
- [x] `SiriSnapshotCoordinator` hydrates snapshots from persisted episodes immediately after launch
- [x] Integration test validates snapshots are correct after restart without network refresh
- [x] Spec updated to include restart scenario for Siri "play latest" command

**Status:** COMPLETE (tracked in Issue 28.1.8)
**Completed:** 2026-02-10 (per dev-log)

### AC10: All Spec Scenarios Have Corresponding Tests

#### Offline Playback (`spec/offline-playback.md`) - 4 Complete / 6 Partial / 2 Missing

| # | Scenario | Status | Test Location | Notes |
|---|----------|--------|---------------|-------|
| 1 | Manual Episode Download | ‚ö†Ô∏è **P** | `DownloadFlowUITests:46` | Test exists but only asserts button dismiss, not actual download start (comment: "For now, we verify the action was tapped successfully") |
| 2 | Download Progress Tracking | ‚ö†Ô∏è **P** | `DownloadFlowUITests:90` | Test exists but only checks for *any* download indicator (icon/text/bar), not specific progress % updates |
| 3 | Download Completion | ‚ö†Ô∏è **P** | `DownloadFlowUITests:129` | Test exists but assertion is weak (comment: "In actual implementation, this test would verify the badge appears") |
| 4 | Download Cancellation | ‚ùå **M** | ‚Äî | **Missing**: `testPauseAndResumeDownload` tests pause/resume, not cancel. True cancel should delete partial download and reset state. |
| 5 | Download Failure Handling | ‚ö†Ô∏è **P** | `DownloadFlowUITests:268` | Test exists but comment says "In actual implementation with failure simulation, this would be verified" |
| 6 | Playing Downloaded Episode | ‚ö†Ô∏è **P** | `OfflinePlaybackUITests:42` | Test exists but relies on `UITEST_DOWNLOADED_EPISODES` env var seeding, not real download |
| 7 | Fallback to Streaming | ‚ùå **M** | ‚Äî | **Missing**: No integration test verifying local file miss ‚Üí streaming URL path |
| 8 | Offline Indicator in UI | ‚úÖ **C** | `OfflinePlaybackUITests:136,162` | Complete: Both downloaded badge and non-downloaded indicator verified |
| 9 | Manual Episode Deletion | ‚úÖ **C** | `OfflinePlaybackUITests:226` | Complete: Swipe delete, confirm dialog, badge disappears |
| 10 | Bulk Episode Deletion | ‚úÖ **C** | `StorageManagementUITests:337` | Complete: Delete all verification with storage stats |
| 11 | Download Resume After Network Loss | ‚ö†Ô∏è **P** | `DownloadFlowUITests:218` | **Mismapped**: Current test is manual pause/resume, not network-loss recovery. Need network interruption during download scenario. |
| 12 | Offline Error Path | ‚úÖ **C** | `OfflinePlaybackUITests:85` | Complete: Force expanded player, offline mode, error alert verified (PR #404) |

**Critical Infrastructure Gap**: Download tests (1-5, 11) rely on environment flags documented as **not implemented** in `zpodUITests/README_DOWNLOAD_TESTS.md:72`:
- `UITEST_DOWNLOAD_SIMULATION_MODE` - Not wired in app
- `UITEST_PREDOWNLOAD_FIRST_EPISODE` - Not wired in app
- `UITEST_SIMULATE_DOWNLOAD_FAILURE` - Not wired in app

These tests may pass but are **not validating real behavior** until flags are implemented or replaced with working test hooks.

#### Streaming Playback (`spec/streaming-playback.md`) - 0 Complete / 2 Partial / 5 Missing

| # | Scenario | Status | Test Location | Notes |
|---|----------|--------|---------------|-------|
| 1 | Seeking While Streaming | ‚ùå **M** | ‚Äî | **Missing**: Need test for seeking within buffered range (<100ms) vs. outside buffered range (new request, <2s) |
| 2 | Network Type Change (Wi-Fi ‚Üî Cellular) | ‚ùå **M** | ‚Äî | **Missing**: Need test for seamless streaming continuation during network type switch |
| 3 | HTTP Range Request Support | ‚ùå **M** | ‚Äî | **Missing**: Need integration test verifying Range headers for seeking and resume-from-position |
| 4 | Server Error (5xx) | ‚ö†Ô∏è **P** | `StreamingInterruptionUITests:374` | **Partial**: Generic error display tested, but not specific 5xx behavior or auto-retry (spec says 5s retry up to 3 attempts) |
| 5 | Not Found Error (404) | ‚ùå **M** | ‚Äî | **Missing**: Need test verifying 404 shows "Episode Not Available" with NO auto-retry (different from 5xx) |
| 6 | Timeout During Streaming | ‚ö†Ô∏è **P** | `StreamingInterruptionUITests:374` | **Partial**: Generic error tested, but not specific timeout (30s no data) with auto-retry message |
| 7 | Automatic Retry on Transient Errors | ‚ö†Ô∏è **P** | `StreamingInterruptionUITests:416` | **Partial**: Retry button tested, but not full exponential backoff (2s/5s/10s per spec) with position preservation |

**Existing Streaming Tests** (`StreamingInterruptionUITests` - 9 tests):
- ‚úÖ Auto-pause on network loss (`testAutoPauseOnNetworkLoss:41`)
- ‚úÖ Auto-resume on network recovery (`testAutoResumeOnNetworkRecovery:92`)
- ‚úÖ Buffer indicator appears (`testBufferIndicatorAppears:162`)
- ‚úÖ Buffer indicator disappears (`testBufferIndicatorDisappears:205`)
- ‚úÖ Network error message displays (`testNetworkErrorMessageDisplays:374`)
- ‚úÖ Retry button available (`testRetryButtonAvailableAfterError:416`)
- ‚úÖ Playback adapts to poor network (`testPlaybackAdaptsToPoorNetwork:460`)
- ‚úÖ Network simulation isolation (`testNetworkSimulationFlagShowsOnlyNetworkControls:266`)
- ‚úÖ Buffer simulation isolation (`testBufferSimulationFlagShowsOnlyBufferControls:317`)

**Critical Spec Mismatch Found**: Retry delays in code vs. spec don't match:
- **Spec** (`spec/streaming-playback.md:220`): 2s, 5s, 10s exponential backoff
- **Code** (`PlaybackEngine/StreamingErrorHandler.swift:73`): 5s, 15s, 60s exponential backoff
- **Action Required**: Either update code to match spec OR update spec with rationale for longer delays

## Implementation Approach

### Phase 1: Episode Metadata Persistence (AC9)

1. Implement episode entity in SwiftData (or JSON cache)
2. Update `SiriSnapshotCoordinator` to use persisted episodes
3. Add integration test for restart scenario
4. Update `spec/playback.md` with restart scenario

**Tracked by:** Issue 28.1.8

### Phase 2: Un-skip Download UI Tests (AC10 - Offline)

1. Add swipe configuration seeding to enable download action in tests
2. Un-skip 5 download flow tests in `DownloadFlowUITests`
3. Add local playback verification test
4. Add fallback logic integration test
5. Un-skip offline error path in `OfflinePlaybackUITests`

### Phase 3: Add Missing Streaming Tests (AC10 - Streaming)

1. Add seeking-to-unbuffered-position test
2. Add connection type change test
3. Add server error/404/timeout tests
4. Verify retry logic in integration tests

## Dependencies

- **Requires:** Issue 28.1.8 (episode metadata persistence)
- **Blocks:** Complete closure of Issue 28.1

## Testing Strategy

- Integration tests for metadata persistence and restart scenarios
- UI tests for all skipped download flows
- UI tests for missing streaming scenarios
- All tests should map to explicit spec scenarios

## Success Metrics

- 100% of `spec/offline-playback.md` scenarios have passing tests
- 100% of `spec/streaming-playback.md` scenarios have passing tests
- Siri snapshots include episodes immediately after app restart (no network dependency)
- Zero `XCTSkip` statements in `DownloadFlowUITests` and `OfflinePlaybackUITests`

## Estimated Effort

Medium-Large (4-6 days)
- Phase 1: 2-3 days (metadata persistence)
- Phase 2: 1-2 days (un-skip download tests)
- Phase 3: 1 day (add streaming tests)

## Files to Modify

### Phase 1 (Metadata Persistence)
- `Packages/Persistence/Sources/Persistence/EpisodeEntity.swift` (new)
- `Packages/Persistence/Sources/Persistence/EpisodeRepository.swift` (new)
- `zpod/Services/SiriSnapshotCoordinator.swift`
- `spec/playback.md`

### Phase 2 (Download Tests)
- `zpodUITests/DownloadFlowUITests.swift`
- `zpodUITests/OfflinePlaybackUITests.swift`
- `zpodUITests/TestSupport/SwipeConfigurationSeeding.swift` (new)

### Phase 3 (Streaming Tests)
- `zpodUITests/StreamingInterruptionUITests.swift`
- `IntegrationTests/StreamingEdgeCaseTests.swift` (new)

## Notes

This issue consolidates the remaining work to achieve 100% acceptance criteria completion for Issue 28.1. Core infrastructure is complete and functional; this focuses on test coverage and Siri metadata persistence gaps.

## Current Status (2026-02-14 - Corrected After Static Analysis)

### Critical Findings from Static Analysis

**Infrastructure Gaps:**
1. ‚ùå **Download test flags not implemented** - `zpodUITests/README_DOWNLOAD_TESTS.md:72` documents that `UITEST_DOWNLOAD_SIMULATION_MODE`, `UITEST_PREDOWNLOAD_FIRST_EPISODE`, and `UITEST_SIMULATE_DOWNLOAD_FAILURE` are "not yet implemented in the app." Tests using these flags may pass but validate nothing.

2. ‚ùå **Retry delay spec mismatch** - Streaming error handler uses 5s/15s/60s delays (`StreamingErrorHandler.swift:73`), but spec requires 2s/5s/10s (`streaming-playback.md:220`). Must align code with spec or update spec intentionally.

3. ‚ö†Ô∏è **Placeholder test assertions** - Many download tests exist but have weak assertions with comments like "For now, we verify the action was tapped successfully" and "In actual implementation, this would be verified."

4. ‚ö†Ô∏è **Mismapped scenario** - "Download Resume After Network Loss" is currently tested as manual pause/resume (`testPauseAndResumeDownload`), not network interruption during download.

5. ‚ùå **Cancellation vs. Pause confusion** - Current `testPauseAndResumeDownload` tests pause/resume, not cancellation. True cancel should delete partial download and reset UI state.

### Completed Work (PR #404)
- ‚úÖ All download flow tests are active and not skipped (but many are placeholders)
- ‚úÖ Offline error path test complete and passing
- ‚úÖ Alert presentation properly wired with accessibility identifiers
- ‚úÖ PlaybackError.accessibilityIdentifier property implemented
- ‚úÖ State emission ordering fixed to prevent Combine coalescing

### Remaining Work - Revised Estimates

**Priority 0: Infrastructure & Alignment** (2-3 days)
1. ‚ö†Ô∏è **Resolve retry delay spec mismatch** - Align StreamingErrorHandler with spec OR update spec with rationale
2. ‚ö†Ô∏è **Implement download test hooks** - Wire the documented-but-unimplemented flags OR replace with deterministic seeded approaches already supported
3. ‚ö†Ô∏è **Rewrite placeholder download tests** - Upgrade assertions from "button dismissed" to real status transitions

**Priority 1: Missing Offline Tests** (1-2 days)
1. ‚ùå **Download Cancellation** - Add true cancel (not pause) test with partial download cleanup verification
2. ‚ùå **Fallback to Streaming** - Add integration test verifying local file miss ‚Üí streaming URL path
3. ‚ö†Ô∏è **Download Resume After Network Loss** - Fix mismapping: test network interruption recovery, not manual pause/resume

**Priority 2: Missing Streaming Tests** (2-3 days)
1. ‚ùå **Seeking While Streaming** - Test buffered (<100ms) vs unbuffered (<2s) seeks
2. ‚ùå **Network Type Change** - Test WiFi‚ÜîCellular seamless continuation
3. ‚ùå **HTTP Range Requests** - Integration test verifying Range headers
4. ‚ö†Ô∏è **Server Error 5xx** - Enhance existing generic error test with specific 5xx + auto-retry
5. ‚ùå **Not Found 404** - Test 404 with NO auto-retry (different from 5xx)
6. ‚ö†Ô∏è **Timeout** - Enhance existing generic error test with specific timeout scenario
7. ‚ö†Ô∏è **Automatic Retry** - Add end-to-end test verifying exponential backoff + position preservation

**Total Remaining Effort**: 5-8 days (vs. original estimate of 1-2 days)

### Blockers
- ‚ö†Ô∏è **Download test infrastructure must be implemented before tests can be meaningful**
- ‚ö†Ô∏è **Retry delay alignment decision required before finalizing streaming tests**

---

**Related Issues:** 28.1 (parent), 28.1.8 (episode metadata persistence)
**Dev Log:** `dev-log/28.1.13-final-acceptance-criteria-completion.md`
