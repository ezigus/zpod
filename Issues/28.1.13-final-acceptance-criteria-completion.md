# Issue 28.1.13 - Final Acceptance Criteria Completion

**Status:** In Progress (83% Complete)
**Priority:** High
**Category:** Testing / Infrastructure
**Created:** 2026-02-10
**Updated:** 2026-02-13
**Parent Issue:** 28.1
**GitHub Issue:** [#403](https://github.com/ezigus/zpod/issues/403)
**Pull Request:** [#404](https://github.com/ezigus/zpod/pull/404)

## Progress Summary

- ‚úÖ **AC9**: Siri Snapshots - COMPLETE (100%)
- üü° **AC10**: Offline Playback Tests - 10/12 Complete (83.3%)
- üî¥ **AC10**: Streaming Tests - 0/7 Complete (0%)
- **Overall**: 10/19 scenarios complete (52.6%)

## Description

Complete the remaining acceptance criteria for Issue 28.1 (Offline and Streaming Playback Infrastructure). Core download, local playback, and streaming infrastructure are implemented and wired end-to-end. This issue tracks the final gaps in test coverage and metadata persistence.

## Background

Static code review (2026-02-10) confirmed:
- ‚úÖ Manual download flows wired end-to-end (EpisodeListView ‚Üí DownloadCoordinator)
- ‚úÖ Playback prefers local files, falls back to streaming (EnhancedEpisodePlayer + localFileProvider)
- ‚úÖ Network interruption handling tested (StreamingInterruptionUITests - 9 tests)
- ‚úÖ Download status/progress/deletion surfaced in UI (EpisodeRowView, StorageManagementView)
- ‚ùå Siri snapshots rely on transient `podcastManager.all()` - episodes evaporate after restart
- ‚ùå Some UI tests remain skipped pending dependencies

## Acceptance Criteria

### AC9: Siri Snapshots Include Episodes After Restart ‚úÖ

- [x] Episode metadata (id, title, duration, pubDate, playbackPosition, isPlayed, podcastID) persisted to SwiftData or JSON cache
- [x] `SiriSnapshotCoordinator` hydrates snapshots from persisted episodes immediately after launch
- [x] Integration test validates snapshots are correct after restart without network refresh
- [x] Spec updated to include restart scenario for Siri "play latest" command

**Status:** COMPLETE (tracked in Issue 28.1.8)
**Completed:** 2026-02-10 (per dev-log)

### AC10: All Spec Scenarios Have Corresponding Tests

#### Offline Playback (`spec/offline-playback.md`) - 10/12 Complete (83.3%)

- [x] Manual Episode Download - ‚úÖ `DownloadFlowUITests.testSwipeToDownloadEpisode()` exists, not skipped
- [x] Download Progress Tracking - ‚úÖ `DownloadFlowUITests.testDownloadProgressIndicatorDisplays()` exists, not skipped
- [x] Download Completion - ‚úÖ `DownloadFlowUITests.testDownloadedEpisodeShowsBadge()` exists, not skipped
- [ ] Download Cancellation - ‚è≥ Add test for cancel mid-download
- [x] Download Failure Handling - ‚úÖ `DownloadFlowUITests.testFailedDownloadShowsRetryButton()` exists, not skipped
- [x] Playing Downloaded Episode - ‚úÖ `OfflinePlaybackUITests.testPlayDownloadedEpisodeFromLocalStorage()` complete
- [ ] Fallback to Streaming When Not Downloaded - ‚è≥ Add integration test for fallback logic
- [x] Offline Indicator in UI - ‚úÖ `OfflinePlaybackUITests.testDownloadedEpisodeShowsBadge()` + `testNonDownloadedEpisodeShowsStreamIndicator()` complete
- [x] Manual Episode Deletion - ‚úÖ `OfflinePlaybackUITests.testDeletedDownloadRevertsToStreaming()` + `StorageManagementUITests` complete
- [x] Bulk Episode Deletion - ‚úÖ `StorageManagementUITests.testDeleteAllExecutes()` complete
- [x] Download Resume After Network Loss - ‚úÖ `DownloadFlowUITests.testPauseAndResumeDownload()` exists, not skipped
- [x] Offline Error Path - ‚úÖ `OfflinePlaybackUITests.testNonDownloadedEpisodeFailsOffline()` complete (PR #404)

#### Streaming Playback (`spec/streaming-playback.md`) - 0/7 Complete (0%)

- [ ] Seeking While Streaming - ‚è≥ Add UI test for seeking to unbuffered position
- [ ] Network Type Change (Wi-Fi to Cellular) - ‚è≥ Add test for connection type changes
- [ ] HTTP Range Request Support - ‚è≥ Verify in integration tests (may already be covered by AVPlayer behavior)
- [ ] Server Error (5xx) - ‚è≥ Add test for server error handling
- [ ] Not Found Error (404) - ‚è≥ Add test for missing audio file
- [ ] Timeout During Streaming - ‚è≥ Add test for timeout scenario
- [ ] Automatic Retry on Transient Errors - ‚è≥ Verify retry logic in integration tests

**Note:** Streaming already has 9 tests passing in `StreamingInterruptionUITests` covering:
- ‚úÖ Auto-pause on network loss
- ‚úÖ Auto-resume on network recovery  
- ‚úÖ Buffer indicator appears/disappears
- ‚úÖ Network error message displays
- ‚úÖ Retry button available after error
- ‚úÖ Playback adapts to poor network
- ‚úÖ Flag-gated simulation controls

## Implementation Approach

### Phase 1: Episode Metadata Persistence (AC9)

1. Implement episode entity in SwiftData (or JSON cache)
2. Update `SiriSnapshotCoordinator` to use persisted episodes
3. Add integration test for restart scenario
4. Update `spec/playback.md` with restart scenario

**Tracked by:** Issue 28.1.8

### Phase 2: Un-skip Download UI Tests (AC10 - Offline)

1. Add swipe configuration seeding to enable download action in tests
2. Un-skip 5 download flow tests in `DownloadFlowUITests`
3. Add local playback verification test
4. Add fallback logic integration test
5. Un-skip offline error path in `OfflinePlaybackUITests`

### Phase 3: Add Missing Streaming Tests (AC10 - Streaming)

1. Add seeking-to-unbuffered-position test
2. Add connection type change test
3. Add server error/404/timeout tests
4. Verify retry logic in integration tests

## Dependencies

- **Requires:** Issue 28.1.8 (episode metadata persistence)
- **Blocks:** Complete closure of Issue 28.1

## Testing Strategy

- Integration tests for metadata persistence and restart scenarios
- UI tests for all skipped download flows
- UI tests for missing streaming scenarios
- All tests should map to explicit spec scenarios

## Success Metrics

- 100% of `spec/offline-playback.md` scenarios have passing tests
- 100% of `spec/streaming-playback.md` scenarios have passing tests
- Siri snapshots include episodes immediately after app restart (no network dependency)
- Zero `XCTSkip` statements in `DownloadFlowUITests` and `OfflinePlaybackUITests`

## Estimated Effort

Medium-Large (4-6 days)
- Phase 1: 2-3 days (metadata persistence)
- Phase 2: 1-2 days (un-skip download tests)
- Phase 3: 1 day (add streaming tests)

## Files to Modify

### Phase 1 (Metadata Persistence)
- `Packages/Persistence/Sources/Persistence/EpisodeEntity.swift` (new)
- `Packages/Persistence/Sources/Persistence/EpisodeRepository.swift` (new)
- `zpod/Services/SiriSnapshotCoordinator.swift`
- `spec/playback.md`

### Phase 2 (Download Tests)
- `zpodUITests/DownloadFlowUITests.swift`
- `zpodUITests/OfflinePlaybackUITests.swift`
- `zpodUITests/TestSupport/SwipeConfigurationSeeding.swift` (new)

### Phase 3 (Streaming Tests)
- `zpodUITests/StreamingInterruptionUITests.swift`
- `IntegrationTests/StreamingEdgeCaseTests.swift` (new)

## Notes

This issue consolidates the remaining work to achieve 100% acceptance criteria completion for Issue 28.1. Core infrastructure is complete and functional; this focuses on test coverage and Siri metadata persistence gaps.

## Current Status (2026-02-13)

### Completed Work (PR #404)
- ‚úÖ All download flow tests are active and not skipped
- ‚úÖ Offline error path test complete and passing
- ‚úÖ Alert presentation properly wired with accessibility identifiers
- ‚úÖ PlaybackError.accessibilityIdentifier property implemented
- ‚úÖ State emission ordering fixed to prevent Combine coalescing

### Remaining Work
**Phase 2 Gaps** (2 items):
1. Download Cancellation - Add UI test for cancel mid-download
2. Fallback to Streaming - Add integration test for fallback logic when episode not downloaded

**Phase 3 - Streaming Tests** (7 items):
1. Seeking While Streaming
2. Network Type Change (Wi-Fi to Cellular)
3. HTTP Range Request Support
4. Server Error (5xx)
5. Not Found Error (404)
6. Timeout During Streaming
7. Automatic Retry on Transient Errors

### Blockers
- ‚è≥ Awaiting local regression test results (1 known failure to investigate)
- After fixing regression, can proceed with remaining Phase 2 & 3 work

---

**Related Issues:** 28.1 (parent), 28.1.8 (episode metadata persistence)
**Dev Log:** `dev-log/28.1.13-final-acceptance-criteria-completion.md`
