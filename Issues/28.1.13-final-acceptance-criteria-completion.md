# Issue 28.1.13 - Final Acceptance Criteria Completion

**Status:** Open  
**Priority:** High  
**Category:** Testing / Infrastructure  
**Created:** 2026-02-10  
**Parent Issue:** 28.1  
**GitHub Issue:** TBD

## Description

Complete the remaining acceptance criteria for Issue 28.1 (Offline and Streaming Playback Infrastructure). Core download, local playback, and streaming infrastructure are implemented and wired end-to-end. This issue tracks the final gaps in test coverage and metadata persistence.

## Background

Static code review (2026-02-10) confirmed:
- ✅ Manual download flows wired end-to-end (EpisodeListView → DownloadCoordinator)
- ✅ Playback prefers local files, falls back to streaming (EnhancedEpisodePlayer + localFileProvider)
- ✅ Network interruption handling tested (StreamingInterruptionUITests - 9 tests)
- ✅ Download status/progress/deletion surfaced in UI (EpisodeRowView, StorageManagementView)
- ❌ Siri snapshots rely on transient `podcastManager.all()` - episodes evaporate after restart
- ❌ Some UI tests remain skipped pending dependencies

## Acceptance Criteria

### AC9: Siri Snapshots Include Episodes After Restart

- [ ] Episode metadata (id, title, duration, pubDate, playbackPosition, isPlayed, podcastID) persisted to SwiftData or JSON cache
- [ ] `SiriSnapshotCoordinator` hydrates snapshots from persisted episodes immediately after launch
- [ ] Integration test validates snapshots are correct after restart without network refresh
- [ ] Spec updated to include restart scenario for Siri "play latest" command

**Tracked by:** Issue 28.1.8 (Episode Metadata Persistence for Siri)

### AC10: All Spec Scenarios Have Corresponding Tests

#### Offline Playback (`spec/offline-playback.md`)

- [ ] Manual Episode Download - Un-skip `DownloadFlowUITests.testSwipeToDownloadEpisode()` once swipe configuration seeding is available
- [ ] Download Progress Tracking - Un-skip `DownloadFlowUITests.testDownloadProgressIndicatorDisplays()`
- [ ] Download Completion - Un-skip `DownloadFlowUITests.testDownloadedEpisodeShowsBadge()`
- [ ] Download Cancellation - Add test for cancel mid-download
- [ ] Download Failure Handling - Un-skip `DownloadFlowUITests.testFailedDownloadShowsRetryButton()`
- [ ] Playing Downloaded Episode - Add UI test verifying local playback without network
- [ ] Fallback to Streaming When Not Downloaded - Add integration test for fallback logic
- [ ] Offline Indicator in UI - Verify in existing `EpisodeRowView` tests
- [ ] Manual Episode Deletion - Verify in `StorageManagementUITests`
- [ ] Bulk Episode Deletion - Verify "Delete All" in `StorageManagementUITests`
- [ ] Download Resume After Network Loss - Un-skip `DownloadFlowUITests.testPauseAndResumeDownload()` (currently tests pause/resume, needs network loss scenario)
- [ ] Offline Error Path - Un-skip `OfflinePlaybackUITests` offline error case (line 77-88)

#### Streaming Playback (`spec/streaming-playback.md`)

- [ ] Seeking While Streaming - Add UI test for seeking to unbuffered position
- [ ] Network Type Change (Wi-Fi to Cellular) - Add test for connection type changes
- [ ] HTTP Range Request Support - Verify in integration tests (may already be covered by AVPlayer behavior)
- [ ] Server Error (5xx) - Add test for server error handling
- [ ] Not Found Error (404) - Add test for missing audio file
- [ ] Timeout During Streaming - Add test for timeout scenario
- [ ] Automatic Retry on Transient Errors - Verify retry logic in integration tests

**Note:** Streaming already has 9 tests passing in `StreamingInterruptionUITests` covering:
- ✅ Auto-pause on network loss
- ✅ Auto-resume on network recovery  
- ✅ Buffer indicator appears/disappears
- ✅ Network error message displays
- ✅ Retry button available after error
- ✅ Playback adapts to poor network
- ✅ Flag-gated simulation controls

## Implementation Approach

### Phase 1: Episode Metadata Persistence (AC9)

1. Implement episode entity in SwiftData (or JSON cache)
2. Update `SiriSnapshotCoordinator` to use persisted episodes
3. Add integration test for restart scenario
4. Update `spec/playback.md` with restart scenario

**Tracked by:** Issue 28.1.8

### Phase 2: Un-skip Download UI Tests (AC10 - Offline)

1. Add swipe configuration seeding to enable download action in tests
2. Un-skip 5 download flow tests in `DownloadFlowUITests`
3. Add local playback verification test
4. Add fallback logic integration test
5. Un-skip offline error path in `OfflinePlaybackUITests`

### Phase 3: Add Missing Streaming Tests (AC10 - Streaming)

1. Add seeking-to-unbuffered-position test
2. Add connection type change test
3. Add server error/404/timeout tests
4. Verify retry logic in integration tests

## Dependencies

- **Requires:** Issue 28.1.8 (episode metadata persistence)
- **Blocks:** Complete closure of Issue 28.1

## Testing Strategy

- Integration tests for metadata persistence and restart scenarios
- UI tests for all skipped download flows
- UI tests for missing streaming scenarios
- All tests should map to explicit spec scenarios

## Success Metrics

- 100% of `spec/offline-playback.md` scenarios have passing tests
- 100% of `spec/streaming-playback.md` scenarios have passing tests
- Siri snapshots include episodes immediately after app restart (no network dependency)
- Zero `XCTSkip` statements in `DownloadFlowUITests` and `OfflinePlaybackUITests`

## Estimated Effort

Medium-Large (4-6 days)
- Phase 1: 2-3 days (metadata persistence)
- Phase 2: 1-2 days (un-skip download tests)
- Phase 3: 1 day (add streaming tests)

## Files to Modify

### Phase 1 (Metadata Persistence)
- `Packages/Persistence/Sources/Persistence/EpisodeEntity.swift` (new)
- `Packages/Persistence/Sources/Persistence/EpisodeRepository.swift` (new)
- `zpod/Services/SiriSnapshotCoordinator.swift`
- `spec/playback.md`

### Phase 2 (Download Tests)
- `zpodUITests/DownloadFlowUITests.swift`
- `zpodUITests/OfflinePlaybackUITests.swift`
- `zpodUITests/TestSupport/SwipeConfigurationSeeding.swift` (new)

### Phase 3 (Streaming Tests)
- `zpodUITests/StreamingInterruptionUITests.swift`
- `IntegrationTests/StreamingEdgeCaseTests.swift` (new)

## Notes

This issue consolidates the remaining work to achieve 100% acceptance criteria completion for Issue 28.1. Core infrastructure is complete and functional; this focuses on test coverage and Siri metadata persistence gaps.

---

**Related Issues:** 28.1 (parent), 28.1.8 (episode metadata persistence)  
**Dev Log:** `dev-log/28.1.13-final-acceptance-criteria-completion.md`
