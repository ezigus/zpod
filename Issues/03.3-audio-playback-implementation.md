# Issue 03.3: Audio Playback Implementation

**Status**: ğŸ†• Proposed

**Priority**: Critical

**GitHub Issue**: [#265](https://github.com/ezigus/zpod/issues/265)

**Parent**: 03 - Player & Playback

## Description

The current playback infrastructure has UI components (MiniPlayer, ExpandedPlayer, SystemMediaCoordinator) but lacks actual audio playback functionality. The `EnhancedEpisodePlayer` emits state once but never advances position, and no AVPlayer integration exists.

This epic addresses the complete audio playback pipeline from feed parsing through real-time UI updates.

## Problem Statement

When a user taps "Play" on an episode:
1. The UI shows "Playing" state momentarily
2. No audio is heard
3. The timeline/progress never advances
4. System Now Playing shows stale data

**Root Cause**: `EnhancedEpisodePlayer` manages state but doesn't:
- Stream audio via AVPlayer
- Advance position over time
- Emit periodic state updates

## Sub-Issues

| Issue | Title | Priority | Status |
|-------|-------|----------|--------|
| 03.3.1 | Position Ticking Engine | High | Proposed |
| 03.3.2 | AVPlayer-Backed Playback Engine | High | Proposed |
| 03.3.3 | Feed Parsing: audioURL & Duration | High | Proposed |
| 03.3.4 | Unplayable Episode UX & Diagnostics | Medium | Proposed |
| 03.3.5 | MPNowPlayingInfoCenter Real-Time Sync | Medium | Proposed |
| 03.3.6 | Production vs Test DI Wiring | Medium | Proposed |
| 03.3.7 | Player Tab Playback Wiring | High | Proposed |

## Acceptance Criteria (Epic Level)

- [ ] User taps Play â†’ Audio streams through device speakers
- [ ] Timeline advances in real-time during playback
- [ ] Mini-player shows accurate position/duration
- [ ] Expanded player shows accurate scrubber position
- [ ] Lock screen/Control Center shows real-time progress
- [ ] Seeking works from all UI surfaces
- [ ] Background playback continues when app backgrounded
- [ ] Audio interruptions (calls, Siri) handled gracefully

## Spec References

The following specifications have been enhanced to cover this epic:

- `zpod/spec/playback.md` - Core Playback Behavior and Playback Error Handling sections
- `zpod/spec/discovery.md` - Feed Parsing section for audio URL extraction
- `zpod/spec/ui.md` - Mini-Player and Expanded Player UI section

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MiniPlayer  â”‚  â”‚ ExpandedPlayer  â”‚  â”‚ SystemMedia     â”‚  â”‚
â”‚  â”‚ ViewModel   â”‚  â”‚ ViewModel       â”‚  â”‚ Coordinator     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                     â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                            â”‚                                 â”‚
â”‚                   statePublisher (Combine)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Playback Engine                            â”‚
â”‚                            â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           AVPlayerPlaybackEngine (NEW)                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  AVPlayer   â”‚  â”‚ TimeObserverâ”‚  â”‚ Ticker       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  (audio)    â”‚  â”‚ (position)  â”‚  â”‚ (fallback)   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    Episode.audioURL
                    (from RSS feed)
```

## Implementation Order

```
Phase 1: Foundation
â”œâ”€â”€ 03.3.1 Position Ticking Engine (unblocks UI timeline)
â””â”€â”€ 03.3.3 Feed Parsing (provides real audio URLs)

Phase 2: Core Playback
â”œâ”€â”€ 03.3.2 AVPlayer-Backed Engine (actual audio)
â””â”€â”€ 03.3.7 Player Tab Wiring (connect UI to service)

Phase 3: Polish
â”œâ”€â”€ 03.3.5 Now Playing Sync (lock screen accuracy)
â”œâ”€â”€ 03.3.4 Unplayable UX (error handling)
â””â”€â”€ 03.3.6 DI Wiring (production safety)
```

## Dependencies

- Requires `Episode` model to have `audioURL: URL?` property
- Requires proper audio session configuration (already in SystemMediaCoordinator)
- Requires Combine for state observation (already in place)

## Testing Strategy

- **Unit Tests**: Ticker timing, state transitions, AVPlayer mock
- **Integration Tests**: Full playback flow with test audio files
- **UI Tests**: Timeline updates, seeking, play/pause
- **Manual Tests**: Real podcast feeds, background playback, interruptions

## Related Issues

- 03.1.1 Core Player Interface (COMPLETE - provides UI)
- 03.1.1.4 System Media Integration (COMPLETE - provides Now Playing)
- 03.2 Mini Player Bottom Overflow (layout fix)
