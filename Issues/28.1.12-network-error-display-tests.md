# Issue 28.1.12 - Network Error Display UI Tests

**Status:** Open
**Priority:** Medium
**Category:** Test Infrastructure
**Created:** 2026-02-09
**Parent Issue:** 28.1
**GitHub Issue:** [#401](https://github.com/ezigus/zpod/issues/401)

## Description

Implement the two `XCTSkip`'d streaming interruption UI tests that verify network error display and retry button availability. These tests were blocked on Issue 03.3.4 (#269 — Unplayable Episode UX & Diagnostics), which is now **closed and complete**. The PlaybackError accessibility surface is implemented and ready for test coverage.

## Problem Statement

**Current State**:
- `StreamingInterruptionUITests.testNetworkErrorMessageDisplays()` skips with stale `XCTSkip` referencing closed Issue 03.3.4
- `StreamingInterruptionUITests.testRetryButtonAvailableAfterError()` skips with stale `XCTSkip` referencing closed Issue 03.3.4
- The PlaybackError UI surface exists but has no end-to-end UI test coverage via simulation hooks

**Target State**:
- Both tests are un-skipped and fully implemented
- Error display and retry flows are exercised through the simulation hook infrastructure from Issue 28.1.11
- A new simulation hook (e.g., `TestHook.SimulatePlaybackError`) triggers `failPlayback(error:)` from the UI test layer
- Existing network/buffer simulation controls are tightened so each group is gated by its specific env flag (network controls by `UITEST_NETWORK_SIMULATION`, buffer controls by `UITEST_BUFFER_SIMULATION`)

## Acceptance Criteria

- [ ] `testNetworkErrorMessageDisplays()` is un-skipped and passes:
  - **Given**: App is launched with error simulation enabled
  - **When**: A playback error is injected via simulation hook
  - **Then**: An error message is visible (`MiniPlayer.ErrorMessage` or expanded-player equivalent)
- [ ] `testRetryButtonAvailableAfterError()` is un-skipped and passes:
  - **Given**: A playback error has been injected and error UI is displayed
  - **When**: The user views the error state
  - **Then**: A retry button is available (`MiniPlayer.RetryButton` or `ExpandedPlayer.RetryButton`)
- [ ] A simulation hook for error injection is added (e.g., `TestHook.SimulatePlaybackError` button gated by environment flag)
- [ ] The hook follows the existing notification-bridge pattern from 28.1.11 (button → notification → manager → engine)
- [ ] Zero runtime cost when simulation environment flags are absent
- [ ] `EpisodeDetailView` simulation controls are split by flag:
  - Network controls (`TestHook.SimulateNetworkLoss`, `TestHook.SimulateNetworkRecovery`, `TestHook.SimulatePoorNetwork`) render only when `UITEST_NETWORK_SIMULATION=1`
  - Buffer controls (`TestHook.SimulateBufferEmpty`, `TestHook.SimulateBufferReady`) render only when `UITEST_BUFFER_SIMULATION=1`
  - Shared simulation state labels may render when either flag is enabled

## Existing Error UI Identifiers

These are already implemented and available for test assertions:

| File | Identifier | Purpose |
|------|-----------|---------|
| `MiniPlayerView.swift:122` | `MiniPlayer.ErrorMessage` | Error text in mini player |
| `MiniPlayerView.swift:132` | `MiniPlayer.RetryButton` | Retry action in mini player |
| `MiniPlayerView.swift:140` | `MiniPlayer.ErrorOverlay` | Error overlay container |
| `ExpandedPlayerView.swift:93` | `ExpandedPlayer.RetryButton` | Retry action in expanded player |

## Spec References

- `spec/streaming-playback.md` — "Network error displayed"
- `spec/streaming-playback.md` — "Retry available after error"

## Dependencies

- Issue 28.1.11 — Network simulation test hooks (provides env-flag infrastructure, notification bridge, `NetworkSimulationControlling` protocol)
- Issue 03.3.4 — Unplayable Episode UX & Diagnostics (completed — provides PlaybackError enum, error UI, retry buttons)

## Implementation Notes

The existing infrastructure from 28.1.11 can be extended:

1. **New notification type**: Add an error simulation case (e.g., `ErrorSimulationType.streamFailed`) to `NetworkSimulationNotifications.swift`
2. **New hook button**: Add `TestHook.SimulatePlaybackError` to `EpisodeDetailView.testNetworkSimulationControls`
3. **Manager routing**: Extend `NetworkSimulationOverlayManager` to observe error simulation notifications and call `failPlayback(error:)` on the controller
4. **Protocol extension**: Optionally extend `NetworkSimulationControlling` with `simulatePlaybackError()`, or call `failPlayback(error:)` directly since `EnhancedEpisodePlayer` already exposes it
5. **Hook visibility tightening**: Split `EpisodeDetailView.testNetworkSimulationControls` so network and buffer button groups each respect their own env flag rather than a shared union gate

## Testing Strategy

### UI Tests
- Un-skip `testNetworkErrorMessageDisplays` and implement Given/When/Then flow
- Un-skip `testRetryButtonAvailableAfterError` and implement Given/When/Then flow
- Both tests should launch with appropriate simulation environment flag

## Estimated Effort

Small (1-2 hours)

## Files to Modify

| File | Changes |
|------|---------|
| `Packages/SharedUtilities/Sources/SharedUtilities/NetworkSimulationNotifications.swift` | Add error simulation type |
| `Packages/PlayerFeature/Sources/PlayerFeature/EpisodeDetailView.swift` | Add `TestHook.SimulatePlaybackError` button and tighten per-flag control visibility |
| `Packages/LibraryFeature/Sources/LibraryFeature/NetworkSimulationOverlayManager.swift` | Route error simulation notification |
| `zpodUITests/StreamingInterruptionUITests.swift` | Un-skip and implement both error tests |
