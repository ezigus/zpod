# Issue 03.1.5: Test Infrastructure Separation and Enhanced Reporting

**GitHub Issue**: [#105](https://github.com/ezigus/zpod/issues/105)

## Priority
High

## Status
üü° IN PROGRESS ‚Äì Regression reporting pipeline hardening underway

## Description
Overhaul the testing infrastructure to provide clear separation of concerns and comprehensive reporting. The current test execution system has overlapping test targets and incomplete reporting when tests fail or are interrupted.

### Goals
1. **Test Separation**: Clearly separate unit tests, integration tests, and UI tests with no overlaps
2. **Default Regression**: Make `./scripts/run-xcode-tests.sh` run a full regression by default (no arguments needed)
3. **Comprehensive Reporting**: Always provide a summary report regardless of test completion status

## Acceptance Criteria

### 1. Test Target Separation
- **Unit Tests** (`AppSmokeTests`): Pure unit tests for app-level logic only
  - No UI test code
  - No integration test scenarios
  - Fast, isolated, mockable
- **Integration Tests** (`IntegrationTests`): Cross-module workflow tests
  - SwiftPM package integration scenarios
  - No UI interactions
  - No app-level unit tests
- **UI Tests** (`zpodUITests`): End-to-end user interface tests only
  - XCUITest-based scenarios
  - No unit or integration test logic
- **Package Tests**: Per-package unit tests via SwiftPM
  - Already isolated (SharedUtilities, CoreModels, Persistence, etc.)
  - Should not overlap with workspace test targets

### 2. Default Full Regression
- Running `./scripts/run-xcode-tests.sh` with no arguments executes:
  1. Syntax check (`-s`)
  2. Test plan coverage verification (`-p`)
  3. Clean workspace build (`-c -b zpod`)
  4. All SwiftPM package tests (`-t <package>` for each module)
  5. App unit tests (`-t zpod` ‚Üí AppSmokeTests only)
  6. Integration tests (`-t IntegrationTests`)
  7. UI tests (`-t zpodUITests`)
  8. Swift lint (`-l`)
- Each phase should be clearly marked in output
- Failures in early phases should not prevent later phases from attempting

### 3. Enhanced Summary Reporting
The script should **always** print a final summary showing:

#### Build Summary
```
================================
Build Summary
================================
‚úÖ Workspace Build: zpod (216 files)
‚úÖ Package: SharedUtilities (52 tests available)
‚úÖ Package: CoreModels (238 tests available)
‚ö†Ô∏è  Package: SettingsDomain (build skipped - macOS only)
‚ùå Package: CustomPackage (build failed - see log)

Builds: 3 succeeded, 1 skipped, 1 failed
```

#### Test Execution Summary
```
================================
Test Execution Summary
================================
Unit Tests (AppSmokeTests):
  ‚úÖ 4 test cases passed (0 failures)
  
Integration Tests (IntegrationTests):
  ‚úÖ 16 test cases passed (0 failures)
  
UI Tests (zpodUITests):
  ‚ö†Ô∏è  52 test cases passed (2 failures)
  ‚ùå SwipeConfigurationPersistenceUITests.testHapticToggle
  ‚ùå EpisodeListUITests.testBatchOperations
  
Package Tests:
  ‚úÖ SharedUtilities: 52/52 passed
  ‚úÖ CoreModels: 238/238 passed
  ‚úÖ Persistence: 49/49 passed
  ‚ö†Ô∏è  SettingsDomain: not run (macOS only)
  
Total: 359 test cases passed, 2 failed, 0 skipped
```

#### Overall Status
```
================================
Overall Status
================================
‚ö†Ô∏è  Regression completed with failures
   - Builds: 3/4 succeeded
   - Tests: 359/361 passed (99.4%)
   - Duration: 15m 32s
   - Logs: /Users/.../TestResults/TestResults_20251018_143000_regression.log

Next steps:
  - Review failed tests: UI tests (2 failures)
  - Check build failure: CustomPackage
  - Full results: TestResults/TestResults_20251018_143000.xcresult
```

### 4. Interrupted Execution Handling
- If user presses Ctrl+C or tests timeout:
  - Print summary of what **was** completed before interruption
  - Mark incomplete phases as "interrupted" not "failed"
  - Example:
    ```
    ‚ö†Ô∏è  Test execution interrupted by user
    Completed phases:
      ‚úÖ Syntax check
      ‚úÖ Workspace build
      ‚úÖ Package tests (3/8 packages)
      ‚è∏Ô∏è  Unit tests (interrupted)
    Not started:
      ‚è≠Ô∏è  Integration tests
      ‚è≠Ô∏è  UI tests
      ‚è≠Ô∏è  Swift lint
    ```

## Specification References
- AGENTS.md Section 7: "Tooling & CI"
- AGENTS.md Section 4: "Testing Strategy"
- `.github/workflows/ci.yml`: CI pipeline configuration

## Dependencies
- Blocks: None (infrastructure improvement)
- Blocked by: None
- Related to:
  - Issue 03.1.4: Settings Domain macOS Support (infrastructure foundation)
  - Issue 12.7: UI Test Reliability CI Hardening (test quality)

## Testing Strategy

### Phase 1: Test Separation
1. Audit current test targets:
   - List all test classes in `AppSmokeTests/`
   - List all test classes in `zpodUITests/`
   - List all test classes in `IntegrationTests/`
2. Identify overlaps and misplaced tests
3. Move tests to correct targets:
   - UI test code ‚Üí `zpodUITests/`
   - Integration scenarios ‚Üí `IntegrationTests/`
   - Pure unit tests ‚Üí `AppSmokeTests/` or package tests
4. Update `.xctestplan` to reflect clean separation
5. Verify no duplicate test execution with `grep -r "class.*XCTestCase"`

### Phase 2: Script Enhancement
1. Add `DEFAULT_REGRESSION=1` mode when no arguments provided
2. Implement comprehensive status tracking:
   - Array of completed phases
   - Dictionary of build results (pass/fail/skip)
   - Dictionary of test results (passed/failed/skipped counts)
3. Add trap handler for SIGINT (Ctrl+C) to print summary before exit
4. Implement summary formatting functions:
   - `print_build_summary()`
   - `print_test_summary()`
   - `print_overall_status()`

### Phase 3: Reporting
1. Create summary data structures during execution
2. Ensure summary prints on:
   - Successful completion
   - Test failures (continue execution, show final summary)
   - Build failures (continue execution, show final summary)
   - User interruption (SIGINT)
   - Script errors (trap ERR)
3. Test all reporting paths:
   - All green (100% success)
   - Some failures (partial success)
   - Early failure (syntax check fails)
   - User interruption at different phases

### Phase 4: CI Integration
1. Update `.github/workflows/ci.yml` matrix:
   - Change from `[zpod, zpodUITests, IntegrationTests]`
   - To separate jobs: `[unit, integration, ui]`
   - Remove duplicate execution of zpodUITests and IntegrationTests
2. Each CI job runs specific target only:
   - `unit`: `./scripts/run-xcode-tests.sh -t AppSmokeTests`
   - `integration`: `./scripts/run-xcode-tests.sh -t IntegrationTests`
   - `ui`: `./scripts/run-xcode-tests.sh -t zpodUITests`
3. Add CI job for full regression on main branch:
   - Runs `./scripts/run-xcode-tests.sh` (default full regression)
   - Only on push to `main` or manual workflow dispatch

## Implementation Plan

### Milestone 1: Test Separation (1-2 days)
- [ ] Audit and categorize all test classes
- [ ] Move misplaced tests to correct targets
- [ ] Verify clean separation with no overlaps
- [ ] Update test plan configuration
- [ ] Document test organization in TestSummary.md files

### Milestone 2: Script Default Behavior (1 day)
- [ ] Implement default full regression mode
- [ ] Add phase markers for clear output
- [ ] Test default execution path
- [ ] Update help text and documentation

### Milestone 3: Summary Reporting (2-3 days)
- [ ] Design summary data structures
- [ ] Implement build result tracking
- [ ] Implement test result tracking
- [ ] Create summary formatting functions
- [ ] Add exit code handling for all paths

### Milestone 4: Interruption Handling (1 day)
- [ ] Add SIGINT trap handler
- [ ] Add ERR trap handler
- [ ] Test interruption at various phases
- [ ] Verify summary prints correctly on interruption

### Milestone 5: CI Update (1 day)
- [ ] Refactor CI matrix to remove duplicates
- [ ] Add separate unit/integration/ui jobs
- [ ] Add full regression job for main branch
- [ ] Test CI pipeline with all changes
- [ ] Update CI documentation

## Success Metrics
1. **Separation**: Zero overlapping test cases between targets
2. **Regression**: Default execution runs all phases in correct order
3. **Reporting**: 100% of script exits produce a summary (success, failure, or interruption)
4. **Performance**: Full regression completes in <20 minutes locally
5. **CI Efficiency**: No duplicate test execution, parallel jobs complete in <15 minutes
6. **Developer Experience**: Clear, actionable summary on every run

## Documentation Updates Required
- [ ] AGENTS.md Section 7: Update tooling workflow with new default behavior
- [ ] AGENTS.md Section 4: Document test target separation rules
- [ ] `scripts/run-xcode-tests.sh`: Update help text with examples
- [ ] `TestSummary.md` files: Document which tests belong in each target
- [ ] CI README: Document parallel job structure and matrix

## Notes
- This issue addresses the "zpod target runs everything" confusion identified during CI debugging
- Enhanced reporting will significantly improve debugging when tests fail in CI
- Test separation will make it clearer what's being tested and reduce execution time
- Default full regression ensures developers always run complete validation before pushing

## Open Questions
- Should package tests run in parallel or sequentially during full regression?
- Should we add a `-q` (quick) flag that skips UI tests for rapid iteration?
- Should the script automatically open `.xcresult` bundles on failure for local runs?
- Do we want color-coded output (green ‚úÖ, yellow ‚ö†Ô∏è, red ‚ùå) or plain text for CI compatibility?
