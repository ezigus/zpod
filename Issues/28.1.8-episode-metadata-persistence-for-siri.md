# Issue 28.1.8 - Episode Metadata Persistence for Siri Snapshots

**Status:** ðŸ†• Proposed  
**Priority:** High  
**Category:** Playback / Persistence  
**Created:** 2026-01-17  
**Parent Issue:** 28.1

## Description

Persist lightweight episode metadata so Siri snapshots can include episode lists after app restart, even before feeds refresh. This closes the current gap where `PodcastEntity` stores no episodes and Siri snapshots can be empty immediately after relaunch.

## Background

- `SwiftDataPodcastManager` persists podcasts only; episodes are transient.
- `SiriSnapshotCoordinator` builds snapshots from `Podcast.episodes`.
- After app relaunch, episodes are empty until feeds refresh, so Siri "play latest" can fail.

## Objectives

1. Persist minimal episode metadata needed for Siri snapshots and offline UX (id, title, duration, publishedAt, playbackPosition, isPlayed, podcastID).
2. Keep persistence lightweight and decoupled from full offline audio storage.
3. Ensure snapshots are correct immediately after restart.

## Spec References

- `spec/playback.md` â€” Siri and Shortcuts Integration (add explicit restart scenario)
- `spec/discovery.md` â€” Subscription persistence context
- `spec/customization.md` â€” Organization persistence context

## Acceptance Criteria

- [ ] Episode metadata is persisted alongside podcasts (SwiftData or dedicated store).
- [ ] `SwiftDataPodcastManager` (or a companion repository) hydrates episodes on fetch.
- [ ] Siri snapshots include episode lists immediately after app relaunch.
- [ ] Episode persistence does not require audio downloads (metadata-only).
- [ ] Tests validate snapshot correctness after restart without network refresh.
- [ ] Specs updated to include Siri restart scenario.

## Design Notes

### Minimal Episode Entity

**Suggested schema fields:**
- `id`, `podcastID`, `title`
- `duration`, `pubDate`
- `playbackPosition`, `isPlayed`

### Data Flow

1. Feed refresh populates episode metadata store.
2. `PodcastManaging` fetch attaches persisted episodes when available.
3. Siri snapshots read from hydrated episodes and write to app group.

### Migration Considerations

- No prior episode persistence exists; start fresh.
- Keep episode payload small to avoid schema bloat.

## Dependencies

- Blocks reliable Siri snapshot verification in Issue 27.1.2.
- Related to Issue 28.1.2 (local storage metadata) and Issue 28.1.7 (test infrastructure).

## Testing Strategy

- Unit tests for episode entity conversions and persistence.
- Integration test: persist episodes, relaunch container, build snapshots, verify episode titles.
- UI test (optional): Siri debug hook for snapshot visibility in test mode.

## Open Questions

- Should episode metadata live in SwiftData or a lightweight JSON cache?
- Do we need to persist all episodes or a recent window (e.g., last 20)?
