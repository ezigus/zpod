# Issue 03.3.5: MPNowPlayingInfoCenter Real-Time Sync

**Status**: üÜï Proposed

**Priority**: Medium

**Parent**: 03.3 - Audio Playback Implementation

**GitHub Issue**: [#270](https://github.com/ezigus/zpod/issues/270)

## Description

Ensure the system Now Playing info (lock screen, Control Center, CarPlay) stays synchronized with actual playback position in real-time. The `SystemMediaCoordinator` already exists and updates Now Playing, but currently receives stale position data.

## Problem Statement

**Current State**:
- `SystemMediaCoordinator` subscribes to `statePublisher` ‚úÖ
- Updates `MPNowPlayingInfoCenter` on state changes ‚úÖ
- Position data is stale (never advances) ‚ùå
- Lock screen shows frozen timeline ‚ùå

**Target State**:
- Lock screen shows real-time progress
- Control Center reflects accurate position
- Scrubbing from lock screen seeks correctly
- CarPlay Now Playing stays in sync
- AirPlay/Bluetooth displays show correct time

## Technical Analysis

### Existing Implementation (Already Complete)

```swift
// SystemMediaCoordinator.swift - ALREADY IMPLEMENTED
private func updateNowPlayingInfo(for state: EpisodePlaybackState) {
    guard let snapshot = infoBuilder.makeSnapshot(from: state) else {
        infoCenter.nowPlayingInfo = nil
        return
    }

    var info: [String: Any] = [
        MPMediaItemPropertyTitle: snapshot.title,
        MPMediaItemPropertyPlaybackDuration: snapshot.duration,
        MPNowPlayingInfoPropertyElapsedPlaybackTime: snapshot.elapsed,  // ‚Üê Position
        MPNowPlayingInfoPropertyPlaybackRate: snapshot.playbackRate,
    ]
    // ...
    infoCenter.nowPlayingInfo = info
}
```

### What's Missing

The coordinator works correctly - it just needs **real position data** from the playback engine. Once 03.3.1 (ticking) and 03.3.2 (AVPlayer) are complete, this should "just work."

However, we should verify:
1. Updates happen frequently enough (every 0.5-1s)
2. Seeking updates position immediately
3. Rate changes (pause/play) update correctly

## Acceptance Criteria

- [ ] Lock screen shows advancing progress bar
- [ ] Lock screen elapsed time updates every second
- [ ] Control Center mirrors lock screen accurately
- [ ] Scrubbing on lock screen seeks playback
- [ ] Pause/play from lock screen works
- [ ] Skip forward/backward from lock screen works
- [ ] CarPlay Now Playing shows correct position
- [ ] AirPlay display shows correct position
- [ ] Position updates even when app is backgrounded

## Spec References

See `zpod/spec/playback.md` - Core Playback Behavior section:
- **Timeline Advancement During Playback** - Lock screen/Control Center position updates
- **Seeking to Position** - Playback position jumps to scrubber location
- **Background Playback** - Lock screen controls remain functional

See `zpod/spec/ui.md`:
- **Using Lock Screen and Control Center Players** - Playback controls available via iOS media controls

## Files to Verify/Modify

| File | Changes |
|------|---------|
| `Packages/LibraryFeature/Sources/LibraryFeature/SystemMediaCoordinator.swift` | Verify update frequency |
| `Packages/LibraryFeature/Sources/LibraryFeature/NowPlayingInfoBuilder.swift` | Verify snapshot accuracy |
| `Packages/LibraryFeature/Tests/LibraryFeatureTests/SystemMediaCoordinatorTests.swift` | Add sync tests |

## Implementation Steps

### 1. Verify Update Frequency

The coordinator already subscribes to `statePublisher`. Once the playback engine emits updates every 0.5s, the Now Playing info should update accordingly.

```swift
// Existing - should work once engine emits updates
stateCancellable = playbackService.statePublisher
    .receive(on: RunLoop.main)
    .sink { [weak self] state in
        self?.handlePlaybackStateChange(state)
    }
```

### 2. Verify Seek Handling

When user scrubs on lock screen, the system calls our remote command handler:

```swift
// Already implemented - verify it works
commandCenter.changePlaybackPositionCommand.addTarget { [weak self] event in
    guard let positionEvent = event as? MPChangePlaybackPositionCommandEvent else {
        return .commandFailed
    }
    self?.playbackService.seek(to: positionEvent.positionTime)
    return .success
}
```

**Note**: The `changePlaybackPositionCommand` may not be registered. Need to verify.

### 3. Add Missing Seek Command (If Needed)

```swift
// Add to configureRemoteCommands() if missing
commandCenter.changePlaybackPositionCommand.isEnabled = true
commandCenter.changePlaybackPositionCommand.addTarget { [weak self] event in
    guard let self = self,
          let positionEvent = event as? MPChangePlaybackPositionCommandEvent else {
        return .commandFailed
    }
    Task { @MainActor in
        self.playbackService.seek(to: positionEvent.positionTime)
    }
    return .success
}
```

### 4. Verify Background Updates

Ensure position updates continue when app is backgrounded:
- Audio session must be active
- Background mode "audio" must be enabled
- Timer/observer must not be suspended

## Testing Strategy

### Unit Tests
- Verify state changes trigger Now Playing updates
- Verify seek command registered and functional
- Verify playback rate updates (0 when paused, 1 when playing)

### Integration Tests
- Play episode ‚Üí verify Now Playing info populated
- Pause ‚Üí verify rate changes to 0
- Seek ‚Üí verify elapsed time updates immediately

### Manual Tests
- Lock screen progress bar advances
- Control Center mirrors lock screen
- Scrub on lock screen ‚Üí audio seeks
- Background the app ‚Üí progress continues
- Test on CarPlay (if available)
- Test with AirPods/Bluetooth

## Dependencies

- **03.3.1**: Position ticking provides updates to subscribe to
- **03.3.2**: AVPlayer provides real position data
- Already depends on completed `SystemMediaCoordinator`

## Estimated Effort

**Low** - 1-2 hours
- Most implementation already exists
- Primarily verification and testing
- May need to add seek command if missing

## Notes

- `MPNowPlayingInfoCenter` throttles updates internally
- Don't update more frequently than every 0.5s
- Verify `playbackRate` is set correctly (crucial for system UI)
- Test with "Now Playing" widget on home screen too
