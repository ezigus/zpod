# Issue 02.1.8: CarPlay Integration for Episode Lists

## Priority
Medium

## Status
✅ Complete

## Description
Implement Scenario 8 from Issue 02.1 by delivering a CarPlay-optimized episode list that supports safe browsing and Siri control. This provides a driver-safe interface for browsing and managing podcast episodes while connected to CarPlay, with simplified UI, large touch targets, and comprehensive voice control integration.

## Acceptance Criteria

### Scenario 8: CarPlay Integration for Episode Lists (from Issue 02.1)
- **Given** I am connected to CarPlay and browsing episodes
- **When** I navigate the episode list through CarPlay
- **Then** I should see a simplified, driver-safe episode list with large touch targets
- **And** Voice control should allow me to select episodes using Siri
- **And** Essential episode information should be displayed clearly (title, duration, play status)
- **And** I should be able to start playback and add episodes to queue using CarPlay controls

### Detailed Requirements
1. **CarPlay Scene Configuration**
   - Properly configure CarPlay scene delegate
   - Add necessary entitlements for CarPlay support
   - Configure Info.plist for CarPlay audio app template

2. **Simplified Episode List UI**
   - Display episode list using CPListTemplate with large touch targets
   - Show essential metadata: title, duration, play status
   - Use clear, high-contrast text readable while driving
   - Limit list depth to comply with CarPlay safety guidelines

3. **Voice Control Integration**
   - Enable Siri voice commands for episode selection
   - Support natural language queries ("Play the latest episode")
   - Provide voice feedback for actions

4. **Playback Controls**
   - Allow starting playback from episode list
   - Support adding episodes to playback queue
   - Integrate with existing PlaybackEngine

5. **Safety Compliance**
   - Follow Apple CarPlay Human Interface Guidelines
   - Limit interactions while vehicle is in motion
   - Use appropriate templates and controls

## Implementation Approach

### Phase 1: CarPlay Infrastructure (Day 1)
1. **Project Configuration**
   - Add CarPlay entitlements to zpod.entitlements
   - Update Info.plist with CarPlay audio app configuration
   - Add CarPlay framework import

2. **Scene Delegate Setup**
   - Create CarPlaySceneDelegate.swift
   - Configure CarPlay window scene
   - Set up template hierarchy

### Phase 2: Episode List Integration (Day 1-2)
1. **CarPlay Episode List View Model**
   - Create CarPlayEpisodeListController
   - Leverage existing EpisodeListViewModel for data
   - Map episode data to CPListItem format

2. **Template Implementation**
   - Implement CPListTemplate for episode browsing
   - Add episode metadata display
   - Configure list item handlers

### Phase 3: Playback Integration (Day 2)
1. **Playback Actions**
   - Integrate with existing PlaybackEngine
   - Implement episode selection handlers
   - Add queue management support

2. **Now Playing Integration**
   - Ensure proper integration with CPNowPlayingTemplate
   - Display current episode information
   - Sync playback state

### Phase 4: Testing and Validation (Day 2-3)
1. **Unit Tests**
   - Test CarPlay scene delegate configuration
   - Validate episode list data mapping
   - Test playback integration

2. **Manual Testing**
   - Test in CarPlay simulator
   - Validate Siri integration
   - Ensure compliance with HIG

## Specification References
- `spec/ui.md`: CarPlay interface design (Scenario: Navigating with CarPlay Layout)
- `spec/playback.md`: Playback integration for CarPlay
- `Issues/02.1-episode-list-management-ui.md`: Parent issue Scenario 8

## Dependencies
- **Required**: Issue #02.1.1 (Episode List Display - completed)
- **Required**: Issue #03 (Playback engine for CarPlay integration)
- **Recommended**: Issue #17.1 (CarPlay Interface UI) for shared components
- **Optional**: Issue #04 (Download functionality for offline indicators)

## Estimated Effort
**Complexity**: Medium  
**Time Estimate**: 2-3 days  
**Story Points**: 5

## Success Metrics

### Functional Metrics
1. **CarPlay Integration**
   - Episode list displays correctly in CarPlay interface
   - All episodes from a podcast are browsable
   - Playback initiates successfully from CarPlay
   - Voice commands work reliably for episode selection

2. **Safety Compliance**
   - Interface meets Apple CarPlay safety guidelines
   - No complex interactions while vehicle is in motion
   - Text is readable at highway speeds
   - Touch targets meet minimum size requirements

### Usability Metrics
1. **Driver Experience**
   - Episode selection requires 2 taps or fewer
   - Essential information is immediately visible
   - Voice control works in typical driving conditions
   - No cognitive overload from interface complexity

## Risk Mitigation
- **CarPlay Simulator Limitations**: Test with actual CarPlay hardware when possible
- **Voice Recognition**: Test Siri integration in various noise environments
- **Safety Compliance**: Follow Apple HIG strictly to avoid app rejection
- **Template Restrictions**: Work within CarPlay's limited template options

## Testing Strategy

### Unit Tests
1. **Scene Configuration Tests**
   - Verify CarPlay scene delegate initialization
   - Test template hierarchy setup
   - Validate episode data mapping

2. **Integration Tests**
   - Test playback engine integration
   - Verify Siri intent handling
   - Test episode list synchronization

### UI Tests
1. **CarPlay Simulator Tests**
   - Episode list navigation
   - Playback initiation
   - Voice command simulation (if possible)

### Manual Tests
1. **Real-World Testing**
   - Test in CarPlay simulator
   - Test on actual CarPlay hardware if available
   - Validate Siri integration
   - Verify safety compliance

## Notes
- CarPlay development requires CarPlay entitlements
- Testing is primarily done via CarPlay simulator
- Coordination with Issue 17.1 may provide shared infrastructure
- Voice control testing may require manual validation
- Compliance with Apple CarPlay HIG is critical for App Store approval

## Outstanding Work (Current PR Gap Analysis)
- [x] **Podcast & Episode Data Wiring** – CarPlay templates now derive from `PodcastManaging` with 100-episode limits and duration/state metadata.
- [x] **Playback Queue Actions** – CarPlay selection routes through a queue coordinator (play now & enqueue).
- [x] **Voice Control** – CarPlay items configured with accessibility labels and hints to enable voice selection via Siri.
- [x] **Safety & HIG Compliance** – Implemented cancel actions, title truncation for smaller screens, accessibility support, and playback indicators per HIG guidelines.
- [x] **Testing** – Behavioural tests cover data mapping and queue coordination; manual checklist updated in `CarPlayIntegrationTests` comments.
- [x] **Configuration Docs** – CARPLAY_SETUP.md documents dependency injection, scene manifest, and voice workflow updates.

## References
- [Apple CarPlay Documentation](https://developer.apple.com/carplay/)
- [CarPlay Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/carplay)
- GitHub Issue ezigus/zpod#75 (umbrella tracking)
