# Issue 28.1 - Offline and Streaming Playback Infrastructure

**Status:** Open  
**Priority:** High  
**Category:** Playback / Audio Engine  
**Created:** 2026-01-05  
**Sprint:** Future

## Description

Implement comprehensive infrastructure to support both offline (downloaded) and streaming playback modes for podcast episodes. This is foundational work that will enable users to download episodes for offline listening while maintaining robust streaming capabilities with intelligent buffering, network adaptation, and error recovery.

## Background

Currently, the app's playback system uses AVPlayer but lacks:
1. Download management to store episodes locally
2. Intelligent selection between local vs. streaming playback
3. Streaming optimizations (buffering, range requests, network adaptation)
4. Robust error handling for network issues during streaming
5. Storage management for downloaded content

This issue establishes the foundational architecture to support both playback modes.

## Objectives

1. **Dual Playback Mode Support** - AVPlayer can play both local files and HTTP streams transparently
2. **Download Infrastructure** - Manage episode downloads with progress tracking and storage
3. **Streaming Infrastructure** - Intelligent buffering, network monitoring, and error recovery
4. **Unified Playback Interface** - Single API that abstracts local vs. streaming differences
5. **Episode Metadata Persistence** - Persist episode metadata needed for offline playback and Siri snapshots after app restart
6. **Testing Infrastructure** - Comprehensive test coverage for both modes

## Related Specifications

- `spec/offline-playback.md` - Full Given/When/Then scenarios for downloads and offline playback
- `spec/streaming-playback.md` - Full Given/When/Then scenarios for streaming behavior
- `spec/playback.md` - Core playback control scenarios (position, seek, pause/resume)

## Sub-Issues

This parent issue is decomposed into focused implementation tasks:

- **28.1.1** - Download Manager Implementation
- **28.1.2** - Local Storage and File Management
- **28.1.3** - Streaming Engine with Buffering
- **28.1.4** - Network Monitoring and Adaptation
- **28.1.5** - Unified Playback Coordinator (`Issues/28.1.5-unified-playback-coordinator.md`, [#341](https://github.com/ezigus/zpod/issues/341))
- **28.1.6** - UI Integration (Download/Streaming Indicators) (`Issues/28.1.6-ui-integration-download-streaming-indicators.md`, [#342](https://github.com/ezigus/zpod/issues/342))
- **28.1.7** - Test Infrastructure for Both Modes (`Issues/28.1.7-test-infrastructure-offline-streaming.md`, [#343](https://github.com/ezigus/zpod/issues/343))
- **28.1.8** - Episode Metadata Persistence for Siri Snapshots (`Issues/28.1.8-episode-metadata-persistence-for-siri.md`)

## Dependencies

- **Requires:** Current AVPlayer-based playback engine (03.3 series complete)
- **Blocks:** Automatic download features, offline-first UX improvements
- **Related:** Issue 27.1.2 (Siri snapshot verification), Issue 28.1.8 (episode metadata persistence)

## Acceptance Criteria

- [ ] User can manually download an episode via UI
- [ ] Downloaded episodes play from local storage without network requests
- [ ] Non-downloaded episodes stream from network URLs
- [ ] UI clearly indicates download status (downloaded, downloading, stream-only)
- [ ] Streaming handles network interruptions gracefully (pause, resume, retry)
- [ ] Downloaded episodes can be deleted to free storage
- [ ] Storage usage is tracked and displayed to user
- [ ] Both playback modes tested comprehensively (unit + UI tests)
- [ ] Siri snapshots include episode lists after app restart (or documented limitation + explicit spec coverage)
- [ ] All scenarios from `spec/offline-playback.md` and `spec/streaming-playback.md` have corresponding tests
- [ ] Dev-log documentation for architecture decisions

## Testing Strategy

1. **Unit Tests** - Download manager, storage operations, network monitoring
2. **Integration Tests** - Playback coordinator switching between modes
3. **UI Tests** - Download flow, offline playback, streaming with network simulation
4. **Manual Tests** - Real device testing with actual network conditions

## Technical Approach (High-Level)

### Architecture Components

```
┌─────────────────────────────────────────────────────────┐
│                   Playback Coordinator                   │
│  (Decides: local file vs. stream, manages transitions)  │
└────────────────┬────────────────────────────────────────┘
                 │
         ┌───────┴────────┐
         │                │
         ▼                ▼
┌─────────────────┐  ┌──────────────────┐
│  Local Playback │  │ Stream Playback  │
│   (file:// URL) │  │  (http:// URL)   │
└────────┬────────┘  └────────┬─────────┘
         │                    │
         └───────┬────────────┘
                 ▼
        ┌─────────────────┐
        │   AVPlayer       │
        │ (unchanged core) │
        └──────────────────┘

Supporting Services:
├─ Download Manager (queue, progress, cancellation)
├─ Storage Manager (file I/O, space monitoring)
├─ Network Monitor (reachability, bandwidth estimation)
└─ Buffer Strategy (adaptive buffering based on network)
```

### Key Design Decisions

1. **AVPlayer for Both Modes** - Use same AVPlayer instance; only URL changes
2. **Storage Location** - App Documents directory, organized by podcast/episode
3. **Download Format** - Original audio format (no transcoding)
4. **Network Library** - URLSession with custom delegate for progress/control
5. **Buffer Strategy** - AVPlayer native buffering with KVO observation

## Out of Scope (Future Issues)

- Automatic download on subscription
- Background download with BGTaskScheduler
- iCloud sync of downloads
- Download scheduling (overnight, etc.)
- Smart cleanup/retention policies
- Adaptive bitrate streaming (HLS/DASH)

## Success Metrics

- Downloaded episodes start playback within 500ms
- Streaming episodes start within 2 seconds on good network
- Network interruption recovery within 3 seconds of reconnection
- Zero crashes related to mode switching or network errors
- 100% test coverage of core download/streaming logic

## Notes

- This is foundational infrastructure; UX polish comes in follow-up issues
- Focus on correctness and reliability over feature completeness
- Maintain backward compatibility with existing playback tests (03.3 series)

---

**Related Issues:** 03.3.x (AVPlayer test infrastructure)  
**Dev Log:** `dev-log/28.1-offline-streaming-playback-infrastructure.md`
