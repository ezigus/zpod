# Issue 28.1.11 - Network Simulation Test Hooks for UI Tests

**Status:** Open
**Priority:** Medium
**Category:** Test Infrastructure
**Created:** 2026-02-07
**Parent Issue:** 28.1
**GitHub Issue:** [#396](https://github.com/ezigus/zpod/issues/396)

## Description

Add environment-gated test hook buttons that allow UI tests to simulate network conditions (loss, recovery, poor quality) and buffer states (empty, ready). These hooks are needed by `StreamingInterruptionUITests` to exercise auto-pause/resume and buffer indicator behaviors.

## Problem Statement

**Current State**:
- `StreamingInterruptionUITests` references several `TestHook.*` button identifiers that do not exist in the app:
  - `TestHook.SimulateNetworkLoss`
  - `TestHook.SimulateNetworkRecovery`
  - `TestHook.SimulateBufferEmpty`
  - `TestHook.SimulateBufferReady`
  - `TestHook.SimulatePoorNetwork`
- Tests that depend on these hooks currently skip gracefully via `XCTSkip` when the buttons are absent
- There is no way to simulate network conditions during UI test runs

**Target State**:
- When launched with `UITEST_NETWORK_SIMULATION=1` or `UITEST_BUFFER_SIMULATION=1`, the app shows a debug overlay with test hook buttons
- Tapping these buttons injects simulated network/buffer state changes into the playback engine
- `StreamingInterruptionUITests` can exercise auto-pause, auto-resume, and buffer indicator flows

## Acceptance Criteria

- [ ] `TestHook.SimulateNetworkLoss` button appears when `UITEST_NETWORK_SIMULATION=1`
- [ ] `TestHook.SimulateNetworkRecovery` button appears when `UITEST_NETWORK_SIMULATION=1`
- [ ] `TestHook.SimulatePoorNetwork` button appears when `UITEST_NETWORK_SIMULATION=1`
- [ ] `TestHook.SimulateBufferEmpty` button appears when `UITEST_BUFFER_SIMULATION=1`
- [ ] `TestHook.SimulateBufferReady` button appears when `UITEST_BUFFER_SIMULATION=1`
- [ ] Tapping network loss triggers auto-pause behavior in the playback engine
- [ ] Tapping network recovery triggers auto-resume after grace period
- [ ] Tapping buffer empty shows buffer indicator in the player UI
- [ ] Tapping buffer ready dismisses the buffer indicator
- [ ] Hooks use the debug overlay pattern (`UIWindow` at `.alert + 100` level) per AGENTS.md guidelines
- [ ] Hooks have zero runtime cost when environment flags are absent

## Architecture

Follow the **debug overlay pattern** documented in AGENTS.md section 4:

```
Environment flag check (runtime)
    |
    v
DebugOverlayManager attaches observer
    |
    v
UIWindow at .alert + 100 level
    |
    v
TestHook buttons with accessibility identifiers
    |
    v
Button tap -> posts Notification -> playback engine reacts
```

## Spec References

- `spec/streaming-playback.md` - Auto-pause on network loss, auto-resume on recovery
- `spec/streaming-playback.md` - Buffer indicator display
- AGENTS.md section 4 - Debug & Test Infrastructure Patterns

## Dependencies

- Issue 28.1.4 - Network Monitoring and Adaptation (provides `NetworkMonitor`)
- Issue 28.1.3 - Streaming Engine with Buffering (provides buffer state management)

## Blocked Tests

This issue unblocks the following streaming interruption UI tests:
- `StreamingInterruptionUITests.testAutoPauseOnNetworkLoss` (currently fails / skips)
- `StreamingInterruptionUITests.testAutoResumeOnNetworkRecovery` (currently fails / skips)
- `StreamingInterruptionUITests.testBufferIndicatorAppears` (currently skips)
- `StreamingInterruptionUITests.testBufferIndicatorDisappears` (currently skips)
- `StreamingInterruptionUITests.testPlaybackAdaptsToPoorNetwork` (currently skips)

## Testing Strategy

### Unit Tests
- Hooks only appear when environment flags are set
- Notifications posted correctly when buttons tapped

### UI Tests
- Remove `XCTSkip` from blocked tests once hooks are implemented
- Verify auto-pause/resume behavior via simulated network state changes
- Verify buffer indicator appears/disappears via simulated buffer state changes

## Estimated Effort

Medium (3-5 hours)

## Files to Create/Modify

| File | Changes |
|------|---------|
| `Packages/LibraryFeature/Sources/LibraryFeature/NetworkSimulationOverlayManager.swift` | New - debug overlay with test hook buttons |
| `zpod/zpodApp.swift` or `ContentView.swift` | Wire overlay manager when env flag present |
| `Packages/Networking/Sources/Networking/NetworkMonitor.swift` | Accept injected network state for simulation |
| `zpodUITests/StreamingInterruptionUITests.swift` | Remove `XCTSkip` from hook-dependent tests |
