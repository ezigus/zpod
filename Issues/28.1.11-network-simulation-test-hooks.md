# Issue 28.1.11 - Network Simulation Test Hooks for UI Tests

**Status:** Closed (2026-02-09)
**Priority:** Medium
**Category:** Test Infrastructure
**Created:** 2026-02-07
**Parent Issue:** 28.1
**GitHub Issue:** [#396](https://github.com/ezigus/zpod/issues/396)

## Description

Add environment-gated test hook buttons that allow UI tests to simulate network conditions (loss, recovery, poor quality) and buffer states (empty, ready). These hooks are needed by `StreamingInterruptionUITests` to exercise auto-pause/resume and buffer indicator behaviors.

## Problem Statement

**Historical State**:
- `StreamingInterruptionUITests` previously referenced `TestHook.*` controls that were not wired to deterministic playback simulation behavior.
- Hook-dependent tests skipped/failed while simulation integration was incomplete.

**Resolved State**:
- Launching with `UITEST_NETWORK_SIMULATION=1` or `UITEST_BUFFER_SIMULATION=1` exposes `TestHook.*` simulation controls in `EpisodeDetailView`.
- Tapping controls posts simulation notifications that are bridged to the shared playback service via `NetworkSimulationOverlayManager`.
- `StreamingInterruptionUITests` now actively validates auto-pause/resume and buffer indicator behaviors.

## Scope Change Record

- Original issue text proposed a dedicated `UIWindow` control overlay at `.alert + 100`.
- Approved implementation (documented in `dev-log/28.1.11-network-simulation-test-hooks.md`) keeps controls in `EpisodeDetailView` and uses an env-gated manager for observer lifecycle and notification-to-engine bridging.
- Rationale: existing stable `TestHook.*` identifiers were already present in the player surface; the integration gap was playback wiring, not control rendering.

## Acceptance Criteria

- [x] `TestHook.SimulateNetworkLoss` button appears when `UITEST_NETWORK_SIMULATION=1`
- [x] `TestHook.SimulateNetworkRecovery` button appears when `UITEST_NETWORK_SIMULATION=1`
- [x] `TestHook.SimulatePoorNetwork` button appears when `UITEST_NETWORK_SIMULATION=1`
- [x] `TestHook.SimulateBufferEmpty` button appears when `UITEST_BUFFER_SIMULATION=1`
- [x] `TestHook.SimulateBufferReady` button appears when `UITEST_BUFFER_SIMULATION=1`
- [x] Tapping network loss triggers auto-pause behavior in the playback engine
- [x] Tapping network recovery triggers auto-resume after grace period
- [x] Tapping buffer empty shows buffer indicator in the player UI
- [x] Tapping buffer ready dismisses the buffer indicator
- [x] Hooks follow the approved debug-hook pattern: env-gated observer lifecycle in `NetworkSimulationOverlayManager` plus notification bridging to playback simulation, with `TestHook.*` controls rendered in `EpisodeDetailView` (no dedicated `UIWindow` control layer)
- [x] Simulation observer lifecycle has no active runtime work when simulation environment flags are absent

## Architecture

Implemented flow:

```
UITEST_NETWORK_SIMULATION / UITEST_BUFFER_SIMULATION
    |
    +-> ZpodApp creates NetworkSimulationOverlayManager (env gated)
    |
    +-> EpisodeDetailView renders TestHook controls (env gated)
            |
            v
       Button tap posts .networkSimulation / .bufferSimulation notification
            |
            v
       NetworkSimulationOverlayManager observes and routes to
       PlaybackEnvironment.playbackService as NetworkSimulationControlling
            |
            v
       EnhancedEpisodePlayer applies simulation state and publishes updates
            |
            v
       EpisodeDetailViewModel consumes simulation publishers
            |
            v
       EpisodeDetailView updates Play/Pause + buffer indicator UI
```

## Spec References

- `spec/streaming-playback.md` - Auto-pause on network loss, auto-resume on recovery
- `spec/streaming-playback.md` - Buffer indicator display
- AGENTS.md section 4 - Debug & Test Infrastructure Patterns

## Dependencies

- Issue 28.1.4 - Network Monitoring and Adaptation (provides `NetworkMonitor`)
- Issue 28.1.3 - Streaming Engine with Buffering (provides buffer state management)

## Unblocked Tests (Resolved)

The following hook-dependent streaming interruption UI tests are active:
- `StreamingInterruptionUITests.testAutoPauseOnNetworkLoss`
- `StreamingInterruptionUITests.testAutoResumeOnNetworkRecovery`
- `StreamingInterruptionUITests.testBufferIndicatorAppears`
- `StreamingInterruptionUITests.testBufferIndicatorDisappears`
- `StreamingInterruptionUITests.testPlaybackAdaptsToPoorNetwork`

## Testing Strategy

### Unit Tests
- `EnhancedEpisodePlayerNetworkSimulationTests` validates simulated network loss/recovery and buffer-state publishers.

### UI Tests
- `StreamingInterruptionUITests` validates auto-pause/resume and buffer indicator transitions via `TestHook.*` controls.
- Error display/retry assertions remain tracked by Issue `03.3.4` and are intentionally skipped there.

## Estimated Effort

Medium (3-5 hours)

## Files Modified

| File | Changes |
|------|---------|
| `Packages/LibraryFeature/Sources/LibraryFeature/NetworkSimulationOverlayManager.swift` | Env-gated observer lifecycle and notification bridge to playback simulation controller |
| `zpod/ZpodApp.swift` | Instantiate simulation manager when simulation env flags are enabled |
| `Packages/PlayerFeature/Sources/PlayerFeature/EpisodeDetailView.swift` | Render `TestHook.*` controls and buffer indicator accessibility surface |
| `Packages/PlayerFeature/Sources/PlayerFeature/EpisodeDetailViewModel.swift` | Observe simulation publishers and expose deterministic UI state |
| `Packages/PlaybackEngine/NetworkSimulationControlling.swift` | Define simulation control protocol for playback engine integration |
| `Packages/PlaybackEngine/EnhancedEpisodePlayer.swift` | Implement simulation pause/resume/buffer behavior and publisher updates |
| `Packages/PlaybackEngine/Tests/EnhancedEpisodePlayerNetworkSimulationTests.swift` | Validate network/buffer simulation behavior and timing/cancellation |
| `zpodUITests/StreamingInterruptionUITests.swift` | Activate hook-dependent interruption tests with concrete assertions |
