# Issue 28.1.5 - Unified Playback Coordinator

**Status:** Complete  
**Priority:** High  
**Category:** Playback / Infrastructure  
**Created:** 2026-01-14  
**Completed:** 2026-02-10  
**Parent Issue:** 28.1  
**GitHub Issue:** [#341](https://github.com/ezigus/zpod/issues/341)

## Description
Create a single coordinator that selects between local-file playback and streaming URLs for each episode, exposes the chosen playback source to the UI, and handles fallbacks when files are missing or network conditions change.

## Acceptance Criteria
- [ ] When episode is downloaded and file exists, playback uses the local file URL and no network request is made.
- [ ] When episode is not downloaded (or file missing), playback uses the streaming URL and reports streaming source.
- [ ] Missing or corrupt local files fall back to streaming (when available) and log a warning.
- [ ] Playback source changes are observable for UI indicators (AsyncStream or Combine).
- [ ] Resume-after-relaunch applies the same source selection logic without race conditions.
- [ ] Failures map to PlaybackError with user-facing messaging.

## Implementation Approach
1. Design: add dev-log entry with flow diagram and source-selection rules.
2. Introduce PlaybackSource enum and PlaybackSourceResolver that uses DownloadManager + FileManagerService.
3. Build UnifiedPlaybackCoordinator that wraps EpisodePlaybackService and selects the URL before play.
4. Wire the coordinator into LibraryFeature/CarPlay dependency setup and PlaybackEnvironment.
5. Avoid direct FileManager access from UI actors; expose lightweight state to views.

## Specification References
- `zpod/spec/offline-playback.md` (Playing Downloaded Episode, Fallback to Streaming)
- `zpod/spec/streaming-playback.md` (Starting Stream Playback, Seeking While Streaming)
- `zpod/spec/playback.md` (Starting Episode Playback, Seeking to Position)

## Dependencies
- Issue 28.1.1 - Download Manager Implementation
- Issue 28.1.2 - Local Storage and File Management
- Issue 28.1.3 - Streaming Engine with Buffering
- Issue 28.1.4 - Network Monitoring and Adaptation
- Issue 03.3.x - Playback engine (EnhancedEpisodePlayer + AVPlayerPlaybackEngine)

## Estimated Effort
Medium (2-3 days)

## Success Metrics
- Correct local vs streaming selection in 100% of unit tests.
- Local playback start time <= 500ms when file exists.
- Zero crashes when local file is missing; fallback occurs.

## Testing Strategy
- Unit tests: resolver selection logic, missing file fallback, offline scenario.
- Integration tests: downloaded episode uses file:// URL, non-downloaded uses https:// URL.
- UI tests: indicators update when switching sources, offline playback works without network.
