# Issue 01.1.1.1: Build Script Core Refactor (Modular Utilities)

## Priority
High

## Status
ðŸ”„ Planned

## Description
Extract shared shell helpers, redesign `run-xcode-tests.sh` around those helpers, and provide a clean parameter-driven interface that works locally (macOS + Linux sandbox) without hard-coded paths.

## Acceptance Criteria

### Scenario 1: Shared Utilities Library
- **Given** the scripts in `scripts/`
- **When** any tooling performs logging, argument parsing, or environment detection
- **Then** they source common helpers located under `scripts/lib/`
- **And** duplicate logic across scripts is removed in favour of the shared helpers

### Scenario 2: Modernised `run-xcode-tests.sh`
- **Given** a developer runs `scripts/run-xcode-tests.sh`
- **When** they pass `-b`, `-t`, `-c`, or `--scheme/--workspace/--sim`
- **Then** argument parsing is handled by the shared helpers and validated with actionable errors
- **And** the script delegates to distinct functions for build and test phases, reusing code paths instead of inline duplication

### Scenario 3: Environment Detection & Fallbacks
- **Given** the script runs on macOS with Xcode tools available OR on a non-macOS sandbox
- **When** required tools are missing
- **Then** the script automatically falls back to Swift Package Manager execution (or exits with a clear message if no supported path exists)
- **And** all paths are computed relative to the repository root (no absolute directories)

### Scenario 4: Self-Test Coverage
- **Given** the new helper library
- **When** `scripts/run-xcode-tests.sh --self-check` (or equivalent) executes
- **Then** it performs lightweight sanity checks (e.g., environment detection, argument parsing simulation) and exits 0/1 accordingly
- **And** the CI job for this issue invokes the self-check to guard regressions

## Implementation Approach
1. **Create `scripts/lib/`** with modules for logging, environment detection, xcodebuild wrappers, and parameter parsing.
2. **Refactor `run-xcode-tests.sh`** to source the helpers, replace inline logic with functions, and expose `--self-check` for quick verification.
3. **Touch `dev-build-enhanced.sh`** only enough to reuse the new logging helpers (full migration handled in later work if needed).
4. **Add basic shell self-tests** (either inline or via a minimal `scripts/tests/` runner) covering helper behaviour.

## Specification References
- Issue 01.1.1 (parent)
- `issues-review.md` for documentation format

## Dependencies
- **Required**: Parent Issue 01.1.1 (context)

## Success Metrics
- Library helpers used by all scripts in `scripts/`
- `run-xcode-tests.sh --help` reports the new flag set and exits cleanly
- Self-check command runs in <1s locally

## Testing Strategy
- Execute `run-xcode-tests.sh --self-check` in CI and locally
- Run representative `-b/-t` combinations on macOS (full xcodebuild) and sandbox (SPM fallback)
- Lint shell scripts with `shellcheck` (if available) or equivalent static checks
