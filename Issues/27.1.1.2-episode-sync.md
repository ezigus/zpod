# Issue 27.1.1.2: Episode Sync (Upsert Rules)

## Priority
Medium

## Status
⏳ Pending (Blocked by 27.1.1.1)

## Description
Implement episode synchronization logic when podcasts are updated (e.g., RSS feed refresh). Define upsert semantics that protect user state (playback position, favorites, downloads) while keeping episodes current with feed content.

## Acceptance Criteria
- [ ] `update()` syncs episodes using upsert logic
- [ ] New episodes from feed are inserted
- [ ] Existing episodes updated (metadata only, preserve user playback state)
- [ ] Episodes with `playbackPosition > 0` never deleted even if removed from feed
- [ ] Downloaded episodes (`downloadStatus == .downloaded`) preserved
- [ ] Favorited/bookmarked episodes preserved
- [ ] Tests for sync edge cases (new episode, updated metadata, removed from feed but has state)

## Implementation Approach

### Sync Logic for `update(_:)`

```swift
private func syncEpisodes(_ episodes: [Episode], forPodcastId podcastId: String) {
    let existing = fetchEpisodeEntities(forPodcastId: podcastId)
    let existingById = Dictionary(uniqueKeysWithValues: existing.map { ($0.id, $0) })
    let incomingIds = Set(episodes.map(\.id))

    // Insert new or update existing
    for episode in episodes {
        if let existingEntity = existingById[episode.id] {
            // Update metadata only - preserve user state
            existingEntity.updateMetadataFrom(episode)
        } else {
            // Insert new episode
            let entity = EpisodeEntity.fromDomain(episode, podcastId: podcastId)
            modelContext.insert(entity)
        }
    }

    // Handle episodes removed from feed
    for entity in existing where !incomingIds.contains(entity.id) {
        let hasUserState = entity.playbackPosition > 0
            || entity.isPlayed
            || entity.isFavorited
            || entity.isBookmarked
            || entity.downloadStatus == "downloaded"

        if !hasUserState {
            modelContext.delete(entity)  // Safe to remove stale episode
        }
        // Otherwise: keep orphaned episode with user state
    }
}
```

### Update Rules

| Scenario | Action |
|----------|--------|
| New episode in feed | Insert as new `EpisodeEntity` |
| Existing episode in feed | Update metadata (title, description, duration) |
| Existing episode with user state | **Preserve** playback position, favorites, downloads |
| Episode removed from feed + no user state | Delete from database |
| Episode removed from feed + has user state | **Keep** as orphaned episode (user data valuable) |

### Metadata-Only Update

```swift
extension EpisodeEntity {
    /// Update only metadata fields, preserving user state
    func updateMetadataFrom(_ episode: Episode) {
        self.title = episode.title
        self.episodeDescription = episode.description
        self.duration = episode.duration
        self.audioURLString = episode.audioURL?.absoluteString
        self.artworkURLString = episode.artworkURL?.absoluteString
        self.pubDate = episode.pubDate
        // Do NOT update: playbackPosition, isPlayed, isFavorited, etc.
    }
}
```

## Known Limitations
- Orphaned episodes (removed from feed but have user state) will not appear in normal episode lists
- Future enhancement: UI to manage orphaned episodes (e.g., "Archived Episodes" section)

## Specification References
- `dev-log/27.1-podcast-persistence-foundation.md` - Sync strategy
- `dev-log/27.1.1.2-episode-sync.md` - Implementation timeline

## Dependencies
- **Blocked by**: Issue 27.1.1.1 (Episode Persistence must exist first)
- **Blocks**: None

## Estimated Effort
2-3 hours

## Success Metrics
- RSS refresh adds new episodes
- Existing episode metadata updated
- User playback state never lost
- Downloaded episodes never deleted
- Favorited episodes never deleted

## Testing Strategy

### Unit Tests
```bash
./scripts/run-xcode-tests.sh -t PersistenceTests/SwiftDataPodcastRepositoryTests
```

**Test Cases:**
- [ ] `testSyncInsertsNewEpisodes` - Feed adds new episode
- [ ] `testSyncUpdatesExistingMetadata` - Episode title/description changes
- [ ] `testSyncPreservesPlaybackPosition` - Playback state unchanged
- [ ] `testSyncKeepsDownloadedEpisodes` - Downloaded episodes not deleted
- [ ] `testSyncKeepsFavoritedEpisodes` - Favorited episodes not deleted
- [ ] `testSyncDeletesStaleEpisodes` - Episodes without user state removed
- [ ] `testSyncKeepsOrphanedWithState` - Removed from feed but has playback → kept

### Manual Verification
- [ ] Refresh feed → new episodes added
- [ ] Refresh feed → existing episode metadata updated
- [ ] Refresh feed → playback position preserved on existing episodes
- [ ] Episode removed from feed but has playback position → still present
- [ ] Episode removed from feed with no user state → deleted

### Full Regression
```bash
./scripts/run-xcode-tests.sh
```

## Related Issues
- Issue 27.1.1.1 - Episode Persistence (prerequisite)
- Issue 27.1 - Podcast Persistence Foundation (parent)
