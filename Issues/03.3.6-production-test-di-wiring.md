# Issue 03.3.6: Production vs Test DI Wiring

**Status**: ðŸ†• Proposed

**Priority**: Medium

**Parent**: 03.3 - Audio Playback Implementation

**GitHub Issue**: [#271](https://github.com/ezigus/zpod/issues/271)

## Description

Audit and configure dependency injection to ensure production builds use the real `AVPlayerPlaybackEngine` while test builds can inject mock services. Prevent accidental use of mock/stub playback services in release builds.

## Problem Statement

**Current State**:
- Unclear which playback service is injected in production
- Tests may or may not be using proper mocks
- DI configuration scattered across multiple files
- Risk of mock service shipping in release build

**Target State**:
- Clear separation: production uses `AVPlayerPlaybackEngine`
- Tests use injectable mock service
- DI configuration documented and centralized
- Compile-time or runtime verification of correct wiring

## Acceptance Criteria

- [ ] Production app uses `AVPlayerPlaybackEngine`
- [ ] UI tests can inject mock playback service
- [ ] Unit tests can inject mock playback service
- [ ] No mock/stub services in release builds
- [ ] DI configuration is documented
- [ ] SwiftUI previews work with stub service
- [ ] Clear error if wrong service detected in release

## Spec References

This is an internal architecture concern and does not require user-facing specification scenarios. The implementation should follow Swift best practices for dependency injection and testability.

## Current DI Analysis

### Files to Audit

| File | Purpose | Current State |
|------|---------|---------------|
| `zpod/zpodApp.swift` | App entry point | Check service initialization |
| `Packages/*/DependencyProvider.swift` | Package-level DI | Check for shared instances |
| `zpodUITests/TestSupport/` | UI test setup | Check mock injection |
| `Packages/*/Tests/*/` | Unit tests | Check mock usage |

### DI Patterns in Use

Need to audit:
1. `@EnvironmentObject` injection
2. Protocol-based dependency injection
3. Singleton/shared instances
4. Factory patterns

## Implementation Steps

### 1. Audit Current State

```bash
# Find all EpisodePlaybackService references
grep -r "EpisodePlaybackService" Packages/ zpod/
grep -r "EnhancedEpisodePlayer" Packages/ zpod/
grep -r "playbackService" Packages/ zpod/
```

### 2. Define Production Service Factory

```swift
// Packages/PlaybackEngine/Sources/PlaybackEngine/PlaybackServiceFactory.swift
public enum PlaybackServiceFactory {
    public static func makeProductionService() -> any EpisodePlaybackService {
        return AVPlayerPlaybackEngine()
    }

    #if DEBUG
    public static func makeMockService() -> any EpisodePlaybackService {
        return MockPlaybackService()
    }
    #endif
}
```

### 3. Configure App Entry Point

```swift
// zpod/zpodApp.swift
@main
struct ZpodApp: App {
    private let playbackService: any EpisodePlaybackService

    init() {
        #if DEBUG
        if ProcessInfo.processInfo.arguments.contains("--use-mock-playback") {
            self.playbackService = PlaybackServiceFactory.makeMockService()
        } else {
            self.playbackService = PlaybackServiceFactory.makeProductionService()
        }
        #else
        self.playbackService = PlaybackServiceFactory.makeProductionService()
        #endif
    }

    var body: some Scene {
        WindowGroup {
            ContentView(podcastManager: Self.sharedPodcastManager)
                .environmentObject(playbackService)
        }
    }
}
```

### 4. Configure UI Tests

```swift
// zpodUITests/TestSetup.swift
class BaseUITest: XCTestCase {
    var app: XCUIApplication!

    override func setUpWithError() throws {
        app = XCUIApplication()
        app.launchArguments.append("--use-mock-playback")
        app.launch()
    }
}
```

### 5. Add Runtime Verification (Optional)

```swift
// In production init
#if !DEBUG
assert(playbackService is AVPlayerPlaybackEngine,
       "Production must use AVPlayerPlaybackEngine")
#endif
```

## Testing Strategy

### Unit Tests
- Factory returns correct type based on configuration
- Mock service conforms to protocol
- Production service conforms to protocol

### Integration Tests
- Verify production service plays audio
- Verify mock service doesn't play audio
- Verify DI wiring in app initialization

### Build Verification
- Release build â†’ uses production service
- Debug build without flag â†’ uses production service
- Debug build with `--use-mock-playback` â†’ uses mock service

## Files to Modify

| File | Changes |
|------|---------|
| `Packages/PlaybackEngine/Sources/PlaybackEngine/PlaybackServiceFactory.swift` | CREATE |
| `zpod/zpodApp.swift` | Use factory for service creation |
| `zpodUITests/XCTestCase+Extensions.swift` | Add mock injection support |
| `Packages/PlaybackEngine/Sources/PlaybackEngine/MockPlaybackService.swift` | CREATE (for tests) |

## Dependencies

- **03.3.2**: `AVPlayerPlaybackEngine` must exist first
- Should be done after main playback functionality works

## Estimated Effort

**Low-Medium** - 2-3 hours
- Audit existing code
- Create factory
- Update app initialization
- Update test setup

## Architecture Considerations

### Option A: Environment Object
```swift
.environmentObject(playbackService as any EpisodePlaybackService)
```
- Simple
- Works with SwiftUI
- Type erasure may complicate

### Option B: Custom Environment Key
```swift
private struct PlaybackServiceKey: EnvironmentKey {
    static let defaultValue: any EpisodePlaybackService = StubPlaybackService()
}
extension EnvironmentValues {
    var playbackService: any EpisodePlaybackService {
        get { self[PlaybackServiceKey.self] }
        set { self[PlaybackServiceKey.self] = newValue }
    }
}
```
- More explicit
- Better for testing
- Requires more boilerplate

### Option C: Dependency Container
```swift
final class DependencyContainer {
    static let shared = DependencyContainer()
    lazy var playbackService: any EpisodePlaybackService = AVPlayerPlaybackEngine()
}
```
- Familiar pattern
- Easy to mock
- Global state concerns

**Recommendation**: Option B (Custom Environment Key) for clean SwiftUI integration

## Notes

- Consider using Swift Testing framework features for DI
- Document DI configuration in README or ARCHITECTURE.md
- Consider adding build-time checks (compiler flags)
- SwiftUI Previews need special handling (use stub)
