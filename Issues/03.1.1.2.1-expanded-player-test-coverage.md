# Issue 03.1.1.2.1: Expanded Player Test Coverage Enhancement (Optional)

**GitHub Issue**: [#258](https://github.com/ezigus/zpod/issues/258)

## Priority
Low (Enhancement)

## Status
ðŸ†• Proposed

## Description
Optional test coverage enhancements for the Expanded Player (Issue 03.1.1.2). All core functionality is complete and production-ready; these enhancements add missing test coverage for edge cases identified during verification.

## Parent Issue
[#109](https://github.com/ezigus/zpod/issues/109) - Expanded Player Layout & Interaction (COMPLETE)

## Proposed Enhancements

### 1. Scrubbing Haptic Feedback Test
**Current State**: Scrubbing logic tested, but haptic feedback not explicitly validated
**Enhancement**: Add `testScrubbingTriggersHapticFeedback` to ExpandedPlayerViewModelTests

**Rationale**: Validate that haptic feedback fires on scrub begin/end as specified in AC #3

**Estimated Effort**: 30 minutes

**Implementation**:
```swift
@Test("Scrubbing triggers haptic feedback")
@MainActor
func testScrubbingTriggersHapticFeedback() async throws {
  let hapticService = RecordingHapticService()
  let viewModel = ExpandedPlayerViewModel(
    playbackService: playbackService,
    hapticFeedback: hapticService
  )

  // Trigger scrubbing
  viewModel.beginScrubbing()
  XCTAssertEqual(hapticService.impactCalls.count, 1)
  XCTAssertEqual(hapticService.impactCalls[0], .light)

  viewModel.endScrubbing()
  XCTAssertEqual(hapticService.impactCalls.count, 2)
  XCTAssertEqual(hapticService.impactCalls[1], .medium)
}
```

**Dependencies**: Requires `RecordingHapticService` test double

---

### 2. Collapse/Dismiss Transition Test
**Current State**: Expansion tested, but dismiss gesture not validated
**Enhancement**: Add `testExpandedPlayerDismissesOnSwipeDown` to PlayerPlaybackInteractionTests

**Rationale**: Validate that swipe-down gesture properly returns to mini-player (AC #2)

**Estimated Effort**: 30 minutes

**Implementation**:
```swift
func testExpandedPlayerDismissesOnSwipeDown() throws {
  launchApp()
  navigateToLibraryTab()
  navigateToPodcast()
  quickPlayEpisode()

  let miniPlayer = miniPlayerElement()
  XCTAssertTrue(miniPlayer.waitForExistence(timeout: adaptiveTimeout))
  miniPlayer.tap()

  let expandedPlayer = app.otherElements
    .matching(identifier: "Expanded Player")
    .firstMatch
  XCTAssertTrue(expandedPlayer.waitForExistence(timeout: 5))

  // Swipe down to dismiss
  expandedPlayer.swipeDown()

  // Verify mini-player visible again (expanded player dismissed)
  XCTAssertTrue(
    miniPlayer.waitForExistence(timeout: 2),
    "Mini-player should be visible after dismissing expanded player"
  )

  // Verify expanded player is gone
  XCTAssertFalse(
    expandedPlayer.exists,
    "Expanded player should be dismissed"
  )
}
```

---

### 3. Progress Slider Drag Interaction Test
**Current State**: Scrubbing logic tested at unit level, no UI-level drag test
**Enhancement**: Add `testProgressSliderDragScrubbing` to PlaybackUITests

**Rationale**: Validate actual slider drag gesture works in UI (AC #3)

**Estimated Effort**: 45 minutes

**Implementation**:
```swift
func testProgressSliderDragScrubbing() throws {
  launchApp()
  navigateToLibraryTab()
  navigateToPodcast()
  quickPlayEpisode()

  let miniPlayer = miniPlayerElement()
  miniPlayer.tap()

  let slider = app.sliders
    .matching(identifier: "Progress Slider")
    .firstMatch
  XCTAssertTrue(slider.waitForExistence(timeout: 5))

  // Get initial value
  let initialValue = slider.value as? String

  // Drag slider to 50%
  slider.adjust(toNormalizedSliderPosition: 0.5)

  // Wait for position update
  let expectation = XCTestExpectation(description: "Slider value updates")
  DispatchQueue.main.asyncAfter(deadline: .now() + 1) {
    expectation.fulfill()
  }
  wait(for: [expectation], timeout: 2)

  // Verify value changed
  let newValue = slider.value as? String
  XCTAssertNotEqual(
    initialValue,
    newValue,
    "Slider value should update after drag"
  )
}
```

---

## Acceptance Criteria
- Enhancement #1: Haptic feedback test passes in CI
- Enhancement #2: Dismiss transition test passes in CI
- Enhancement #3: Slider drag test passes in CI
- All existing tests continue to pass

## Dependencies
None (parent issue 03.1.1.2 is complete)

## Testing Strategy
- Run existing test suite to ensure no regressions
- Verify new tests pass locally and in CI
- Update TestSummary.md with new coverage

## Deliverables
- New test added to `ExpandedPlayerViewModelTests.swift`
- New test added to `PlayerPlaybackInteractionTests.swift`
- New test added to `PlaybackUITests.swift`
- TestSummary.md updated
- Dev-log entry documenting enhancements
