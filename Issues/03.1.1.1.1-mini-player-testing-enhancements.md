# Issue 03.1.1.1.1: Mini-Player Testing Enhancements (Optional)

**GitHub Issue**: [#257](https://github.com/ezigus/zpod/issues/257)

## Priority
Low (Enhancement)

## Status
ðŸ†• Proposed

## Description
Optional testing enhancements for the mini-player feature (Issue 03.1.1.1). All core acceptance criteria are already met; these enhancements add additional test coverage and visual regression protection.

## Parent Issue
[#108](https://github.com/ezigus/zpod/issues/108) - Mini-Player Foundation (COMPLETE)

## Proposed Enhancements

### 1. Explicit Tap-to-Expand UI Test
**Current State**: Expansion behavior validated implicitly via persistence tests
**Enhancement**: Add explicit `testTapMiniPlayerOpensFullPlayer()` test

**Rationale**: More explicit validation of tap gesture and sheet presentation

**Estimated Effort**: 30 minutes

**Implementation**:
```swift
func testTapMiniPlayerOpensFullPlayer() throws {
  launchApp()
  navigateToLibraryTab()
  navigateToPodcast()
  quickPlayEpisode()

  let miniPlayer = miniPlayerElement()
  XCTAssertTrue(miniPlayer.waitForExistence(timeout: adaptiveTimeout))
  miniPlayer.tap()

  let expandedPlayer = app.otherElements
    .matching(identifier: "Expanded Player")
    .firstMatch
  XCTAssertTrue(
    expandedPlayer.waitForExistence(timeout: adaptiveTimeout),
    "Expanded player should appear after tapping mini-player"
  )
}
```

---

### 2. Snapshot Tests for Layout Regression
**Current State**: No snapshot tests (marked "optional" in original issue)
**Enhancement**: Validate compact layout with varying title lengths

**Rationale**: Catch layout regressions visually, especially title truncation

**Estimated Effort**: 1-2 hours (including SnapshotTesting library setup)

**Implementation**:
```swift
import SnapshotTesting

func testMiniPlayerLayoutWithShortTitle() {
  let viewModel = createMiniPlayerViewModel(
    episode: Episode(title: "Short", podcastTitle: "Pod")
  )
  let view = MiniPlayerView(viewModel: viewModel, onTapExpand: {})
  assertSnapshot(matching: view, as: .image)
}

func testMiniPlayerLayoutWithLongTitle() {
  let viewModel = createMiniPlayerViewModel(
    episode: Episode(
      title: "Very Long Episode Title That Should Truncate Properly With Ellipsis",
      podcastTitle: "Very Long Podcast Name That Also Should Truncate"
    )
  )
  let view = MiniPlayerView(viewModel: viewModel, onTapExpand: {})
  assertSnapshot(matching: view, as: .image)
}

func testMiniPlayerLayoutVariations() {
  // Test with/without podcast artwork
  // Test with/without podcast title
  // Test in different states (playing/paused)
}
```

**Dependencies**:
- Add `SnapshotTesting` library to project
- Configure snapshot reference directory

---

### 3. Queue-Aware Visibility UI Test
**Current State**: Unit test uses mock `queueIsEmpty: { true }`
**Enhancement**: Test actual queue state from playback engine

**Rationale**: Validate real-world queue-based hide behavior

**Blocker**: Depends on Issue 03.1.1.3 (Playback State Synchronization) implementation

**Estimated Effort**: 30 minutes (after blocker resolved)

**Implementation**:
```swift
func testMiniPlayerHidesWhenQueueBecomesEmpty() throws {
  launchApp()
  quickPlayEpisode() // Queue has 1 episode

  let miniPlayer = miniPlayerElement()
  XCTAssertTrue(miniPlayer.waitForExistence(timeout: adaptiveTimeout))

  // Wait for episode to finish
  waitForPlaybackToFinish(timeout: 600)

  // Verify mini-player hides when queue is empty
  XCTAssertFalse(
    miniPlayer.waitForExistence(timeout: 2),
    "Mini-player should hide when queue becomes empty after episode finishes"
  )
}
```

---

## Acceptance Criteria
- Enhancement #1: Explicit tap-to-expand test passes in CI
- Enhancement #2: Snapshot tests capture all layout variations
- Enhancement #3: Queue-aware visibility test passes after Issue 03.1.1.3 lands

## Dependencies
- Enhancement #3 blocked by Issue 03.1.1.3 (Playback State Synchronization)

## Testing Strategy
- Run existing test suite to ensure no regressions
- Verify new tests pass locally and in CI
- Update TestSummary.md with new coverage

## Deliverables
- New UI tests added to `zpodUITests/MiniPlayerPersistenceTests.swift`
- Snapshot tests in new file (if Enhancement #2 implemented)
- TestSummary.md updated
- Dev-log entry documenting enhancements
