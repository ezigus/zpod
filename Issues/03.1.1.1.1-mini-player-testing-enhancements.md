# Issue 03.1.1.1.1: Mini-Player Testing Enhancements (Optional)

**GitHub Issue**: [#257](https://github.com/ezigus/zpod/issues/257)

## Priority
Low (Enhancement)

## Status
ðŸ†• Proposed

## Description
Optional testing enhancements for the mini-player feature (Issue 03.1.1.1). All core acceptance criteria are already met; these enhancements add additional test coverage and visual regression protection.

## Parent Issue
[#108](https://github.com/ezigus/zpod/issues/108) - Mini-Player Foundation (COMPLETE)

**Scope Update (2026-01)**: Mini-player presentation is moving to a pill-based, hidden-by-default model. Tests should validate the pill handle and expand/collapse flows (see `03.1.1.6-mini-player-pill-reveal`).

## Proposed Enhancements

### 1. Explicit Tap-to-Expand UI Test
**Current State**: Expansion behavior validated implicitly via persistence tests
**Enhancement**: Add explicit `testTapPillOpensMiniPlayer()` and `testMiniPlayerExpandOpensFullPlayer()` tests

**Rationale**: Validate the pill-based reveal and the handoff to the full player

**Estimated Effort**: 30 minutes

**Implementation**:
```swift
func testTapPillOpensMiniPlayer() throws {
  launchApp()
  let pillHandle = miniPlayerPillElement()
  XCTAssertTrue(pillHandle.waitForExistence(timeout: adaptiveTimeout))
  pillHandle.tap()

  let miniPlayer = miniPlayerElement()
  XCTAssertTrue(
    miniPlayer.waitForExistence(timeout: adaptiveTimeout),
    "Mini-player should appear after tapping pill handle"
  )
}

func testMiniPlayerExpandOpensFullPlayer() throws {
  launchApp()
  navigateToLibraryTab()
  navigateToPodcast()
  quickPlayEpisode()

  let pillHandle = miniPlayerPillElement()
  XCTAssertTrue(pillHandle.waitForExistence(timeout: adaptiveTimeout))
  pillHandle.tap()

  let miniPlayer = miniPlayerElement()
  XCTAssertTrue(miniPlayer.waitForExistence(timeout: adaptiveTimeout))
  miniPlayer.tap()

  let expandedPlayer = app.otherElements
    .matching(identifier: "Expanded Player")
    .firstMatch
  XCTAssertTrue(expandedPlayer.waitForExistence(timeout: adaptiveTimeout))
}
```

---

### 2. Snapshot Tests for Layout Regression
**Current State**: No snapshot tests (marked "optional" in original issue)
**Enhancement**: Validate compact layout with varying title lengths

**Rationale**: Catch layout regressions visually, especially title truncation

**Estimated Effort**: 1-2 hours (including SnapshotTesting library setup)

**Implementation**:
```swift
import SnapshotTesting

func testMiniPlayerLayoutWithShortTitle() {
  let viewModel = createMiniPlayerViewModel(
    episode: Episode(title: "Short", podcastTitle: "Pod")
  )
  let view = MiniPlayerView(viewModel: viewModel, onTapExpand: {})
  assertSnapshot(matching: view, as: .image)
}

func testMiniPlayerLayoutWithLongTitle() {
  let viewModel = createMiniPlayerViewModel(
    episode: Episode(
      title: "Very Long Episode Title That Should Truncate Properly With Ellipsis",
      podcastTitle: "Very Long Podcast Name That Also Should Truncate"
    )
  )
  let view = MiniPlayerView(viewModel: viewModel, onTapExpand: {})
  assertSnapshot(matching: view, as: .image)
}

func testMiniPlayerLayoutVariations() {
  // Test with/without podcast artwork
  // Test with/without podcast title
  // Test in different states (playing/paused)
}
```

**Dependencies**:
- Add `SnapshotTesting` library to project
- Configure snapshot reference directory

---

### 3. Pill Persistence UI Test
**Current State**: Mini-player visibility is tied to playback state
**Enhancement**: Validate that the pill remains visible regardless of playback

**Rationale**: The pill is always available, even when no episode is active

**Estimated Effort**: 30 minutes

**Implementation**:
```swift
func testPillVisibleWithoutPlayback() throws {
  launchApp()
  let pillHandle = miniPlayerPillElement()
  XCTAssertTrue(
    pillHandle.waitForExistence(timeout: adaptiveTimeout),
    "Mini-player pill should be visible even when no playback is active"
  )
}
```

---

## Acceptance Criteria
- Enhancement #1: Pill reveal and expand-to-full-player tests pass in CI
- Enhancement #2: Snapshot tests capture all layout variations
- Enhancement #3: Pill visibility test passes with no active playback

## Dependencies
None

## Testing Strategy
- Run existing test suite to ensure no regressions
- Verify new tests pass locally and in CI
- Update TestSummary.md with new coverage

## Deliverables
- New UI tests added to `zpodUITests/MiniPlayerPersistenceTests.swift`
- Snapshot tests in new file (if Enhancement #2 implemented)
- TestSummary.md updated
- Dev-log entry documenting enhancements
