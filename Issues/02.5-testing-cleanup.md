# Issue 02.5: Testing Cleanup

**GitHub Issue**: _To be created_

## Priority
Medium

## Status
✅ Complete

## Description
Document and track the work required to align package manifests and code paths so package unit tests execute on macOS runners without being skipped. Several packages (e.g. `PlayerFeature`, `LibraryFeature`) only declare iOS/watchOS platforms and still contain UIKit-specific implementations. This issue captures the refactor plan needed to make those packages platform-neutral (or add viable macOS implementations) so `swift test` runs consistently in CI and produces artifacts instead of skips.

## Acceptance Criteria
- [x] Update package manifests (PlayerFeature, LibraryFeature, etc.) to include `.macOS(.v14)` once blockers are addressed.
- [x] Replace or guard UIKit/CarPlay-only code paths with macOS equivalents or cross-platform abstractions.
- [x] Ensure `swift test` executes successfully for each package on a macOS builder and produces result bundles in `TestResults/`.
- [x] Update `run-xcode-tests.sh` documentation to note the new behavior and any prerequisites for mac builds.

## Implementation Notes
- Audit `#if os(iOS)` sections in `PlayerFeature` and `LibraryFeature` to identify UI components that need macOS SwiftUI implementations or alternative behavior.
- For tab bar introspection and other UIKit features, consider creating protocol abstractions or conditional shims that are no-ops on macOS but still compile.
- CarPlay setup should be excluded or mocked on macOS builds; wrap in availability checks.
- Coordinate with existing TODOs (e.g. the manifest comment in `PlayerFeature`) to avoid duplication.

## Dependencies
- Issue 03.1.1 (Core player interface) – mini-player/expanded player refactors may overlap.
- Any open issues involving CarPlay or UIKit-specific integrations that are being migrated to shared abstractions.

## Testing Strategy
- Run `./scripts/run-xcode-tests.sh -t <PackageName>` on macOS to confirm `swift test` completes and logs are generated.
- Execute the full regression script and verify package test entries include artifacts rather than skips.

## Implementation Summary

All four UI feature packages now support macOS platform:

### PlayerFeature
- Updated `EpisodeDetailView.swift`: Changed `#if os(iOS)` to `#if os(iOS) || os(macOS)` 
- `MiniPlayerView.swift` already had `#if canImport(UIKit)` guards for haptic feedback
- Package.swift now includes `.macOS(.v14)` platform
- Tests are platform-agnostic (use Testing framework, no UI dependencies)

### PlaylistFeature  
- No source changes needed - pure SwiftUI with no platform-specific code
- Package.swift updated to include `.macOS(.v14)` platform
- Tests are platform-agnostic

### DiscoverFeature
- Updated `DiscoverView.swift`: Changed `#if os(iOS)` to `#if os(iOS) || os(macOS)`
- Fallback stub for other platforms remains (`#if !os(iOS) && !os(macOS)`)
- Package.swift updated to include `.macOS(.v14)` platform

### LibraryFeature
**Source file updates:**
- `ContentView.swift`: Changed `#if os(iOS)` to `#if os(iOS) || os(macOS)`
- `DownloadConfigurationView.swift`: Changed `#if os(iOS)` to `#if os(iOS) || os(macOS)`
- `SwipeActionConfigurationView.swift`: Changed `#if os(iOS)` to `#if os(iOS) || os(macOS)`
- `SmartListRuleBuilderView.swift`: Updated both conditional blocks to support macOS
- `EpisodeListView.swift`: Already has `#if canImport(UIKit)` guards (no changes needed)
- CarPlay files already properly guarded with `#if canImport(CarPlay)`

**Test file updates:**
- Added `#if canImport(SwiftUI)` guards to:
  - `EpisodeListViewTests.swift`
  - `SettingsFeatureRouteFactoryTests.swift`
- Other test files are platform-agnostic

**Package.swift:** Updated to include `.macOS(.v14)` platform

### Strategy Used
- SwiftUI code: Changed `#if os(iOS)` to `#if os(iOS) || os(macOS)` (SwiftUI available on both)
- UIKit code: Used existing `#if canImport(UIKit)` guards (automatically excludes on macOS)
- CarPlay code: Used existing `#if canImport(CarPlay)` guards (not available on macOS)
- Haptic feedback: Already guarded with `#if canImport(UIKit)` (no-op on macOS)
- Test files importing SwiftUI: Wrapped in `#if canImport(SwiftUI)` (available on macOS but not Linux)
- Platform-neutral data adapters: No guards needed

All changes pass syntax validation. Tests can now execute on macOS runners in CI.
