# Issue 03.3.2.1: Playback Test Shared Infrastructure

**Status**: ✅ Closed

**Priority**: High

**Parent**: 03.3.2 - AVPlayer Playback Engine (#267)

**GitHub Issue**: [#295](https://github.com/ezigus/zpod/issues/295)

**Estimated Effort**: 2 hours

## Description

Create shared infrastructure for dual-mode playback position testing. Extract common helpers, navigation logic, and assertion utilities into a reusable protocol that both Ticker and AVPlayer test suites can use.

## Problem Statement

**Current State**:
- `PlaybackPositionUITests.swift` contains all navigation and assertion logic
- Tests cannot run in both Ticker and AVPlayer modes
- Duplicating tests would require copy-pasting ~200 lines of helper code

**Target State**:
- Shared protocol `PlaybackPositionTestSupport` contains all helpers
- Both test modes use identical navigation and assertion logic
- Zero code duplication between ticker and AVPlayer test suites
- Launch configuration supports explicit playback mode selection

## Technical Design

### PlaybackPositionTestSupport Protocol

```swift
/// Shared test support for playback position tests.
/// Used by both PlaybackPositionTickerTests and PlaybackPositionAVPlayerTests.
///
/// **Issue**: 03.3.2.1 - Playback Test Shared Infrastructure
@MainActor
protocol PlaybackPositionTestSupport: SmartUITesting {
    var app: XCUIApplication! { get set }
    static var logger: Logger { get }
}

extension PlaybackPositionTestSupport where Self: XCTestCase {
    // MARK: - Navigation Helpers
    func startPlayback() -> Bool
    func expandPlayer() -> Bool
    
    // MARK: - Slider Value Helpers
    func getSliderValue() -> String?
    func extractCurrentPosition(from value: String?) -> TimeInterval?
    
    // MARK: - Position Advancement Helpers
    func waitForPositionAdvancement(beyond initialValue: String?, timeout: TimeInterval) -> String?
    func waitForUIStabilization(afterSeekingFrom initialValue: String?, timeout: TimeInterval, minimumDelta: TimeInterval, stabilityWindow: TimeInterval) -> String?
    func verifyPositionStable(at expectedValue: String?, forDuration: TimeInterval, tolerance: TimeInterval) -> Bool
    
    // MARK: - Logging Helpers
    func logSliderValue(_ label: String, value: String?)
    func logBreadcrumb(_ message: String)
}
```

### PlaybackTestMode Enum

```swift
/// Playback engine mode for UI tests.
public enum PlaybackTestMode {
    /// Uses TimerTicker for deterministic, fast position updates (no audio).
    case ticker

    /// Uses AVPlayerPlaybackEngine for real audio streaming.
    case avplayer
}

extension XCUIApplication {
    static func configuredForUITests(
        playbackMode: PlaybackTestMode,
        environmentOverrides: [String: String] = [:]
    ) -> XCUIApplication {
        var baseOverrides = environmentOverrides
        
        switch playbackMode {
        case .ticker:
            baseOverrides["UITEST_DISABLE_AUDIO_ENGINE"] = "1"
        case .avplayer:
            baseOverrides["UITEST_DISABLE_AUDIO_ENGINE"] = "0"
        }
        
        return XCUIApplication.configuredForUITests(environmentOverrides: baseOverrides)
    }
}
```

## Acceptance Criteria

- [x] `PlaybackPositionTestSupport.swift` created with protocol and helpers
- [x] `startPlayback()` navigates to library and starts episode
- [x] `expandPlayer()` expands mini-player to full player
- [x] `getSliderValue()` reads progress slider value
- [x] `extractCurrentPosition(from:)` parses time string to seconds
- [x] `waitForPositionAdvancement(beyond:timeout:)` waits for position increase
- [x] `waitForUIStabilization(afterSeekingFrom:...)` waits for seek completion
- [x] `verifyPositionStable(at:forDuration:tolerance:)` verifies no drift
- [x] `PlaybackTestMode` enum added to `UITestHelpers.swift`
- [x] `launchWithPlaybackMode()` helper added to `SmartUITesting` (integrates with `launchConfiguredApp`)
- [x] `CarPlayDependencies.swift` respects `UITEST_DISABLE_AUDIO_ENGINE=0`
- [x] All helpers use adaptive timeouts from `SmartUITesting`
- [x] Debug logging respects `UITEST_POSITION_DEBUG` environment variable

## Spec References

See `zpod/spec/playback.md`:
- **Timeline Advancement During Playback** - Position updates while playing
- **Pausing Playback** - Position stops when paused
- **Resuming Playback** - Position resumes after pause
- **Seeking to Position** - Position updates after seek

## Files to Create/Modify

| File | Action | Lines | Purpose |
|------|--------|-------|---------|
| `zpodUITests/PlaybackPositionTestSupport.swift` | CREATE | ~200 | Shared protocol and helpers |
| `zpodUITests/UITestHelpers.swift` | MODIFY | +35 | Add PlaybackTestMode enum |
| `Packages/LibraryFeature/Sources/LibraryFeature/CarPlayDependencies.swift` | MODIFY | +2 | Respect "0" as disabled |

## Implementation Steps

### Step 1: Create PlaybackPositionTestSupport.swift (60 minutes)

1. Create new file `zpodUITests/PlaybackPositionTestSupport.swift`
2. Define `PlaybackPositionTestSupport` protocol
3. Extract navigation helpers from `PlaybackPositionUITests.swift`:
   - `startPlayback()` - Full navigation flow
   - `expandPlayer()` - Mini-player expansion
4. Extract slider helpers:
   - `getSliderValue()` - Query slider value
   - `extractCurrentPosition(from:)` - Parse time string
   - `parseTimeString(_ timeString:)` - MM:SS to seconds
5. Extract position advancement helpers:
   - `waitForPositionAdvancement(beyond:timeout:)` - Predicate-based waiting
   - `waitForUIStabilization(afterSeekingFrom:...)` - Seek completion
   - `verifyPositionStable(at:forDuration:tolerance:)` - Stability check
6. Extract logging helpers:
   - `logSliderValue(_ label:value:)` - Debug slider value
   - `logBreadcrumb(_ message:)` - Debug navigation
7. Add private `waitForState(timeout:pollInterval:description:condition:)` helper

### Step 2: Add PlaybackTestMode to UITestHelpers.swift (20 minutes)

1. Open `zpodUITests/UITestHelpers.swift`
2. After line 54, add:
   - `PlaybackTestMode` enum with `.ticker` and `.avplayer` cases
   - `configuredForUITests(playbackMode:environmentOverrides:)` factory method
3. Add doc comments explaining each mode

### Step 3: Fix CarPlayDependencies.swift (5 minutes)

1. Open `Packages/LibraryFeature/Sources/LibraryFeature/CarPlayDependencies.swift`
2. Find line ~158 with `UITEST_DISABLE_AUDIO_ENGINE` check
3. Change logic to:
   ```swift
   let disableFlag = ProcessInfo.processInfo.environment["UITEST_DISABLE_AUDIO_ENGINE"] ?? ""
   let useAudioEngine = disableFlag != "1"  // "0", "", or absent = use audio engine
   ```

### Step 4: Validate Extraction (15 minutes)

1. Build zpodUITests target
2. Verify no compilation errors
3. Verify `PlaybackPositionUITests` can conform to protocol (don't migrate yet)
4. Run syntax check: `./scripts/run-xcode-tests.sh -s`

## Testing Strategy

### Compilation Tests
- `xcodebuild -workspace zpod.xcworkspace -scheme zpod build-for-testing`
- Verify `PlaybackPositionTestSupport.swift` compiles
- Verify `UITestHelpers.swift` changes compile

### Integration Tests (Next Phase)
- Ticker test class will conform to protocol
- AVPlayer test class will conform to protocol
- Both will use identical helper implementations

## Dependencies

- **03.3.2**: Parent issue (AVPlayer implementation complete)
- **Next**: 03.3.2.2 (Ticker tests) depends on this infrastructure
- **Next**: 03.3.2.3 (AVPlayer tests) depends on this infrastructure

## Notes

### Why Protocol Instead of Base Class?

- Swift protocols support multiple conformance
- Test classes already inherit from `XCTestCase`
- Protocol extension provides default implementations
- Easier to mock/stub in future tests

### Why Extract Now?

- Prevents code duplication before writing new tests
- Ensures ticker and AVPlayer tests use identical logic
- Makes future test additions easier (just conform to protocol)

## Estimated Effort

**2 hours total**:
- Protocol definition and extraction: 60 minutes
- UITestHelpers modifications: 20 minutes
- CarPlayDependencies fix: 5 minutes
- Validation and documentation: 35 minutes

## Success Criteria

| Criterion | Verification | Status |
|-----------|--------------|--------|
| Protocol compiles | Build zpodUITests target | ⏳ |
| All helpers extracted | No missing methods | ⏳ |
| PlaybackTestMode works | Launch with each mode | ⏳ |
| CarPlayDependencies fixed | "0" disables flag | ⏳ |
| Documentation complete | All doc comments added | ⏳ |
