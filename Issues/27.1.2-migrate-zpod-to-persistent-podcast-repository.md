# Issue 27.1.2: Migrate zpod App to Persistent PodcastRepository

**Status**: ✅ COMPLETE (Reopened work finished 2026-01-17)
**Priority**: P0 - CRITICAL (Production using test code)
**Created**: 2026-01-02
**Previously Completed**: 2026-01-15
**Reopened**: 2026-01-17
**Was Blocked By**: Issue 27.1.1 (Repository implementation - completed)
**Category**: Architecture / Technical Debt

## Description

Migrate the zpod production app from using `InMemoryPodcastManager` (test code) to the new persistent `PodcastRepository` implementation. Remove the TestSupport dependency from the zpod app target and ensure proper build configuration.

## Problem Statement

**Current State** (`zpod/ZpodApp.swift`):
```swift
#if canImport(LibraryFeature)
  import SwiftData
  import LibraryFeature
  import TestSupport  // ❌ PROBLEM: Importing test code in production
#endif

private static let sharedPodcastManager: InMemoryPodcastManager = InMemoryPodcastManager()
```

**Impact**:
- ❌ TestSupport linked into production app builds
- ❌ All podcast data lost on app restart
- ❌ Violates separation of concerns (test vs production code)
- ❌ Cannot ship to App Store with test dependencies

## Reopened Notes

Reopened to track Siri snapshot verification coverage and persistence spec updates.

## Missing Work (Reopened)

1. **Siri snapshot verification**: automated check added in `IntegrationTests/PodcastPersistenceIntegrationTests.testSiriSnapshotReflectsPersistentData`. ✅
2. **Spec alignment**: persistence-after-restart scenarios mapped to tests in `IntegrationTests/TestSummary.md`. Spec scenario expansion tracked in Issue 02.1.8.3. ✅

## Design Notes (Reopened)

### Siri Snapshot Verification

**Goal**: Verify that `SwiftDataPodcastManager` changes are reflected in the app-group Siri snapshots.

**Proposed Approach**:
1. Add a test-only injection point for the snapshot sink (e.g., configurable UserDefaults suite) or add an override to `SiriSnapshotCoordinator`.
2. Build an integration test that:
   - Creates a persistent ModelContainer.
   - Adds a subscribed podcast with episodes.
   - Invokes snapshot refresh.
   - Loads snapshots from the test suite and validates podcast + episode titles.
3. Keep a no-op fallback for production to avoid performance impact outside tests.

**Dependency Note**: If episode metadata is not persisted after restart, snapshots may only include podcast titles. See Issue 28.1.8 for metadata persistence to close that gap.

## Acceptance Criteria

- [x] Remove `import TestSupport` from `zpod/ZpodApp.swift` ✅
- [x] Replace `InMemoryPodcastManager` with `SwiftDataPodcastManager` ✅
- [x] Update zpod target dependencies in Xcode project: ✅
  - [x] Removed TestSupport from production app ✅
  - [x] Added Persistence via local `zpod/Persistence/` directory ✅
- [x] Update all references to `sharedPodcastManager`: ✅
  - [x] ContentView initialization ✅
  - [x] CarPlay dependencies (`CarPlayDependencyRegistry.configure()`) ✅
  - [x] Siri snapshots (`SiriSnapshotCoordinator`) ✅
  - [x] Playback state reset (`resetAllPlaybackPositions()`) ✅
- [x] Ensure ModelContainer configuration includes PodcastEntity schema ✅
- [x] Verify Siri snapshots still work with persistent repository ✅
  - Test: `IntegrationTests/PodcastPersistenceIntegrationTests.testSiriSnapshotReflectsPersistentData`
  - Known limitation: Episodes remain empty until Issue 28.1.8 persists episode metadata
- [x] Update UI tests to work with persistent storage (or in-memory for tests) ✅
- [x] All regression tests pass (`./scripts/run-xcode-tests.sh`) ✅
- [x] App launches successfully with persistent podcast library ✅
- [x] Manual testing: Add podcast → close app → relaunch → podcast still exists ✅
- [x] Update persistence specs (subscriptions, folders, tags) for app restart scenarios ✅
  - `IntegrationTests/TestSummary.md` updated with test mappings
  - Spec scenario expansion tracked in Issue 02.1.8.3

## Implementation Plan

### 1. Update ZpodApp.swift

**Before**:
```swift
#if canImport(LibraryFeature)
  import TestSupport
  private static let sharedPodcastManager: InMemoryPodcastManager = InMemoryPodcastManager()
#endif
```

**After**:
```swift
#if canImport(LibraryFeature)
  import Persistence

  // PodcastRepository requires async initialization
  private static var _sharedPodcastRepository: PodcastRepository?

  private static func getSharedPodcastRepository() async -> PodcastRepository {
    if let existing = _sharedPodcastRepository {
      return existing
    }
    let repo = PodcastRepository(modelContainer: sharedModelContainer)
    _sharedPodcastRepository = repo
    return repo
  }
#endif
```

### 2. Update ModelContainer Configuration

Add `PodcastEntity` to schema:

```swift
private static let sharedModelContainer: ModelContainer = {
  let isUITesting = ProcessInfo.processInfo.environment["UITEST_DISABLE_DOWNLOAD_COORDINATOR"] == "1"

  if isUITesting {
    let config = ModelConfiguration(isStoredInMemoryOnly: true)
    return try! ModelContainer(
      for: LibraryFeature.Item.self, PodcastEntity.self,
      configurations: config
    )
  } else {
    let schema = Schema([LibraryFeature.Item.self, PodcastEntity.self])
    let config = ModelConfiguration(schema: schema, isStoredInMemoryOnly: false)
    return try! ModelContainer(for: schema, configurations: [config])
  }
}()
```

### 3. Update Async Initialization

Since PodcastRepository is an actor, initialization must be async:

```swift
init() {
  disableHardwareKeyboard()

  Task {
    await configureSiriSnapshots()
    await configureCarPlayDependencies()
  }

  resetPlaybackStateForUITests()

  NotificationCenter.default.post(name: .appDidInitialize, object: nil)
}

private func configureCarPlayDependencies() async {
  #if canImport(CarPlay)
    let repo = await Self.getSharedPodcastRepository()
    CarPlayDependencyRegistry.configure(podcastManager: repo)
  #endif
}

private func configureSiriSnapshots() async {
  guard #available(iOS 14.0, *) else { return }
  let repo = await Self.getSharedPodcastRepository()
  SiriSnapshotCoordinator(podcastManager: repo).refreshAll()
}
```

### 4. Update UI Tests for In-Memory Testing

UI tests should use in-memory storage to avoid test pollution:

```swift
// In test setup
app.launchEnvironment["UITEST_DISABLE_DOWNLOAD_COORDINATOR"] = "1"  // Already sets in-memory
```

Verify ModelContainer configuration respects this flag (already does for `LibraryFeature.Item`).

### 5. Update Xcode Project Dependencies

**zpod target → Build Phases → Link Binary With Libraries**:
- ❌ Remove: `TestSupport.framework`
- ✅ Add: `Persistence.framework`

**Verify dependencies**:
```bash
xcodebuild -project zpod.xcodeproj -target zpod -showBuildSettings | grep FRAMEWORK_SEARCH_PATHS
```

Should NOT include `TestSupport`, SHOULD include `Persistence`.

### 6. Update ContentView

If ContentView accepts a PodcastManager parameter, update to use repository:

**Check current signature**:
```swift
// zpod/ContentView.swift or LibraryFeature/ContentView.swift
struct ContentView: View {
    let podcastManager: PodcastManaging  // Should work as-is (protocol)
    // ...
}
```

**Update initialization**:
```swift
var body: some Scene {
  WindowGroup {
    // PodcastRepository initialization must be async
    ContentViewWrapper()
  }
  .modelContainer(Self.sharedModelContainer)
}

struct ContentViewWrapper: View {
  @State private var podcastManager: PodcastManaging?

  var body: some View {
    if let manager = podcastManager {
      ContentView(podcastManager: manager)
    } else {
      ProgressView("Loading...")
        .task {
          podcastManager = await ZpodApp.getSharedPodcastRepository()
        }
    }
  }
}
```

## Dependencies

- **Blocks**: Issue 27.1.3 (cleanup of duplicate implementations)
- **Blocked By**: Issue 27.1 (PodcastRepository must exist first)
- **Related**: Issue 02.1.8.1 (Siri integration depends on PodcastManaging)

## Testing Strategy

### Unit Tests
- [ ] Verify zpod app builds without TestSupport dependency
- [ ] Verify app launches successfully
- [ ] Verify ModelContainer includes PodcastEntity schema

### Integration Tests
- [ ] Add podcast via UI → verify persisted to SwiftData
- [ ] Relaunch app → verify podcast still exists
- [ ] Update podcast → verify changes persisted
- [ ] Remove podcast → verify deleted from storage
- [x] Siri snapshot generation → verify written to app group (`IntegrationTests/PodcastPersistenceIntegrationTests.testSiriSnapshotReflectsPersistentData`)

### UI Tests
- [ ] All existing UI tests pass with in-memory ModelContainer
- [ ] No test pollution between test runs
- [ ] Verify `UITEST_DISABLE_DOWNLOAD_COORDINATOR=1` creates in-memory storage

### Regression
- [ ] Run full regression: `./scripts/run-xcode-tests.sh`
- [ ] Verify no TestSupport references in zpod target
- [ ] Verify Persistence package linked correctly

## Manual Testing Checklist

- [ ] Launch app in simulator
- [ ] Subscribe to a test podcast
- [ ] Close app (terminate from app switcher)
- [ ] Relaunch app
- [ ] Verify podcast subscription persists
- [ ] Test CarPlay integration still works
- [ ] Test Siri voice commands still work
- [ ] Verify folder organization persists
- [ ] Verify tag organization persists

## Known Risks

- **Async Initialization**: PodcastRepository is an actor, requires async setup
  - **Mitigation**: Use Task {} in init, or wrapper view with .task modifier
- **UI Tests Breaking**: Tests may fail if expecting in-memory behavior
  - **Mitigation**: Verify `isStoredInMemoryOnly: true` when UITEST flag set
- **Data Loss**: No migration from in-memory (acceptable, nothing persists currently)

## Definition of Done

- [x] TestSupport dependency removed from zpod target ✅
- [x] ~~Persistence dependency added to zpod target~~ ✅ (zpod/Persistence/ in app target)
- [x] All references to InMemoryPodcastManager replaced with SwiftDataPodcastManager ✅
- [x] ModelContainer includes PodcastEntity schema ✅
- [x] All regression tests pass ✅
- [x] Manual testing completed successfully ✅
- [x] Dev-log entry documenting migration process ✅
- [x] Code review approved ✅
- [x] Merged to main branch ✅

## Implementation Notes

**Actual Implementation**: Simpler than planned - no async initialization wrapper needed.

**ZpodApp.swift Changes**:
```swift
// BEFORE
#if canImport(LibraryFeature)
  import TestSupport  // ❌ REMOVED
  private static let sharedPodcastManager: InMemoryPodcastManager = InMemoryPodcastManager()
#endif

// AFTER
#if canImport(LibraryFeature)
  // No import needed - SwiftDataPodcastManager in same app target
  private static let sharedPodcastManager = SwiftDataPodcastManager(modelContainer: sharedModelContainer)
#endif
```

**ModelContainer Configuration**:
```swift
private static let sharedModelContainer: ModelContainer = {
  let isUITesting = ProcessInfo.processInfo.environment["UITEST_DISABLE_DOWNLOAD_COORDINATOR"] == "1"

  let schema = Schema([
    LibraryFeature.Item.self,
    PodcastEntity.self  // ✅ ADDED
  ])

  let configuration = ModelConfiguration(
    schema: schema,
    isStoredInMemoryOnly: isUITesting  // In-memory for tests, persistent for production
  )

  return try! ModelContainer(for: schema, configurations: [configuration])
}()
```

**Conditional Storage**:
- **UI Tests**: `isStoredInMemoryOnly: true` (no test pollution)
- **Production**: `isStoredInMemoryOnly: false` (persistent SQLite)

**Dependencies Configured**:
- CarPlay: `CarPlayDependencyRegistry.configure(podcastManager: sharedPodcastManager)`
- Siri: `SiriSnapshotCoordinator(podcastManager: sharedPodcastManager)`
- UI Tests: `sharedPodcastManager.resetAllPlaybackPositions()`

**No Async Wrapper Needed**: Unlike original plan, no ContentViewWrapper or Task{} in init required. SwiftDataPodcastManager uses serial DispatchQueue (synchronous interface), so initialization is straightforward.

## Time Estimate

- Update ZpodApp.swift: 1 hour
- Update Xcode project dependencies: 0.5 hours
- Handle async initialization: 1.5 hours
- Update UI tests: 1 hour
- Testing and verification: 2 hours
- Documentation: 0.5 hours
- **Total**: ~6.5 hours

---

**Created**: 2026-01-02
**Blocker**: This is blocked by Issue 27.1 (repository implementation)
**Technical Debt**: HIGH - Must complete before App Store submission
