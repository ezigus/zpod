# Issue 27.1.2: Migrate zpod App to Persistent PodcastRepository

**Status**: üÜï NEW (Blocked by 27.1)
**Priority**: P0 - CRITICAL (Production using test code)
**Created**: 2026-01-02
**Blocked By**: Issue 27.1 (PodcastRepository implementation)
**Category**: Architecture / Technical Debt

## Description

Migrate the zpod production app from using `InMemoryPodcastManager` (test code) to the new persistent `PodcastRepository` implementation. Remove the TestSupport dependency from the zpod app target and ensure proper build configuration.

## Problem Statement

**Current State** (`zpod/ZpodApp.swift`):
```swift
#if canImport(LibraryFeature)
  import SwiftData
  import LibraryFeature
  import TestSupport  // ‚ùå PROBLEM: Importing test code in production
#endif

private static let sharedPodcastManager: InMemoryPodcastManager = InMemoryPodcastManager()
```

**Impact**:
- ‚ùå TestSupport linked into production app builds
- ‚ùå All podcast data lost on app restart
- ‚ùå Violates separation of concerns (test vs production code)
- ‚ùå Cannot ship to App Store with test dependencies

## Acceptance Criteria

- [ ] Remove `import TestSupport` from `zpod/ZpodApp.swift`
- [ ] Replace `InMemoryPodcastManager` with `PodcastRepository`
- [ ] Update zpod target dependencies in Xcode project:
  - [ ] Remove TestSupport from linked frameworks
  - [ ] Add Persistence package dependency
- [ ] Update all references to `sharedPodcastManager`:
  - [ ] ContentView initialization
  - [ ] CarPlay dependencies (`configureCarPlayDependencies()`)
  - [ ] Siri snapshots (`configureSiriSnapshots()`)
  - [ ] Playback state reset (`resetPlaybackStateForUITests()`)
- [ ] Ensure ModelContainer configuration includes PodcastEntity schema
- [ ] Verify Siri snapshots still work with persistent repository
- [ ] Update UI tests to work with persistent storage (or in-memory for tests)
- [ ] All regression tests pass (`./scripts/run-xcode-tests.sh`)
- [ ] App launches successfully with persistent podcast library
- [ ] Manual testing: Add podcast ‚Üí close app ‚Üí relaunch ‚Üí podcast still exists

## Implementation Plan

### 1. Update ZpodApp.swift

**Before**:
```swift
#if canImport(LibraryFeature)
  import TestSupport
  private static let sharedPodcastManager: InMemoryPodcastManager = InMemoryPodcastManager()
#endif
```

**After**:
```swift
#if canImport(LibraryFeature)
  import Persistence

  // PodcastRepository requires async initialization
  private static var _sharedPodcastRepository: PodcastRepository?

  private static func getSharedPodcastRepository() async -> PodcastRepository {
    if let existing = _sharedPodcastRepository {
      return existing
    }
    let repo = PodcastRepository(modelContainer: sharedModelContainer)
    _sharedPodcastRepository = repo
    return repo
  }
#endif
```

### 2. Update ModelContainer Configuration

Add `PodcastEntity` to schema:

```swift
private static let sharedModelContainer: ModelContainer = {
  let isUITesting = ProcessInfo.processInfo.environment["UITEST_DISABLE_DOWNLOAD_COORDINATOR"] == "1"

  if isUITesting {
    let config = ModelConfiguration(isStoredInMemoryOnly: true)
    return try! ModelContainer(
      for: LibraryFeature.Item.self, PodcastEntity.self,
      configurations: config
    )
  } else {
    let schema = Schema([LibraryFeature.Item.self, PodcastEntity.self])
    let config = ModelConfiguration(schema: schema, isStoredInMemoryOnly: false)
    return try! ModelContainer(for: schema, configurations: [config])
  }
}()
```

### 3. Update Async Initialization

Since PodcastRepository is an actor, initialization must be async:

```swift
init() {
  disableHardwareKeyboard()

  Task {
    await configureSiriSnapshots()
    await configureCarPlayDependencies()
  }

  resetPlaybackStateForUITests()

  NotificationCenter.default.post(name: .appDidInitialize, object: nil)
}

private func configureCarPlayDependencies() async {
  #if canImport(CarPlay)
    let repo = await Self.getSharedPodcastRepository()
    CarPlayDependencyRegistry.configure(podcastManager: repo)
  #endif
}

private func configureSiriSnapshots() async {
  guard #available(iOS 14.0, *) else { return }
  let repo = await Self.getSharedPodcastRepository()
  SiriSnapshotCoordinator(podcastManager: repo).refreshAll()
}
```

### 4. Update UI Tests for In-Memory Testing

UI tests should use in-memory storage to avoid test pollution:

```swift
// In test setup
app.launchEnvironment["UITEST_DISABLE_DOWNLOAD_COORDINATOR"] = "1"  // Already sets in-memory
```

Verify ModelContainer configuration respects this flag (already does for `LibraryFeature.Item`).

### 5. Update Xcode Project Dependencies

**zpod target ‚Üí Build Phases ‚Üí Link Binary With Libraries**:
- ‚ùå Remove: `TestSupport.framework`
- ‚úÖ Add: `Persistence.framework`

**Verify dependencies**:
```bash
xcodebuild -project zpod.xcodeproj -target zpod -showBuildSettings | grep FRAMEWORK_SEARCH_PATHS
```

Should NOT include `TestSupport`, SHOULD include `Persistence`.

### 6. Update ContentView

If ContentView accepts a PodcastManager parameter, update to use repository:

**Check current signature**:
```swift
// zpod/ContentView.swift or LibraryFeature/ContentView.swift
struct ContentView: View {
    let podcastManager: PodcastManaging  // Should work as-is (protocol)
    // ...
}
```

**Update initialization**:
```swift
var body: some Scene {
  WindowGroup {
    // PodcastRepository initialization must be async
    ContentViewWrapper()
  }
  .modelContainer(Self.sharedModelContainer)
}

struct ContentViewWrapper: View {
  @State private var podcastManager: PodcastManaging?

  var body: some View {
    if let manager = podcastManager {
      ContentView(podcastManager: manager)
    } else {
      ProgressView("Loading...")
        .task {
          podcastManager = await ZpodApp.getSharedPodcastRepository()
        }
    }
  }
}
```

## Dependencies

- **Blocks**: Issue 27.1.3 (cleanup of duplicate implementations)
- **Blocked By**: Issue 27.1 (PodcastRepository must exist first)
- **Related**: Issue 02.1.8.1 (Siri integration depends on PodcastManaging)

## Testing Strategy

### Unit Tests
- [ ] Verify zpod app builds without TestSupport dependency
- [ ] Verify app launches successfully
- [ ] Verify ModelContainer includes PodcastEntity schema

### Integration Tests
- [ ] Add podcast via UI ‚Üí verify persisted to SwiftData
- [ ] Relaunch app ‚Üí verify podcast still exists
- [ ] Update podcast ‚Üí verify changes persisted
- [ ] Remove podcast ‚Üí verify deleted from storage
- [ ] Siri snapshot generation ‚Üí verify written to app group

### UI Tests
- [ ] All existing UI tests pass with in-memory ModelContainer
- [ ] No test pollution between test runs
- [ ] Verify `UITEST_DISABLE_DOWNLOAD_COORDINATOR=1` creates in-memory storage

### Regression
- [ ] Run full regression: `./scripts/run-xcode-tests.sh`
- [ ] Verify no TestSupport references in zpod target
- [ ] Verify Persistence package linked correctly

## Manual Testing Checklist

- [ ] Launch app in simulator
- [ ] Subscribe to a test podcast
- [ ] Close app (terminate from app switcher)
- [ ] Relaunch app
- [ ] Verify podcast subscription persists
- [ ] Test CarPlay integration still works
- [ ] Test Siri voice commands still work
- [ ] Verify folder organization persists
- [ ] Verify tag organization persists

## Known Risks

- **Async Initialization**: PodcastRepository is an actor, requires async setup
  - **Mitigation**: Use Task {} in init, or wrapper view with .task modifier
- **UI Tests Breaking**: Tests may fail if expecting in-memory behavior
  - **Mitigation**: Verify `isStoredInMemoryOnly: true` when UITEST flag set
- **Data Loss**: No migration from in-memory (acceptable, nothing persists currently)

## Definition of Done

- [ ] TestSupport dependency removed from zpod target
- [ ] Persistence dependency added to zpod target
- [ ] All references to InMemoryPodcastManager replaced with PodcastRepository
- [ ] ModelContainer includes PodcastEntity schema
- [ ] All regression tests pass
- [ ] Manual testing completed successfully
- [ ] Dev-log entry documenting migration process
- [ ] Code review approved
- [ ] Merged to main branch

## Time Estimate

- Update ZpodApp.swift: 1 hour
- Update Xcode project dependencies: 0.5 hours
- Handle async initialization: 1.5 hours
- Update UI tests: 1 hour
- Testing and verification: 2 hours
- Documentation: 0.5 hours
- **Total**: ~6.5 hours

---

**Created**: 2026-01-02
**Blocker**: This is blocked by Issue 27.1 (repository implementation)
**Technical Debt**: HIGH - Must complete before App Store submission
