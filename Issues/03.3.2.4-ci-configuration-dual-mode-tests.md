# Issue 03.3.2.4: CI Configuration for Dual-Mode Playback Tests

**Status**: üöß In Progress

**Priority**: High

**Parent**: 03.3.2 - AVPlayer Playback Engine (#267)

**GitHub Issue**: [#298](https://github.com/ezigus/zpod/issues/298)

**Estimated Effort**: 1.5 hours

## Description

Add CI workflow configuration for the two new playback test suites (Ticker and AVPlayer). Both suites run as blocking jobs in a dedicated playback matrix, parallel to the existing UI test job group.

## Problem Statement

**Current State**:
- Playback position suites moved into a dedicated `ui-tests-playback` matrix (pending CI validation)
- Playback validation now lives outside the legacy `ui-tests` matrix
- CI runs still need two consecutive green passes to mark complete

**Target State**:
- `ui-tests-playback` matrix job runs both playback suites (Ticker + AVPlayer)
- Both playback jobs are BLOCKING (must pass to merge)
- Playback matrix runs in parallel with the legacy `ui-tests` matrix
 - Legacy `ui-tests` matrix excludes playback position suites

## Technical Design

### CI Matrix Configuration

Current UI matrix (5 jobs):
```yaml
matrix:
  include:
    - name: UITests-Navigation
    - name: UITests-ContentDiscovery
    - name: UITests-Playback
    - name: UITests-CorePlayback
    - name: UITests-BatchOperations
```

New playback matrix (2 jobs, separate job group):
```yaml
matrix:
  include:
    # NEW: Dual-mode playback position tests
    - name: UITests-PlaybackTicker
      tests: zpodUITests/PlaybackPositionTickerTests
    - name: UITests-PlaybackAVPlayer
      tests: zpodUITests/PlaybackPositionAVPlayerTests
```

### Execution Timeline

```
Preflight (builds host app, ~8 min)
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> unit-tests + package-tests (parallel)
         ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ui-tests matrix (max-parallel: 5)
                 
                 Wave 1 (5 jobs run in parallel):
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ Navigation  ‚îÇ ContentDisc ‚îÇ Playback    ‚îÇ CorePlayback‚îÇ BatchOps    ‚îÇ
                 ‚îÇ (~8 min)    ‚îÇ (~6 min)    ‚îÇ (~10 min)   ‚îÇ (~8 min)    ‚îÇ (~12 min)   ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 
                 Playback matrix runs in parallel with Wave 1:
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ PlaybackTick‚îÇ PlaybackAV  ‚îÇ
                 ‚îÇ (~3 min)    ‚îÇ (~5 min)    ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Total CI time impact**: +5 minutes (playback matrix overlaps with UI wave 1)

## Acceptance Criteria

- [x] `UITests-PlaybackTicker` job added to ci.yml matrix
- [x] `UITests-PlaybackAVPlayer` job added to ci.yml matrix
- [x] Playback tests run in a dedicated `ui-tests-playback` matrix job
- [x] Legacy `ui-tests` matrix excludes playback position suites
- [x] Both jobs provision dedicated simulators (same pattern as existing jobs)
- [x] Both jobs use same timeout as other UI jobs (15 minutes)
- [x] Both jobs are blocking (no `continue-on-error: true`)
- [x] Workflow dispatch supports `ui-playback` option for targeted testing
- [ ] CI pipeline runtime recorded (current >1h acceptable; no <35 min requirement)
- [ ] Both jobs pass in at least 2 consecutive CI runs

## Spec References

These tests validate `zpod/spec/playback.md` Core Playback Behavior scenarios in CI.

## Files to Modify

| File | Lines Modified | Purpose |
|------|----------------|---------|
| `.github/workflows/ci.yml` | +200 | Add playback matrix job + dispatch gating |

## Implementation Steps

### Step 1: Add Playback Matrix Job (15 minutes)

1. Open `.github/workflows/ci.yml`
2. Add a new `ui-tests-playback` job near `ui-tests`/`ui-tests-swipe`
3. Configure its matrix with:

```yaml
        # Dual-mode playback position tests (Issue 03.3.2.4)
        - name: UITests-PlaybackTicker
          tests: zpodUITests/PlaybackPositionTickerTests
        - name: UITests-PlaybackAVPlayer
          tests: zpodUITests/PlaybackPositionAVPlayerTests
```

### Step 2: Add Workflow Dispatch Option (15 minutes)

1. Find `workflow_dispatch` inputs (lines 6-19)
2. Update the `matrix` input options to include `ui-playback`:

```yaml
matrix:
  description: 'Test matrix to run'
  required: true
  default: 'all'
  type: choice
  options:
    - all
    - preflight
    - unit-tests
    - integration-tests
    - ui
    - ui-swipe
    - ui-playback     # NEW: Run just playback position tests
    - packages
    - linux
```

3. Update the `ui-tests-playback` job condition to include `ui-playback`:

```yaml
if: |
  github.event_name != 'workflow_dispatch' 
  || github.event.inputs.matrix == 'all'
  || github.event.inputs.matrix == 'ui'
  || github.event.inputs.matrix == 'ui-playback'  # NEW
```

### Step 3: Validate CI Configuration (30 minutes)

1. Commit changes to branch
2. Push to GitHub
3. Trigger CI manually with `ui-playback` option
4. Verify both jobs appear in Actions UI
5. Verify both jobs provision simulators correctly
6. Verify both jobs execute tests
7. Check job logs for any errors

### Step 4: Monitor Initial CI Runs (30 minutes)

1. Wait for automated CI run on push
2. Verify full regression includes both new jobs
3. Check for flakiness in AVPlayer suite
4. Verify total CI time is acceptable (<35 minutes)
5. If flaky, adjust timeouts in test files (not CI config)

### Step 5: Documentation Updates (15 minutes)

1. Update `.github/workflows/README.md` (if exists)
2. Document the new workflow dispatch option
3. Note that both jobs are blocking

## Testing Strategy

### Local Validation (Before Push)

```bash
# Validate YAML syntax
yamllint .github/workflows/ci.yml

# Run both test suites locally to ensure they pass
./scripts/run-xcode-tests.sh -t zpodUITests/PlaybackPositionTickerTests
./scripts/run-xcode-tests.sh -t zpodUITests/PlaybackPositionAVPlayerTests
```

### CI Validation (After Push)

1. **Manual Dispatch Test**:
   - Go to Actions ‚Üí CI workflow ‚Üí Run workflow
   - Select `ui-playback` option
   - Verify only playback jobs run

2. **Full Regression Test**:
   - Push to branch
   - Wait for automated CI
   - Verify all 7 UI jobs run
   - Verify both new jobs pass

3. **Flakiness Check**:
   - Run CI 3 times consecutively
   - Both new jobs should pass all 3 times
   - If AVPlayer job fails >1/3, investigate

## Dependencies

- **03.3.2.1**: Shared infrastructure (must be merged)
- **03.3.2.2**: Ticker tests (must be merged)
- **03.3.2.3**: AVPlayer tests (must be merged)
- **Existing**: CI simulator provisioning infrastructure (already working)

## Notes

### Why Blocking Jobs?

AVPlayer tests are the only automated validation of production audio path. Failures indicate bugs that would affect real users, so we must block merges.

### Why Separate Jobs?

1. **Isolation**: Ticker and AVPlayer tests use different configurations
2. **Parallelism**: Both can run simultaneously (different simulators)
3. **Clarity**: Separate job logs make debugging easier
4. **Targeting**: Can run just ticker tests for fast feedback

### Simulator Provisioning

The existing CI infrastructure automatically:
- Provisions a dedicated simulator per job
- Sets `ZPOD_SIMULATOR_UDID` environment variable
- Cleans up simulator in `always()` step

Both new jobs will use this infrastructure (no changes needed).

### Expected Failure Patterns

**Ticker failures** (should be rare):
- UI logic bugs
- Navigation issues
- Test infrastructure problems

**AVPlayer failures** (may be flaky):
- Network timeouts
- Simulator audio session conflicts
- CI resource constraints
- Real integration bugs

**Mitigation for AVPlayer flakiness**:
- Generous timeouts (10s for advancement)
- Tolerant assertions (¬±0.5s for stability)
- Retry logic (if needed, add in future)

### CI Resource Impact

| Metric | Before | After | Delta |
|--------|--------|-------|-------|
| UI matrix jobs | 5 | 5 | 0 |
| Playback matrix jobs | 0 | 2 | +2 |
| Max parallel (ui-tests) | 5 | 5 | 0 |
| Max parallel (ui-tests-playback) | 0 | 2 | +2 |
| Total CI time | ~25 min | ~30 min | +5 min |

**Cost**: ~5 minutes per CI run (acceptable for production audio validation)

## Estimated Effort

**1.5 hours total**:
- Matrix entry addition: 10 minutes
- Workflow dispatch update: 15 minutes
- CI validation: 30 minutes
- Initial run monitoring: 30 minutes
- Documentation: 15 minutes

## Success Criteria

| Criterion | Verification | Status |
|-----------|--------------|--------|
| Ticker job in matrix | Check ci.yml line ~815 | ‚è≥ |
| AVPlayer job in matrix | Check ci.yml line ~817 | ‚è≥ |
| Workflow dispatch works | Manual trigger succeeds | ‚è≥ |
| Both jobs pass in CI | Check Actions logs | ‚è≥ |
| No flakiness | 3/3 passes for both jobs | ‚è≥ |
| CI time acceptable | <35 minutes total | ‚è≥ |
| Jobs are blocking | No continue-on-error | ‚è≥ |

## Rollback Plan

If AVPlayer job is too flaky (>20% failure rate):

1. Add `continue-on-error: true` to AVPlayer job temporarily
2. Open issue to investigate flakiness
3. Keep ticker job as blocking (still validates UI logic)
4. Re-enable AVPlayer blocking after fixes

**Do NOT remove the job entirely** - monitoring flakiness is valuable even if non-blocking.
