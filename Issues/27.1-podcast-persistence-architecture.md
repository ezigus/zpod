# Issue 27.1: Podcast Persistence Architecture

**Status**: ğŸ†• NEW
**Priority**: P0 - CRITICAL (Technical Debt - Production using test code)
**Created**: 2026-01-02
**Category**: Architecture / Technical Debt
**Type**: Umbrella Issue

## Description

Implement a production-grade persistent storage architecture for the podcast library. Currently, the zpod app uses ephemeral in-memory storage (`InMemoryPodcastManager`) which loses all user data on app restart. This umbrella issue tracks the implementation of proper SwiftData-based persistence for podcasts.

## Problem Statement

**Current Architecture**:
- Production app imports TestSupport package (test code in production âŒ)
- Uses `InMemoryPodcastManager` which loses data on restart âŒ
- Two duplicate implementations exist (zpod/Controllers and TestSupport) âŒ
- No persistent storage for podcast subscriptions, organization, or metadata âŒ

**Impact**:
- Users cannot maintain a podcast library (data lost on restart)
- Test dependencies shipped in production builds
- Violates architectural separation (test vs production code)
- Blocks App Store submission with current architecture

## Scope

This umbrella issue encompasses three sub-issues:

1. **Issue 27.1.1**: Implement `PodcastRepository` with SwiftData persistence
   - Create persistent repository in Persistence package
   - Support all PodcastManaging protocol operations
   - Thread-safe with proper actor isolation
   - Full test coverage

2. **Issue 27.1.2**: Migrate zpod app to use PodcastRepository
   - Remove TestSupport dependency from production app
   - Update ZpodApp.swift to use persistent repository
   - Update Xcode project build configuration
   - Ensure all regression tests pass

3. **Issue 27.1.3**: Remove duplicate InMemoryPodcastManager implementations
   - Delete zpod/Controllers/PodcastManager.swift (duplicate)
   - Consolidate test code in TestSupport package only
   - Clean up stale references

## Success Criteria

### Technical
- [ ] Production app has NO dependencies on TestSupport
- [ ] Podcast library persists across app restarts
- [ ] SwiftData models defined and tested
- [ ] All regression tests pass
- [ ] Zero duplicate code

### User Experience
- [ ] User subscribes to podcast â†’ closes app â†’ reopens â†’ subscription persists
- [ ] Folder organization survives app restart
- [ ] Tag assignments persist
- [ ] No data loss on app updates

### Code Quality
- [ ] Clean architecture (Persistence â†’ App)
- [ ] Proper actor isolation (@ModelActor)
- [ ] >90% test coverage for repository
- [ ] Documentation complete

## Dependencies

- Depends on: SwiftData framework (iOS 18+)
- Depends on: CoreModels (PodcastManaging protocol)
- Depends on: SharedUtilities (AppGroup for Siri)

## Related Issues

- Enables: CarPlay integration (Issue 02.1.8)
- Enables: Siri voice commands (Issue 02.1.8.1)
- Blocks: App Store submission (cannot ship with test dependencies)

## Architectural Design

### Package Structure

```
Packages/
â”œâ”€â”€ CoreModels/
â”‚   â””â”€â”€ PodcastManaging.swift          # Protocol definition
â”œâ”€â”€ Persistence/
â”‚   â”œâ”€â”€ PodcastRepository.swift        # NEW: Persistent implementation
â”‚   â””â”€â”€ Models/
â”‚       â””â”€â”€ PodcastEntity.swift        # NEW: SwiftData model
â”œâ”€â”€ TestSupport/
â”‚   â””â”€â”€ InMemoryPodcastManager.swift   # Kept for tests only
â””â”€â”€ LibraryFeature/
    â””â”€â”€ ContentView.swift              # Uses PodcastRepository
```

### Data Flow

```
User Action (Subscribe to Podcast)
    â†“
ContentView / DiscoverView
    â†“
PodcastRepository.add(podcast)  â† @ModelActor (thread-safe)
    â†“
SwiftData ModelContext
    â†“
Persistent SQLite Storage
    â†“
Siri Snapshot Generation â†’ App Group
```

### Key Design Decisions

1. **SwiftData over CoreData**: Modern API, better Swift 6 concurrency support
2. **@ModelActor**: Automatic thread-safety, no manual synchronization
3. **Transient Episodes**: Episodes not persisted initially (fetched from feed)
4. **Migration Strategy**: Start fresh (acceptable since no data persists currently)

## Testing Strategy

### Unit Tests
- Repository CRUD operations
- Organization filtering (folders, tags)
- Concurrent access patterns
- Error handling

### Integration Tests
- App restart persistence
- Siri snapshot generation
- CarPlay data access
- Multi-context scenarios

### UI Tests
- Subscribe â†’ restart â†’ verify subscription
- Organize â†’ restart â†’ verify organization
- Full user workflows

## Implementation Timeline

| Sub-Issue | Description | Est. Hours | Dependencies |
|-----------|-------------|------------|--------------|
| 27.1.1 | PodcastRepository implementation | 14h | None |
| 27.1.2 | Migrate zpod app | 6.5h | Requires 27.1.1 |
| 27.1.3 | Cleanup duplicates | 3h | Requires 27.1.2 |
| **Total** | | **23.5h** | Sequential |

## Known Risks

**Data Migration**: No migration needed (no persistent data currently)
**Performance**: SwiftData queries may be slower than in-memory (acceptable trade-off)
**Complexity**: Actor isolation requires careful async/await handling
**Breaking Changes**: API changes must be coordinated with consuming features

## Definition of Done

- [ ] All three sub-issues completed and merged
- [ ] Production app builds without TestSupport dependency
- [ ] Full regression test suite passes
- [ ] Manual testing: podcast persists across app restarts
- [ ] Documentation updated
- [ ] Dev-log entries complete
- [ ] Code review approved
- [ ] Merged to main branch

## Resources

- SwiftData Documentation: https://developer.apple.com/documentation/swiftdata
- AGENTS.md Section 6: Package Architecture Guidelines
- Issue 02.1.8.1: Siri integration (depends on PodcastManaging)

---

**Created**: 2026-01-02
**Blocked By**: None (can start immediately)
**Blocks**: App Store submission
**Technical Debt Level**: CRITICAL
**Type**: Architecture / Foundation
