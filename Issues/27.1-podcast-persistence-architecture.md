# Issue 27.1: Podcast Persistence Architecture

**Status**: ✅ COMPLETE
**Priority**: P0 - CRITICAL (Technical Debt - Production using test code)
**Created**: 2026-01-02
**Completed**: 2026-01-15
**Category**: Architecture / Technical Debt
**Type**: Umbrella Issue

## Description

Implement a production-grade persistent storage architecture for the podcast library. Currently, the zpod app uses ephemeral in-memory storage (`InMemoryPodcastManager`) which loses all user data on app restart. This umbrella issue tracks the implementation of proper SwiftData-based persistence for podcasts.

## Problem Statement

**Current Architecture**:
- Production app imports TestSupport package (test code in production ❌)
- Uses `InMemoryPodcastManager` which loses data on restart ❌
- Two duplicate implementations exist (zpod/Controllers and TestSupport) ❌
- No persistent storage for podcast subscriptions, organization, or metadata ❌

**Impact**:
- Users cannot maintain a podcast library (data lost on restart)
- Test dependencies shipped in production builds
- Violates architectural separation (test vs production code)
- Blocks App Store submission with current architecture

## Scope

This umbrella issue encompasses three sub-issues:

1. **Issue 27.1.1**: Implement `PodcastRepository` with SwiftData persistence
   - Create persistent repository in Persistence package
   - Support all PodcastManaging protocol operations
   - Thread-safe with proper actor isolation
   - Full test coverage

2. **Issue 27.1.2**: Migrate zpod app to use PodcastRepository
   - Remove TestSupport dependency from production app
   - Update ZpodApp.swift to use persistent repository
   - Update Xcode project build configuration
   - Ensure all regression tests pass

3. **Issue 27.1.3**: Remove duplicate InMemoryPodcastManager implementations
   - Delete zpod/Controllers/PodcastManager.swift (duplicate)
   - Consolidate test code in TestSupport package only
   - Clean up stale references

## Success Criteria

### Technical
- [x] Production app has NO dependencies on TestSupport ✅
- [x] Podcast library persists across app restarts ✅
- [x] SwiftData models defined and tested ✅
- [x] All regression tests pass ✅
- [x] Zero duplicate code ✅

### User Experience
- [x] User subscribes to podcast → closes app → reopens → subscription persists ✅
- [x] Folder organization survives app restart ✅
- [x] Tag assignments persist ✅
- [x] No data loss on app updates ✅

### Code Quality
- [x] Clean architecture (Persistence → App) ✅
- [x] Proper actor isolation (Serial DispatchQueue for thread safety) ✅
- [x] >90% test coverage for repository ✅
- [x] Documentation complete ✅

## Dependencies

- Depends on: SwiftData framework (iOS 18+)
- Depends on: CoreModels (PodcastManaging protocol)
- Depends on: SharedUtilities (AppGroup for Siri)

## Related Issues

- Enables: CarPlay integration (Issue 02.1.8)
- Enables: Siri voice commands (Issue 02.1.8.1)
- Blocks: App Store submission (cannot ship with test dependencies)

## Architectural Design

### Package Structure

```
Packages/
├── CoreModels/
│   └── PodcastManaging.swift          # Protocol definition
├── Persistence/
│   ├── PodcastRepository.swift        # NEW: Persistent implementation
│   └── Models/
│       └── PodcastEntity.swift        # NEW: SwiftData model
├── TestSupport/
│   └── InMemoryPodcastManager.swift   # Kept for tests only
└── LibraryFeature/
    └── ContentView.swift              # Uses PodcastRepository
```

### Data Flow

```
User Action (Subscribe to Podcast)
    ↓
ContentView / DiscoverView
    ↓
PodcastRepository.add(podcast)  ← @ModelActor (thread-safe)
    ↓
SwiftData ModelContext
    ↓
Persistent SQLite Storage
    ↓
Siri Snapshot Generation → App Group
```

### Key Design Decisions

1. **SwiftData over CoreData**: Modern API, better Swift 6 concurrency support
2. **@ModelActor**: Automatic thread-safety, no manual synchronization
3. **Transient Episodes**: Episodes not persisted initially (fetched from feed)
4. **Migration Strategy**: Start fresh (acceptable since no data persists currently)

## Testing Strategy

### Unit Tests
- Repository CRUD operations
- Organization filtering (folders, tags)
- Concurrent access patterns
- Error handling

### Integration Tests
- App restart persistence
- Siri snapshot generation
- CarPlay data access
- Multi-context scenarios

### UI Tests
- Subscribe → restart → verify subscription
- Organize → restart → verify organization
- Full user workflows

## Implementation Timeline

| Sub-Issue | Description | Est. Hours | Dependencies |
|-----------|-------------|------------|--------------|
| 27.1.1 | PodcastRepository implementation | 14h | None |
| 27.1.2 | Migrate zpod app | 6.5h | Requires 27.1.1 |
| 27.1.3 | Cleanup duplicates | 3h | Requires 27.1.2 |
| **Total** | | **23.5h** | Sequential |

## Known Risks

**Data Migration**: No migration needed (no persistent data currently)
**Performance**: SwiftData queries may be slower than in-memory (acceptable trade-off)
**Complexity**: Actor isolation requires careful async/await handling
**Breaking Changes**: API changes must be coordinated with consuming features

## Definition of Done

- [x] All three sub-issues completed and merged ✅
- [x] Production app builds without TestSupport dependency ✅
- [x] Full regression test suite passes ✅
- [x] Manual testing: podcast persists across app restarts ✅
- [x] Documentation updated ✅
- [x] Dev-log entries complete ✅
- [x] Code review approved ✅
- [x] Merged to main branch ✅

## Implementation Results

**Completion Date**: 2026-01-15

**Implementation Approach**: Implemented across multiple commits on `feature/27.1-podcast-persistence-foundation` (e6c6482, 280ca9f, c219436), with issue-reference cleanup in 27723d7 and retroactive test addition in `feature/27.1-add-missing-tests`.

**Key Deviations from Plan**:
1. **Location**: Implemented in `zpod/Persistence/` instead of `Packages/Persistence/`
   - **Reason**: Swift 6.x macro expansion limitations across module boundaries
   - **Impact**: @Model macros require same-module compilation
   - **Reference**: See dev-log for full rationale

2. **Thread Safety**: Used serial DispatchQueue instead of @ModelActor
   - **Reason**: PodcastManaging protocol has synchronous methods
   - **Impact**: ~0.1ms overhead per operation (negligible)
   - **Future**: Can migrate to @ModelActor + async protocol if needed

3. **Testing**: Tests added retroactively instead of TDD
   - **Reason**: Implementation already complete and working
   - **Impact**: Added 31 unit tests and 8 integration tests; existing AppSmokeTests remain green
   - **Lesson**: Follow TDD from start in future issues

**Test Coverage**:
- SwiftDataPodcastManagerTests: 31 tests in `AppSmokeTests/SwiftDataPodcastManagerTests.swift`
- Integration Tests: 8 tests in `IntegrationTests/PodcastPersistenceIntegrationTests.swift`
- AppSmokeTests (total): 63 test functions (31 SwiftDataPodcastManager + 32 existing)
- **Total**: 71 tests across AppSmokeTests + IntegrationTests, >90% code coverage

**Documentation**:
- Dev-log: `dev-log/27.1-podcast-persistence-foundation.md`
- Implementation Summary: `dev-log/implementation-summaries/27.1-podcast-persistence-foundation.md`

**Files Created**:
- `zpod/Persistence/SwiftDataPodcastManager.swift` (232 lines)
- `zpod/Persistence/PodcastEntity.swift` (137 lines)
- `AppSmokeTests/SwiftDataPodcastManagerTests.swift` (31 tests)
- `IntegrationTests/PodcastPersistenceIntegrationTests.swift` (8 tests)

**Files Modified**:
- `zpod/ZpodApp.swift` - Removed TestSupport, added ModelContainer
- `Package.swift` - Excluded Controllers/ directory

**Files Deleted**:
- `zpod/Controllers/PodcastManager.swift` (170 lines duplicate)

## Resources

- SwiftData Documentation: https://developer.apple.com/documentation/swiftdata
- AGENTS.md Section 6: Package Architecture Guidelines
- Issue 02.1.8.1: Siri integration (depends on PodcastManaging)

---

**Created**: 2026-01-02
**Blocked By**: None (can start immediately)
**Blocks**: App Store submission
**Technical Debt Level**: CRITICAL
**Type**: Architecture / Foundation
