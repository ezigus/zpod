# Issue 30.2: Deprecated API Migration

**Status**: Open
**Priority**: Medium
**Type**: Technical Debt
**Effort**: Small (2-4 hours)
**GitHub Issue**: [#339](https://github.com/ezigus/zpod/issues/339)

## Description

Update deprecated SwiftUI APIs to their modern equivalents. Currently 40 warnings for deprecated `onChange(of:perform:)` modifier usage in iOS 17/macOS 14.

## Problem Statement

The codebase uses the deprecated SwiftUI `onChange(of:perform:)` modifier which was replaced with a new signature in iOS 17/macOS 14. While the old API still works, it will be removed in future iOS/macOS versions.

**Warning Message:**
```
'onChange(of:perform:)' was deprecated in macOS 14.0: Use `onChange` with a two or zero parameter action closure instead.
```

**Locations** (40 total warnings):
- `LibraryFeature/Sources/LibraryFeature/SettingsComponents.swift:35` (20 occurrences)
- `LibraryFeature/Sources/LibraryFeature/SettingsComponents.swift:91` (20 occurrences)

## Acceptance Criteria

- [ ] Update all `onChange(of:perform:)` calls to new syntax (40 locations)
- [ ] Verify UI behavior unchanged (manual testing)
- [ ] Verify tests still pass
- [ ] Confirm warning count = 0 for onChange deprecations

## Migration Guide

### Old Syntax (Deprecated)
```swift
.onChange(of: selectedValue) { newValue in
    print("Value changed to: \(newValue)")
    handleChange(newValue)
}
```

### New Syntax (Two-Parameter)
```swift
.onChange(of: selectedValue) { oldValue, newValue in
    print("Value changed from \(oldValue) to \(newValue)")
    handleChange(newValue)
}
```

### New Syntax (Zero-Parameter)
Use when you don't need the old or new value directly:
```swift
.onChange(of: selectedValue) {
    print("Value changed to: \(selectedValue)") // Access via binding
    handleChange(selectedValue)
}
```

## Implementation Steps

### Step 1: Locate All Usages
```bash
grep -n "onChange(of:" Packages/LibraryFeature/Sources/LibraryFeature/SettingsComponents.swift
```

### Step 2: Update Line 35
**Current Code:**
```swift
.onChange(of: value) { newValue in
    // existing logic
}
```

**Updated Code:**
```swift
.onChange(of: value) { oldValue, newValue in
    // existing logic (unchanged)
}
```

### Step 3: Update Line 91
**Current Code:**
```swift
.onChange(of: anotherValue) { newValue in
    // existing logic
}
```

**Updated Code:**
```swift
.onChange(of: anotherValue) { oldValue, newValue in
    // existing logic (unchanged)
}
```

### Step 4: Testing
1. Build LibraryFeature package
2. Run LibraryFeature tests
3. Manual testing:
   - Open Settings view
   - Change settings values
   - Verify onChange handlers fire correctly
   - Verify no behavior changes

### Step 5: Validation
```bash
./scripts/run-xcode-tests.sh -s  # Syntax check
./scripts/run-xcode-tests.sh -t LibraryFeature  # Run tests
```

## Testing Strategy

### Automated Tests
- Run LibraryFeature package tests
- Run AppSmokeTests
- Run settings-related UI tests

### Manual Testing Checklist
- [ ] Open Settings view
- [ ] Toggle swipe action settings
- [ ] Change playback speed settings
- [ ] Change skip interval settings
- [ ] Verify all changes save correctly
- [ ] Verify onChange handlers fire on change
- [ ] Verify no console errors

## Risk Assessment

**Risk Level**: Low

### Why Low Risk?
1. Simple syntax change (add `oldValue` parameter)
2. No logic changes required
3. Existing tests validate behavior
4. 2 files affected (SettingsComponents.swift)

### Potential Issues
1. If `oldValue` shadows existing variable name
   - **Mitigation**: Rename to `_oldValue` if needed
2. If closure captures change behavior
   - **Mitigation**: Review each closure carefully

## Related Warnings

### Other Deprecated APIs (1 warning)
```
'allowBluetooth' was deprecated in iOS 8.0: renamed to 'AVAudioSession.CategoryOptions.allowBluetoothHFP'
```

**Location**: Not shown in current output
**Action**: Track separately or include in this issue

## Out of Scope

- Refactoring settings architecture
- Adding new onChange features
- Migrating other deprecated APIs (outside SettingsComponents.swift)

## Success Metrics

- ✅ onChange deprecation warnings: 40 → 0
- ✅ All LibraryFeature tests passing
- ✅ Settings UI functions identically
- ✅ No new warnings introduced

## Timeline

- **Estimated Time**: 2-4 hours
- **Effort Breakdown**:
  - Code changes: 30 minutes
  - Testing: 1 hour
  - Manual verification: 30 minutes
  - Documentation: 30 minutes

## Related Issues

- **30.1**: Swift 6 Concurrency Warnings (separate concurrency warnings)
- **30.3**: Code Quality & SwiftLint Compliance (style issues)

## Notes

This is a straightforward migration with minimal risk. Can be completed in a single PR. Consider including the `allowBluetooth` deprecation fix in the same PR if easy to locate.

## References

- SwiftUI onChange: https://developer.apple.com/documentation/swiftui/view/onchange(of:initial:_:)
- iOS 17 Release Notes: https://developer.apple.com/documentation/ios-ipados-release-notes/ios-ipados-17-release-notes
