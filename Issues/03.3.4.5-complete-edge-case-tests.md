# Issue 03.3.4.5: Return to 03.3.2.7 and Complete Edge-Case Tests

**Status**: ⏸️ Blocked (Test Infrastructure Gap Discovered)

**Priority**: Medium (downgraded - not critical path)

**Parent**: 03.3.4 - Unplayable Episode UX & Diagnostics (#269)

**GitHub Issue**: [#322](https://github.com/ezigus/zpod/issues/322)

**Estimated Effort**: 2-3 hours (revised - needs test data infrastructure)

## Description

After completing Issues 03.3.4.1-03.3.4.4, return to Issue 03.3.2.7 to implement the error-related edge-case tests. **Discovery**: The tests are stubs that need full implementation AND test data infrastructure to create episodes with nil/invalid audio URLs.

## Problem Statement - REVISED

**Current State** (after investigation 2026-01-08):
- Issue 03.3.2.7 has 10 edge-case tests
- 7 tests passing ✅
- 3 tests are stubs with `XCTSkip`:
  1. `testInterruptionPausesAndResumesPlayback` - Debug UI visibility issue (separate)
  2. `testMissingAudioURLShowsErrorNoRetry` - ⚠️ **Needs test data infrastructure**
  3. `testNetworkErrorShowsRetryAndRecovers` - ⚠️ **Needs test data infrastructure**

**Discovery**:
- Error UI is complete ✅ (03.3.4.2-3)
- Error detection is complete ✅ (03.3.4.4)
- Error tests are **stubs**, not implemented tests
- Test data infrastructure **doesn't support**:
  - Creating episodes with nil audioURL
  - Injecting invalid/unreachable URLs for network error simulation

**Revised Target State**:
- Build test data infrastructure for error scenarios
- Implement the 2 error test bodies
- Verify tests pass with new error UI
- Mark 03.3.2.7 as 90% complete (9/10 passing)

## Infrastructure Gaps Identified

```swift
// zpodUITests/PlaybackPositionAVPlayerTests.swift

@MainActor
func testMissingAudioURLShowsErrorNoRetry() throws {
  // REMOVE: throw XCTSkip("Blocked by 03.3.4: error UI/messages not aligned yet")
  
  // Launch with environment that creates episodes with nil audioURL
  launchApp(
    environmentOverrides: ["UITEST_AUDIO_OVERRIDE_MODE": "missing"],
    audioVariant: "short"
  )
  
  guard startPlaybackFromPlayerTab() else {
    XCTFail("Failed to start playback from Player tab")
    return
  }
  
  // Wait for error UI to appear
  let errorOverlay = app.otherElements.matching(identifier: "ExpandedPlayer.ErrorView").firstMatch
  XCTAssertTrue(
    errorOverlay.waitForExistence(timeout: adaptiveShortTimeout),
    "Error view should appear for missing audioURL"
  )
  
  // Verify error message
  let errorMessage = errorOverlay.staticTexts["This episode doesn't have audio available"]
  XCTAssertTrue(
    errorMessage.exists,
    "Should show missing audio message"
  )
  
  // Verify NO retry button (not recoverable)
  let retryButton = app.buttons.matching(identifier: "ExpandedPlayer.RetryButton").firstMatch
  XCTAssertFalse(
    retryButton.exists,
    "Should not show retry button for missing URL"
  )
}
```

#### Test 2: Network Error with Retry

```swift
@MainActor
func testNetworkErrorShowsRetryAndRecovers() throws {
  // REMOVE: throw XCTSkip("Blocked by 03.3.4: error UI/messages not aligned yet")
  
  // Launch with environment that simulates network failure
  // (Implementation depends on how we simulate network errors in tests)
  launchApp(
    environmentOverrides: [
      "UITEST_AUDIO_OVERRIDE_URL": "http://invalid-host.local/episode.mp3"
    ],
    audioVariant: "short"
  )
  
  guard startPlaybackFromPlayerTab() else {
    XCTFail("Failed to start playback from Player tab")
    return
  }
  
  // Wait for error UI
  let errorOverlay = app.otherElements.matching(identifier: "ExpandedPlayer.ErrorView").firstMatch
  XCTAssertTrue(
    errorOverlay.waitForExistence(timeout: avplayerTimeout),
    "Error view should appear for network error"
  )
  
  // Verify error message contains connection error
  let errorMessage = errorOverlay.staticTexts["Unable to load episode"]
  XCTAssertTrue(
    errorMessage.exists,
    "Should show network error message"
  )
  
  // Verify retry button exists (recoverable error)
  let retryButton = app.buttons.matching(identifier: "ExpandedPlayer.RetryButton").firstMatch
  XCTAssertTrue(
    retryButton.waitForExistence(timeout: adaptiveShortTimeout),
    "Should show retry button for network error"
  )
  
  // Note: Actually testing recovery would require mocking network layer
  // For now, verify retry button exists and is tappable
  XCTAssertTrue(retryButton.isEnabled, "Retry button should be enabled")
}
```

## Acceptance Criteria

- [ ] Remove `XCTSkip` from `testMissingAudioURLShowsErrorNoRetry`
- [ ] Remove `XCTSkip` from `testNetworkErrorShowsRetryAndRecovers`
- [ ] Verify both tests pass with new error UI
- [ ] Update test counts in `docs/testing/PLAYBACK_TESTS.md`
- [ ] Update test counts in `zpodUITests/TestSummary.md`
- [ ] Update 03.3.2.7 issue status to 90% (9/10 tests)
- [ ] Update PR #315 description to reflect new status
- [ ] Add comment to PR #315 explaining completion

## Files to Modify

| File | Changes |
|------|---------|
| `zpodUITests/PlaybackPositionAVPlayerTests.swift` | Remove 2 `XCTSkip` statements, tests run (~10 lines removed) |
| `docs/testing/PLAYBACK_TESTS.md` | Update edge-case test status (2 lines) |
| `zpodUITests/TestSummary.md` | Update test count to 9/10 (2 lines) |
| `Issues/03.3.2.7-avplayer-edge-case-tests.md` | Update completion status (5 lines) |

## Testing Strategy

### Run Updated Tests

```bash
# Run just the error tests
./scripts/run-xcode-tests.sh -t zpodUITests/PlaybackPositionAVPlayerTests/testMissingAudioURLShowsErrorNoRetry
./scripts/run-xcode-tests.sh -t zpodUITests/PlaybackPositionAVPlayerTests/testNetworkErrorShowsRetryAndRecovers

# Run full AVPlayer suite to verify nothing broke
./scripts/run-xcode-tests.sh -t zpodUITests/PlaybackPositionAVPlayerTests
```

**Expected Results**:
- `total 10 (✅ 9, ❌ 0, ⏭️ 1, ⚠️ 1)` - 9 passing, 1 skipped (interruption)
- Exit Status: 0

### Verify Documentation Updates

1. Check `PLAYBACK_TESTS.md` - edge-case table shows 2 passing (was skipped)
2. Check `TestSummary.md` - 9/10 tests, 90% complete
3. Check Issue 03.3.2.7 - Updated completion metrics

## Dependencies

- **Requires**: 03.3.4.1 (PlaybackError enum) - must be complete
- **Requires**: 03.3.4.2 (Mini-player error UI) - must be complete
- **Requires**: 03.3.4.3 (Expanded player error UI) - must be complete
- **Requires**: 03.3.4.4 (Error detection) - must be complete
- **Completes**: Issue 03.3.2.7 to 90% (9/10 tests)

## Remaining Work After This Issue

### Interruption Test (Still Blocked)

The `testInterruptionPausesAndResumesPlayback` test will remain skipped because it has a **different blocker**:
- **Issue**: Debug controls not visible in Player tab during UI tests
- **Status**: Needs separate investigation (not part of 03.3.4)
- **Workaround**: Could use notification-based approach instead of UI buttons

**Options for Interruption Test**:
1. Fix debug control visibility (30 min - 1 hour)
2. Rewrite test to use notification-based triggering (1 hour)
3. Leave skipped until future issue addresses it

## Success Metrics

**Before 03.3.4**:
- 03.3.2.7: 70% complete (7/10 tests)
- 2 error tests skipped
- 1 interruption test skipped

**After 03.3.4.5**:
- 03.3.2.7: 90% complete (9/10 tests) ✅
- 2 error tests **passing** ✅
- 1 interruption test still skipped (different issue)

## Related Issues

- **03.3.2.7** - AVPlayer Edge-Case Tests (this completes 90% of it)
- **03.3.4.1-03.3.4.4** - Prerequisites (must all be done first)
- **Issue #269** - Parent issue (03.3.4)
- **Issue #311** - GitHub issue for 03.3.2.7

## Notes

### Why Not 100% Complete?

The interruption test (`testInterruptionPausesAndResumesPlayback`) has a **UI visibility issue** unrelated to error handling:
- Debug overlay controls don't appear during UI tests in Player tab
- This is a SwiftUI layout/testing issue, not an error UX issue
- Fixing it is outside the scope of 03.3.4

**Recommendation**: Mark 03.3.2.7 as "Complete with Known Limitation" at 90%, document the interruption test issue separately, and move forward.

### PR #315 Status

After this issue:
- Update PR #315 title to reflect 90% completion
- Add comment explaining error tests now pass
- Consider merging PR #315 (90% is significant progress)
- Create separate issue for interruption test if needed
