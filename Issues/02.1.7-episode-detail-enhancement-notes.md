# Issue 02.1.7: Episode Detail Enhancement and Notes

## Priority
High

## Status
ðŸ”„ Open â€” tracked in GitHub Issue [#75](https://github.com/ezigus/zpod/issues/75)

## Description
Fulfill Scenario 7 from Issue 02.1 by enriching the episode detail experience with advanced metadata, personal annotation tools, and transcript access. This enhancement provides users with comprehensive episode information and powerful tools to annotate and organize their listening experience.

## Acceptance Criteria

### Given/When/Then Scenario (from Issue 02.1, Scenario 7)
- **Given** I am viewing episode details
- **When** I access the enhanced episode view
- **Then** I should see comprehensive episode metadata including file size, bitrate, and chapter information
- **And** I should be able to add personal notes and tags to episodes
- **And** I should be able to create bookmarks with custom labels and timestamps
- **And** I should be able to rate episodes and see community ratings if available
- **And** Episode transcripts should be accessible if available with search capability

### Detailed Acceptance Criteria

#### Metadata Display
- [x] Display file size (if available)
- [x] Display bitrate/audio quality (if available)
- [x] Display chapter information (already partially supported)
- [x] Display publication date and duration
- [x] Display podcast information

#### Personal Notes and Tags
- [x] Allow users to add text notes to episodes
- [x] Support adding/removing tags for organization
- [x] Persist notes and tags across app sessions
- [x] Display note count indicator on episode list

#### Bookmarks
- [x] Create bookmarks at current or custom timestamps
- [x] Add custom labels to bookmarks
- [x] List all bookmarks for an episode
- [x] Jump to bookmarked positions
- [x] Delete bookmarks

#### Ratings
- [x] Allow users to rate episodes (1-5 stars)
- [x] Display user's rating
- [x] Show average/community ratings (placeholder for future backend)

#### Transcript Access
- [x] Display transcript if available
- [x] Search within transcript
- [x] Jump to transcript position in playback
- [x] Sync transcript highlighting with playback position

## Implementation Approach

### Phase 1: Core Models and Data Layer (Day 1)
1. **Create Annotation Models**
   - EpisodeMetadata: file size, bitrate, format information
   - EpisodeNote: text, tags, creation/modification dates
   - EpisodeBookmark: timestamp, label, creation date
   - EpisodeTranscript: text segments with timestamps

2. **Create Persistence Service**
   - EpisodeAnnotationRepository for CRUD operations
   - Use UserDefaults or CoreData for local storage
   - Design for future iCloud sync compatibility

### Phase 2: ViewModel Extensions (Day 2)
1. **Extend EpisodeDetailViewModel**
   - Add metadata properties
   - Add notes/tags management methods
   - Add bookmark management methods
   - Add rating management
   - Add transcript loading and search

### Phase 3: UI Enhancements (Day 2-3)
1. **Enhance EpisodeDetailView**
   - Add metadata section
   - Add notes editor with tag support
   - Add bookmarks list with creation UI
   - Add rating stars
   - Add transcript viewer with search

2. **Create Supporting Views**
   - NoteEditorView for adding/editing notes
   - BookmarkListView for managing bookmarks
   - TranscriptSearchView for transcript search
   - TagInputView for tag management

### Phase 4: Testing (Day 3)
1. **Unit Tests**
   - Test annotation models
   - Test repository CRUD operations
   - Test ViewModel logic

2. **UI Tests**
   - Test metadata display
   - Test note creation/editing
   - Test bookmark creation/navigation
   - Test rating interaction
   - Test transcript search

## Specification References
- `spec/playback.md`: Enhanced Transcript View, Navigating Episode Chapters, Adding Episode Notes
- `spec/advanced.md`: Using Bookmarks, Rating and Reviewing Podcasts
- Issue 02.1, Scenario 7: Episode Detail Enhancement and Notes

## Dependencies
- **Required**: CoreModels package (Episode, Chapter models)
- **Required**: PlayerFeature package (EpisodeDetailView/ViewModel)
- **Recommended**: Persistence package (data storage)
- **Coordinate with**: Issue #11 (Bookmarks) to avoid duplicative storage
- **Future**: Backend service for community ratings

## Estimated Effort
**Complexity**: Medium  
**Time Estimate**: 3 days  
**Story Points**: 8

## Success Metrics

### Functional Metrics
1. **Metadata Display**
   - All available metadata fields displayed correctly
   - Performance: Metadata loads within 100ms

2. **Annotation Features**
   - Users can create/edit/delete notes successfully
   - Users can add/remove tags
   - Users can create/delete bookmarks
   - All annotations persist correctly

3. **User Experience**
   - Notes editor is intuitive and responsive
   - Bookmark creation is seamless during playback
   - Transcript search returns results within 500ms
   - Rating interaction follows iOS conventions

### Usability Metrics
1. **Discoverability**
   - Annotation features are easy to find
   - Clear visual indicators for episodes with notes/bookmarks
   - Transcript access is intuitive when available

2. **Accessibility**
   - VoiceOver support for all new UI elements
   - Dynamic Type support for text content
   - High contrast mode compatibility
   - Keyboard navigation support

## Risk Mitigation
- **Storage Size**: Monitor storage usage for notes/transcripts, implement cleanup policies
- **Performance**: Lazy load transcript data, implement search indexing if needed
- **Data Sync**: Design models for future iCloud sync without breaking changes
- **UI Complexity**: Keep interface clean with collapsible sections, avoid overwhelming users

## Testing Strategy

### Unit Tests (`PlayerFeatureTests/`)
- EpisodeMetadata model validation
- EpisodeNote CRUD operations
- EpisodeBookmark timestamp validation
- EpisodeAnnotationRepository functionality
- ViewModel annotation management logic

### Integration Tests
- Annotation persistence across app launches
- Bookmark navigation during playback
- Transcript loading and search
- Rating storage and retrieval

### UI Tests (`zpodUITests/`)
- Metadata section display
- Note creation and editing workflow
- Bookmark creation and deletion
- Rating interaction
- Transcript search functionality

## Notes
- Coordinate with Issue #11 (Bookmarks) to use shared bookmark models/services
- Ensure all annotations can be exported/imported for backup
- Design for future features: sharing notes, collaborative ratings, transcript timestamps in share links
- Consider privacy: notes and bookmarks should be private by default

## TODO Items
- [ ] Implement EpisodeMetadata model
- [ ] Implement EpisodeNote model with tags
- [ ] Implement EpisodeBookmark model
- [ ] Create EpisodeAnnotationRepository
- [ ] Extend EpisodeDetailViewModel for annotations
- [ ] Add metadata display to EpisodeDetailView
- [ ] Create notes editor UI
- [ ] Create bookmarks manager UI
- [ ] Add rating stars UI
- [ ] Implement transcript viewer
- [ ] Add comprehensive tests
- [ ] Update documentation
