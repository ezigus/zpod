# 03.3.2.6 - Test Audio Infrastructure for AVPlayer Tests

**Parent**: 03.3.2 - AVPlayer Playback Engine
**Depends on**: 03.3.2.3 (AVPlayer test suite created)
**Status**: Open
**Created**: 2026-01-04

## Problem

The AVPlayer test suite (PlaybackPositionAVPlayerTests) correctly enables AVPlayer mode but fails because test episodes have no `audioURL` set. Without valid audio URLs, `EnhancedEpisodePlayer` transitions to failed state and AVPlayer never starts playback.

### Current Behavior
```swift
// ContentView.swift line 1045
SimpleEpisodeItem(
  id: "st-001", 
  title: "Episode 1: Introduction",
  duration: "45:23", 
  date: "Dec 8"
)  // ← No audioURL field
```

When AVPlayer mode is enabled:
1. `EnhancedEpisodePlayer.play()` checks `episode.audioURL`
2. Finds `nil`, falls into error branch
3. Stops audio engine, transitions to `.failed` state
4. Position never advances (test fails correctly)

## Solution Options

### Option 1: Bundle Test Audio Files (Recommended)
- **Pros**: Reliable, deterministic, works offline, fast
- **Cons**: Adds ~1-5MB to test target size
- **Implementation**:
  1. Create short (10-15 second) test audio files in multiple formats
  2. Add to `zpodUITests` target as bundle resources
  3. Update test episode creation to use `Bundle.main.url(forResource:withExtension:)`
  4. Store in `zpodUITests/TestResources/Audio/`

### Option 2: Use Real Podcast URLs
- **Pros**: No bundled resources, tests real network streaming
- **Cons**: Network-dependent, flaky in CI, rate limiting risks
- **Implementation**: Point `audioURL` to stable podcast URLs (e.g., objc.io Swift Talk episodes)

### Option 3: Mock HTTP Server
- **Pros**: Realistic streaming without external dependencies
- **Cons**: Complex setup, slower test execution, requires SwiftNIO or similar
- **Implementation**: Embed lightweight HTTP server in test suite

### Option 4: Accept Limitation (Current State)
- **Pros**: No additional work
- **Cons**: AVPlayer tests always fail, can't validate audio pipeline
- **Status**: Tests validate environment configuration but not actual playback

## Acceptance Criteria

- [ ] Test audio files created (10-15 seconds, MP3/M4A formats)
- [ ] Files added to `zpodUITests/TestResources/Audio/` directory
- [ ] Files included in `zpodUITests` target membership
- [ ] Test episode factory updated to assign `audioURL` from bundle
- [ ] PlaybackPositionAVPlayerTests pass consistently (3/3 runs)
- [ ] Total audio file size < 2MB
- [ ] Audio files documented in TestSummary.md

## Spec References

**Spec**: `spec/playback.md`
- Lines 62-68: Timeline Advancement During Playback
- Lines 69-75: Pausing Playback  
- Lines 76-82: Resuming Playback
- Lines 83-87: Seeking to Position

All scenarios require actual audio streaming to validate AVPlayer integration.

## Dependencies

### Upstream (Blocking This)
- 03.3.2.3: AVPlayer test suite must exist

### Downstream (Blocked By This)
- 03.3.2.4: CI integration (tests must pass before adding to CI)
- Future AVPlayer enhancements (buffering, error handling tests)

## Testing Strategy

1. **Unit Tests**: Verify bundle resource loading helpers
2. **Integration Tests**: Verify test episodes have valid audio URLs
3. **UI Tests**: Existing PlaybackPositionAVPlayerTests should pass
4. **Manual Verification**: 
   - Download test .xcresult
   - Verify audio files are embedded
   - Check bundle size increase

## Implementation Plan

### Step 1: Create Test Audio (30 minutes)
1. Use Audacity or GarageBand to generate simple tones or speech
2. Export as MP3 (128kbps) and M4A (AAC)
3. Target 10-15 seconds per file (aim for ~100-200KB each)
4. Create 3 files: `test-episode-short.mp3`, `test-episode-medium.mp3`, `test-episode-long.mp3`

### Step 2: Add to Test Target (15 minutes)
1. Create `zpodUITests/TestResources/Audio/` directory
2. Add files to Xcode project
3. Verify target membership in `zpodUITests`
4. Add `.gitattributes` entry to treat as binary

### Step 3: Update Test Episode Factory (30 minutes)
1. Create helper in `PlaybackPositionTestSupport`:
   ```swift
   func testEpisodeURL(named: String) -> URL? {
     Bundle(for: type(of: self)).url(
       forResource: named, 
       withExtension: "mp3", 
       subdirectory: "TestResources/Audio"
     )
   }
   ```
2. Update episode creation in test data to use real URLs
3. Add validation that URLs exist before running tests

### Step 4: Verify Tests Pass (30 minutes)
1. Run PlaybackPositionAVPlayerTests locally (3 times)
2. Verify all 5 tests pass consistently
3. Check execution time (should stay < 2 minutes)
4. Inspect logs for AVPlayer "ready to play" messages

### Step 5: Document (15 minutes)
1. Update `PlaybackPositionAVPlayerTests.swift` file header
2. Add section to `docs/testing/PLAYBACK_TESTS.md`
3. Update `zpodUITests/TestSummary.md`
4. Note audio file licenses/attribution if using samples

## Edge Cases

1. **Bundle resource not found**: Test should fail fast with clear message
2. **Audio format unsupported**: Use widely-supported MP3/M4A only
3. **File corruption**: Add checksum validation in test setup
4. **Simulator audio restrictions**: Document if certain simulators fail

## Notes

- Total estimated time: **2 hours**
- Could use AI-generated speech for test audio (royalty-free)
- Alternative: Use silence + single beep at intervals for timing validation
- Consider using same audio across multiple test episodes (deduplicate storage)

## Validation Checklist

| Criterion | Verification | Status |
|-----------|--------------|--------|
| Audio files < 2MB total | Check bundle size delta | ⏳ |
| All 5 AVPlayer tests pass | Run test suite 3x | ⏳ |
| Bundle resources load correctly | Unit test helpers | ⏳ |
| Execution time < 2min | Check test logs | ⏳ |
| No flakiness | 10 consecutive passes | ⏳ |
| Documentation updated | Review PLAYBACK_TESTS.md | ⏳ |

## Related Issues

- **03.3.2.3**: Creates the AVPlayer test suite (completed)
- **03.3.2.4**: CI integration (blocked by this)
- **03.3.2.5**: Documentation and cleanup (can proceed in parallel)
