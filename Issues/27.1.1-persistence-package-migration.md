# Issue 27.1.1: Persistence Package Migration

## Priority
High

## Status
âœ… Complete

## Description
Migrate podcast persistence from `zpod` app target to `Packages/Persistence`, rename `SwiftDataPodcastManager` to `SwiftDataPodcastRepository`, and decouple Siri snapshot injection. This establishes the foundation for episode persistence and broader persistence refactoring.

This is the first deliverable in the persistence migration series. Episode persistence will be added in follow-up issues once package migration is complete.

## Acceptance Criteria
- [x] `SwiftDataPodcastManager.swift` moved to `Packages/Persistence/Sources/Persistence/SwiftDataPodcastRepository.swift`
- [x] Class renamed to `SwiftDataPodcastRepository`
- [x] Siri snapshot refresh decoupled via `setSiriSnapshotRefresher()` dependency injection
- [x] Concurrency tests added (20 concurrent adds)
- [x] Error-path tests added (save failure scenarios)
- [x] Positive Siri refresh tests added (successful add/update/remove trigger refresh)
- [x] All existing tests passing (80/80 PersistenceTests)
- [x] Episode persistence gap documented as known limitation in dev-log

## Implementation Approach

### Phase 1: Package Migration (Current PR)
1. Create `Packages/Persistence` package structure
2. Move `SwiftDataPodcastManager.swift` to package
3. Rename class to `SwiftDataPodcastRepository`
4. Update all references in `zpod` app target
5. Verify compilation and tests

### Phase 2: Siri Decoupling
1. Add `setSiriSnapshotRefresher()` method for dependency injection
2. Remove direct Siri dependencies from repository
3. Update `ZpodApp.swift` to inject refresher
4. Add tests for refresh triggering

### Phase 3: Test Hardening
1. Add concurrency tests (20 concurrent operations)
2. Add error-path tests (save failures, invalid data)
3. Add positive Siri refresh tests
4. Document episode gap limitation

## Known Limitations
- **Episode persistence not yet implemented** - `toDomain()` returns `episodes: []`
- This breaks CarPlay playback restore, search indexing, and playback position reset
- Will be addressed in Issue 27.1.1.1

## Specification References
- `dev-log/27.1-podcast-persistence-foundation.md` - Architecture decisions
- `dev-log/implementation-summaries/27.1.1-persistence-package-migration.md` - Implementation summary (to be created)

## Dependencies
- **Blocks**: Issue 27.1.1.1 (Episode Persistence)
- **Blocked by**: None

## Estimated Effort
1-2 hours remaining

## Success Metrics
- All package tests pass
- All integration tests pass
- No regressions in app functionality
- Clean separation of concerns (persistence vs. Siri)

## Testing Strategy

### Unit Tests
```bash
./scripts/run-xcode-tests.sh -t PersistenceTests
```

### Integration Tests
```bash
./scripts/run-xcode-tests.sh -t IntegrationTests/PodcastPersistenceIntegrationTests
```

### App Smoke Tests
```bash
./scripts/run-xcode-tests.sh -t AppSmokeTests/SwiftDataPodcastRepositoryAppTests
```

### Full Regression
```bash
./scripts/run-xcode-tests.sh
```

## Related Issues
- Issue 27.1.1.1 - Episode Persistence (Schema + CRUD + Hydration + Hardening)
- Issue 27.1.1.2 - Episode Sync (Upsert Rules)
- Issue 27.1.1.3 - Optional API Polish
- Issue 27.1 - Podcast Persistence Foundation (parent)
