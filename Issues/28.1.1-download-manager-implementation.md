# Issue 28.1.1 - Download Manager Implementation

**Status:** Open  
**Priority:** High  
**Category:** Core Services  
**Created:** 2026-01-05  
**Parent Issue:** 28.1

## Description

Implement a DownloadManager service that handles episode download operations including queue management, progress tracking, cancellation, pause/resume, and error handling.

## Spec Reference

See `spec/offline-playback.md`:
- Manual Episode Download
- Download Progress Tracking
- Download Completion
- Download Cancellation
- Download Failure Handling
- Download Resume After Network Loss

## Objectives

1. Download episodes from HTTP URLs to local storage
2. Track download progress with byte-level accuracy
3. Support cancellation without corrupting partial files
4. Handle network errors with automatic retry logic
5. Persist download state across app restarts
6. Expose async/await API for modern Swift concurrency

## API Design

```swift
@MainActor
public final class DownloadManager: ObservableObject {
    // Singleton instance
    static let shared = DownloadManager()
    
    // Published state for UI binding
    @Published private(set) var downloads: [String: DownloadTask] = [:]
    
    // Start download for episode
    func downloadEpisode(_ episode: Episode) async throws -> URL
    
    // Cancel ongoing download
    func cancelDownload(for episodeID: String) async
    
    // Pause download (preserves partial data)
    func pauseDownload(for episodeID: String) async
    
    // Resume paused download
    func resumeDownload(for episodeID: String) async throws
    
    // Query download status
    func downloadStatus(for episodeID: String) -> DownloadStatus
    
    // Query all active downloads
    func activeDownloads() -> [DownloadTask]
}

public struct DownloadTask: Identifiable {
    let id: String  // Episode ID
    let episode: Episode
    let progress: Progress  // NSProgress for KVO
    let status: DownloadStatus
    let error: Error?
}

public enum DownloadStatus {
    case waiting
    case downloading(bytesReceived: Int64, totalBytes: Int64)
    case paused(bytesReceived: Int64, totalBytes: Int64)
    case completed(localURL: URL)
    case failed(Error)
    case cancelled
}
```

## Implementation Requirements

### Core Functionality

1. **URLSession Configuration**
   - Background-capable session (future BGTaskScheduler support)
   - Custom delegate for progress/completion callbacks
   - Support for HTTP Range requests (resume downloads)

2. **Progress Tracking**
   - Use URLSessionDownloadTask for native progress support
   - Expose NSProgress for UI observation (KVO/Combine)
   - Track bytes received/total bytes
   - Calculate estimated time remaining

3. **Download Queue**
   - Support concurrent downloads (limit: 3 simultaneous)
   - FIFO queue for pending downloads
   - Priority support (high-priority episodes jump queue)

4. **Partial Download Handling**
   - Store partial data in temporary location
   - Move to final location only on successful completion
   - Resume from last received byte using Range requests
   - Clean up partial files on cancellation

5. **Error Handling**
   - Network timeout → Automatic retry (3 attempts)
   - Server error (5xx) → Retry with exponential backoff
   - Storage full → Fail immediately with clear error
   - Invalid URL → Fail immediately, no retry

6. **State Persistence**
   - Save download queue to UserDefaults (simple)
   - Or use CoreData/SwiftData for robustness (if available)
   - Restore downloads on app launch
   - Auto-retry interrupted downloads

### Testing Requirements

1. **Unit Tests** (`Packages/PlaybackEngine/Tests/`)
   - Download a small test file successfully
   - Cancel download mid-progress
   - Pause and resume download
   - Handle network error with retry
   - Handle storage full error
   - Concurrent download limiting (3 max)

2. **Integration Tests** (`IntegrationTests/`)
   - Download real episode from mock HTTP server
   - Simulate network loss during download
   - Restore downloads after app restart

3. **UI Tests** (`zpodUITests/`)
   - Tap download button → progress indicator appears
   - Cancel download → button reverts to initial state
   - Download completes → "Downloaded" badge appears

## Acceptance Criteria

- [ ] DownloadManager actor/class implemented with async/await API
- [ ] Downloads tracked with accurate progress (bytes/total)
- [ ] Cancellation stops download immediately and removes partial files
- [ ] Pause/resume preserves partial data and uses HTTP Range requests
- [ ] Network errors trigger automatic retry (up to 3 attempts)
- [ ] Concurrent download limit enforced (3 simultaneous max)
- [ ] Download state persists across app restarts
- [ ] Unit tests cover success, cancellation, pause/resume, errors
- [ ] Integration test downloads from mock HTTP server
- [ ] All spec scenarios from `offline-playback.md` (download section) pass

## Dependencies

- **Requires:** Episode model with audioURL property
- **Blocks:** 28.1.2 (storage), 28.1.5 (playback coordinator)

## Technical Notes

### URLSession Setup

```swift
let config = URLSessionConfiguration.background(withIdentifier: "us.zig.zpod.downloads")
config.isDiscretionary = false  // Start immediately
config.sessionSendsLaunchEvents = true  // Future background support
let session = URLSession(configuration: config, delegate: self, delegateQueue: nil)
```

### Range Request for Resume

```swift
var request = URLRequest(url: episodeURL)
if let partialData = loadPartialData(for: episodeID) {
    let resumeOffset = partialData.count
    request.setValue("bytes=\(resumeOffset)-", forHTTPHeaderField: "Range")
}
```

### Progress Observation

```swift
// In URLSessionDownloadDelegate
func urlSession(_ session: URLSession, 
                downloadTask: URLSessionDownloadTask, 
                didWriteData bytesWritten: Int64, 
                totalBytesWritten: Int64, 
                totalBytesExpectedToWrite: Int64) {
    Task { @MainActor in
        updateProgress(for: downloadTask, 
                      bytesReceived: totalBytesWritten, 
                      totalBytes: totalBytesExpectedToWrite)
    }
}
```

## Out of Scope

- Background download scheduling (future issue)
- Wi-Fi-only restrictions (handled in 28.1.4)
- Quality selection (future enhancement)
- Automatic downloads (future issue)

## Dev Log

Document decisions, implementation approach, and test results in:
`dev-log/28.1.1-download-manager-implementation.md`

---

**Related Issues:** 28.1 (parent), 28.1.2 (storage), 28.1.4 (network monitoring)  
**Estimated Effort:** 2-3 days
