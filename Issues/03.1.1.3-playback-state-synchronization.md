# Issue 03.1.1.3: Playback State Synchronization & Persistence

**GitHub Issue**: [#110](https://github.com/ezigus/zpod/issues/110)

## Priority
High

## Status
âœ… Complete (2025-11-08)

**Completion Summary**:
- All 5 acceptance criteria fully implemented
- PlaybackStateCoordinator manages state sync, persistence, and lifecycle
- PlaybackResumeState with 24-hour expiry for resume-after-relaunch
- PlaybackAlertPresenter + toast UI for error handling
- 33+ tests (unit + integration) all passing
- GitHub Issue #110 closed 2025-11-08

## Description
Ensure the mini-player and expanded player stay in lockstep with the playback engine, persist state across app lifecycle events, and resume reliably after backgrounding or relaunch. This slice wires the UI to the underlying playback session and handles queue/episode transitions exposed in the base engine.

## Acceptance Criteria
- Shared playback view model publishes episode metadata, progress, playing/paused state, and queue changes to both mini and expanded views.
- State persists across background/foreground transitions; resuming the app reflects accurate position within 500ms.
- Resume-after-relaunch restores the last playing episode and position when the user returns within 24 hours (leveraging persistence layer hooks).
- Queue or episode changes (next/previous) update both player surfaces without desync or flicker.
- Errors in playback (unavailable episode, stream failure) surface as actionable toasts/alerts and pause playback cleanly.

## Implementation Notes
- Leverage Combine/async streams to observe playback engine and sync to `@MainActor` view models.
- Integrate with Persistence (SettingsDomain/Persistence packages) to store last played episode + position.
- Add lightweight error-handling policy (e.g., toast) wired through existing notification utilities.
- Ensure background audio session remains active per Apple guidelines.

## Dependencies
- Parent: [#107](https://github.com/ezigus/zpod/issues/107).
- Playback engine base API (Issue 03 foundation) delivering play/pause/seek hooks.
- Persistence layer for resume metadata.

## Testing Strategy
- Unit tests for state mapping (engine events -> view model outputs).
- Integration tests simulating playback transitions and verifying persisted resume state.
- UI tests covering pause/resume after background (XCUIApplication terminate/launch cycle).

## Deliverables
- Shared playback coordinator/view model module powering both player surfaces.
- Persistence hooks for resume state.
- Error surfacing hooks (toast/banner) tied into existing UI infrastructure.
