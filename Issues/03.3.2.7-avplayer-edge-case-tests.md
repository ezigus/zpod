# Issue 03.3.2.7: AVPlayer Edge-Case Spec Coverage Tests

**Status**: ðŸš§ In Progress  
**Priority**: Medium  
**Parent**: 03.3.2 - AVPlayer Playback Engine (#267)  
**GitHub Issue**: [#311](https://github.com/ezigus/zpod/issues/311)

## Description

Expand the AVPlayer UI test suite to cover playback spec scenarios that are not exercised by the core position/seek tests. This focuses on interruption handling, playback error handling, and playback speed changes using real AVPlayer playback.

## Problem Statement

The current AVPlayer UI tests validate only timeline advancement, pause/resume, and seeking. Spec scenarios for interruptions, error handling, and playback speed changes can regress without automated coverage.

## Acceptance Criteria

- [ ] UI test validates **Episode Missing Audio URL** error state (no retry) per `zpod/spec/playback.md` (blocked by 03.3.4).
- [ ] UI test validates **Network Error During Playback** shows retry, and **Successful Retry After Error** clears the error (blocked by 03.3.4).
- [ ] Integration/UI test simulates **Audio Interruption Handling** (pause on interruption, resume after interruption ends).
- [ ] UI test validates **Playing an Episode with Custom Speed** updates position advancement rate.
- [x] Manual test checklist covers **Headphone Disconnect** behavior if route-change simulation is not feasible.

## Spec References

- `zpod/spec/playback.md`
  - Audio Interruption Handling
  - Headphone Disconnect
  - Playback Error Handling (missing URL, network error, retry)
  - Playing an Episode with Custom Speed

## Dependencies

- 03.3.2.3 Playback AVPlayer Test Suite (core tests must be stable)
- 03.3.4 Unplayable Episode UX & Diagnostics (error UI)
- 03.1.2 Advanced Playback Controls (speed control UI)
- 03.3.2 AVPlayer Playback Engine (interruption handling already implemented)

## Testing Strategy

- **UI Tests**:
  - Use invalid/missing audioURL to trigger error UI.
  - Use a controllable URL (local HTTP server or local file) to simulate retry success.
  - Use debug-only hooks (env-gated) to simulate audio interruptions when feasible.
- **Integration Tests**:
  - Validate interruption/resume flows if system-level simulation is possible.
- **Manual Tests**:
  - Headphone disconnect behavior documented with device steps.

## Manual Checklist (Headphone Disconnect)

1. Start playback with headphones connected (wired or Bluetooth).
2. Disconnect headphones while playback is running.
3. Verify playback pauses immediately.
4. Verify playback does not auto-resume.
5. Tap Play to resume playback.

## Out-of-Spec Candidates (Require Spec Update)

- Playback completion state (end-of-audio handling and UI reset).
- Seek beyond duration clamping and seek-after-end resume behavior.
- Rapid seek burst stability.
