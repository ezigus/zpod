# Issue 03.1.1.5: Mini-Player Layout & Dismissal Enhancement

**GitHub Issue**: [#136](https://github.com/ezigus/zpod/issues/136)

## Priority
Medium

## Status
ðŸ†• Proposed

## Description
Improve the mini-player's integration with the tab bar by transitioning from an overlay approach to an inline layout that pushes content up. Additionally, add a dismiss button that hides the mini-player without stopping playback, giving users control over the UI while maintaining their listening session.

## Background
Currently, the mini-player overlays the bottom tab bar when visible, which can obscure tab navigation buttons and create a cluttered visual hierarchy. This causes usability issues where:
- Tab bar buttons may be partially or fully hidden by the mini-player
- The visual relationship between mini-player and tabs is unclear (floating vs integrated)
- Users have no way to temporarily hide the mini-player UI while keeping playback active

## Acceptance Criteria

### Given/When/Then Scenarios

#### Scenario 1: Inline Layout Integration
- **Given** An episode is playing or paused
- **When** The mini-player becomes visible
- **Then** The mini-player should appear above the tab bar as part of the page layout
- **And** The tab bar content should remain fully visible and accessible
- **And** The mini-player should push content up rather than overlay it
- **And** Safe area insets should adjust to accommodate the mini-player height

#### Scenario 2: Mini-Player Dismissal
- **Given** The mini-player is visible during playback
- **When** I tap a dismiss/close button on the mini-player
- **Then** The mini-player should hide with a smooth transition
- **And** Playback should continue in the background
- **And** The tab bar should expand to fill the reclaimed space
- **And** The mini-player should not reappear until I navigate to the player tab or start new playback

#### Scenario 3: Mini-Player Re-appearance
- **Given** The mini-player has been dismissed during playback
- **When** I navigate to the Player tab
- **Then** The full player interface should be displayed
- **When** I navigate back to another tab
- **Then** The mini-player should reappear automatically
- **And** The dismissal state should be reset

#### Scenario 4: Accessibility
- **Given** The mini-player is visible with a dismiss button
- **When** Using VoiceOver
- **Then** The dismiss button should have a clear accessibility label ("Hide mini-player")
- **And** The accessibility hint should indicate "Hides the mini-player without stopping playback"
- **And** All transport controls should remain accessible

## Implementation Notes

### Layout Strategy
1. **Remove ZStack Overlay**: Replace the current `ZStack(alignment: .bottom)` approach with a `VStack` that includes the mini-player as a child view
2. **Conditional Inclusion**: Use `if miniPlayerVisible && !miniPlayerDismissed` to control presence in layout
3. **Safe Area Management**: Ensure TabView respects the mini-player height via `.safeAreaInset(edge: .bottom)`
4. **Transition Animations**: Use `.transition(.move(edge: .bottom))` for smooth show/hide

### State Management
1. **Add ViewModel State**: Extend `MiniPlayerViewModel` with `@Published var isDismissed: Bool = false`
2. **Dismissal Logic**: Dismiss button sets `isDismissed = true` without affecting playback
3. **Reset Logic**: Reset `isDismissed = false` when:
   - User navigates to Player tab
   - New episode starts playing
   - User explicitly expands mini-player from elsewhere

### UI Components
1. **Dismiss Button**: Add close icon (xmark.circle.fill) to trailing edge of mini-player
2. **Button Styling**: Match existing transport button style with appropriate size/padding
3. **Haptic Feedback**: Provide light haptic feedback on dismiss tap

### Example Implementation Structure
```swift
// In ContentView.swift
VStack(spacing: 0) {
  TabView {
    // tabs...
  }
  .safeAreaInset(edge: .bottom) {
    if miniPlayerViewModel.isVisible && !miniPlayerViewModel.isDismissed {
      MiniPlayerView(viewModel: miniPlayerViewModel, onTapExpand: { showFullPlayer = true })
        .transition(.move(edge: .bottom))
    }
  }
}

// In MiniPlayerView.swift - add dismiss button
HStack(spacing: 12) {
  artwork(for: episode)
  // ... existing content ...
  
  Button {
    performHaptic()
    viewModel.dismiss()
  } label: {
    Image(systemName: "xmark.circle.fill")
      .font(.title3)
      .foregroundStyle(.secondary)
  }
  .accessibilityLabel("Hide mini-player")
  .accessibilityHint("Hides the mini-player without stopping playback")
  .accessibilityIdentifier("Mini Player Dismiss")
}
```

## Dependencies
- Parent issue: [#107](https://github.com/ezigus/zpod/issues/107) (Core player interface)
- Foundation: [#108](https://github.com/ezigus/zpod/issues/108) / `03.1.1.1-mini-player-foundation` (Current mini-player implementation)

## Testing Strategy

### Unit Tests
- Test `MiniPlayerViewModel.dismiss()` sets `isDismissed = true` without affecting playback state
- Test dismissal reset logic when navigating to Player tab
- Test dismissal reset logic when new episode starts

### UI Tests
- Test mini-player appears inline above tab bar (not overlaying)
- Test tab bar buttons remain fully accessible when mini-player is visible
- Test dismiss button hides mini-player while playback continues
- Test mini-player reappears when navigating to Player tab after dismissal
- Test mini-player reappears when starting new playback after dismissal
- Test VoiceOver accessibility of dismiss button

### Manual Testing
- Verify smooth transitions when mini-player appears/disappears
- Test with various tab bar configurations (4, 5 tabs)
- Verify safe area insets adjust correctly
- Test on various device sizes (SE, standard, Plus/Max)

## Deliverables
1. Updated `MiniPlayerViewModel` with dismissal state management
2. Updated `MiniPlayerView` with dismiss button UI
3. Updated `ContentView` layout from ZStack overlay to VStack + safeAreaInset
4. Unit tests for dismissal logic
5. UI tests for layout and interaction
6. Updated documentation in `dev-log/03.1.1.5-mini-player-layout-dismiss.md`

## Related Issues
- `03.1.1.1-mini-player-foundation.md` - Foundation implementation
- `03.1.1-core-player-interface.md` - Parent player interface issue
- `03.1-player-interface-ui.md` - Top-level player UI epic

## Notes
- Consider persisting dismissal preference across app launches (future enhancement)
- May want to add swipe-down gesture for dismissal in future iteration
- Dismissal state should be independent per playback session
