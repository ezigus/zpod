# Issue 03.3.1: Position Ticking Engine

**Status**: ðŸ†• Proposed

**Priority**: High (Quick Win)

**Parent**: 03.3 - Audio Playback Implementation

**GitHub Issue**: [#266](https://github.com/ezigus/zpod/issues/266)

## Description

The `EnhancedEpisodePlayer` emits a `.playing` state once when play is called, but never advances `currentPosition`. The `Ticker` protocol and `TimerTicker` implementation exist in `SimplePlaybackService.swift` but are never instantiated or used.

This issue adds periodic position updates so the UI timeline advances during playback.

## Problem Statement

**Current Behavior**:
1. User taps Play
2. `EnhancedEpisodePlayer.play()` sets `isPlaying = true`
3. Single `.playing(episode, 0, duration)` emitted
4. Position stays at 0 forever

**Expected Behavior**:
1. User taps Play
2. Position advances every 0.5-1.0 seconds
3. UI timeline updates in real-time
4. Seeking updates position immediately

## Technical Analysis

### Existing Code (Unused)

```swift
// SimplePlaybackService.swift - EXISTS but never used
public protocol Ticker: AnyObject, Sendable {
    func schedule(every interval: TimeInterval, _ handler: @escaping @Sendable () -> Void)
    func cancel()
}

public final class TimerTicker: Ticker, @unchecked Sendable {
    // Full implementation exists!
}
```

### Missing Integration

```swift
// EnhancedEpisodePlayer.swift - NEEDS ticker integration
private var ticker: Ticker?

func play(episode: Episode, duration: TimeInterval) {
    // ... existing setup ...

    // START TICKER (missing)
    ticker = TimerTicker()
    ticker?.schedule(every: 0.5) { [weak self] in
        self?.tick()
    }
}

private func tick() {
    guard isPlaying else { return }
    currentPosition += 0.5
    emitCurrentState()
}
```

## Acceptance Criteria

- [ ] Position advances during playback (every 0.5s or 1.0s)
- [ ] Ticker pauses when `pause()` called
- [ ] Ticker resumes when `play()` called after pause
- [ ] Ticker stops on `stop()` or episode finish
- [ ] Ticker cleaned up in `deinit`
- [ ] Mini-player timeline updates visually
- [ ] Expanded player scrubber advances
- [ ] System Now Playing shows advancing time
- [ ] Seeking immediately updates position (doesn't wait for next tick)

## Spec References

See `zpod/spec/playback.md` - Core Playback Behavior section:
- **Timeline Advancement During Playback** - Position advances every second
- **Pausing Playback** - Position remains fixed when paused
- **Resuming Playback** - Timeline continues advancing from paused position
- **Seeking to Position** - Position jumps to scrubber location

## Files to Modify

| File | Changes |
|------|---------|
| `Packages/PlaybackEngine/Sources/PlaybackEngine/EnhancedEpisodePlayer.swift` | Add ticker integration |
| `Packages/PlaybackEngine/Sources/PlaybackEngine/PlaybackTypes.swift` | May need minor updates |
| `Packages/PlaybackEngine/Tests/PlaybackEngineTests/TickerTests.swift` | Add/update tests |

## Implementation Steps

1. **Add Ticker Property**
   ```swift
   private var ticker: Ticker?
   ```

2. **Start Ticker on Play**
   ```swift
   func play(...) {
       // existing code...
       startTicker()
   }

   private func startTicker() {
       ticker?.stop()
       ticker = TimerTicker()
       ticker?.start(interval: 0.5) { [weak self] in
           Task { @MainActor in
               self?.tick()
           }
       }
   }
   ```

3. **Advance Position on Tick**
   ```swift
   private func tick() {
       guard isPlaying, currentPosition < currentDuration else {
           if currentPosition >= currentDuration {
               finish()
           }
           return
       }
       currentPosition += 0.5
       emitCurrentState()
   }
   ```

4. **Stop Ticker on Pause/Stop**
   ```swift
   func pause() {
       isPlaying = false
       ticker?.stop()
       emitCurrentState()
   }
   ```

5. **Clean Up on Deinit**
   ```swift
   deinit {
       ticker?.stop()
   }
   ```

## Testing Strategy

### Unit Tests
- Ticker starts when play called
- Ticker stops when pause called
- Position advances correctly over time
- Position doesn't exceed duration
- Finish state emitted when position reaches duration

### Integration Tests
- MiniPlayerViewModel receives position updates
- ExpandedPlayerViewModel receives position updates
- SystemMediaCoordinator receives position updates

## Dependencies

- None - can be implemented immediately
- Uses existing `Ticker` protocol and `TimerTicker` class

## Estimated Effort

**Quick Win** - 1-2 hours
- Code infrastructure exists
- Just needs wiring

## Notes

- This issue provides "simulated" playback (position advances without real audio)
- Real audio requires 03.3.2 (AVPlayer integration)
- After AVPlayer is added, ticker becomes fallback/validation
- AVPlayer's `addPeriodicTimeObserver` will be primary position source
