# Issue 03.3.2.7.1: Retry Success Verification with Integrated Error UI

**Status**: Open
**Priority**: Medium
**Parent**: 03.3.2.7 - AVPlayer Edge-Case Spec Coverage Tests
**Blocked By**: 03.3.4 - Unplayable Episode UX & Diagnostics

## Description

Verify that network error retry scenarios work end-to-end once the error UI from Issue 03.3.4 is integrated. The current `PlaybackPositionAVPlayerTests` suite has skipped tests for error/retry flows that need to be re-enabled and validated.

## Problem Statement

Issue 03.3.2.7 added test infrastructure for error handling (debug overlay, audio overrides) but couldn't complete error/retry test validation because the error UI was not yet integrated. Once 03.3.4 lands, we need to:
1. Re-enable the skipped error/retry tests
2. Verify the error UI appears correctly
3. Verify the retry button works as expected
4. Verify successful retry clears the error state

## Acceptance Criteria

- [ ] Re-enable `testNetworkErrorShowsRetryAndRecovers()` in `PlaybackPositionAVPlayerTests`
- [ ] Verify error alert appears with correct message text
- [ ] Verify retry button is accessible and labeled correctly
- [ ] Verify tapping retry button triggers playback attempt
- [ ] Verify successful retry clears error UI and starts playback
- [ ] Verify test passes consistently (3+ runs without flakiness)

## Spec References

- `zpod/spec/playback.md` - Playback Error Handling section
  - Network Error During Playback
  - Successful Retry After Error

## Dependencies

- **03.3.4** - Unplayable Episode UX & Diagnostics (blocking)
- **03.3.2.7** - AVPlayer Edge-Case Tests (parent, completed)

## Testing Strategy

### Re-Enable Skipped Tests
1. Remove `XCTSkip` from `testNetworkErrorShowsRetryAndRecovers()`
2. Run targeted test: `./scripts/run-xcode-tests.sh -t zpodUITests/PlaybackPositionAVPlayerTests/testNetworkErrorShowsRetryAndRecovers`
3. Verify test passes

### Verification Steps
1. Launch app with `UITEST_AUDIO_OVERRIDE_URL=<test-server-url>`
2. Start playback (first request fails)
3. Verify error alert appears via accessibility identifier
4. Verify retry button exists and is tappable
5. Tap retry button
6. Verify second request succeeds
7. Verify error alert dismisses
8. Verify playback starts

### Debug Infrastructure (Already Implemented)
- Audio override environment variables:
  - `UITEST_AUDIO_OVERRIDE_URL` - HTTP URL for test server
  - `UITEST_AUDIO_OVERRIDE_MODE=missing` - Force missing URL
  - `UITEST_AUDIO_DISABLE_BUNDLE=1` - Skip bundle fallback
- Debug overlay buttons:
  - `ErrorDebug.Network` - Trigger network error manually
  - `ErrorDebug.Clear` - Clear error state

## Implementation Notes

### Current Test Infrastructure
The test infrastructure is ready:
- `PlaybackDebugControlsView` provides debug error triggers
- Environment-based audio override implemented in `ContentView`
- Test HTTP server helper available in `zpodUITests` (if needed)

### Expected Changes
Minimal changes needed:
1. Remove `XCTSkip` from blocked tests
2. Update accessibility identifier queries to match 03.3.4 error UI
3. Add any missing waits for error UI appearance

### Error UI Identifiers (Expected from 03.3.4)
- Alert container: `Playback.Alert.Container`
- Alert title: `Playback.Alert.Title`
- Alert message: `Playback.Alert.Message`
- Retry button: `Playback.Alert.Retry`
- Dismiss button: `Playback.Alert.Dismiss`

## Out-of-Scope

- Local HTTP server implementation (may not be needed if manual trigger sufficient)
- Additional error scenarios beyond network error + retry
- Error analytics or telemetry

## Timeline

- **Blocked Until**: 03.3.4 merged
- **Estimated Effort**: 1-2 hours (mostly verification)
- **Target**: Complete within 1 sprint after 03.3.4 lands

## Related Issues

- **03.3.2.7** - AVPlayer Edge-Case Tests (parent)
- **03.3.4** - Unplayable Episode UX & Diagnostics (blocking)
- **03.3.2.3** - Playback AVPlayer Test Suite (related)

## Notes

This is primarily a verification task. The test infrastructure and debug hooks are already implemented. Once 03.3.4 provides the error UI, we just need to re-enable the skipped tests and ensure they pass.
