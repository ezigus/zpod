# 02.7.3 - CI Test Flakiness: Phase 3 - Infrastructure Improvements

**Parent Issue**: #145 (02.7 - CI Test Flakiness - Investigation & Infrastructure)
**Phase**: 3 of 4
**Timeline**: Ongoing (iterative improvements)
**Goal**: Build reusable infrastructure that prevents flakiness
**Depends On**: #02.7.2 (Phase 2 - Root Cause Analysis)

## Description

Implement reusable test infrastructure based on root causes identified in Phase 2. Create helpers, utilities, and patterns that make writing reliable tests easier and prevent future flakiness.

## Prerequisites

From Phase 2 (#02.7.2):
- ✅ Root causes categorized by pattern
- ✅ Infrastructure gaps identified
- ✅ Fix recommendations prioritized

## Infrastructure Components

### 1. Retry Mechanism ⭐ **High Priority**

**Problem Solved**: 40% of flakiness from timing/synchronization issues
**Impact**: Prevents "element not found" failures during transitions

**Implementation**:
```swift
// File: zpodUITests/TestSupport/RetryHelpers.swift

extension XCTestCase {
  /// Retries an operation that may fail due to timing issues
  func retryOnFailure<T>(
    attempts: Int = 3,
    delay: TimeInterval = 0.5,
    operation: () throws -> T
  ) rethrows -> T {
    var lastError: Error?
    for attempt in 1...attempts {
      do {
        return try operation()
      } catch {
        lastError = error
        if attempt < attempts {
          Thread.sleep(forTimeInterval: delay)
        }
      }
    }
    throw lastError!
  }

  /// Retries element discovery with exponential backoff
  func retryElementDiscovery<T>(
    _ query: () -> XCUIElement,
    operation: (XCUIElement) throws -> T
  ) rethrows -> T {
    return try retryOnFailure(attempts: 3, delay: 0.5) {
      let element = query()
      guard element.exists else {
        throw TestError.elementNotFound
      }
      return try operation(element)
    }
  }
}
```

**Acceptance Criteria**:
- [ ] `retryOnFailure` helper implemented
- [ ] `retryElementDiscovery` helper implemented
- [ ] Unit tests for retry logic
- [ ] Documentation added to testing guide

---

### 2. Stable Wait Primitives ⭐ **High Priority**

**Problem Solved**: 25% of flakiness from animations/transitions
**Impact**: Prevents tapping elements mid-animation

**Implementation**:
```swift
// File: zpodUITests/TestSupport/StableWaitHelpers.swift

extension XCUIElement {
  /// Waits for element to exist AND have stable frame (not animating)
  func waitForStable(timeout: TimeInterval = 5.0) -> Bool {
    guard waitForExistence(timeout: timeout) else { return false }

    var lastFrame = frame
    let stabilityWindow: TimeInterval = 0.5  // Must be stable for 500ms
    let deadline = Date().addingTimeInterval(stabilityWindow)

    while Date() < deadline {
      Thread.sleep(forTimeInterval: 0.05)  // Check every 50ms
      if frame == lastFrame {
        return true  // Frame hasn't changed for 500ms
      }
      lastFrame = frame
      deadline = Date().addingTimeInterval(stabilityWindow)  // Reset timer
    }

    return true
  }

  /// Waits for animation to complete on element
  func waitForAnimationComplete(timeout: TimeInterval = 2.0) -> Bool {
    return waitForStable(timeout: timeout)
  }

  /// Waits for element to be hittable (exists, visible, not obscured)
  func waitForHittable(timeout: TimeInterval = 5.0) -> Bool {
    let predicate = NSPredicate { [weak self] _, _ in
      guard let element = self else { return false }
      return element.exists && element.isHittable
    }
    let expectation = XCTNSPredicateExpectation(predicate: predicate, object: nil)
    return XCTWaiter.wait(for: [expectation], timeout: timeout) == .completed
  }
}
```

**Acceptance Criteria**:
- [ ] `waitForStable` helper implemented
- [ ] `waitForAnimationComplete` helper implemented
- [ ] `waitForHittable` helper implemented
- [ ] Tested with real animation scenarios
- [ ] Documentation with examples

---

### 3. Environmental Isolation ⭐ **Medium Priority**

**Problem Solved**: 10% of flakiness from state pollution
**Impact**: Prevents tests from affecting each other

**Implementation**:
```swift
// File: zpodUITests/TestSupport/EnvironmentalIsolation.swift

protocol TestEnvironmentIsolation {
  func clearUserDefaults()
  func clearKeychain()
  func resetAppState()
}

extension XCTestCase: TestEnvironmentIsolation {
  /// Clears all UserDefaults to prevent state pollution
  func clearUserDefaults() {
    let defaults = UserDefaults.standard
    defaults.dictionaryRepresentation().keys.forEach {
      defaults.removeObject(forKey: $0)
    }
    defaults.synchronize()
  }

  /// Clears keychain items for test isolation
  func clearKeychain() {
    let secItemClasses = [
      kSecClassGenericPassword,
      kSecClassInternetPassword,
      kSecClassCertificate,
      kSecClassKey,
      kSecClassIdentity
    ]

    for itemClass in secItemClasses {
      let spec: [String: Any] = [kSecClass as String: itemClass]
      SecItemDelete(spec as CFDictionary)
    }
  }

  /// Terminates and relaunches app to clear in-memory state
  func resetAppState() {
    XCUIApplication().terminate()
    // App relaunched automatically in setUp
  }

  /// Standard cleanup for test isolation
  func performStandardCleanup() {
    clearUserDefaults()
    clearKeychain()
    // App termination happens in tearDown
  }
}

// Extend base test case to use standard cleanup
extension SwipeConfigurationTestCase {
  override func tearDown() {
    performStandardCleanup()
    super.tearDown()
  }
}
```

**Acceptance Criteria**:
- [ ] `clearUserDefaults` helper implemented
- [ ] `clearKeychain` helper implemented
- [ ] `performStandardCleanup` integrated into test base classes
- [ ] Verified tests don't affect each other
- [ ] Documentation on when to use

---

### 4. CI-Specific Timeout Adjustments **Medium Priority**

**Problem Solved**: 25% of flakiness from CI environment being slower
**Impact**: Prevents false timeouts on slower CI machines

**Implementation**:
```swift
// File: zpodUITests/TestSupport/CIConfiguration.swift

struct TestConfiguration {
  static let isCI: Bool = {
    ProcessInfo.processInfo.environment["CI"] != nil
  }()

  static let timeoutMultiplier: Double = {
    isCI ? 2.0 : 1.0  // Double timeouts in CI
  }()

  static func adaptiveTimeout(_ baseTimeout: TimeInterval) -> TimeInterval {
    return baseTimeout * timeoutMultiplier
  }
}

// Usage in tests:
let timeout = TestConfiguration.adaptiveTimeout(5.0)  // 5s local, 10s CI
XCTAssertTrue(element.waitForExistence(timeout: timeout))
```

**Acceptance Criteria**:
- [ ] CI detection logic implemented
- [ ] Adaptive timeout helper created
- [ ] Applied to test base classes
- [ ] Verified with actual CI runs
- [ ] Documentation on usage

---

### 5. Improved Element Discovery **High Priority**

**Problem Solved**: Lazy SwiftUI materialization causing "not found" errors
**Impact**: Handles SwiftUI's deferred rendering

**Implementation**:
```swift
// File: zpodUITests/TestSupport/ImprovedElementDiscovery.swift

extension XCUIElement {
  /// Discovers element with scroll-to-reveal if needed
  func discoverWithScrolling(
    in scrollView: XCUIElement,
    timeout: TimeInterval = 5.0
  ) -> Bool {
    if waitForExistence(timeout: timeout) {
      return true
    }

    // Element doesn't exist, try scrolling to reveal
    let maxScrollAttempts = 5
    for _ in 0..<maxScrollAttempts {
      scrollView.swipeUp()
      if waitForExistence(timeout: 1.0) {
        return true
      }
    }

    return false
  }

  /// Waits for element with automatic retry and logging
  func waitWithRetry(
    timeout: TimeInterval = 5.0,
    description: String? = nil
  ) -> Bool {
    let success = waitForExistence(timeout: timeout)
    if !success, let desc = description {
      print("[Test] Element not found: \(desc)")
    }
    return success
  }
}
```

**Acceptance Criteria**:
- [ ] `discoverWithScrolling` helper implemented
- [ ] `waitWithRetry` helper with logging
- [ ] Integrated into SwipeConfiguration test support
- [ ] Tested with lazy-loaded SwiftUI views
- [ ] Documentation with examples

---

## Deliverables

### 1. Test Infrastructure Files
```
zpodUITests/TestSupport/
├── RetryHelpers.swift              (retry mechanism)
├── StableWaitHelpers.swift         (animation/stability waits)
├── EnvironmentalIsolation.swift    (cleanup helpers)
├── CIConfiguration.swift           (CI-specific adjustments)
└── ImprovedElementDiscovery.swift  (better element finding)
```

### 2. Documentation
**File**: `docs/testing/preventing-flakiness.md`

**Contents**:
```markdown
# Preventing Test Flakiness

## Quick Reference

### Always Use Waits
❌ Bad: `app.buttons["Submit"].tap()`
✅ Good: `let btn = app.buttons["Submit"]; XCTAssertTrue(btn.waitForExistence(timeout: 5.0)); btn.tap()`

### Wait for Stable Elements
❌ Bad: `element.tap()`  // May tap mid-animation
✅ Good: `element.waitForStable(); element.tap()`

### Retry Flaky Operations
```swift
retryOnFailure {
  // Operation that might fail due to timing
  complexUIInteraction()
}
```

### Clean Up State
```swift
override func tearDown() {
  performStandardCleanup()  // Clears UserDefaults, Keychain
  super.tearDown()
}
```
```

### 3. Migration Guide
**File**: `docs/testing/flakiness-migration-guide.md`

Shows how to migrate existing tests to use new infrastructure

---

## Acceptance Criteria

- [ ] All 5 infrastructure components implemented
- [ ] Test support files created and documented
- [ ] Integrated into existing test base classes
- [ ] Documentation written (`preventing-flakiness.md`)
- [ ] Migration guide created for existing tests
- [ ] At least 3 existing flaky tests migrated as examples
- [ ] CI runs show reduced flakiness (measured weekly)

## Success Metrics

**Before Infrastructure**:
- Manual retry logic duplicated in tests
- No standard cleanup patterns
- Fixed timeouts fail in CI
- No animation/stability waits

**After Infrastructure**:
- Reusable helpers available to all tests
- Standard cleanup applied automatically
- Timeouts adjust for CI environment
- Animation waits prevent mid-transition taps
- Flakiness rate reduced by 50%+ (target)

## Migration Strategy

### Phase 1: Foundation (Week 1)
- Implement retry helpers
- Implement stable wait helpers
- Add to test base classes

### Phase 2: Integration (Week 2)
- Apply to top 3 flakiest tests
- Measure improvement
- Gather feedback

### Phase 3: Rollout (Week 3-4)
- Document patterns
- Migrate remaining flaky tests
- Update testing guidelines

## Notes

**This is Ongoing**:
- Infrastructure evolves as new patterns emerge
- Weekly reviews identify gaps
- Continuous improvement based on flakiness dashboard

**Benefits Beyond Flakiness**:
- ✅ Easier to write new tests (helpers available)
- ✅ Tests more readable (clear intent with helpers)
- ✅ Faster test development (less debugging)
- ✅ Knowledge transfer (documented patterns)

## References

- Parent: #145 (02.7 - CI Test Flakiness Master Issue)
- Prerequisites: #02.7.2 (Root cause analysis)
- Next: #02.7.4+ (Targeted fixes using this infrastructure)
- XCTest Best Practices: Apple WWDC sessions on UI testing
