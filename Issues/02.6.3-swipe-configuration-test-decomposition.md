# Issue 02.6.3: SwipeConfiguration UI Test Decomposition

**GitHub Issue**: [#131](https://github.com/ezigus/zpod/issues/131)  
**Priority**: High  
**Status**: ðŸ†• Proposed  
**Created**: 2025-11-05  
**Parent Issue**: [#12.8](12.8-ui-test-matrix-optimization.md) - UI Test Matrix Optimization

## Description

Decompose the monolithic `SwipeConfigurationUITests.swift` (1,766 lines) into smaller, focused test files that test specific functionality rather than long, run-on integration tests. This file currently takes the longest to run in the zpodUITests suite due to complex test scenarios that involve multiple app relaunches, persistence checks, and intricate UI interactions.

## Problem Statement

### Current State

**File Structure:**

- **Total lines**: 1,766 (largest UI test file in the project)
- **Base class**: `SwipeConfigurationTestCase` (lines 1-884) - 884 lines of helper infrastructure
- **Test classes**: 4 final classes with 6 total tests
- **Current execution time**: Longest-running test suite in CI

**Test Classes & Methods:**

1. **SwipeConfigurationPersistenceUITests** (3 tests):
   - `testManualConfigurationPersistsAcrossLaunches()` - ~20 lines, multiple relaunches
   - `testFullSwipeTogglesPersistAcrossSave()` - ~50 lines, seeded config + relaunch
   - `testHapticTogglePersistsAcrossLaunches()` - ~50 lines, 2 relaunches with seeding

2. **SwipeConfigurationExecutionUITests** (1 test):
   - `testSeededSwipeActionsExecuteInEpisodeList()` - ~73 lines, full workflow from seeding to execution

3. **SwipeConfigurationPresetCyclingUITests** (1 test):
   - `testPresetSelectionUpdatesSummaryForEachPreset()` - ~20 lines, loops through 3 presets

4. **SwipeConfigurationActionManagementUITests** (1 test):
   - `testAddingActionsRespectsConfiguredCap()` - ~60 lines, iterative action management

### Issues Identified

1. **Monolithic integration tests**: Each test performs multiple operations that could be broken into atomic tests
2. **Complex helper infrastructure**: 884 lines of base class helpers make the file hard to maintain
3. **Multiple relaunches per test**: Persistence tests relaunch the app 2-3 times, slowing execution
4. **Seeding complexity**: Custom base64 JSON seeding logic embedded in test helpers
5. **Debug state validation**: Custom parsing of debug summary strings adds overhead
6. **Test coupling**: Tests rely on shared helper methods that perform multiple operations
7. **Long execution time**: Complex scenarios with multiple waits, scrolling, state validation

## Proposed Solution

### Goal

Break down 6 complex integration tests into **15-20 focused unit tests** organized by functional area:

1. **Configuration UI Display** (3 tests)
2. **Action Management** (4 tests)
3. **Preset Selection** (3 tests)
4. **Toggle Interactions** (3 tests)
5. **Persistence** (3 tests)
6. **Swipe Execution** (2 tests)

### Detailed Breakdown

#### 1. Configuration UI Display Tests (3 tests)

**File**: `SwipeConfigurationUIDisplayTests.swift`

- `testConfigurationSheetOpensFromEpisodeList()`
  - Navigate to episode list â†’ Tap configure button â†’ Verify sheet appears
  - **Extract from**: Navigation logic in `openSwipeConfigurationSheet()`
  
- `testConfigurationSheetShowsDefaultActions()`
  - Open sheet â†’ Verify default leading ["markPlayed"] and trailing ["delete", "archive"]
  - **Extract from**: `waitForDebugSummary()` validation in multiple tests
  
- `testConfigurationSheetShowsHapticControls()`
  - Open sheet â†’ Verify haptic toggle + style picker visible
  - **Extract from**: Haptic validation logic in persistence tests

**Helpers needed**: `openConfigurationSheet()`, `assertDebugSummary()`

---

#### 2. Action Management Tests (4 tests)

**File**: `SwipeActionManagementTests.swift`

- `testAddingSingleLeadingAction()`
  - Open sheet â†’ Add "Play" to leading â†’ Verify action appears
  - **Extract from**: `addAction()` helper usage in manual configuration
  
- `testAddingSingleTrailingAction()`
  - Open sheet â†’ Add "Download" to trailing â†’ Verify action appears
  - **Extract from**: `addAction()` helper usage in manual configuration
  
- `testRemovingLeadingAction()`
  - Open sheet â†’ Remove "Mark Played" â†’ Verify action removed
  - **Extract from**: `removeAction()` helper in `configurePlaybackLayoutManually()`
  
- `testActionLimitEnforcementLeading()`
  - Open sheet â†’ Add actions until cap reached â†’ Verify "Add" button disappears
  - **Extract from**: `testAddingActionsRespectsConfiguredCap()` (current 60-line test)

**Helpers needed**: `addAction()`, `removeAction()`, `waitForDebugSummary()`

---

#### 3. Preset Selection Tests (3 tests)

**File**: `SwipePresetSelectionTests.swift`

- `testPlaybackPresetAppliesCorrectly()`
  - Open sheet â†’ Select "Playback" preset â†’ Verify leading=["play", "addToPlaylist"], trailing=["download", "favorite"]
  - **Extract from**: `testPresetSelectionUpdatesSummaryForEachPreset()` preset loop
  
- `testOrganizationPresetAppliesCorrectly()`
  - Open sheet â†’ Select "Organization" preset â†’ Verify leading=["markPlayed", "favorite"], trailing=["archive", "delete"]
  - **Extract from**: `testPresetSelectionUpdatesSummaryForEachPreset()` preset loop
  
- `testDownloadPresetAppliesCorrectly()`
  - Open sheet â†’ Select "Download" preset â†’ Verify leading=["download", "markPlayed"], trailing=["archive", "delete"]
  - **Extract from**: `testPresetSelectionUpdatesSummaryForEachPreset()` preset loop

**Helpers needed**: `applyPreset()`, `waitForDebugSummary()`, `waitForSaveButton()`

---

#### 4. Toggle Interaction Tests (3 tests)

**File**: `SwipeToggleInteractionTests.swift`

- `testHapticToggleEnablesDisables()`
  - Open sheet â†’ Toggle haptics off â†’ Verify toggle state + debug summary
  - **Extract from**: `setHaptics()` / `assertHapticsEnabled()` logic
  
- `testHapticStylePickerChangesValue()`
  - Open sheet â†’ Enable haptics â†’ Select "Rigid" â†’ Verify style selected
  - **Extract from**: Haptic style picker interaction in `setHaptics()`
  
- `testFullSwipeToggleLeadingTrailing()`
  - Open sheet â†’ Toggle full swipe for leading/trailing â†’ Verify state
  - **Extract from**: `setFullSwipeToggle()` / `assertFullSwipeState()` logic

**Helpers needed**: `setToggle()`, `selectSegmentedControl()`, `assertToggleState()`

---

#### 5. Persistence Tests (3 tests)

**File**: `SwipeConfigurationPersistenceTests.swift`

- `testManualConfigurationPersists()`
  - Configure actions â†’ Save â†’ Relaunch â†’ Verify persisted
  - **Simplify from**: `testManualConfigurationPersistsAcrossLaunches()` (remove multi-step complexity)
  
- `testHapticSettingPersists()`
  - Enable haptics + select style â†’ Save â†’ Relaunch â†’ Verify persisted
  - **Extract from**: `testHapticTogglePersistsAcrossLaunches()` (single relaunch instead of 2)
  
- `testFullSwipeSettingPersists()`
  - Configure full swipe toggles â†’ Save â†’ Relaunch â†’ Verify persisted
  - **Extract from**: `testFullSwipeTogglesPersistAcrossSave()` (single relaunch)

**Helpers needed**: `saveAndRelaunch()`, `assertPersistedState()`

---

#### 6. Swipe Execution Tests (2 tests)

**File**: `SwipeActionExecutionTests.swift`

- `testLeadingSwipeActionsExecute()`
  - Seed config with leading actions â†’ Swipe episode right â†’ Verify action appears
  - **Extract from**: First half of `testSeededSwipeActionsExecuteInEpisodeList()`
  
- `testTrailingSwipeActionsExecute()`
  - Seed config with trailing actions â†’ Swipe episode left â†’ Verify action appears
  - **Extract from**: Trailing action logic (currently only tests leading in 73-line test)

**Helpers needed**: `seedConfiguration()`, `requireEpisodeButton()`, `revealSwipeActions()`

---

### Helper Refactoring Strategy

**Shared Test Support File**: `SwipeConfigurationTestSupport.swift`

Move reusable helpers from `SwipeConfigurationTestCase` base class:

**Navigation helpers** (keep):

- `openConfigurationSheet()`
- `navigateToEpisodeList()`
- `requireEpisodeButton()`

**Interaction helpers** (keep):

- `addAction()`, `removeAction()`
- `applyPreset()`
- `setToggle()` (simplified from `setFullSwipeToggle()` + `setHaptics()`)
- `tapElement()`

**Assertion helpers** (keep):

- `waitForDebugSummary()`
- `assertActionList()`
- `assertToggleState()`
- `assertHapticsEnabled()`

**Configuration helpers** (keep):

- `seedSwipeConfiguration()`
- `saveAndDismissConfiguration()`
- `resetSwipeSettingsToDefault()`

**Complex helpers to simplify**:

- `waitForDebugState()` - 50+ lines, custom parsing logic (keep but document)
- `swipeActionsSheetListContainer()` - 60+ lines, complex query logic (keep but document)
- `resolveToggleSwitch()` - 25+ lines, fallback chain (simplify to 10 lines)
- `currentStateIsOn()` - 30+ lines, value interpretation (simplify to 15 lines)

**Remove/inline**:

- `configurePlaybackLayoutManually()` - too specific, inline into tests
- `completeSeedIfNeeded()` - seeding logic, inline into seed helper

---

### Implementation Plan

#### Phase 1: Extract Simple Tests (UI Display + Preset Selection)

1. Create `SwipeConfigurationUIDisplayTests.swift` with 3 display tests
2. Create `SwipePresetSelectionTests.swift` with 3 preset tests
3. Copy minimal helpers from base class
4. **Validation**: Run extracted tests, verify they pass independently

#### Phase 2: Extract Interaction Tests (Action Management + Toggles)

1. Create `SwipeActionManagementTests.swift` with 4 action tests
2. Create `SwipeToggleInteractionTests.swift` with 3 toggle tests
3. Refine helpers based on Phase 1 learnings
4. **Validation**: Run all extracted tests + original file

#### Phase 3: Extract Complex Tests (Persistence + Execution)

1. Create `SwipeConfigurationPersistenceTests.swift` with 3 persistence tests
2. Create `SwipeActionExecutionTests.swift` with 2 execution tests
3. Simplify relaunch/seeding logic for faster execution
4. **Validation**: Full regression of all swipe tests

#### Phase 4: Consolidate Helpers & Remove Original

1. Create `SwipeConfigurationTestSupport.swift` with shared base class
2. Update all 6 new test files to inherit from consolidated support
3. Delete original `SwipeConfigurationUITests.swift` (1,766 lines)
4. Update CI matrix to run 6 new test files
5. **Validation**: Full CI run with new test structure

---

### Resulting CI Matrix

**Before (1 job):**

- `UITests-SwipeConfiguration`: 6 tests, ~1,766 lines, longest execution time

**After (6 jobs):**

1. `UITests-SwipeUIDisplay`: 3 tests, ~150 lines, fast
2. `UITests-SwipeActionManagement`: 4 tests, ~200 lines, fast
3. `UITests-SwipePresetSelection`: 3 tests, ~150 lines, fast
4. `UITests-SwipeToggleInteraction`: 3 tests, ~150 lines, fast
5. `UITests-SwipePersistence`: 3 tests, ~200 lines, medium (relaunches)
6. `UITests-SwipeExecution`: 2 tests, ~150 lines, medium (navigation + swipe)

**Total**: 18 tests across 6 files, ~1,000 lines (vs 6 tests in 1,766 lines)

**Estimated improvement**:

- **40-50% reduction** in SwipeConfiguration suite execution time (parallel execution + simpler tests)
- **Easier maintenance**: Smaller, focused test files with clear responsibilities
- **Better CI visibility**: Granular job failures pinpoint exact functionality issues

---

## Acceptance Criteria

- [ ] SwipeConfigurationUITests.swift (1,766 lines) deleted
- [ ] 6 new focused test files created with 18 total tests
- [ ] SwipeConfigurationTestSupport.swift base class with shared helpers (~300-400 lines)
- [ ] All 18 new tests pass independently
- [ ] CI matrix updated with 6 new SwipeConfiguration jobs
- [ ] Full regression passes (all zpodUITests)
- [ ] Documentation in TestSummary.md updated with new file structure
- [ ] Execution time improved by 40-50% (measure before/after)

## Dependencies

- **Blocks**: Issue #12.8 (CI matrix optimization) - SwipeConfiguration is a major bottleneck
- **Blocked by**: None - can be implemented independently
- **Related**: Issue #02.1.6.2 (original swipe configuration implementation)

## Testing Strategy

### Before Implementation

1. Run current SwipeConfigurationUITests 3 times, record average execution time
2. Document current test coverage: 6 tests covering 4 functional areas
3. Identify any flaky tests or timing issues

### During Implementation

1. Each phase: Run new tests + original tests to ensure no regression
2. Validate helpers work across all new test files
3. Check for test isolation (no shared state issues)

### After Implementation

1. Run full zpodUITests suite 5 times, verify stability
2. Measure new SwipeConfiguration job execution times
3. Calculate total time improvement vs original single-job approach
4. Verify CI matrix runs all 6 jobs in parallel (max-parallel: 5)

## Spec References

- **spec/02.1.6-swipe-gestures.feature**: Original swipe configuration feature
- **spec/02.1.6.2-swipe-configuration-ui.feature**: UI configuration scenarios

## Implementation Notes

### Key Simplifications

1. **Reduce relaunches**: Current persistence tests do 2-3 relaunches; simplify to 1 per test
2. **Inline one-off helpers**: `configurePlaybackLayoutManually()` only used once, inline it
3. **Simplify toggle detection**: Current `currentStateIsOn()` handles 10+ value types; reduce to 3-4
4. **Remove redundant waits**: Many helpers have defensive waits; trust SmartUITesting protocol
5. **Seed configuration directly**: Current seeding uses base64 JSON environment variables; consider direct UserDefaults injection

### Test Execution Order

New tests are designed to run **independently** in any order:

- Each test opens fresh configuration sheet
- Persistence tests use `resetDefaults: true` between runs
- No shared mutable state between test classes

### Debugging Support

Keep diagnostic helpers for troubleshooting:

- `reportAvailableSwipeIdentifiers()` - captures element hierarchy snapshots
- `attachToggleDiagnostics()` - detailed toggle state on failures
- `logDebugState()` - OSLog entries for CI investigation
- Debug summary parsing - validates state without UI introspection

---

## Deliverables

1. **Code**:
   - [ ] 6 new test files (SwipeConfigurationUIDisplayTests, SwipeActionManagementTests, SwipePresetSelectionTests, SwipeToggleInteractionTests, SwipeConfigurationPersistenceTests, SwipeActionExecutionTests)
   - [ ] 1 support file (SwipeConfigurationTestSupport.swift)
   - [ ] Delete SwipeConfigurationUITests.swift

2. **CI Configuration**:
   - [ ] Update `.github/workflows/ci.yml` with 6 new jobs
   - [ ] Remove old UITests-SwipeConfiguration job reference

3. **Documentation**:
   - [ ] Update `zpodUITests/TestSummary.md` with new structure
   - [ ] Add dev-log entry documenting decomposition approach
   - [ ] Update this issue with execution time metrics

4. **Validation**:
   - [ ] Before/after execution time comparison
   - [ ] CI run showing all 6 jobs passing
   - [ ] Full regression test results

---

## Future Enhancements

- **Issue #12.8.2**: Further optimize persistence tests by using in-memory UserDefaults
- **Issue #12.8.3**: Add visual regression tests for swipe configuration UI layout
- **Issue #12.8.4**: Consolidate shared UI helpers across all test suites

---

**Related Issues**: #12.8, #02.1.6.2  
**Spec References**: spec/02.1.6-swipe-gestures.feature, spec/02.1.6.2-swipe-configuration-ui.feature
