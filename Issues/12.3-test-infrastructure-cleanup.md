# Issue 12.3: UI Test Infrastructure Cleanup - Page Objects, Base Class, Unified Wait API

**Status**: In Progress
**Priority**: P0 (blocks test maintainability)
**Effort**: Medium (3-4 phases)
**Impact**: High (affects all UI tests)

## Summary

Refactor zpod's UI test infrastructure to eliminate "spaghetti" patterns by consolidating fragmented helpers, introducing proper architectural patterns (Page Objects, mandatory base class), and unifying the wait API. This addresses technical debt accumulated across 19 test files totaling 1,970+ lines of helper code.

## Problem Statement

### Current Pain Points

1. **Helper File Fragmentation** (4 files, 1,970+ lines)
   - `UITestHelpers.swift` (950 lines) - Core protocols + waits + app launch + element discovery
   - `UITestStableWaitHelpers.swift` (400 lines) - Frame stability helpers
   - `UITestRetryHelpers.swift` (240 lines) - Diagnostic helpers
   - `UITestImprovedElementDiscovery.swift` (380 lines) - Scroll-based discovery
   - **Problem**: Developers must search 4 files to find the right wait method

2. **No Page Objects** (duplicated element queries)
   - Ad-hoc element queries duplicated across 19 test files
   - Example from `CoreUINavigationTests.swift:422-429`:
     ```swift
     let candidates: [XCUIElement] = [
         app.buttons.matching(identifier: "Settings.Feature.swipeActions").firstMatch,
         app.otherElements.matching(identifier: "Settings.Feature.swipeActions").firstMatch,
         app.cells.matching(identifier: "Settings.Feature.swipeActions").firstMatch,
         // ... 6-8 more fallback queries
     ]
     ```
   - When UI changes, every test file must be updated

3. **Inconsistent Base Class Usage**
   - `SwipeConfigurationTestCase` - Proper isolation with setup/teardown/cleanup
   - Other tests (`CoreUINavigationTests`, `PlaybackUITests`) - Skip cleanup, causing state pollution

4. **Wait Method Proliferation** (14+ methods across 4 files)
   - `waitForElement()`, `waitForAnyElement()`, `waitForElementToBeHittable()`, `waitForElementToDisappear()`
   - `waitForStable()`, `waitForHittable()`, `waitForValueStable()`, `waitForAnimationComplete()`
   - `waitForState()`, `waitForTransition()`, `waitForModalPresentation()`
   - `waitBriefly()`, `waitForPageLoad()`, `waitWithDiagnostics()`
   - **Problem**: Developers don't know which to use, leading to flakiness

5. **Launch Configuration Sprawl**
   - `XCUIApplication.configuredForUITests()` - Base config
   - `SwipeConfigurationTestCase.baseLaunchEnvironment` - Swipe overrides
   - Individual tests add inline overrides
   - **Problem**: Hard to understand what config applies where

## Success Metrics

| Metric | Current | Target |
|--------|---------|--------|
| Helper files | 4 | 2 (UITestWait + UITestHelpers) |
| Wait methods to choose from | 14+ | 1 unified API |
| Test files using page objects | 0 | 5+ (high-traffic screens) |
| Tests with consistent cleanup | ~30% (swipe only) | 100% |
| Ad-hoc fallback chains | 20+ locations | 0 (encapsulated) |

## Implementation Plan

### Phase 1: Consolidate Wait Helpers (Reduce 4 files → 2)

**Goal**: Single unified wait API that delegates to existing primitives

**Create**: `zpodUITests/UITestWait.swift`
```swift
/// Single entry point for all waiting operations
enum WaitCondition {
    case exists
    case hittable
    case stable(window: TimeInterval = 0.3)
    case value(String)
    case disappeared
}

extension XCUIElement {
    @MainActor
    @discardableResult
    func waitUntil(_ condition: WaitCondition, timeout: TimeInterval? = nil) -> Bool {
        // Delegates to existing primitives - no reimplementation
    }
}
```

**Deprecate**: Add `@available(*, deprecated)` to old wait helpers to guide migration

**Consolidate Discovery**: Move `findElementWithFallback`, `findContainerElement` into `UITestElementDiscovery.swift`

**Files Modified**:
- Create: `zpodUITests/UITestWait.swift`
- Deprecate contents: `UITestStableWaitHelpers.swift`, `UITestRetryHelpers.swift`, `UITestImprovedElementDiscovery.swift`
- Simplify: `UITestHelpers.swift` (remove wait methods, keep protocols + app launch)

### Phase 2: Introduce Mandatory Base Class

**Goal**: All UI tests inherit consistent setup/teardown/cleanup

**Create**: `zpodUITests/IsolatedUITestCase.swift`
```swift
/// Mandatory base class for all UI tests. Enforces isolation and cleanup.
/// Pattern from: https://alexilyenko.github.io/xcuitest-page-object/
class IsolatedUITestCase: XCTestCase, SmartUITesting {
    nonisolated(unsafe) var app: XCUIApplication!

    /// Override to specify UserDefaults suite for test isolation
    open var userDefaultsSuite: String? { nil }

    override func setUpWithError() throws {
        try super.setUpWithError()
        continueAfterFailure = false
        performPreTestCleanup()
    }

    override func tearDownWithError() throws {
        performPostTestCleanup()
        app = nil
        try super.tearDownWithError()
    }
}
```

**Migrate**:
- `SwipeConfigurationTestCase: IsolatedUITestCase` (inherits base cleanup)
- All `*Tests.swift` files (19 files, incremental migration)

**Files Modified**:
- Create: `zpodUITests/IsolatedUITestCase.swift`
- Modify: `zpodUITests/SwipeConfigurationTestSupport.swift`
- Migrate: All `*Tests.swift` files

### Phase 3: Introduce Page Objects

**Goal**: Encapsulate screen-specific element queries and actions

**Directory Structure**:
```
zpodUITests/PageObjects/
├── BaseScreen.swift        # Protocol with shared helpers
├── TabBarNavigation.swift  # Main tab bar navigation
├── LibraryScreen.swift     # Library tab content
├── DiscoverScreen.swift    # Discover/search functionality
├── PlayerScreen.swift      # Player controls and state
├── SettingsScreen.swift    # Settings navigation
└── SwipeConfigSheet.swift  # Swipe configuration modal
```

**Example**: `SettingsScreen.swift`
```swift
/// Page object for Settings tab - per https://swiftwithmajid.com
struct SettingsScreen {
    let app: XCUIApplication

    var swipeActionsRow: XCUIElement {
        // Encapsulates the 6-element fallback chain
        let identifiers = ["Settings.Feature.swipeActions", "Swipe Actions"]
        // ... encapsulated discovery logic
    }

    @MainActor
    func navigateToSwipeActions() -> Bool {
        guard swipeActionsRow.waitUntil(.hittable) else { return false }
        swipeActionsRow.tap()
        return app.otherElements.matching(identifier: "SwipeActions.List")
            .firstMatch.waitUntil(.exists)
    }
}
```

**Migration Priority**:
1. `TabBarNavigation` - Used in every test
2. `SettingsScreen` - Most complex fallback chains
3. `SwipeConfigSheet` - Extract from existing support
4. `LibraryScreen`, `PlayerScreen`, `DiscoverScreen` - As needed

### Phase 4: Centralize Launch Configuration

**Goal**: Single source of truth for all launch environment variables

**Create**: `zpodUITests/UITestLaunchConfiguration.swift`
```swift
enum UITestLaunchConfiguration {
    static let base: [String: String] = [
        "UITEST_DISABLE_DOWNLOAD_COORDINATOR": "1",
        "UITEST_DISABLE_ANIMATIONS": "1",
        "UITEST_SLIDER_OPACITY": "0.1",
    ]

    static let tickerPlayback: [String: String] = base.merging([
        "UITEST_DISABLE_AUDIO_ENGINE": "1"
    ]) { _, new in new }

    static func swipeConfiguration(suite: String, reset: Bool) -> [String: String] {
        base.merging([
            "UITEST_SWIPE_DEBUG": "1",
            "UITEST_USER_DEFAULTS_SUITE": suite,
            // ...
        ]) { _, new in new }
    }
}
```

**Files Modified**:
- Create: `zpodUITests/UITestLaunchConfiguration.swift`
- Simplify: `XCUIApplication.configuredForUITests()`
- Simplify: `SwipeConfigurationTestCase.baseLaunchEnvironment`

### Phase 5: Add Guardrails

**Goal**: Prevent regression to spaghetti patterns

**Sleep Lint**: Add to `scripts/run-xcode-tests.sh`
```bash
check_sleep_usage() {
  VIOLATIONS=$(grep -r "Thread\.sleep\|usleep" zpodUITests/*.swift \
    | grep -v "// ALLOWED:" || true)
  if [[ -n "$VIOLATIONS" ]]; then
    log_warn "Found sleep usage in UI tests - prefer waitUntil():"
    echo "$VIOLATIONS"
  fi
}
```

## Implementation Order

| Phase | Priority | Effort | Impact | Dependencies |
|-------|----------|--------|--------|--------------|
| 2.1 IsolatedUITestCase | P0 | Low | High | None |
| 1.1 Unified Wait API | P0 | Medium | High | None |
| 4.1 Launch Configuration Registry | P1 | Low | Medium | None |
| 3.1-3.2 TabBar + Settings Page Objects | P1 | Medium | High | Phase 1, 2 |
| 5.1 Sleep Lint | P2 | Low | Medium | None |
| 3.3-3.5 Remaining Page Objects | P2 | Medium | Medium | Phase 3.1-3.2 |
| 1.2-1.3 Consolidate/Deprecate Old Helpers | P3 | Low | Low | Phase 1.1 |

## Acceptance Criteria

- [ ] All UI tests inherit from `IsolatedUITestCase`
- [ ] Single unified wait API (`waitUntil()`) available
- [ ] Page objects created for 5+ high-traffic screens
- [ ] Launch configuration centralized in single registry
- [ ] Sleep lint guardrail added to test harness
- [ ] Full regression passes: `./scripts/run-xcode-tests.sh`
- [ ] CI success rate >90% after migration

## Testing Strategy

1. **After Phase 1-2**: Run full regression
2. **After Phase 3-4**: Run targeted tests for migrated screens
3. **Ongoing**: CI success rate tracking

## References

### Industry Best Practices
- [Alex Ilyenko - Page Object in XCTest](https://alexilyenko.github.io/xcuitest-page-object/)
- [Swift with Majid - UI Testing Page Object Pattern](https://swiftwithmajid.com/2021/03/24/ui-testing-using-page-object-pattern-in-swift/)
- [REI Engineering - XCUITest Page Object Models](https://engineering.rei.com/mobile/xcuitest-page-object-models.html)
- [Maestro - XCTest Best Practices](https://maestro.dev/insights/xctest-best-practices-ios-testing)

### Project Guidelines
- `AGENTS.md` - Section 3: iOS UI Testing Best Practices
- `docs/testing/ACCESSIBILITY_TESTING_BEST_PRACTICES.md`
- `docs/testing/UI_TESTING_ADVANCED_PATTERNS.md`

## Dependencies

- None (internal refactoring only)

## Known Limitations

- Migration must be incremental to avoid breaking existing tests
- Some tests may need manual review for complex element queries

## Future Enhancements

- Automated page object generation from accessibility identifiers
- Test recorder integration with page objects
- Performance profiling for wait operations

---

**Created**: 2026-01-18
**Last Updated**: 2026-01-18
**Related Issues**: None
**Related PRs**: (to be added)
