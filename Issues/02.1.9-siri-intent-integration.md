# Issue 02.1.9: Siri Intent Integration for CarPlay

## Priority
High

## Status
ðŸ“‹ Planned

## Description
Complete true Siri voice control integration for the CarPlay episode list interface (Issue 02.1.8). While basic CarPlay UI and accessibility-based voice support exist, full natural language Siri commands like "Play the latest episode of [podcast]" require SiriKit intent handlers that are currently missing.

## Background
Issue 02.1.8 delivered CarPlay infrastructure but only implemented accessibility labels/hints for VoiceOver. The acceptance criteria explicitly require:
- "Voice control should allow me to select episodes using Siri"
- "Support natural language queries ('Play the latest episode')"
- "Verify Siri intent handling"

**Current State**: Accessibility labels enable "tap [item]" commands via VoiceOver
**Required State**: Full Siri integration via INPlayMediaIntent for natural queries

## Acceptance Criteria

### Core Siri Integration
- **Given** I am connected to CarPlay
- **When** I say "Hey Siri, play the latest episode of [podcast name]"
- **Then** The app should resolve the podcast and episode
- **And** Start playback immediately
- **And** Provide voice feedback confirming the action

### Natural Language Support
- **Given** I have listened to several podcasts
- **When** I use natural language commands like:
  - "Play [episode title]"
  - "Continue playing [podcast]"
  - "Play my newest episodes"
- **Then** Siri should correctly interpret and execute the command
- **And** Handle ambiguous queries by asking for clarification

### Media Donations
- **Given** I regularly listen to specific podcasts
- **When** I interact with Siri in CarPlay
- **Then** Siri should suggest relevant podcasts and episodes
- **And** Suggestions should be based on my listening history

## Implementation Approach

### Phase 1: Intent Extension Setup (1 day)
1. **Create Intents Extension Target**
   - Add new Intents Extension target to Xcode project
   - Configure Info.plist for media playback intents
   - Add SiriKit framework dependency
   - Set up shared code access between app and extension

2. **Basic Intent Handler**
   - Implement `INPlayMediaIntentHandling` protocol
   - Create intent handler registration
   - Add basic error handling
   - Test with simple "Play [podcast]" commands

### Phase 2: Media Search Implementation (1-2 days)
1. **Episode/Podcast Resolution**
   - Implement `INMediaSearch` vocabulary
   - Add fuzzy matching for podcast/episode names
   - Handle common misspellings and variations
   - Resolve "latest episode" queries to actual episodes

2. **Natural Language Processing**
   - Parse temporal queries ("latest", "newest", "recent")
   - Handle podcast-specific queries
   - Support episode title searches
   - Add disambiguation logic for ambiguous queries

### Phase 3: Media Donations (1 day)
1. **Playback Activity Donation**
   - Donate to Siri using `INInteraction` on playback start
   - Include podcast and episode metadata
   - Configure media item identifiers
   - Set up donation timing (immediate on play)

2. **User Context**
   - Implement `INMediaUserContext` for personalized suggestions
   - Track listening patterns
   - Configure Siri shortcuts for favorite podcasts
   - Test suggestion quality

### Phase 4: Testing & Validation (1 day)
1. **Unit Testing**
   - Test intent handler resolution logic
   - Validate media search algorithms
   - Test error handling paths
   - Mock Siri interactions

2. **Integration Testing**
   - Test in CarPlay simulator with Siri
   - Validate natural language queries
   - Test with various podcast/episode names
   - Verify error messages are helpful

## Technical Details

### Required Files

**New Files**:
- `zpodIntents/` - Intents Extension target
- `zpodIntents/IntentHandler.swift` - Main intent handler
- `zpodIntents/PlayMediaIntentHandler.swift` - Media playback handler
- `zpodIntents/Info.plist` - Extension configuration
- `Packages/SharedUtilities/Sources/SharedUtilities/SiriMediaSearch.swift` - Search logic

**Modified Files**:
- `zpod.xcodeproj/project.pbxproj` - Add extension target
- `zpod/Info.plist` - Register intent extension
- `Packages/LibraryFeature/Sources/LibraryFeature/CarPlayEpisodeListController.swift` - Add donations

### Intent Handler Example

```swift
import Intents
import CoreModels

@available(iOS 14.0, *)
class PlayMediaIntentHandler: NSObject, INPlayMediaIntentHandling {
    
    func resolveMediaItems(
        for intent: INPlayMediaIntent,
        with completion: @escaping ([INPlayMediaMediaItemResolutionResult]) -> Void
    ) {
        guard let search = intent.mediaSearch else {
            completion([.unsupported()])
            return
        }
        
        // Search for matching podcast/episode
        let results = searchMedia(query: search)
        
        if results.isEmpty {
            completion([.unsupported()])
        } else if results.count == 1 {
            completion([.success(with: results[0])])
        } else {
            completion([.disambiguation(with: results)])
        }
    }
    
    func handle(
        intent: INPlayMediaIntent,
        completion: @escaping (INPlayMediaIntentResponse) -> Void
    ) {
        guard let mediaItem = intent.mediaItems?.first else {
            completion(INPlayMediaIntentResponse(code: .failure, userActivity: nil))
            return
        }
        
        // Extract episode ID and start playback
        if let episodeId = mediaItem.identifier {
            startPlayback(episodeId: episodeId)
            completion(INPlayMediaIntentResponse(code: .success, userActivity: nil))
        } else {
            completion(INPlayMediaIntentResponse(code: .failure, userActivity: nil))
        }
    }
    
    private func searchMedia(query: INMediaSearch) -> [INMediaItem] {
        // Implementation: Search PodcastManaging for matches
        // Convert Episode/Podcast to INMediaItem
        []
    }
    
    private func startPlayback(episodeId: String) {
        // Implementation: Signal main app to start playback
    }
}
```

### Media Donation Example

```swift
// In CarPlayEpisodeListController or PlaybackEngine
func donatePlaybackActivity(episode: Episode, podcast: Podcast) {
    let mediaItem = INMediaItem(
        identifier: episode.id.uuidString,
        title: episode.title,
        type: .podcastEpisode,
        artwork: nil
    )
    
    let intent = INPlayMediaIntent(
        mediaItems: [mediaItem],
        mediaContainer: nil,
        playShuffled: false,
        playbackRepeatMode: .none,
        resumePlayback: false
    )
    
    intent.suggestedInvocationPhrase = "Play \(episode.title)"
    
    let interaction = INInteraction(intent: intent, response: nil)
    interaction.donate { error in
        if let error = error {
            logger.error("Failed to donate media intent: \(error)")
        }
    }
}
```

## Dependencies
- **Blocker**: Issue 02.1.8 (CarPlay infrastructure - completed with caveats)
- **Required**: Access to PodcastManaging and EpisodePlaybackService
- **Required**: Shared utilities for media search/matching
- **Optional**: Issue #04 (Download functionality for offline indicators)

## Estimated Effort
**Complexity**: Medium-High  
**Time Estimate**: 4-5 days  
**Story Points**: 8

## Success Metrics

### Functional Metrics
1. **Siri Command Success Rate**
   - >90% success rate for unambiguous commands
   - Proper disambiguation for ambiguous queries
   - Graceful error messages for failed queries

2. **Natural Language Support**
   - Support for 5+ command variations
   - Temporal queries ("latest", "newest") work correctly
   - Common misspellings handled appropriately

3. **Media Donations**
   - Siri suggestions appear within 24 hours of listening
   - Suggestions are relevant to listening history
   - Shortcuts work reliably from lock screen

### Usability Metrics
1. **Driver Safety**
   - Commands work without looking at screen
   - Feedback is audible and clear
   - Errors don't require screen interaction to resolve

2. **Response Time**
   - Intent resolution < 1 second for cached data
   - Intent resolution < 3 seconds for network queries
   - Playback starts within 2 seconds of command

## Testing Strategy

### Unit Tests
1. **Intent Handler Tests**
   - Test media search resolution
   - Validate disambiguation logic
   - Test error handling paths
   - Mock INMediaSearch queries

2. **Search Algorithm Tests**
   - Test fuzzy matching
   - Validate temporal query parsing
   - Test synonym handling
   - Verify ranking algorithms

### Integration Tests
1. **Siri Simulator Tests**
   - Test basic commands
   - Validate natural language queries
   - Test disambiguation flows
   - Verify error messages

2. **Real-World Testing**
   - Test with actual Siri in CarPlay simulator
   - Test on device with various accents
   - Test in noisy environments
   - Validate suggestion quality over time

## Risk Mitigation
- **Siri Recognition Accuracy**: Use clear, unambiguous vocabulary for media items
- **Search Performance**: Implement caching for frequently accessed podcasts/episodes
- **Intent Extension Crashes**: Thorough error handling and logging throughout
- **Privacy Concerns**: Document what data is donated to Siri, ensure user controls

## Notes
- Intent extensions run in separate process from main app
- Shared code must be in framework accessible to both app and extension
- Testing real Siri integration requires physical device (simulator has limitations)
- Media donations may take time to appear in Siri suggestions
- Consider iOS version compatibility (INPlayMediaIntent available iOS 12+)

## References
- [SiriKit Media Intents](https://developer.apple.com/documentation/sirikit/media)
- [INPlayMediaIntent Documentation](https://developer.apple.com/documentation/sirikit/inplaymediaintent)
- [Adding Media Intents to Your App](https://developer.apple.com/documentation/sirikit/media/adding_media_intents_to_your_app)
- [Donating Shortcuts](https://developer.apple.com/documentation/sirikit/donating_shortcuts)
- Parent Issue: 02.1.8 (CarPlay Integration)
