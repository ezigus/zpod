# Issue 27.1.3: Remove Duplicate InMemoryPodcastManager Implementations

**Status**: Open
**Priority**: P1 - Technical Debt Cleanup
**Created**: 2026-01-02
**Previously Completed**: 2026-01-15
**Reopened**: 2026-01-17
**Was Blocked By**: Issue 27.1.2 (zpod app migration - completed)
**Category**: Code Cleanup / Technical Debt

## Description

Remove the duplicate `InMemoryPodcastManager` implementation from `zpod/Controllers/PodcastManager.swift` after the production app has been migrated to use the persistent `PodcastRepository`. Consolidate test code into a single location in the TestSupport package.

## Problem Statement

**Current State**:
There are TWO nearly identical `InMemoryPodcastManager` implementations:

1. **Production location** (shouldn't be here):
   - `zpod/Controllers/PodcastManager.swift` (142 lines)
   - Comment says: *"In-memory implementation suitable for early development & unit testing"*
   - Used by production app currently (technical debt)

2. **Test location** (correct location):
   - `Packages/TestSupport/Sources/TestSupport/InMemoryPodcastManager.swift`
   - Used by test targets

**Problems**:
- ❌ Code duplication (maintenance burden)
- ❌ Confusion about which implementation to use
- ❌ Risk of divergence between implementations
- ❌ Production code in zpod/Controllers/ that's actually test infrastructure

## Reopened Notes

Reopened to restore Siri snapshot parity in TestSupport's `InMemoryPodcastManager`.

## Missing Work (Reopened)

1. **Siri snapshot parity**: add snapshot refresh support to TestSupport `InMemoryPodcastManager`.
2. **Test coverage**: add a unit test that verifies refresh is invoked on add/update/remove.

## Design Notes (Reopened)

### Snapshot Parity for TestSupport

**Goal**: Mirror production behavior so test-only managers refresh Siri snapshots after library mutations.

**Proposed Approach**:
1. Introduce an optional `SiriSnapshotRefreshing` dependency (default nil) to `InMemoryPodcastManager`.
2. Invoke `refreshAll()` after add/update/remove when provided.
3. Use a spy refresher in tests to verify calls without writing to app-group storage.

## Acceptance Criteria

- [x] Delete `zpod/Controllers/PodcastManager.swift` entirely ✅
- [x] Verify NO production code references this file ✅
- [x] Ensure TestSupport implementation is comprehensive: ✅
  - [ ] Includes Siri snapshot persistence
  - [x] Includes organization methods (folder, tag filtering) ✅
  - [x] Includes playback position reset for UI tests ✅
- [x] ~~Update all test targets to use `TestSupport.InMemoryPodcastManager`~~ ✅ (already using TestSupport)
  - [x] `AppSmokeTests` ✅
  - [x] `zpodUITests` ✅
  - [x] `IntegrationTests` ✅
  - [x] Package tests (DiscoverFeatureTests, etc.) ✅
- [ ] Add a unit test verifying snapshot refresh after add/update/remove
- [x] Update any documentation referencing the old location ✅
- [x] All regression tests pass ✅
- [x] Clean build with no orphaned references ✅

## Implementation Plan

### 1. Verify Production Migration Complete

**Prerequisite**: Issue 27.1.2 must be complete (zpod app using PodcastRepository).

Verify no production references:
```bash
# Search for references to zpod/Controllers/PodcastManager
grep -r "Controllers/PodcastManager" zpod/ --include="*.swift"
grep -r "InMemoryPodcastManager" zpod/ --include="*.swift" --exclude-dir=Controllers

# Should return NO results (except in test files)
```

### 2. Compare Implementations

Before deleting, verify TestSupport version has all features:

**Features in zpod/Controllers/PodcastManager.swift**:
- ✅ Basic CRUD (all, find, add, update, remove)
- ✅ Organization filtering (findByFolder, findByTag, findUnorganized)
- ✅ Recursive folder queries (findByFolderRecursive)
- ✅ Siri snapshot persistence (persistSiriSnapshots)
- ✅ Episode merge logic (preserves dateAdded, handles subscription changes)

**Verify TestSupport has equivalent features**:
```bash
diff -u zpod/Controllers/PodcastManager.swift \
        Packages/TestSupport/Sources/TestSupport/InMemoryPodcastManager.swift
```

If TestSupport is missing features, port them BEFORE deleting zpod version.

### 3. Update Test Targets

Ensure all test targets import from TestSupport:

**AppSmokeTests**:
```swift
import TestSupport  // Should already be here
```

**zpodUITests**:
```swift
// If using in-memory manager for test fixtures
import TestSupport
let testManager = InMemoryPodcastManager(initial: testPodcasts)
```

**IntegrationTests**:
```swift
import TestSupport
```

**Package Tests**:
```swift
// DiscoverFeatureTests, NetworkingTests, etc.
import TestSupport
```

### 4. Delete Production File

```bash
git rm zpod/Controllers/PodcastManager.swift
```

### 5. Update Xcode Project

- Remove file reference from Xcode project navigator
- Verify no broken references in zpod target
- Clean build folder: `rm -rf ~/Library/Developer/Xcode/DerivedData`

### 6. Search for Documentation References

```bash
# Find any docs referencing the old location
grep -r "Controllers/PodcastManager" docs/ dev-log/ Issues/ README.md
```

Update any references to point to TestSupport version.

## Files to Delete

- ❌ `zpod/Controllers/PodcastManager.swift`

## Files to Keep

- ✅ `Packages/TestSupport/Sources/TestSupport/InMemoryPodcastManager.swift`
- ✅ `Packages/CoreModels/Sources/CoreModels/PodcastManaging.swift` (protocol)

## Dependencies

- **Blocked By**: Issue 27.1.2 (production app must be migrated first)
- **Related**: Issue 27.1 (PodcastRepository implementation)

## Testing Strategy

### Verification Steps

1. **Clean Build**:
   ```bash
   ./scripts/run-xcode-tests.sh -c -b zpod
   # Should succeed with no errors
   ```

2. **Search for Orphaned References**:
   ```bash
   # No results expected:
   grep -r "Controllers/PodcastManager" . --include="*.swift"
   ```

3. **Regression Tests**:
   ```bash
   ./scripts/run-xcode-tests.sh
   # All tests should pass
   ```

4. **Test Targets Build**:
   ```bash
   ./scripts/run-xcode-tests.sh -t AppSmokeTests
   ./scripts/run-xcode-tests.sh -t zpodUITests
   ./scripts/run-xcode-tests.sh -t IntegrationTests
   ```

## Known Risks

- **Test Breakage**: If tests were importing from production location
  - **Mitigation**: Verify all test imports use TestSupport before deleting
- **Documentation Staleness**: Old references in docs/dev-logs
  - **Mitigation**: Comprehensive grep search and update

## Definition of Done

- [x] `zpod/Controllers/PodcastManager.swift` deleted ✅
- [x] No production code references the deleted file ✅
- [x] All test targets use TestSupport implementation ✅
- [x] All regression tests pass ✅
- [x] Documentation updated (if needed) ✅
- [x] Clean build with no warnings ✅
- [x] Git commit with clear message ✅
- [x] Merged to main branch ✅

## Implementation Notes

**File Deleted**: `zpod/Controllers/PodcastManager.swift` (170 lines)

**Additional Changes**:
- Updated `Package.swift` to exclude `Controllers/` directory from SPM targets
- This prevents accidental inclusion of the Controllers directory in package builds

**Verification**:
```bash
# Confirmed no orphaned references:
grep -r "Controllers/PodcastManager" . --include="*.swift"
# Result: No matches found
```

**Test Targets**: All test targets were already using `TestSupport.InMemoryPodcastManager`, so no updates needed.

**Production Code**: Production app now uses `SwiftDataPodcastManager` (implemented in Issue 27.1.1), completely independent of the deleted duplicate.

## Time Estimate

- Verify migration complete: 0.5 hours
- Compare implementations: 0.5 hours
- Delete file and update project: 0.5 hours
- Update documentation: 0.5 hours
- Testing and verification: 1 hour
- **Total**: ~3 hours

---

**Created**: 2026-01-02
**Blocker**: Blocked by Issue 27.1.2 (production migration)
**Technical Debt**: MEDIUM - Code cleanup, not critical for functionality
**Type**: Refactoring / Cleanup
