# Issue 03.3.4: Unplayable Episode UX & Diagnostics

**Status**: ðŸ†• Proposed

**Priority**: Medium

**Parent**: 03.3 - Audio Playback Implementation

**GitHub Issue**: [#269](https://github.com/ezigus/zpod/issues/269)

## Description

Provide clear user feedback when an episode cannot be played due to missing audio URL, network errors, or other failures. Currently, playback failures are silent or confusing to users.

## Problem Statement

**Current State**:
- Missing `audioURL` results in silent failure
- Network errors not communicated to user
- No retry mechanism for transient failures
- Errors logged to console but user sees nothing

**Target State**:
- Clear error message in player UI
- Different messages for different error types
- Retry button for recoverable errors
- Diagnostic info logged for debugging

## Error Categories

| Error Type | User Message | Recoverable? |
|------------|--------------|--------------|
| Missing URL | "This episode doesn't have audio available" | No |
| Network Error | "Unable to load episode. Check your connection." | Yes (retry) |
| Format Error | "This audio format isn't supported" | No |
| Server Error | "The podcast server is unavailable" | Yes (retry later) |
| Timeout | "Loading timed out. Tap to retry." | Yes (retry) |

## Acceptance Criteria

- [ ] Missing audioURL shows "no audio available" message
- [ ] Network errors show "check connection" with retry button
- [ ] Error state visible in mini-player
- [ ] Error state visible in expanded player
- [ ] Retry button triggers new playback attempt
- [ ] Error auto-clears when new episode selected
- [ ] Diagnostic logging includes episode ID, URL, error details
- [ ] VoiceOver announces error state appropriately

## Spec References

See `zpod/spec/playback.md` - Playback Error Handling section:
- **Episode Missing Audio URL** - Error message, no retry button
- **Network Error During Playback** - Error message with retry button
- **Successful Retry After Error** - Retry clears error and starts playback

See `zpod/spec/ui.md` - Mini-Player and Expanded Player UI section:
- **Player Error State Display** - Error message, retry button, VoiceOver announcement

## Files to Modify

| File | Changes |
|------|---------|
| `Packages/PlaybackEngine/Sources/PlaybackEngine/PlaybackError.swift` | CREATE - error enum |
| `Packages/PlayerFeature/Sources/PlayerFeature/MiniPlayerView.swift` | Add error state UI |
| `Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerView.swift` | Add error state UI |
| `Packages/PlayerFeature/Sources/PlayerFeature/MiniPlayerViewModel.swift` | Handle error state |
| `Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerViewModel.swift` | Handle error state |

## Implementation Steps

### 1. Define PlaybackError Enum
```swift
// PlaybackEngine/PlaybackError.swift
public enum PlaybackError: Error, Sendable, Equatable {
    case missingAudioURL
    case networkError(URLError)
    case formatNotSupported
    case serverError(Int) // HTTP status code
    case timeout
    case unknown(String)

    public var isRecoverable: Bool {
        switch self {
        case .networkError, .serverError, .timeout:
            return true
        case .missingAudioURL, .formatNotSupported, .unknown:
            return false
        }
    }

    public var userMessage: String {
        switch self {
        case .missingAudioURL:
            return "This episode doesn't have audio available"
        case .networkError:
            return "Unable to load episode. Check your connection."
        case .formatNotSupported:
            return "This audio format isn't supported"
        case .serverError:
            return "The podcast server is unavailable"
        case .timeout:
            return "Loading timed out. Tap to retry."
        case .unknown(let message):
            return "Playback error: \(message)"
        }
    }
}
```

### 2. Update EpisodePlaybackState
```swift
// Existing state already supports this:
case failed(Episode, TimeInterval, TimeInterval, PlaybackError)
```

### 3. Add Error UI to MiniPlayer
```swift
// MiniPlayerView.swift
@ViewBuilder
private var errorOverlay: some View {
    if case .failed(_, _, _, let error) = viewModel.state {
        HStack {
            Image(systemName: "exclamationmark.triangle")
                .foregroundColor(.red)
            Text(error.userMessage)
                .font(.caption)
                .foregroundColor(.secondary)
            if error.isRecoverable {
                Button("Retry") {
                    viewModel.retry()
                }
                .font(.caption.bold())
            }
        }
        .padding(.horizontal)
    }
}
```

### 4. Add Diagnostic Logging
```swift
// AVPlayerPlaybackEngine.swift
private func handlePlaybackError(_ error: Error, episode: Episode) {
    let playbackError = mapToPlaybackError(error)

    Logger.error("""
        Playback failed:
        - Episode: \(episode.id)
        - Title: \(episode.title)
        - URL: \(episode.audioURL?.absoluteString ?? "nil")
        - Error: \(playbackError)
        - Underlying: \(error)
        """)

    stateSubject.send(.failed(episode, currentPosition, currentDuration, playbackError))
}
```

## Testing Strategy

### Unit Tests
- Error enum properties (isRecoverable, userMessage)
- ViewModel correctly exposes error state
- Retry action triggers new play attempt

### UI Tests
- Error message displays for failed playback
- Retry button visible for recoverable errors
- Retry button hidden for non-recoverable errors
- Error clears when new episode selected

### Manual Tests
- Airplane mode â†’ network error
- Invalid URL â†’ appropriate error
- Server down â†’ server error message

## Dependencies

- **03.3.2**: AVPlayer engine surfaces errors to this system
- **03.3.3**: Valid audioURL presence detected here

## Estimated Effort

**Medium** - 3-4 hours
- Error enum design
- UI modifications in two player views
- Testing various error scenarios

## Accessibility Considerations

- Error messages must be announced by VoiceOver
- Retry button must be accessible
- Error icon needs accessibility label
- Consider haptic feedback for error state

## Notes

- Consider toast/snackbar for transient errors
- May want to track error frequency for analytics
- Could auto-retry on network restoration (future enhancement)
