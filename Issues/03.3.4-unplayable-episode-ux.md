# Issue 03.3.4: Unplayable Episode UX & Diagnostics

**Status**: üöß In Progress (Decomposed into Sub-Issues)

**Priority**: Medium

**Parent**: 03.3 - Audio Playback Implementation

**GitHub Issue**: [#269](https://github.com/ezigus/zpod/issues/269)

**Branch**: `03.3.4-unplayable-episode-ux`

## Description

Provide clear user feedback when an episode cannot be played due to missing audio URL, network errors, or other failures. Currently, playback failures are silent or confusing to users.

**‚ö†Ô∏è IMPORTANT**: This issue blocks Issue 03.3.2.7 (AVPlayer Edge-Case Tests) from reaching 100% completion. Once 03.3.4 is complete, return to 03.3.2.7 to un-skip error tests.

## Sub-Issues

This issue has been decomposed into 5 manageable sub-issues:

### 03.3.4.1: Extend PlaybackError Enum ‚è±Ô∏è 30 min
- **Status**: üÜï Proposed
- **File**: `Issues/03.3.4.1-playback-error-enum-extension.md`
- **Purpose**: Add `.missingAudioURL`, `.networkError`, `.timeout` cases + `isRecoverable` property
- **Dependencies**: None (foundation for other sub-issues)

### 03.3.4.2: Mini-Player Error UI ‚è±Ô∏è 1.5 hours
- **Status**: üÜï Proposed
- **File**: `Issues/03.3.4.2-mini-player-error-ui.md`
- **Purpose**: Expose error in `MiniPlayerDisplayState`, show error overlay with retry button
- **Dependencies**: Requires 03.3.4.1
- **Note**: Includes ViewModel changes to expose error state to views

### 03.3.4.3: Expanded Player Error UI ‚è±Ô∏è 1.5 hours
- **Status**: üÜï Proposed
- **File**: `Issues/03.3.4.3-expanded-player-error-ui.md`
- **Purpose**: Add `currentError` to ExpandedPlayerViewModel, show error view with retry button
- **Dependencies**: Requires 03.3.4.1 (parallel with 03.3.4.2)
- **Note**: Includes ViewModel changes to expose error state to views

### 03.3.4.4: AVPlayer Error Detection ‚è±Ô∏è 1 hour
- **Status**: üÜï Proposed
- **File**: `Issues/03.3.4.4-avplayer-error-detection.md`
- **Purpose**: Add `mapAVError()` to map AVPlayer errors to PlaybackError cases
- **Dependencies**: Requires 03.3.4.1
- **Note**: Some infrastructure already exists (nil URL check, onError wiring)

### 03.3.4.5: Complete 03.3.2.7 Tests ‚è±Ô∏è 30 min
- **Status**: üÜï Proposed
- **File**: `Issues/03.3.4.5-complete-edge-case-tests.md`
- **Purpose**: Remove `XCTSkip` from error tests in 03.3.2.7, verify they pass
- **Dependencies**: Requires 03.3.4.1-03.3.4.4 all complete

**Total Estimated Effort**: 5 hours

## Problem Statement

**Current State**:
- Missing `audioURL` results in silent failure
- Network errors not communicated to user
- No retry mechanism for transient failures
- Errors logged to console but user sees nothing

**Target State**:
- Clear error message in player UI
- Different messages for different error types
- Retry button for recoverable errors
- Diagnostic info logged for debugging

## Error Categories

| Error Type | User Message | Recoverable? |
|------------|--------------|--------------|
| Missing URL | "This episode doesn't have audio available" | No |
| Network Error | "Unable to load episode. Check your connection." | Yes (retry) |
| Format Error | "This audio format isn't supported" | No |
| Server Error | "The podcast server is unavailable" | Yes (retry later) |
| Timeout | "Loading timed out. Tap to retry." | Yes (retry) |

## Acceptance Criteria

- [ ] Missing audioURL shows "no audio available" message
- [ ] Network errors show "check connection" with retry button
- [ ] Error state visible in mini-player
- [ ] Error state visible in expanded player
- [ ] Retry button triggers new playback attempt
- [ ] Error auto-clears when new episode selected
- [ ] Diagnostic logging includes episode ID, URL, error details
- [ ] VoiceOver announces error state appropriately

## Spec References

See `zpod/spec/spec.md`:
- **Podcast Playback Control** - playback error handling behaviors
- **User Interface and Experience** - mini-player expansion and full player access paths

## Files to Modify

| File | Changes |
|------|---------|
| `Packages/SharedUtilities/Sources/SharedUtilities/PlaybackAlerts.swift` | REVIEW - verify existing error cases |
| `Packages/PlayerFeature/Sources/PlayerFeature/MiniPlayerView.swift` | Add error state UI |
| `Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerView.swift` | Add error state UI |
| `Packages/PlayerFeature/Sources/PlayerFeature/MiniPlayerViewModel.swift` | Handle error state |
| `Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerViewModel.swift` | Handle error state |

## Implementation Steps

### 1. Use Existing PlaybackError Enum
```swift
// SharedUtilities/PlaybackAlerts.swift (ALREADY EXISTS at line 111)
// Review and extend if needed:
public enum PlaybackError: Error, Sendable, Equatable {
    case streamFailed
    case networkError
    case formatNotSupported
    // Add additional cases if needed
    case timeout
    case unknown(String)

    public var isRecoverable: Bool {
        switch self {
        case .networkError, .serverError, .timeout:
            return true
        case .missingAudioURL, .formatNotSupported, .unknown:
            return false
        }
    }

    public var userMessage: String {
        switch self {
        case .missingAudioURL:
            return "This episode doesn't have audio available"
        case .networkError:
            return "Unable to load episode. Check your connection."
        case .formatNotSupported:
            return "This audio format isn't supported"
        case .serverError:
            return "The podcast server is unavailable"
        case .timeout:
            return "Loading timed out. Tap to retry."
        case .unknown(let message):
            return "Playback error: \(message)"
        }
    }
}
```

### 2. Update EpisodePlaybackState
```swift
// Existing state already supports this:
case failed(Episode, TimeInterval, TimeInterval, PlaybackError)
```

### 3. Add Error UI to MiniPlayer
```swift
// MiniPlayerView.swift
@ViewBuilder
private var errorOverlay: some View {
    if case .failed(_, _, _, let error) = viewModel.state {
        HStack {
            Image(systemName: "exclamationmark.triangle")
                .foregroundColor(.red)
            Text(error.userMessage)
                .font(.caption)
                .foregroundColor(.secondary)
            if error.isRecoverable {
                Button("Retry") {
                    viewModel.retry()
                }
                .font(.caption.bold())
            }
        }
        .padding(.horizontal)
    }
}
```

### 4. Add Diagnostic Logging
```swift
// AVPlayerPlaybackEngine.swift
private func handlePlaybackError(_ error: Error, episode: Episode) {
    let playbackError = mapToPlaybackError(error)

    Logger.error("""
        Playback failed:
        - Episode: \(episode.id)
        - Title: \(episode.title)
        - URL: \(episode.audioURL?.absoluteString ?? "nil")
        - Error: \(playbackError)
        - Underlying: \(error)
        """)

    stateSubject.send(.failed(episode, currentPosition, currentDuration, playbackError))
}
```

## Testing Strategy

### Unit Tests
- Error enum properties (isRecoverable, userMessage)
- ViewModel correctly exposes error state
- Retry action triggers new play attempt

### UI Tests
- Error message displays for failed playback
- Retry button visible for recoverable errors
- Retry button hidden for non-recoverable errors
- Error clears when new episode selected

### Manual Tests
- Airplane mode ‚Üí network error
- Invalid URL ‚Üí appropriate error
- Server down ‚Üí server error message

## Dependencies

- **03.3.2**: AVPlayer engine surfaces errors to this system
- **03.3.3**: Valid audioURL presence detected here

## Estimated Effort

**Medium** - 3-4 hours
- Error enum design
- UI modifications in two player views
- Testing various error scenarios

## Accessibility Considerations

- Error messages must be announced by VoiceOver
- Retry button must be accessible
- Error icon needs accessibility label
- Consider haptic feedback for error state

## Notes

- Consider toast/snackbar for transient errors
- May want to track error frequency for analytics
- Could auto-retry on network restoration (future enhancement)

## Work Reminders

- Verify both mini/expanded view models explicitly reset the error state when playback transitions to a new episode so the overlays disappear without manual cleanup.
- Confirm the UI accessibility hints/labels match the `VoiceOver` expectations listed in the acceptance criteria (combine icon/message/button into a single container and annotate the retry button when present).
- Ensure the playback engine logging referenced in 03.3.4.4 includes episode ID, title, and audio URL so diagnostics are available once these tests are re-enabled.
