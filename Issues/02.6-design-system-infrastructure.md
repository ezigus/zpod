# Issue 02.6: Design System & Infrastructure Improvements

**GitHub Issue**: [#129](https://github.com/ezigus/zpod/issues/129)

## Priority

Medium

## Status

ðŸ†• Proposed

## Description

Establish foundational infrastructure for consistent design tokens, accessibility validation, and shared utility services across the application. This addresses technical debt identified during feature development where inline values and duplicated code patterns reduce maintainability and consistency.

## Context

During implementation of Issues 03.1.1.1 and 03.1.1.2 (mini-player and expanded player), several application-wide patterns emerged that should be centralized:

- Color values hardcoded inline (e.g., `Color.white.opacity(0.7)`)
- Typography specifications repeated across views
- Spacing values not standardized
- Haptic feedback implemented directly with `UIImpactFeedbackGenerator`
- No automated accessibility contrast validation
- Settings integration patterns (skip intervals) not consistently applied

## Acceptance Criteria

### 1. Design Token System

- [ ] Centralized color palette with semantic naming (e.g., `Color.primary`, `Color.secondaryText`)
- [ ] Typography scale with named styles (e.g., `Font.title`, `Font.body`)
- [ ] Spacing system with consistent values (e.g., `Spacing.small`, `Spacing.medium`)
- [ ] All existing UI components migrated to use design tokens
- [ ] Documentation of token usage guidelines

### 2. Haptic Feedback Service

- [ ] Shared `HapticService` abstraction in `SharedUtilities` or `SettingsDomain`
- [ ] Methods for common patterns: light impact, medium impact, selection changed, notification success/error
- [ ] Respects user system haptic settings
- [ ] Replace direct `UIImpactFeedbackGenerator` usage across codebase

### 3. Accessibility Infrastructure

- [ ] Automated contrast ratio validation in CI (WCAG AA minimum 4.5:1 for text)
- [ ] Accessibility audit script for common issues (missing labels, insufficient hit targets)
- [ ] Documentation of accessibility testing procedures
- [ ] Integration with SwiftLint or custom linter rules

### 4. Settings Integration Patterns

- [ ] Centralized `SettingsRepository` access patterns
- [ ] Skip interval preferences properly connected to playback controls
- [ ] Playback rate preferences applied consistently
- [ ] Settings change notifications handled uniformly across features

## Implementation Notes

### Design Tokens Structure

```swift
// SharedUtilities/Sources/DesignTokens/Colors.swift
extension Color {
    static let primaryBackground = Color.black
    static let secondaryBackground = Color.black.opacity(0.85)
    static let primaryText = Color.white
    static let secondaryText = Color.white.opacity(0.7)
    // ... etc
}

// SharedUtilities/Sources/DesignTokens/Typography.swift
extension Font {
    static let largeTitle = Font.system(size: 34, weight: .bold)
    static let title = Font.system(size: 28, weight: .semibold)
    // ... etc
}

// SharedUtilities/Sources/DesignTokens/Spacing.swift
enum Spacing {
    static let xxsmall: CGFloat = 4
    static let xsmall: CGFloat = 8
    static let small: CGFloat = 12
    static let medium: CGFloat = 16
    static let large: CGFloat = 24
    // ... etc
}
```

### Haptic Service Pattern

```swift
// SharedUtilities/Sources/HapticService.swift
@MainActor
public final class HapticService {
    public static let shared = HapticService()
    
    public func lightImpact() { /* ... */ }
    public func mediumImpact() { /* ... */ }
    public func selectionChanged() { /* ... */ }
    public func notificationSuccess() { /* ... */ }
    public func notificationError() { /* ... */ }
}

// Usage in views:
HapticService.shared.lightImpact()
```

### Accessibility Validation Script

```bash
#!/bin/bash
# scripts/validate-accessibility.sh
# - Check for views without accessibility identifiers
# - Verify button sizes meet 44pt minimum
# - Validate contrast ratios in design tokens
# - Run accessibility inspector in CI
```

## Dependencies

- None (foundational infrastructure)
- Should be completed before major new feature work to avoid accumulating more technical debt

## Testing Strategy

- Unit tests for HapticService mock/stub behavior
- Design token usage validated through existing UI tests
- Accessibility validation runs in CI on every PR
- Manual testing of haptic feedback on physical devices
- Contrast checker integrated into design review process

## Deliverables

- [ ] Design token files in `SharedUtilities/Sources/DesignTokens/`
- [ ] `HapticService` implementation and tests
- [ ] Accessibility validation script in `scripts/`
- [ ] Migration guide for converting inline values to tokens
- [ ] Updated UI components using design system
- [ ] CI integration for accessibility checks
- [ ] Documentation in `docs/design-system.md`

## Migration Plan

1. **Phase 1**: Establish token definitions (colors, typography, spacing)
2. **Phase 2**: Implement HapticService and migrate existing haptic calls
3. **Phase 3**: Set up accessibility validation CI
4. **Phase 4**: Migrate existing views to use design tokens (PlayerFeature, LibraryFeature)
5. **Phase 5**: Enforce token usage through linter rules (optional)

## Related Issues

- Issue 03.1.1.2: Identified inline color/spacing values in ExpandedPlayerView
- Settings domain work will inform skip interval integration patterns

## Estimated Effort

- Design tokens definition: 4-6 hours
- HapticService implementation: 2-3 hours
- Accessibility validation setup: 4-6 hours
- Migration of existing views: 8-12 hours
- **Total**: ~20-30 hours (can be split across multiple PRs)

## Notes

- This is technical debt cleanup, not user-facing features
- Should be done incrementally to avoid large, risky refactors
- Each phase can be a separate PR for easier review
- Design tokens should be extensible for future theming/dark mode work
