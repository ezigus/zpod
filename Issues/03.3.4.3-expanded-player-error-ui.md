# Issue 03.3.4.3: Add Error State UI to Expanded Player

**Status**: ðŸ†• Proposed

**Priority**: High

**Parent**: 03.3.4 - Unplayable Episode UX & Diagnostics (#269)

**GitHub Issue**: [#320](https://github.com/ezigus/zpod/issues/320)

**Estimated Effort**: 1.5 hours

## Description

Add error state display to the expanded player when playback fails. Show prominent error message with larger icon and retry button (for recoverable errors).

## Problem Statement

**Current State**:
- Expanded player shows full controls and artwork
- When playback fails (`.failed` state), controls remain visible but don't work
- User has no indication why audio won't play
- Tapping play button does nothing

**Target State**:
- Expanded player shows prominent error display when in `.failed` state
- Error message is clear and centered
- Retry button is prominent (for recoverable errors)
- Playback controls are hidden or disabled during error state
- Error clears when new episode selected

## Technical Design

### Step 1: Expose Error State in ViewModel (Critical Prerequisite)

**Problem**: The current `ExpandedPlayerViewModel` does not expose the raw `EpisodePlaybackState` or error info to views. It only exposes individual `@Published` properties like `episode`, `isPlaying`, `currentPosition`, etc.

**Solution**: Add a new `@Published var currentError: PlaybackError?` property:

```swift
// Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerViewModel.swift

// Add new published property for error state
@Published public private(set) var currentError: PlaybackError?

// Update handlePlaybackStateChange to set error:
private func handlePlaybackStateChange(_ state: EpisodePlaybackState) {
  // ... existing code ...

  switch state {
  case .idle:
    currentError = nil  // Clear error on new idle state
    // ... existing handling

  case .playing(let episode, let position, let duration):
    currentError = nil  // Clear error when playback succeeds
    self.episode = episode
    // ... existing handling

  case .paused(let episode, let position, let duration):
    currentError = nil  // Clear error when paused (successful state)
    // ... existing handling

  case .finished(let episode, let duration):
    currentError = nil  // Clear error when finished
    // ... existing handling

  case .failed(let episode, let position, let duration, let error):
    self.episode = episode
    self.isPlaying = false
    self.currentPosition = position
    self.duration = duration
    self.currentError = error  // NEW: expose error to view
  }
}
```

### Step 2: Expanded Player Error View

```swift
// Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerView.swift

@ViewBuilder
private var errorView: some View {
  if let error = viewModel.currentError {
    VStack(spacing: 20) {
      // Large error icon
      Image(systemName: "exclamationmark.triangle.fill")
        .font(.system(size: 60))
        .foregroundColor(.red)
        .accessibilityLabel("Error")
      
      // Error message
      VStack(spacing: 8) {
        Text("Playback Error")
          .font(.title2.bold())
          .foregroundColor(.primary)
        
        Text(error.userMessage)
          .font(.body)
          .foregroundColor(.secondary)
          .multilineTextAlignment(.center)
          .padding(.horizontal, 40)
      }
      
      // Retry button (if recoverable)
      if error.isRecoverable {
        Button {
          viewModel.retryPlayback()
        } label: {
          Label("Retry Playback", systemImage: "arrow.clockwise")
            .font(.headline)
        }
        .buttonStyle(.borderedProminent)
        .controlSize(.large)
        .accessibilityIdentifier("ExpandedPlayer.RetryButton")
      }
      
      // Episode info (for context)
      if let episode = viewModel.episode {
        VStack(spacing: 4) {
          Text(episode.title)
            .font(.caption)
            .foregroundColor(.secondary)
          if let podcastTitle = episode.podcast?.title {
            Text(podcastTitle)
              .font(.caption2)
              .foregroundColor(.tertiary)
          }
        }
        .padding(.top, 20)
      }
    }
    .frame(maxWidth: .infinity, maxHeight: .infinity)
    .accessibilityElement(children: .contain)
    .accessibilityIdentifier("ExpandedPlayer.ErrorView")
  }
}
```

### Step 3: Integration into Expanded Player Layout

```swift
// Update ExpandedPlayerView body to show error view when failed
var body: some View {
  VStack {
    if viewModel.currentError != nil {
      errorView
    } else {
      // Existing player UI (artwork, controls, scrubber)
      normalPlayerView
    }
  }
}
```

### Step 4: ViewModel Retry Logic

```swift
// Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerViewModel.swift

@MainActor
func retryPlayback() {
  guard currentError != nil,
        let episode = episode else { return }

  let position = currentPosition

  // Log retry attempt
  Logger.info("User retry playback: \(episode.title) at \(position)s")

  // Clear error and attempt playback again
  playbackService.play(episode, from: position)
}
```

## Acceptance Criteria

### ViewModel Changes
- [ ] `ExpandedPlayerViewModel` has new `@Published var currentError: PlaybackError?` property
- [ ] `handlePlaybackStateChange(.failed)` sets `currentError` to the error
- [ ] All non-error states (`.idle`, `.playing`, `.paused`, `.finished`) set `currentError = nil`
- [ ] `retryPlayback()` method added to `ExpandedPlayerViewModel`

### View Changes
- [ ] Error view appears in expanded player when `viewModel.currentError != nil`
- [ ] Large error icon (60pt) is visible
- [ ] "Playback Error" title is shown
- [ ] Error message uses `PlaybackError.userMessage`
- [ ] Retry button appears only for `isRecoverable` errors
- [ ] Retry button triggers `retryPlayback()` in viewmodel
- [ ] Episode title/podcast shown for context
- [ ] Normal playback controls are hidden during error state
- [ ] Error view has accessibility identifier `ExpandedPlayer.ErrorView`
- [ ] Retry button has accessibility identifier `ExpandedPlayer.RetryButton`
- [ ] VoiceOver reads error state appropriately
- [ ] Error clears when new episode starts playing (currentError becomes nil)

## Files to Modify

| File | Changes |
|------|---------|
| `Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerViewModel.swift` | Add `currentError` property, update `handlePlaybackStateChange` to set/clear error, add `retryPlayback()` (+25 lines) |
| `Packages/PlayerFeature/Sources/PlayerFeature/ExpandedPlayerView.swift` | Add `errorView`, update body to show error view when `currentError != nil` (+50 lines) |

## Testing Strategy

### Manual Testing

1. **Missing URL Error**:
   - Launch app with missing audio URL episode
   - Navigate to expanded player
   - Tap play
   - Verify expanded player shows:
     - Large red exclamation icon
     - "Playback Error" title
     - "This episode doesn't have audio available"
     - No retry button (not recoverable)
     - Episode title below for context

2. **Network Error with Retry**:
   - Enable airplane mode or use invalid URL
   - Tap play
   - Verify expanded player shows:
     - Error UI as above
     - "Unable to load episode. Check your connection."
     - Prominent "Retry Playback" button

3. **Retry Flow**:
   - Tap retry button
   - Verify playback attempt is made
   - If still fails, error remains
   - If succeeds, normal player UI appears

4. **Error Clears on New Episode**:
   - In error state, select different episode
   - Tap play on new episode
   - Verify error clears, new episode plays

### UI Tests (add to zpodUITests)

```swift
// Will be enabled after 03.3.4 completes
func testExpandedPlayerShowsErrorForMissingURL() {
  // Launch with episode that has nil audioURL
  // Navigate to expanded player
  // Tap play
  
  let errorView = app.otherElements["ExpandedPlayer.ErrorView"]
  XCTAssertTrue(errorView.waitForExistence(timeout: 5))
  
  // Verify error message
  XCTAssertTrue(errorView.staticTexts["This episode doesn't have audio available"].exists)
  
  // Verify no retry button (not recoverable)
  let retryButton = app.buttons["ExpandedPlayer.RetryButton"]
  XCTAssertFalse(retryButton.exists)
}

func testExpandedPlayerRetryButtonWorks() {
  // Launch with network error scenario
  // Navigate to expanded player
  // Tap play
  
  let retryButton = app.buttons["ExpandedPlayer.RetryButton"]
  XCTAssertTrue(retryButton.waitForExistence(timeout: 5))
  
  // Tap retry
  retryButton.tap()
  
  // Verify retry was attempted
  // (Error remains if still failing, or player appears if succeeds)
}
```

## Dependencies

- **Requires**: 03.3.4.1 (PlaybackError enum extension) - must be complete first
- **Parallel**: 03.3.4.2 (Mini-player error UI) - can be done simultaneously
- **Unblocks**: 03.3.2.7 test `testMissingAudioURLShowsErrorNoRetry`
- **Unblocks**: 03.3.2.7 test `testNetworkErrorShowsRetryAndRecovers`

## Design Notes

### Layout Considerations

- **Prominent**: Expanded player has more space, so use larger icons/text
- **Centered**: Error view uses center alignment for visual balance
- **Context**: Show episode info below so user knows what failed
- **Color**: Red icon conveys error clearly, but text uses secondary colors for readability

### Accessibility

- Error view is a single accessibility container
- VoiceOver reads: "Playback Error. [Message]. [Episode context]. [Retry button if present]"
- Retry button has clear label with icon
- Controls respect user's preferred text size (Dynamic Type)
- Ensure retry/clear logic in the view model resets the `.failed` state when a new episode starts so the expanded player's accessibility focus returns to the normal controls and playlist context when playback recovers.

### User Experience

- **Non-Recoverable Errors**: User sees error but no retry (e.g., missing URL)
  - They can navigate back to episode list and try different episode
  
- **Recoverable Errors**: User sees retry button
  - First retry often succeeds (transient network issues)
  - If multiple retries fail, user understands issue is persistent

## Related Issues

- **03.3.2.7** - AVPlayer edge-case tests (currently skipped, waiting for this UI)
- **03.3.4.2** - Mini-player error UI (parallel work, same pattern)
- **03.3.4.4** - Error detection in AVPlayerPlaybackEngine (provides the errors)
