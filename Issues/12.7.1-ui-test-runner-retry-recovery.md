# Issue 12.7.1: UI Test Runner Retry & Simulator Refresh

## Priority

Medium

## Status

üìù Planned

## Description

Add targeted retry logic for system-level UI test runner/install/load failures and provide an opt-in fresh-simulator mode for UI suites. The goal is to turn transient XCTest runner issues into a single automatic retry without masking real test failures, while keeping `scripts/run-xcode-tests.sh` modular.

## Problem Statement

UI suites occasionally fail with system errors such as:
- `Failed to create a bundle instance representing ... zpodUITests.xctest`
- Test runner install/load failures (no test assertions executed)

These are typically transient CoreSimulator or container-manager issues and are resolved by rerunning the suite. Today the script fails immediately, forcing manual reruns.

## Key Actions

1. Detect system-level install/load failures in UI test logs.
2. On detection, reset CoreSimulator, create a fresh simulator, and retry the suite once.
3. Add an opt-in fresh-simulator-per-suite mode for UI suites to reduce state leakage.
4. Keep the retry logic modular (new lib helpers, minimal growth in the main script).

## Acceptance Criteria

### Scenario 1: System-Level Retry
- **Given** a UI test suite run fails with a system-level runner/install/load error
- **When** the script detects the failure pattern
- **Then** it resets CoreSimulator, provisions a fresh simulator, and retries the suite once
- **And** the retry uses the fresh simulator destination

### Scenario 2: Real Test Failures Are Not Masked
- **Given** a UI test suite fails due to test assertions
- **When** the script evaluates the failure
- **Then** it does **not** retry and reports the failure normally

### Scenario 3: Opt-In Fresh Simulator Per Suite
- **Given** `ZPOD_UI_TEST_FRESH_SIM=1` is set
- **When** UI suites run
- **Then** each suite runs on a freshly created simulator
- **And** the simulator is deleted after the suite completes

### Scenario 4: Documentation Updated
- **Given** the new behavior
- **When** reviewing usage guidance
- **Then** the script help/docs mention the new retry behavior and `ZPOD_UI_TEST_FRESH_SIM`

## Implementation Approach

1. Add log pattern detection helper for system-level install/load errors.
2. Extract simulator provisioning helpers into a shared library module.
3. Add a single retry path that resets CoreSimulator and retries on a fresh simulator.
4. Add opt-in fresh-simulator-per-suite behavior in the UI suite runner.
5. Update script usage text and dev-log documentation.

## Specification References

- `docs/testing/preventing-flakiness.md`
- `docs/testing/flakiness-migration-guide.md`

## Dependencies

- `scripts/run-xcode-tests.sh`
- `scripts/lib/xcode.sh` (destination selection)
- `xcrun simctl` availability

## Testing Strategy

1. Run a UI suite normally and verify no behavior change.
2. Validate retry path using a captured log (or a forced reproduction) that matches system-level error patterns.
3. Run a UI suite with `ZPOD_UI_TEST_FRESH_SIM=1` and confirm the simulator is created and deleted.

## Notes

- Retry should be **single-attempt** to avoid masking persistent failures.
- Fresh simulator mode is opt-in to avoid default runtime cost.
