# Issue 02.1.6.7: SwiftLens Swift 6.2+ Concurrency Compatibility

## Priority
Medium ‚Äî Blocks local development on Swift 6.2.3+ (Xcode 26.2), but CI (Swift 6.1.2) unaffected

## Status
Blocked ‚Äî Waiting for upstream SwiftLens library update

## Description
SwiftLens library has data race isolation issues that are detected by Swift 6.2.3's stricter concurrency checking. The `LensObserver` and `LensInteractor` types in SwiftLens need updated isolation annotations to satisfy Swift 6.2+ strict concurrency mode.

**Current State:**
- ‚úÖ CI builds pass (Swift 6.1.2 / Xcode 26.1)
- ‚ùå Local builds fail on Swift 6.2.3+ (Xcode 26.2)
- üö´ All SwiftLens tests disabled via `#if false` guard

**Error:**
```
error: sending 'workbench.observer' risks causing data races
error: sending 'workbench.interactor' risks causing data races
```

## Root Cause
SwiftLens library code predates Swift 6.2's stricter actor isolation checking. The `LensObserver` and `LensInteractor` types need to be updated with proper isolation annotations (`@MainActor`, `nonisolated`, or `Sendable` conformance).

**Location in SwiftLens library:**
- `LensObserver` - tracks visible SwiftUI view state
- `LensInteractor` - simulates user interactions
- These are accessed from `LensWorkBench` in test code

## Objectives
- Monitor SwiftLens repository for Swift 6.2+ compatibility updates
- Re-enable SwiftLens tests when library is updated
- Verify all tests pass on Swift 6.2.3+ locally before pushing

## Acceptance Criteria
1. SwiftLens library updated with Swift 6.2+ compatible isolation annotations
2. Local builds succeed on Swift 6.2.3+ (Xcode 26.2) without data race errors
3. All 4 SwiftLens tests in `AppSmokeTests/SwipePresetSelectionSwiftLensTests.swift` pass
4. Remove `#if false` guard from test file
5. CI continues to pass on Swift 6.1.2 (backward compatibility verified)

## Dependencies
- **Upstream**: SwiftLens library maintainer (https://github.com/gahntpo/SwiftLens)
- **Related**: Issue 02.1.6.6 (SwiftLens Swipe UI Testing)
- **Related**: PR #163 (SwiftLens integration)

## Blocked Tests
**File**: `AppSmokeTests/SwipePresetSelectionSwiftLensTests.swift` (4 tests disabled)

1. `testDownloadPresetAppliesCorrectly_SwiftLens`
2. `testPlaybackPresetAppliesCorrectly_SwiftLens`
3. `testOrganizationPresetAppliesCorrectly_SwiftLens`
4. `testMinimalPresetAppliesCorrectly_SwiftLens`

## Monitoring Strategy

### Option 1: Watch SwiftLens Repository (Recommended)
1. Watch https://github.com/gahntpo/SwiftLens for releases
2. Check release notes for "Swift 6.2", "concurrency", or "isolation" mentions
3. Test locally on Swift 6.2.3+ when new version released

### Option 2: File Issue with SwiftLens
1. Create issue on SwiftLens repo documenting the problem
2. Include error message and Swift 6.2.3 version details
3. Offer to test fixes if maintainer needs validation

### Option 3: Fork and Fix (If Upstream Stalled)
1. Fork SwiftLens repository
2. Apply isolation annotations to `LensObserver` and `LensInteractor`
3. Tag custom release (e.g., `v1.1.1-zpod.swift62`)
4. Update package dependency to use fork

## Re-enablement Steps

When SwiftLens is updated:

1. **Update SwiftLens dependency** to new version:
   ```swift
   // In zpod.xcodeproj/project.pbxproj
   requirement = {
     kind = revision;
     revision = "<new-commit-sha>";  // Or use semantic version if available
   };
   ```

2. **Remove `#if false` guard**:
   ```bash
   # Remove line 1 and line 270 from:
   AppSmokeTests/SwipePresetSelectionSwiftLensTests.swift
   ```

3. **Verify locally on Swift 6.2.3+**:
   ```bash
   # On macOS with Xcode 26.2+
   ./scripts/run-xcode-tests.sh -t AppSmokeTests
   ```

4. **Run full regression**:
   ```bash
   ./scripts/run-xcode-tests.sh
   ```

5. **Update this issue** with test results and close

## Temporary Workaround
The `#if false` guard allows the code to remain in the repository with full git history while preventing compilation errors. This is preferred over:
- ‚ùå Deleting the file (loses history)
- ‚ùå Commenting out with `//` (clutters code)
- ‚ùå Feature flags (overkill for library compatibility)

## Testing Strategy
Once re-enabled, the 4 SwiftLens tests should:
- Execute in <1 second each (in-process, no UI automation)
- Pass with 100% reliability (no timing dependencies)
- Complement existing XCUITest coverage in `zpodUITests/SwipePresetSelectionTests.swift`

## Spec References
- **Issue 02.1.6.6**: SwiftLens Swipe UI Test Coverage
- **Dev-log**: `dev-log/02.1.6.6-swiftlens-swipe-ui-testing.md`
- **SwiftLens Library**: https://github.com/gahntpo/SwiftLens

## Notes
- CI unaffected because GitHub Actions uses Swift 6.1.2 (Xcode 26.1)
- Only developers on Swift 6.2.3+ (Xcode 26.2) encounter this issue
- XCUITest-based swipe tests remain fully functional as alternative
- This does not block SwiftLens adoption for future tests once library updates

---

**Created**: 2025-12-21
**Blocked By**: SwiftLens library Swift 6.2 compatibility
**Monitoring**: https://github.com/gahntpo/SwiftLens
