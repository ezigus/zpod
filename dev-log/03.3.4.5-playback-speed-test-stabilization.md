# 03.3.4.5: Stabilize testPlaybackSpeedChangesPositionRate for CI

## Intent

Fix CI flakiness in PlaybackPositionAVPlayerTests::testPlaybackSpeedChangesPositionRate by:
1. Explicitly enforcing 1.0x baseline speed (currently implicit assumption)
2. Adding stabilization polling after speed changes (no sleep)
3. Lengthening measurement windows from 2s to 3-4s for stability
4. Adding diagnostic logging to understand CI variance

## Root Cause

The test measures position advancement at 1.0x speed (baseline) vs 2.0x speed (fast), then asserts the ratio is ≥1.7x. However:

- **Baseline is not enforced**: Test assumes 1.0x but never sets it
- **CI failure data**: baselineDelta=4.0s over 2.0s window → suggests ~2.0x rate already active
- **Result**: Both baseline and fast measurements capture ~2.0x speed → low ratio (1.25x)

## Timeline Diagram

```
Test Start
    │
    ├─ [NEW] Set speed to 1.0x explicitly
    │        Wait for speed UI to apply (polling)
    │
    ├─ Measure Baseline (3-4s window at 1.0x)
    │  ├─ t=0.0s: capture start position
    │  ├─ t=0.5s: sample (diagnostic)
    │  ├─ t=1.0s: sample (diagnostic)
    │  ├─ t=1.5s: sample (diagnostic)
    │  ├─ t=2.0s: sample (diagnostic)
    │  ├─ t=2.5s: sample (diagnostic)
    │  ├─ t=3.0s: sample (diagnostic)
    │  └─ t=3.5-4.0s: capture end position
    │     baselineDelta = end - start (expect ~3.5-4.0s at 1.0x)
    │
    ├─ Change speed to 2.0x (tap UI)
    │
    ├─ [NEW] Wait for speed stabilization (polling, NOT sleep)
    │        Poll until position advances >baseline rate for 2 consecutive samples
    │
    ├─ Measure Fast (3-4s window at 2.0x)
    │  ├─ t=0.0s: capture start position
    │  ├─ ... (same sampling as baseline)
    │  └─ t=3.5-4.0s: capture end position
    │     fastDelta = end - start (expect ~7-8s at 2.0x)
    │
    └─ Assert: fastDelta / baselineDelta ≥ 1.7x
       With improved measurements: expect ~1.9-2.0x
```

## Expected Outcome

After stabilization:
- Baseline: 3.5-4.0s advancement over 3.5-4.0s window (ratio ~1.0)
- Fast: 7.0-8.0s advancement over 3.5-4.0s window (ratio ~2.0)
- Test ratio: 7.5 / 3.75 ≈ 2.0x >> 1.7x threshold ✅

If ratio still <1.7x after these changes, CI logs will show exactly where the variance is.

## Implementation Steps

### Step 0: ✅ Dev-Log Entry (This Document)
**Status**: Complete
**Date**: 2026-01-10

### Step 1: Verify Speed Option Identifiers
**Status**: ✅ Complete
**Date**: 2026-01-10
**Goal**: Confirm accessibility identifiers for 1.0x and 2.0x speed options

**Findings**:
- Speed Control Button: `"Speed Control"` (EpisodeDetailView.swift:302)
- Speed options generated from `[1.0, 1.5, 2.0]` via ForEach (line 306)
- Identifier pattern: `"PlaybackSpeed.Option.\(label)"` where label is formatted as "X.Xx"
- Confirmed identifiers:
  - `"PlaybackSpeed.Option.1.0x"` for 1.0x
  - `"PlaybackSpeed.Option.2.0x"` for 2.0x
- Test's expected identifiers are correct ✅

### Step 2: Add Diagnostic Logging
**Status**: ✅ Complete
**Date**: 2026-01-10
**Goal**: Add XCTContext.runActivity logging without changing test behavior

**Changes**:
- Added logging for raw slider values at baseline/fast start/end
- Added parsed position values at each measurement point
- Added actual elapsed time tracking for both windows
- Added intermediate sampling every 0.5s (diagnostic only, doesn't affect delta)
- Added computed measurements logging (baseline, fast, ratio, threshold)
- Added pass/fail prediction before assertion
- Build verified: ✅ SUCCESS

### Step 3: Force Baseline Speed to 1.0x
**Status**: ✅ Complete
**Date**: 2026-01-10
**Goal**: Explicitly set playback speed to 1.0x before baseline measurement

**Changes**:
- Added code to tap Speed Control button before baseline measurement
- Tap 1.0x option explicitly (was implicit assumption before)
- Wait for UI settle using `waitUntil` (NOT sleep)
- Verify playback advancing after speed set
- Added comment explaining CI root cause (baselineDelta=4.0s over 2.0s → ~2.0x rate)
- Build verified: ✅ SUCCESS

### Step 4: Stabilization Polling After Speed Change
**Status**: ✅ Complete
**Date**: 2026-01-10
**Goal**: Wait for AVPlayer to apply 2.0x rate before measuring

**Changes**:
- Added wait for speed menu to close after tapping 2.0x
- Implemented heuristic stabilization polling:
  - Poll position every 0.2s
  - Calculate instantaneous rate (position delta / time delta)
  - Threshold: rate > 0.3 indicates faster than 1.0x
  - Require 2 consecutive fast samples to confirm
- Timeout: 2.0s with assertion if stabilization fails
- Uses `waitUntil` polling (NOT sleep) ✅
- Added diagnostic logging for each sample
- Build verified: ✅ SUCCESS

### Step 5: Lengthen Measurement Windows
**Status**: ✅ Complete
**Date**: 2026-01-10
**Goal**: Use 3.5 second windows instead of 2 seconds

**Changes**:
- Changed baseline window from 2.0s to 3.5s
- Changed fast window from 2.0s to 3.5s
- Updated timeouts from 2.4s to 4.0s
- Updated intermediate sampling to go through 3.5s
- Updated logging to reflect 3.5s targets
- Expected measurements:
  - Baseline: ~3.5s advancement at 1.0x speed
  - Fast: ~7.0s advancement at 2.0x speed
  - Ratio: ~2.0x (well above 1.7x threshold)
- Build verified: ✅ SUCCESS

### Step 6: Threshold Adjustment (If Needed)
**Status**: Pending
**Goal**: Data-driven threshold relaxation only after Steps 2-5

### Step 7: Validation
**Status**: Pending
**Goal**: 10 local runs + 3 CI runs to verify stability

### Step 8: Documentation and Cleanup
**Status**: Pending
**Goal**: Update this dev-log with results

## Forbidden Patterns (Critical)

❌ **DO NOT USE**:
- `Thread.sleep()` or any blocking delays
- Background test runs with `&`
- Linear regression or median of multiple windows
- Debug overlay (defer to separate issue if needed)

✅ **DO USE**:
- `waitUntil()` for polling
- `waitForExistence()` for UI elements
- `waitForPlayerTabAdvancement()` for playback verification
- `XCTContext.runActivity()` for diagnostic logging

## Results

*To be filled after implementation*

### Before Fix
- CI Failure: baselineDelta=4.0s, fastDelta=5.0s, ratio=1.25x
- Root Cause: Baseline speed was not enforced (likely 2.0x from previous test)

### After Fix
*Pending implementation*

### Key Changes
*To be documented*

### Follow-Up
*To be documented*
