# Issue #02.6.3.1 - Swipe Configuration Test Cache Fix

**Issue**: CI-only failures in 3 swipe UI test suites due to stale element cache
**Branch**: `copilot/decompose-swipeconfiguration-ui-tests`
**PR**: #134
**Date**: 2025-01-22

## Problem Summary

### Failing Tests (CI Only)

1. `SwipeConfigurationUIDisplayTests` - 3 tests
2. `SwipePresetSelectionTests` - 3 tests  
3. `SwipeExecutionTests` - 1 test

### Root Cause

The test infrastructure caches the sheet container element (`cachedSwipeContainer`) and assumes it remains valid throughout test execution. In CI, SwiftUI appears to dismiss/recreate the sheet between operations, invalidating the cached `XCUIElement` reference.

**Key failure patterns**:

- "No matches found for first query match sequence: Elements matching predicate 'SwipeActions.List' IN identifiers"
- "Swipe configuration sheet container unavailable while applying preset"

### Why It Only Failed in CI

- Local tests run faster with warmer simulators
- CI has additional pre-warming script overhead (~30s of spawning process retries)
- CI simulators are freshly provisioned per job
- Timing differences cause SwiftUI to invalidate/recreate sheets more frequently

## Solution: Eliminate Cache Assumptions

Instead of trusting a cached element, **always re-discover the sheet container** when needed. This is deterministic because it relies on query existence checks, not time-based waits.

### Changes Made

#### 1. `SwipeConfigurationTestSupport+SheetUtilities.swift`

**Removed cache trust** - Always verify sheet exists before returning:

```swift
@MainActor
func swipeActionsSheetListContainer() -> XCUIElement? {
  // Always re-discover instead of trusting cache - SwiftUI may recreate the sheet
  let save = app.buttons.matching(identifier: "SwipeActions.Save").firstMatch
  let cancel = app.buttons.matching(identifier: "SwipeActions.Cancel").firstMatch
  guard
    save.exists || cancel.exists
      || app.staticTexts.matching(identifier: "Swipe Actions").firstMatch.exists
  else {
    return nil
  }
  // ... discovery logic continues ...
}
```

**Key**: Removed `if let cached = cachedSwipeContainer, cached.exists { return cached }` check.

#### 2. `SwipeConfigurationTestSupport+Navigation.swift`

**Changed reuse logic** - Always call discovery function instead of returning cached element:

```swift
@MainActor
@discardableResult
func reuseOrOpenConfigurationSheet(resetDefaults: Bool = false) throws -> XCUIElement? {
  if resetDefaults {
    cachedSwipeContainer = nil
    return try openConfigurationSheetReady(resetDefaults: resetDefaults)
  }
  // Try to discover existing sheet first
  if let container = swipeActionsSheetListContainer() {
    return container
  }
  // Sheet not found, open it
  return try openConfigurationSheetReady(resetDefaults: resetDefaults)
}
```

**Key**: Changed from `if let cached = cachedSwipeContainer, cached.exists` to calling `swipeActionsSheetListContainer()`.

#### 3. `SwipeConfigurationTestSupport+ActionManagement.swift`

**Improved error message** to clarify when sheet is missing:

```swift
@MainActor
func applyPreset(identifier: String) {
  // ... debug overlay checks ...
  
  // Re-discover container to handle sheet state changes
  guard let container = swipeActionsSheetListContainer() else {
    XCTFail("Swipe configuration sheet not found. Sheet may have been dismissed or not yet opened.")
    return
  }
  // ... rest of method ...
}
```

## Why This Is Deterministic

✅ **No waits** - Uses only synchronous `exists` checks on query results
✅ **No timeouts** - Either element exists now or it doesn't  
✅ **No timing dependencies** - Discovery is query-based, not time-based
✅ **Handles SwiftUI lifecycle** - Re-discovers sheet every time, catching recreation

## Testing Plan

### Local Validation

```bash
# Run each failing test suite individually
./scripts/run-xcode-tests.sh -t zpodUITests/SwipeConfigurationUIDisplayTests
./scripts/run-xcode-tests.sh -t zpodUITests/SwipePresetSelectionTests  
./scripts/run-xcode-tests.sh -t zpodUITests/SwipeExecutionTests

# Run full regression
./scripts/run-xcode-tests.sh
```

### CI Validation

Push to PR #134 and verify all 3 swipe test suites pass in the `ui-tests-swipe` matrix job.

## Architecture Notes

### Cache Still Exists (For Now)

The `cachedSwipeContainer` variable still exists and is set in `openConfigurationSheetReady()`, but it's no longer trusted as the source of truth. This allows for potential future optimization if we determine the cache is reliable in certain contexts.

### Future Consideration

If this pattern proves stable, consider removing `cachedSwipeContainer` entirely and always use fresh queries. The discovery logic already has multiple fallback strategies, so performance impact should be minimal.

## Acceptance Criteria

- [x] Changes compile without errors
- [ ] Local test runs pass consistently
- [ ] CI test runs pass in PR #134
- [ ] No new `waitForExistence()` calls added
- [ ] Solution uses only deterministic query checks

## Related Documentation

- PR #134: "[#02.6.3] Hybrid tier architecture for swipe UI tests"
- Root cause analysis in GitHub Actions run 19597330948 logs
- AGENTS.md terminal command guidelines (no waits, no background execution)

## 2025-11-24 11:34 ET – Implementation and rediscovery hardening

- Removed all reliance on `cachedSwipeContainer` when reusing the configuration sheet; `reuseOrOpenConfigurationSheet` now re-discovers before opening and resets both the cache and `sectionsMaterialized` flag when defaults are reset.
- `swipeActionsSheetListContainer()` always performs fresh queries and `ensureVisibleInSheet` now refreshes the container/target before every scroll, keeping the scroll surface valid when SwiftUI rebuilds the sheet.
- Debug helpers standardized to a 2s timeout with early validator exit; toggle assertions drop the retry loop and rely on the refreshed container plus debug state consistency.
- Added `sectionsMaterialized` guard to run section materialization only once per test, with reset on cache clear to avoid stale state across test-level relaunches.
- Next: run targeted swipe suites and full regression to validate the rediscovery path; update acceptance criteria with results.

## 2025-11-24 12:05 ET – Failure analysis + stabilization plan

### What broke
- The new reuse path tries to rediscover the sheet before launching the app. In `SwipeConfigurationUIDisplayTests`, `app` is still `nil` on the first call, so accessing `app.buttons` in `swipeActionsSheetListContainer()` traps (IUO crash).
- State flags (`cachedSwipeContainer`, `sectionsMaterialized`) can drift: some paths reset one but not the other; rediscovery + relaunch + seeds all interact.
- Multiple overlapping waits (`waitForSectionMaterialization`, `waitForSectionIfNeeded`, ensure-visible refresh) increase timeout surface and mask real failures.
- Mixed debug overlay defaults (`UITEST_SWIPE_DEBUG` on by default, off in display tests) create divergent helper behavior.

### Simplification / stabilization plan
1) Single entry point: Replace the rediscover-first flow with a single `openOrReuseConfigurationSheet(resetDefaults:)` that always ensures the app is launched, opens the sheet, then returns a freshly-discovered container. Remove discovery-before-launch.
2) Drop cross-call cache/flags: Stop persisting `cachedSwipeContainer` and `sectionsMaterialized` across helper calls. Discover after opening each time; optional per-call reuse only if `.exists` right now.
3) Guard `app`: Make all discovery helpers early-return nil (or XCTFail) if `app` is nil/not running. Convert the IUO access into a safe getter so we fail the test, not crash.
4) Consolidate waits: Keep a single readiness check (section materialization) after opening; remove redundant `waitForSectionIfNeeded` and stacked waits in the display tests. Use identifiers + one materialization probe.
5) Scroll minimalism: Keep container discovery, but only refresh the container when it’s missing/empty/hittable=false; avoid per-scroll refresh churn and cap scroll attempts with explicit failure.
6) Debug mode consistency: Pick one default (likely keep debug overlay on in helpers) and gate overlay-dependent checks. Ensure display tests either opt in or skip overlay-only probes.
7) Per-test isolation: Relaunch/reset defaults per test in swipe suites to avoid cross-test state; seeds remain per test where required.

### Execution steps (next work block)
- Implement items 1–4 first to unblock crashes and reduce state drift.
- Run `./scripts/run-xcode-tests.sh -t zpodUITests/SwipeConfigurationUIDisplayTests` to confirm crash removal; then the other swipe suites as time permits.
- If stable, follow with items 5–7 to further simplify and harden timing/scroll behavior; update acceptance criteria and PR notes accordingly.

## 2025-11-24 12:35 ET – Crash fix attempt + current status

### Changes applied
- Removed cross-call caching flags (`cachedSwipeContainer`, `sectionsMaterialized`); each helper call now discovers fresh containers after opening the sheet.
- `reuseOrOpenConfigurationSheet` now launches the app first when needed and only rediscover after confirming the app is running; no discovery-before-launch paths remain.
- `swipeActionsSheetListContainer` guards against nil/not-running apps and no longer caches the container; discovery exits gracefully instead of crashing.

### Targeted test result
- `./scripts/run-xcode-tests.sh -t zpodUITests/SwipeConfigurationUIDisplayTests` (iPhone 17 Pro, iOS 26.1): crash resolved, but test fails because `SwipeActions.Preset.Playback` is not surfaced within 1s in `testAllSectionsAppearInSheet`. Exit status 65 due to result inspection; see `TestResults/TestResults_20251124_074032_test_zpodUITests-SwipeConfigurationUIDisplayTests.log`.

### Next focus
- Investigate why preset button isn’t surfaced post-simplification (likely scroll/materialization logic or debug overlay off in display tests). Adjust visibility helper/timeouts per plan items 5–7 if needed.

### Detailed plan for steps 5–7
5) Scroll minimalism (targeted):
   - Only refresh container when `exists == false` or `frame.isEmpty`; keep the same container during a scroll sweep.
   - Cap scroll attempts: top reset (1), downward sweep (2), upward sweep (1). Fail with a clear XCTFail and attach visible identifiers.
   - Make preset/toggle visibility timeouts consistent (e.g., 2s) and avoid nested waiters inside ensure-visible.

6) Debug mode consistency:
   - Set a single default (debug overlay ON) in helpers; display tests explicitly disable but skip overlay-only probes.
   - Gate all overlay-dependent helpers behind a check; no helper should assume overlay identifiers when disabled.
   - Ensure materialization/waits behave the same regardless of debug flag.

7) Per-test isolation:
   - Always relaunch + reset defaults per test in swipe suites (including display tests) unless a seed is supplied for that test.
   - Remove lingering shared state between tests; treat `seededConfigurationPayload` as per-test only.
   - After relaunch, perform a single section materialization check and reuse that within the test scope (no cross-test reuse).

Execution sequencing for 5–7:
1. Implement scroll minimalism + consistent timeouts in `ensureVisibleInSheet` and preset/toggle visibility helpers.
2. Standardize debug overlay handling and guard overlay-dependent code paths.
3. Enforce per-test relaunch/reset semantics and ensure seeds are per-test.
4. Rerun `SwipeConfigurationUIDisplayTests`, then the other swipe suites; update acceptance criteria and PR notes with results.

## 2025-11-24 12:58 ET – Execution of steps 5–7 (partial) + status

### Changes applied
- Per-test isolation: `openConfigurationSheetReady` now launches once per test (resets when requested) and avoids discovery-before-launch paths. `hasLaunchedForCurrentSeed` resets in tearDown.
- Scroll minimalism: `ensureVisibleInSheet` refreshes the container only when missing/empty, caps sweeps (1 top reset, 2 down, 1 up), and logs explicit failures.
- Timeout alignment: increased short readiness timeout to 2.0s (CI)/1.5s (local) to give preset/toggle visibility consistent breathing room.
- Cache/flag removal held: no cross-call cached container/section flags remain; each open rediscoveries fresh containers.

### Outstanding issues
- Harness failure: `./scripts/run-xcode-tests.sh -t zpodUITests/SwipeConfigurationUIDisplayTests` now exits with “script error at line 159” (category_in path) and status 65; no suites reported. Log: `TestResults/TestResults_20251124_074842_test_zpodUITests-SwipeConfigurationUIDisplayTests.log`. Needs harness fix before validating the UI tests.
- Prior run (before this harness failure) still missed `SwipeActions.Preset.Playback` within 1s; visibility may need further tuning once the harness is fixed.

### Next actions
- Fix the harness error around line 159 in `scripts/run-xcode-tests.sh` (category_in/summary printing) so summaries don’t abort on empty/missing results.
- Rerun `zpodUITests/SwipeConfigurationUIDisplayTests`; if preset still missing, adjust ensure-visible/preset waits and debug-mode gating per the remaining plan items.
