# Dev Log: Issue 27.1.1.4 — Orphaned Episodes UI

## Intent (2026-02-02)
- Surface episodes that were removed from feeds but preserved because they hold user state.
- Allow users to review and delete these “orphaned” episodes (single + bulk).
- Keep behavior consistent with SwiftData persistence and iPhone 16 simulator (iOS 18).

## Spec Traceability
- Adds scenario under **Download and Sync Management** in `zpod/spec/spec.md`: “Users Can View and Manage Orphaned Episodes.”

## Design Notes
- Persistence will tag preserved, feed-removed episodes with `isOrphaned: Bool` and `dateOrphaned: Date?`.
- Sync rules:
  - When a feed omits an episode with user state → set `isOrphaned = true` and keep the row.
  - When the episode reappears in a later feed → clear `isOrphaned`, `dateOrphaned`.
  - Unsubscribe path still deletes everything (explicit user intent).
- Fetch helpers:
  - `fetchOrphanedEpisodes()` returns only `isOrphaned == true`.
  - Delete helpers: `deleteOrphanedEpisode(id:)`, `deleteAllOrphanedEpisodes()`.
- UI entry: Settings › Storage › “Orphaned Episodes”; list rows show title, podcast, badges (progress/download/favorite/archived/rating) and reason. Empty state when none.

```mermaid
flowchart TD
  FeedRefresh -->|removed + hasUserState| MarkOrphan[Mark isOrphaned = true, dateOrphaned = now]
  FeedRefresh -->|still in feed| ClearOrphan[Clear isOrphaned/dateOrphaned]
  FeedRefresh -->|removed + no state| DeleteRow[Delete episode]

  UI[List] --> Fetch[fetchOrphanedEpisodes()]
  UIDeleteOne[Delete one] --> DeleteHelper[deleteOrphanedEpisode]
  UIBulkDelete[Delete all] --> DeleteAllHelper[deleteAllOrphanedEpisodes]
```

## TDD Plan
1) **Specs**: Add scenario to spec.md.
2) **Unit tests (Persistence)**: orphan marking/clearing, fetch, delete, unsubscribe cascade.
3) **Entity tests**: defaults + dateOrphaned behavior.
4) **Integration test**: seed → orphan → fetch → delete all.
5) **UI tests**: navigation, list, delete single/bulk, empty state, play attempt.
6) Implement to make tests green; rerun targeted suites then full script.

## Follow-up: Simulator Boot Timing & Timeout (2026-02-02)
- Problem: single timeout currently conflates simulator boot/contended provisioning with test execution, causing 900s watchdog to kill runs without insight.
- Plan: pre-flight boot the chosen simulator with `simctl boot` + `bootstatus -b -t <seconds>` using a dedicated timeout (env `ZPOD_SIM_BOOT_TIMEOUT_SECONDS`, default 180). Log start/end + elapsed via `log_time`.
- After boot completes (or if already booted), run `xcodebuild` under existing `ZPOD_XCODEBUILD_TIMEOUT_SECONDS` watchdog; log elapsed separately.
- Validation: run a targeted UI test (`zpodUITests/OrphanedEpisodesUITests`) locally and confirm log shows boot timing + test timing and respects new timeout.

## Risks / Watch
- Migration: new fields must default safely; add tests for default false.
- Dead audio URLs: handle gracefully in UI (error toast); document limitation.
- Performance: large orphan set—predicate on `isOrphaned` should be indexable if needed.

## Done / Next
- [x] Spec updated
- [x] Tests added (red)
- [x] Implementation
- [x] Targeted runs
- [x] Full pipeline
- [ ] Gap fix follow-up (2026-02-02): address playback validity handling, reason badges completeness, single-delete UI + deleteOne VM tests, and ensure orphan filtering in primary lists; keep scope tightly aligned to Issue 27.1.1.4 acceptance.
- [x] (2026-02-02) Added Settings badge showing orphaned episode count (scope creep request)
- [x] (2026-02-02) Add separate simulator-boot timing/timeout in test harness; log elapsed per phase; verify via targeted UI test (boot timing logged; targeted UITest currently flaky with runner interruption after tearDown—see TestResults_20260202_154515_test_zpodUITests-OrphanedEpisodesUITests.log)
