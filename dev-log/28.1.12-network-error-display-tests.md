# 2026-02-09 — Issue 28.1.12 Network Error Display UI Tests

## Intent / Scope
- Implement Issue `28.1.12` by replacing the two `XCTSkip` placeholders in `StreamingInterruptionUITests` with active assertions for:
  - playback error message visibility
  - retry control availability for recoverable errors
- Extend the existing Issue `28.1.11` simulation hook infrastructure with deterministic playback-error injection from UI tests.
- Include the scoped follow-up from Issue `28.1.12`: split simulation control visibility by env flag (`UITEST_NETWORK_SIMULATION` vs `UITEST_BUFFER_SIMULATION`).

## Design Constraints
- Follow the existing notification-bridge pattern (`button -> notification -> manager -> playback simulation controller`).
- Keep simulation runtime overhead zero when no simulation env flags are enabled.
- Preserve SwiftUI/XCUITest reliability patterns (`.matching(identifier:).firstMatch`, wait helpers, no fixed sleeps in UI tests).
- Keep `03.3.4` error surface identifiers as the assertion contract (`MiniPlayer.ErrorMessage`, `MiniPlayer.RetryButton`, `ExpandedPlayer.RetryButton`).

## Proposed Flow
```mermaid
flowchart TD
  A[UITEST_NETWORK_SIMULATION / UITEST_BUFFER_SIMULATION / UITEST_PLAYBACK_ERROR_SIMULATION] --> B[EpisodeDetailView test hook controls]
  B --> C[NotificationCenter posts simulation event]
  C --> D[NetworkSimulationOverlayManager observers]
  D --> E[PlaybackEnvironment.playbackService as NetworkSimulationControlling]
  E --> F[EnhancedEpisodePlayer simulatePlaybackError -> failPlayback(.networkError)]
  F --> G[Playback state emits .failed]
  G --> H[MiniPlayerViewModel / ExpandedPlayerViewModel]
  H --> I[MiniPlayer.ErrorMessage + Retry / ExpandedPlayer.RetryButton visible]
```

## TDD Plan
1. Capture baseline run for `StreamingInterruptionUITests` to preserve pre-change behavior.
2. Make UI tests fail first:
   - unskip `testNetworkErrorMessageDisplays`
   - unskip `testRetryButtonAvailableAfterError`
   - add explicit per-flag simulation-control visibility assertions
3. Make engine-level tests fail for playback-error simulation behavior (`EnhancedEpisodePlayerNetworkSimulationTests`).
4. Implement production changes to satisfy failing tests:
   - notifications + manager routing
   - simulation controller API + engine behavior
   - EpisodeDetailView test hook and per-flag control rendering
5. Run targeted suites until green.
6. Run full regression with `./scripts/run-xcode-tests.sh`.

## Open Decisions
- Error injection should use a recoverable `PlaybackError` (`.networkError`) so retry-button AC is satisfiable.
- Error hook env gate will be explicit (`UITEST_PLAYBACK_ERROR_SIMULATION`) and may also allow operation when network simulation is enabled for compatibility.

## Baseline
- Command: `./scripts/run-xcode-tests.sh -t zpodUITests/StreamingInterruptionUITests`
- Date: 2026-02-09 07:43-07:46 ET
- Result: `7 run, 5 passed, 0 failed, 2 skipped` (exit `0`)
- Log: `TestResults/TestResults_20260209_074413_test_zpodUITests-StreamingInterruptionUITests.log`
- xcresult: `TestResults/TestResults_20260209_074413_test_zpodUITests-StreamingInterruptionUITests.xcresult`
- Skips still present by design pre-28.1.12:
  - `testNetworkErrorMessageDisplays`
  - `testRetryButtonAvailableAfterError`

## Red Cycle 1 — UI Tests
- Updated `zpodUITests/StreamingInterruptionUITests.swift`:
  - Unskipped:
    - `testNetworkErrorMessageDisplays`
    - `testRetryButtonAvailableAfterError`
  - Added per-flag visibility tests:
    - `testNetworkSimulationFlagShowsOnlyNetworkControls`
    - `testBufferSimulationFlagShowsOnlyBufferControls`
  - Added helper `injectPlaybackErrorViaSimulationHook()` requiring `TestHook.SimulatePlaybackError`.
- Command: `./scripts/run-xcode-tests.sh -t zpodUITests/StreamingInterruptionUITests`
- Date: 2026-02-09 07:47-07:51 ET
- Result: `9 run, 7 passed, 2 failed, 0 skipped` (exit `65`)
- Log: `TestResults/TestResults_20260209_074808_test_zpodUITests-StreamingInterruptionUITests.log`
- Expected red failures:
  - `testNetworkErrorMessageDisplays` (`Playback error simulation hook should inject an error`)
  - `testRetryButtonAvailableAfterError` (`Playback error simulation hook should inject an error`)

## Red Cycle 2 — PlaybackEngine Tests
- Updated `Packages/PlaybackEngine/Tests/EnhancedEpisodePlayerNetworkSimulationTests.swift` with:
  - `testSimulatedPlaybackErrorPublishesRecoverableFailedState`
  - Explicit recoverable error expectation: `.networkError` (not `.streamFailed`)
- Command: `./scripts/run-xcode-tests.sh -t PlaybackEngine`
- Date: 2026-02-09 07:52 ET
- Result: compile failure (exit `1`)
- Log: `TestResults/TestResults_20260209_075216_test_pkg_PlaybackEngine.log`
- Expected red failure:
  - `EnhancedEpisodePlayer` has no `simulatePlaybackError()` member yet

## Green Cycle 1 — Hook Infrastructure + UI Gating
- Implemented notification bridge additions:
  - `Packages/SharedUtilities/Sources/SharedUtilities/NetworkSimulationNotifications.swift`
    - `PlaybackErrorSimulationType.recoverableNetworkError`
    - `NetworkSimulationNotificationKey.playbackErrorType`
    - `Notification.Name.playbackErrorSimulation`
- Extended simulation control protocol + engine:
  - `Packages/PlaybackEngine/NetworkSimulationControlling.swift`
    - added `simulatePlaybackError()`
  - `Packages/PlaybackEngine/EnhancedEpisodePlayer.swift`
    - `simulatePlaybackError()` routes to `failPlayback(error: .networkError)`
- Extended manager bridge:
  - `Packages/LibraryFeature/Sources/LibraryFeature/NetworkSimulationOverlayManager.swift`
    - env gate `UITEST_PLAYBACK_ERROR_SIMULATION`
    - playback error observer wiring
    - routing to `controller.simulatePlaybackError()`
- Extended app-level lazy activation gate:
  - `zpod/ZpodApp.swift`
    - initializes `NetworkSimulationOverlayManager.shared` when `UITEST_PLAYBACK_ERROR_SIMULATION=1`
- Updated test hook UI and per-flag control visibility:
  - `Packages/PlayerFeature/Sources/PlayerFeature/EpisodeDetailView.swift`
    - network controls only under `UITEST_NETWORK_SIMULATION=1`
    - buffer controls only under `UITEST_BUFFER_SIMULATION=1`
    - added `TestHook.SimulatePlaybackError` under `UITEST_PLAYBACK_ERROR_SIMULATION=1`

## Investigation Finding (08:10 ET)
- `testNetworkErrorMessageDisplays` still failed after hook wiring in earlier runs.
- Root cause: `PlaybackStateCoordinator` handled `.failed` states by immediately calling `pause()`, which emitted `.paused` and cleared error UI state in mini/expanded player view models before assertions could observe it.

## Green Cycle 2 — Preserve Error Surface on `.failed`
- Updated `Packages/LibraryFeature/Sources/LibraryFeature/PlaybackStateCoordinator.swift`:
  - `presentAlert` now accepts `shouldPausePlayback`.
  - `.failed` playback-state handling now calls `presentAlert(..., shouldPausePlayback: false)` (no redundant pause emission).
  - explicit `reportPlaybackError(...)` path still pauses playback (`shouldPausePlayback: true`).
  - resume-state-expired alert path uses `shouldPausePlayback: false`.
- Added targeted coordinator coverage:
  - `Packages/LibraryFeature/Tests/LibraryFeatureTests/PlaybackStateCoordinatorTests.swift`
    - `testFailedStateDoesNotPausePlaybackServiceBeforePresentingAlert`
    - `testReportPlaybackErrorStillPausesPlaybackService`
    - mock now tracks `pauseCallCount`

## Green Validation
- `./scripts/run-xcode-tests.sh -t LibraryFeature`
  - Date: 2026-02-09 08:12 ET
  - Result: pass (`21/21`)
  - Log: `TestResults/TestResults_20260209_081244_test_pkg_LibraryFeature.log`

- `./scripts/run-xcode-tests.sh -t zpodUITests/StreamingInterruptionUITests/testNetworkErrorMessageDisplays,zpodUITests/StreamingInterruptionUITests/testRetryButtonAvailableAfterError,zpodUITests/StreamingInterruptionUITests/testNetworkSimulationFlagShowsOnlyNetworkControls,zpodUITests/StreamingInterruptionUITests/testBufferSimulationFlagShowsOnlyBufferControls`
  - Date: 2026-02-09 08:13-08:21 ET
  - Result: pass (`4/4`)
  - Logs:
    - `TestResults/TestResults_20260209_081334_test_zpodUITests-StreamingInterruptionUITests-testNetworkErrorMessageDisplays.log`
    - `TestResults/TestResults_20260209_081525_test_zpodUITests-StreamingInterruptionUITests-testRetryButtonAvailableAfterError.log`
    - `TestResults/TestResults_20260209_081726_test_zpodUITests-StreamingInterruptionUITests-testNetworkSimulationFlagShowsOnlyNetworkControls.log`
    - `TestResults/TestResults_20260209_081927_test_zpodUITests-StreamingInterruptionUITests-testBufferSimulationFlagShowsOnlyBufferControls.log`

## Acceptance Criteria Check
- [x] `testNetworkErrorMessageDisplays()` unskipped and passing
- [x] `testRetryButtonAvailableAfterError()` unskipped and passing
- [x] `TestHook.SimulatePlaybackError` added and env-gated
- [x] Bridge path implemented (`button -> notification -> manager -> engine`)
- [x] Zero runtime work when env flags are absent (manager creation remains env-gated)
- [x] Network/buffer controls split by dedicated env flags
