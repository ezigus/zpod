# 2026-02-09 â€” Issue 28.1.12 Network Error Display UI Tests

## Intent / Scope
- Implement Issue `28.1.12` by replacing the two `XCTSkip` placeholders in `StreamingInterruptionUITests` with active assertions for:
  - playback error message visibility
  - retry control availability for recoverable errors
- Extend the existing Issue `28.1.11` simulation hook infrastructure with deterministic playback-error injection from UI tests.
- Include the scoped follow-up from Issue `28.1.12`: split simulation control visibility by env flag (`UITEST_NETWORK_SIMULATION` vs `UITEST_BUFFER_SIMULATION`).

## Design Constraints
- Follow the existing notification-bridge pattern (`button -> notification -> manager -> playback simulation controller`).
- Keep simulation runtime overhead zero when no simulation env flags are enabled.
- Preserve SwiftUI/XCUITest reliability patterns (`.matching(identifier:).firstMatch`, wait helpers, no fixed sleeps in UI tests).
- Keep `03.3.4` error surface identifiers as the assertion contract (`MiniPlayer.ErrorMessage`, `MiniPlayer.RetryButton`, `ExpandedPlayer.RetryButton`).

## Proposed Flow
```mermaid
flowchart TD
  A[UITEST_NETWORK_SIMULATION / UITEST_BUFFER_SIMULATION / UITEST_PLAYBACK_ERROR_SIMULATION] --> B[EpisodeDetailView test hook controls]
  B --> C[NotificationCenter posts simulation event]
  C --> D[NetworkSimulationOverlayManager observers]
  D --> E[PlaybackEnvironment.playbackService as NetworkSimulationControlling]
  E --> F[EnhancedEpisodePlayer simulatePlaybackError -> failPlayback(.networkError)]
  F --> G[Playback state emits .failed]
  G --> H[MiniPlayerViewModel / ExpandedPlayerViewModel]
  H --> I[MiniPlayer.ErrorMessage + Retry / ExpandedPlayer.RetryButton visible]
```

## TDD Plan
1. Capture baseline run for `StreamingInterruptionUITests` to preserve pre-change behavior.
2. Make UI tests fail first:
   - unskip `testNetworkErrorMessageDisplays`
   - unskip `testRetryButtonAvailableAfterError`
   - add explicit per-flag simulation-control visibility assertions
3. Make engine-level tests fail for playback-error simulation behavior (`EnhancedEpisodePlayerNetworkSimulationTests`).
4. Implement production changes to satisfy failing tests:
   - notifications + manager routing
   - simulation controller API + engine behavior
   - EpisodeDetailView test hook and per-flag control rendering
5. Run targeted suites until green.
6. Run full regression with `./scripts/run-xcode-tests.sh`.

## Open Decisions
- Error injection should use a recoverable `PlaybackError` (`.networkError`) so retry-button AC is satisfiable.
- Error hook env gate will be explicit (`UITEST_PLAYBACK_ERROR_SIMULATION`) and may also allow operation when network simulation is enabled for compatibility.

## Baseline
- Command: `./scripts/run-xcode-tests.sh -t zpodUITests/StreamingInterruptionUITests`
- Date: 2026-02-09 07:43-07:46 ET
- Result: `7 run, 5 passed, 0 failed, 2 skipped` (exit `0`)
- Log: `TestResults/TestResults_20260209_074413_test_zpodUITests-StreamingInterruptionUITests.log`
- xcresult: `TestResults/TestResults_20260209_074413_test_zpodUITests-StreamingInterruptionUITests.xcresult`
- Skips still present by design pre-28.1.12:
  - `testNetworkErrorMessageDisplays`
  - `testRetryButtonAvailableAfterError`
