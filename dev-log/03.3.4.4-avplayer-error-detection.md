# Dev Log: Issue 03.3.4.4 â€” AVPlayer Error Detection

**Issue**: [#321](https://github.com/ezigus/zpod/issues/321)  
**Branch**: `03.3.4.4-error-detection`  
**Status**: ðŸš§ In Progress  
**Started**: 2026-01-09

## Goal

Bridge the gap between AVPlayer's raw failures and the `PlaybackError` enum so the player UI can show the right message, and log the diagnostic context (episode ID, URL, error code) for triage.

## Design Strategy

1. **Error mapping**  
   AVPlayer/AVPlayerItem errors tend to surface as `NSError`s; create `AVPlayerPlaybackEngine.mapAVError(_:)` to translate common domains/codes (`NSURLErrorDomain` â†’ `.networkError`/`.timeout`, `AVFoundationErrorDomain` â†’ `.streamFailed`, fallback to `.unknown`).  
2. **Failure observation**  
   Extend the engine's existing status observer with the new mapping and add a listener for `AVPlayerItemFailedToPlayToEndTime` so we catch both KVO and notification-driven errors. Both paths should feed `onError` with the mapped `PlaybackError`.  
3. **Logging & diagnostics**  
   Log each failure in `EnhancedEpisodePlayer.failPlayback(error:)` using a dedicated `Logger` so the entry includes episode ID, title, audio URL, and the `PlaybackError`. This keeps domain knowledge (episode metadata) inside the player while surface-level errors stay inside the engine.  
4. **Missing audio signal**  
   When the enhanced player tries to use the AVPlayer engine but the episode lacks an audio URL, log the situation and emit `.missingAudioURL` instead of `.episodeUnavailable`, matching the spec.

## Testing Plan

- Extend `AVPlayerPlaybackEngineTests` with mapping-focused tests:
  1. `mapAVError` returns `.networkError` for `NSURLErrorNotConnectedToInternet`.  
  2. `mapAVError` returns `.timeout` for `NSURLErrorTimedOut`.  
  3. `mapAVError` treats unexpected NSError as `.unknown` (with message).  
- Add state-based check in `EnhancedEpisodePlayerAudioIntegrationTests` to confirm playing an episode without an audio URL transitions to `.failed(..., .missingAudioURL)`.
- Confirm the existing invalid URL integration test still asserts `.streamFailed` (no logical change).

## Tasks

1. Implement `mapAVError` and wire it into `observePlayerStatus()` / failure notification.  
2. Ensure `onError` always receives the mapped `PlaybackError`.  
3. Add OSLog logger and detailed error logging inside `EnhancedEpisodePlayer.failPlayback(error:)`.  
4. Update the nil-audio branch to use `.missingAudioURL`.  
5. Add the new tests described above.  
6. Record manual verification notes (VoiceOver or manual tests not needed for this issue; engine logic only).
