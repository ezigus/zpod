# Implementation Plan: Issue 28.1.13 — Final Acceptance Criteria Completion

**Created:** 2026-02-16
**Branch:** `feat/-issue-28-1-13-final-acceptance-criteria-403`
**GitHub Issue:** #403 (OPEN)

## Current State Assessment

**Prior work merged:** PR #406 (download state seeding, streaming simulation hooks, harness fix)

### What's Already Done
- AC9 (Siri Snapshots): **COMPLETE**
- Download state seeding infrastructure: working (27 integration tests, 6 UI tests pass)
- Streaming simulation hooks: fully wired (network/buffer/error simulation controls in EpisodeDetailView)
- Streaming UI tests: 15 tests across interruption, buffering, seeking, error types
- Retry delays: Code already matches spec (2s, 5s, 10s) — doc comment is stale but code is correct
- Offline playback UI tests: 8 tests covering badges, offline error, deletion

### What Remains (Acceptance Criteria Gaps)

**Offline Playback (AC10) — 3 gaps:**
1. **Download Cancellation test** — No UI element exists for cancel (only pause/resume). Need: add `.cancelDownload` swipe action + UI test
2. **Fallback-to-Streaming behavioral test** — Current integration tests only validate data model contract. Missing: test of actual localFileProvider fallback path
3. **Download Resume After Network Loss** — Current tests only cover seeded pause state, not network-interruption-triggered pause

**Streaming Playback (AC10) — 3 gaps:**
1. **Stale doc comment** — `StreamingErrorHandler.swift` lines 48-51 say "5s, 15s, 60s" but code is `[2.0, 5.0, 10.0]`
2. **HTTP Range Request integration test** — No test verifying Range headers
3. **Retry backoff integration test** — UI tests verify retry UI but not timing/position preservation

---

## Files to Modify

### Priority 0: Cosmetic / Alignment
- `Packages/PlaybackEngine/Sources/PlaybackEngine/StreamingErrorHandler.swift` — Fix stale doc comment

### Priority 1: Download Cancellation (New Capability + Tests)
- `Packages/CoreModels/Sources/CoreModels/SwipeActionSettings.swift` — Add `.cancelDownload` to `SwipeActionType`
- `Packages/LibraryFeature/Sources/LibraryFeature/EpisodeListView.swift` — Wire `.cancelDownload` swipe action
- `Packages/LibraryFeature/Sources/LibraryFeature/SwipeActionView.swift` — Add icon/label
- `zpodUITests/DownloadFlowUITests.swift` — Add `testCancelDownloadResetsState()`
- `zpodUITests/TestSupport/SwipeConfigurationSeeding.swift` — Add `.cancelDownloadFocused` preset

### Priority 2: Fallback-to-Streaming Integration Test
- `IntegrationTests/OfflinePlaybackIntegrationTests.swift` — Add fallback behavior tests

### Priority 3: Streaming Integration Tests
- `Packages/PlaybackEngine/Tests/PlaybackEngineTests/StreamingErrorHandlerTests.swift` — Add/verify retry tests
- `IntegrationTests/StreamingEdgeCaseIntegrationTests.swift` — **New file**

### Priority 4: Issue/Spec Updates
- `Issues/28.1.13-final-acceptance-criteria-completion.md` — Update status
- `dev-log/28.1.13-final-acceptance-criteria-completion.md` — Add completion notes

---

## Implementation Steps

### Step 1: Fix StreamingErrorHandler Doc Comment
Update lines 48-51 from "5s, 15s, 60s" to "2s, 5s, 10s". Code already matches spec.

### Step 2: Add `.cancelDownload` Swipe Action
1. Add `case cancelDownload` to `SwipeActionType`
2. Icon: `xmark.circle.fill`, tint red, label "Cancel Download"
3. Visibility: only when `downloadStatus == .downloading || .paused`
4. Wire to `viewModel.cancelEpisodeDownload(episodeId:)`

### Step 3: Add Download Cancellation UI Test
- Seed episode as downloading at 50%, swipe config with `.cancelDownload`
- Swipe left, tap "Cancel Download"
- Assert: download status disappears, progress indicator gone

### Step 4: Add Fallback-to-Streaming Integration Tests
- `testLocalFileProviderFallbackToStreamingURL()` — localFileProvider returns nil → uses audioURL
- `testDownloadedEpisodeUsesLocalFile()` — localFileProvider returns file URL → uses local

### Step 5: Add Streaming Integration Tests
- `testRetryBackoffDelaysMatchSpec()` — 3 retries, correct state transitions
- `testNonRetryableErrorSkipsRetry()` — 404 → immediate `.failed`
- `testRetryableErrorPreservesPosition()` — position not reset after retry

### Step 6: Check existing StreamingErrorHandler unit tests for overlap

### Step 7: Run targeted test suites

### Step 8: Run full regression

### Step 9: Update issue documentation, commit, push

---

## Task Checklist

- [ ] Task 1: Fix StreamingErrorHandler doc comment
- [ ] Task 2: Add `.cancelDownload` to `SwipeActionType` enum
- [ ] Task 3: Wire `.cancelDownload` visibility and action handler
- [ ] Task 4: Add `cancelDownloadFocused` swipe preset to test support
- [ ] Task 5: Add `testCancelDownloadResetsState()` UI test
- [ ] Task 6: Add fallback-to-streaming integration tests
- [ ] Task 7: Create `StreamingEdgeCaseIntegrationTests.swift`
- [ ] Task 8: Run targeted test suites
- [ ] Task 9: Run full regression
- [ ] Task 10: Update issue file and dev-log
- [ ] Task 11: Commit, push, update PR #403

---

## Testing Approach

### Unit/Integration Layer
- `DownloadStateSeedingIntegrationTests` — existing 27 tests (no changes)
- `OfflinePlaybackIntegrationTests` — add 2 fallback behavior tests
- `StreamingEdgeCaseIntegrationTests` — new file with 3 retry contract tests

### UI Layer
- `DownloadFlowUITests` — add 1 cancel test (total: 7)
- `OfflinePlaybackUITests` — existing 8 tests (verify pass)
- `StreamingInterruptionUITests` — existing 15 tests (verify pass)

### Full Regression
- `./scripts/run-xcode-tests.sh` — syntax → AppSmoke → workspace build → all packages → integration → UI → lint

---

## Definition of Done

- [ ] All 12 offline playback spec scenarios have corresponding tests
- [ ] All 7 streaming playback error/edge-case spec scenarios have corresponding tests
- [ ] Download cancellation exposed via swipe action and tested
- [ ] Fallback-to-streaming behavior tested at integration level
- [ ] Retry backoff contract verified at integration level
- [ ] StreamingErrorHandler doc comment matches actual delays
- [ ] Zero `XCTSkip` in download or offline playback test files
- [ ] Full regression passes
- [ ] Issue file updated with 100% completion status
- [ ] PR pushed and ready for review

---

## Risks and Mitigations

| Risk | Mitigation |
|------|-----------|
| `.cancelDownload` breaks existing swipe configs | Opt-in only; not in default presets |
| `localFileProvider` not easily mockable | Test at protocol level if needed |
| Streaming integration tests need `@testable import` | Use `IntegrationTests/` target |
| UI test flakiness on CI | Seed-first approach; deterministic state |
