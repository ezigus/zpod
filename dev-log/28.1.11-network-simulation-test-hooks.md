# 2026-02-08 â€” Issue 28.1.11 Network Simulation Test Hooks

## Intent / Scope
- Implement Issue `28.1.11` by wiring existing `TestHook.*` controls to shared playback state so `StreamingInterruptionUITests` can validate auto-pause/resume and buffer indicators.
- Apply agreed scope change: keep controls in `EpisodeDetailView` (no new rendered button overlay), but use a dedicated env-gated manager for lifecycle/observer ownership.
- Keep Issue `03.3.4` skips unchanged (network error/retry accessibility surface remains out of scope).

## Baseline (2026-02-08)
- Targeted run: `./scripts/run-xcode-tests.sh -t zpodUITests/StreamingInterruptionUITests`
- Result: 7 run, 3 passed, 4 skipped.
- `28.1.11` blockers:
  - `testAutoPauseOnNetworkLoss` skipped at simulation-state normalization.
  - `testAutoResumeOnNetworkRecovery` skipped at auto-pause transition.

## Scope Change Record
- Original issue text references debug overlay pattern with `UIWindow` controls.
- Agreed implementation path: controls remain in `EpisodeDetailView`; lifecycle and simulation wiring move to an env-gated manager (`NetworkSimulationOverlayManager`) using `.appDidInitialize` observer pattern.
- Rationale: controls already exist with stable `TestHook.*` identifiers; missing piece is deterministic engine wiring under ticker-mode UI tests.

## Design
```mermaid
flowchart TD
  A[UITEST_NETWORK_SIMULATION / UITEST_BUFFER_SIMULATION] --> B[NetworkSimulationOverlayManager]
  B --> C[Observe .networkSimulation/.bufferSimulation notifications]
  C --> D[Shared playback service cast to NetworkSimulationControlling]
  D --> E[EnhancedEpisodePlayer simulation methods]
  E --> F[EpisodePlaybackState + simulation publishers]
  F --> G[EpisodeDetailViewModel published simulation state]
  G --> H[EpisodeDetailView deterministic test state IDs + buffer indicator]
```

## Key Decisions
1. Target `EnhancedEpisodePlayer` for simulation controls (ticker path), not only `AVPlayerPlaybackEngine`.
2. Add deterministic simulation-state accessibility IDs so UI tests avoid inferring state from container text.
3. Add explicit resume behavior for simulated network recovery in ticker mode.
4. Keep runtime overhead zero when simulation env flags are absent by conditional observer registration.

## TDD Plan
1. Add failing PlaybackEngine tests for simulation pause/resume/buffer behavior.
2. Remove 28.1.11 skip wrappers from streaming interruption UI tests to force red.
3. Implement notifications contract + simulation protocol + manager + view/view-model wiring.
4. Run targeted suites, then full regression.

## Review Follow-up (2026-02-09)
- Accepted: replace `MainActor.assumeIsolated` usage in notification callbacks with explicit `Task { @MainActor ... }` hops in `NetworkSimulationOverlayManager` to avoid relying on queue-thread affinity for actor isolation.
- Accepted: stop strongly capturing a resolved controller inside observer closures; handlers now resolve the current `NetworkSimulationControlling` instance on delivery.
- Accepted: remove dead-write simulation flags in `EnhancedEpisodePlayer` (`isPausedBySimulatedNetworkLoss`, `isBufferingFromSimulation`) and keep Combine subjects as the sole simulation state source.
- Deferred: clock/scheduler injection for simulation recovery timing tests. Current tests intentionally use a short `simulationRecoveryGracePeriod` and bounded waits to validate real async timing behavior; adding a full injectable clock is a broader test-architecture change and can be scoped as a follow-up if flakiness appears.

## Closeout Intent (2026-02-09 ET)
- Align Issue `28.1.11` acceptance criteria and architecture text with the implemented scope change: `EpisodeDetailView` controls + env-gated `NetworkSimulationOverlayManager` notification bridge.
- Update stale docs still describing `28.1.11` as blocked (`StreamingInterruptionUITests` header, `zpodUITests/TestSummary.md`, and `ISSUE_28.1_STATUS.md` task list).
- Re-run targeted verification suites:
  - `./scripts/run-xcode-tests.sh -t zpodUITests/StreamingInterruptionUITests`
  - `./scripts/run-xcode-tests.sh -t PlaybackEngineTests/EnhancedEpisodePlayerNetworkSimulationTests`

## Closeout Results (2026-02-09 ET)
- Updated `Issues/28.1.11-network-simulation-test-hooks.md`:
  - AC #10 now reflects the approved scope (`EpisodeDetailView` controls + env-gated notification bridge manager) instead of requiring a dedicated `.alert + 100` `UIWindow` control layer.
  - Status moved to closed with acceptance criteria checked and architecture flow updated to match implementation.
- Updated stale documentation references:
  - `zpodUITests/StreamingInterruptionUITests.swift` status header now marks `28.1.11/#396` resolved and keeps `03.3.4` skips explicit.
  - `zpodUITests/TestSummary.md` removed `28.1.11` as an active blocker.
  - `ISSUE_28.1_STATUS.md` marks network simulation helpers task complete.
  - `Issues/28.1.9-ui-test-hardening-offline-streaming-playback.md` now treats `#396` as resolved traceability context, not an active blocker.
- Verification runs:
  - `./scripts/run-xcode-tests.sh -t zpodUITests/StreamingInterruptionUITests`:
    - Result: 7 run, 5 passed, 0 failed, 2 skipped (`Issue 03.3.4`), exit 0.
    - Log: `TestResults/TestResults_20260209_071007_test_zpodUITests-StreamingInterruptionUITests.log`.
  - Attempted `./scripts/run-xcode-tests.sh -t PlaybackEngineTests/EnhancedEpisodePlayerNetworkSimulationTests`:
    - Harness does not support class-level package filter; returned unknown target guidance.
  - Executed supported equivalent `./scripts/run-xcode-tests.sh -t PlaybackEngine`:
    - Result: 46 run, 46 passed, 0 failed, 0 skipped, exit 0.
    - Includes `EnhancedEpisodePlayerNetworkSimulationTests` (4/4 pass).
    - Log: `TestResults/TestResults_20260209_071220_test_pkg_PlaybackEngine.log`.
- Documentation grep verification:
  - No active `blocked by 28.1.11` references remain in updated closeout docs (`Issues/28.1.11...`, `zpodUITests/StreamingInterruptionUITests.swift`, `zpodUITests/TestSummary.md`, `ISSUE_28.1_STATUS.md`).
