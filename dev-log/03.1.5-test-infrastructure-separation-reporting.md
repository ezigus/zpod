# Dev Log – Issue 03.1.5: Test Infrastructure Separation and Enhanced Reporting

## 2025-10-20 23:05 ET – Intent & Design

### Objective
Bring the run script in line with the remaining acceptance criteria by:
- Allowing each regression phase to complete even if earlier steps fail.
- Printing structured Build/Test/Overall summaries on every exit path, including interruptions.
- Capturing SIGINT/ERR to surface partial progress instead of aborting silently.

### Design Notes
- Introduce a lightweight phase runner that wraps each task (syntax, test-plan, builds, package tests, AppSmoke, Integration, UI, lint) and records success/failure without short-circuiting.
- Track phase results in associative arrays keyed by category so summary formatting can compute totals (success, warn, fail, interrupted).
- Apply `trap` handlers for `ERR` and `INT` that flip an `INTERRUPTED=1` flag, append an interruption summary item, and fall through to unified exit logic.
- Replace the existing free-form `print_summary` output with structured sections matching Issue 03.1.5 expectations.

```mermaid
flowchart TD
    A[Setup & Argument Parsing]
    A --> B{Specific Flags?}
    B -- yes --> C[Run Requested Actions]
    B -- no --> D[Default Regression Phases]
    D --> E[Phase Runner (per step)]
    C --> E
    E --> F[Record Phase Result]
    F --> G[Final Summary Formatter]
    G --> H[Print Build/Test/Overall Sections]
    H --> I[Exit with appropriate status]
    subgraph Traps
      J[SIGINT] --> K[Set INTERRUPTED]
      L[ERR] --> M[Record Failure]
      K --> G
      M --> G
    end
```

### Open Questions
- How granular should interrupted phases be reported (per phase vs overall)? Plan to tag incomplete phases with status `interrupted` in the summary array.
- Exit code strategy: prefer first failing phase's status while still running later phases. Will capture first non-zero exit status and return it at the end.

### Next Steps
1. Update issue status to in-progress.
2. Implement phase runner, traps, and structured summary logic in `scripts/run-xcode-tests.sh`.
3. Backfill this log with implementation notes and verification steps.

## 2025-10-20 23:42 ET – Phase Runner & Reporting Implementation

### Work Completed
- Added phase orchestration helpers (`execute_phase`, `begin_phase`) so the default regression runs every step even when a command fails, capturing the first non-zero exit code for the final status.
- Installed shared signal handling (`trap` on `INT`/`ERR`) to print partial summaries and tag the in-flight phase as interrupted rather than terminating silently.
- Rebuilt `print_summary` into structured Build/Test/Lint/Overall sections with aggregate counts and per-group breakdowns (Unit, Integration, UI, Package).
- Hardened package build/test helpers and lint invocations to detect errors without relying on `set -e`, ensuring summaries get written for both successes and failures.
- Front-loaded regression gating so syntax and AppSmoke tests execute first and halt the remaining phases on failure; mirrored the same gating in CI with a preflight job that runs syntax, clean build, and smoke before fanning out.

### Verification
- `bash -n scripts/run-xcode-tests.sh` ✅
- `bash -n scripts/lib/spm.sh` ✅
- `./scripts/run-xcode-tests.sh --self-check` ✅

### Follow-up
- Monitor a full default run to confirm the new summary formatting looks clean end-to-end.

## 2025-10-21 00:52 ET – CI ordering tweak
- Updated the workflow so the macOS UI/integration matrix waits for the package matrix (`needs: [preflight, package-tests]`). Packages now compile/test immediately after the preflight gate and before any UI suites fan out.

## 2025-10-21 08:02 ET – CI selector inputs
- Added a `matrix` input to the workflow_dispatch trigger so we can run `all`, `packages`, `ui`, or `linux` slices on demand. Each downstream job now checks that input before running.

## 2025-10-21 09:47 ET – Layered CI separation design

### Intent
- Break the current `xcode-tests` matrix into dedicated jobs for `AppSmokeTests`, `IntegrationTests`, and the grouped UI suites so logs remain focused per layer.
- Preserve the existing `preflight` gate for syntax/build health, but make downstream jobs depend on it instead of letting AppSmoke ride inside the gate.
- Update Issue 03.1.5 acceptance criteria to reflect that CI coverage across the layered jobs supersedes the need for a redundant "no-arguments" regression job.

### Job Structure
```mermaid
flowchart LR
    P[preflight]
    P --> U[unit-tests]
    P --> PK[package-tests]
    U --> I[integration-tests]
    U --> UI[ui-tests (matrix)]
    PK --> UI
    PK --> I
```

### Notes
- `unit-tests` provisions its own simulator, runs `./scripts/run-xcode-tests.sh -t AppSmokeTests`, and shares gating status via `needs`.
- `integration-tests` becomes a standalone job (no longer inside the UI matrix) and runs only `-t IntegrationTests`.
- `ui-tests` keeps the existing suite matrix, limited to UI-only bundles, and still fans out after packages to balance runtime.
- Acceptance criteria update will clarify that CI already executes the full regression suite once the three jobs plus packages and Linux syntax pass.
