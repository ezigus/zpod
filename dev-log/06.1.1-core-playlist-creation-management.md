# Dev Log: 06.1.1 Core Playlist Creation and Management

## Overview

This log covers the implementation of core playlist creation and management for the zpod iOS app. The work spans the `feat/06-1-1-core-playlist-creation-and-manage-186` branch and GitHub issue #186.

---

## Intent

Provide users with a first-class playlist experience: create named playlists with optional descriptions, add/remove/reorder episodes, see total duration at a glance, and initiate playback (Play All / Shuffle) — all from a dedicated Playlists tab backed by a clean MVVM architecture.

---

## Architecture Decisions

### Package-Layer Protocol (`PlaylistManaging`)

The `PlaylistManaging` protocol in `CoreModels` defines the canonical playlist contract:
- `allPlaylists() -> [Playlist]`
- `createPlaylist`, `updatePlaylist`, `deletePlaylist(id:)`
- `duplicatePlaylist(id:)`
- `addEpisode(episodeId:to:)`, `removeEpisode(episodeId:from:)`
- `reorderEpisodes(in:from:to:)`

This keeps the feature package independent of persistence: the `PlaylistViewModel` accepts `any PlaylistManaging`, so tests use `InMemoryPlaylistManager` and the app layer can later supply a SwiftData-backed implementation without touching feature code.

### Value-Type `Playlist` with Builder Methods

`Playlist` is a Swift `struct` with builder-pattern methods (`withName`, `withDescription`, `addingEpisodeId`, `removingEpisodeId`). Immutability prevents accidental mutation across actor boundaries and makes test assertions straightforward.

### Episode Provider Closure

`PlaylistViewModel` takes an `episodeProvider: (Playlist) -> [Episode]` closure rather than directly importing a persistence or networking module. This keeps `PlaylistFeature` in its proper layer (no upward dependencies) and lets tests inject deterministic episode fixtures.

### `@Observable` ViewModel

Using the Swift 5.9 `@Observable` macro instead of `ObservableObject`/`@Published` reduces boilerplate and ensures fine-grained dependency tracking — only views that actually read a property re-render when it changes.

### Platform-Conditional `EditButton`

`EditButton` is iOS-only. The detail view wraps it in `#if os(iOS)` to keep the package building cleanly on macOS (which hosts package tests on the CI matrix).

---

## Implementation Timeline

### Phase 1 — Data Layer (earlier iterations)

| Commit | Change |
|--------|--------|
| `2ab9130` | Added `description` field and `duplicatePlaylist` to `Playlist` + `PlaylistManaging` |
| `ec2a29a` | Implemented `PlaylistViewModel` with full CRUD and episode management |
| `289cc22` | Built `PlaylistFeatureView` with toolbar, edit sheets, swipe-to-delete, context menus |
| `921b8ac` | Resolved Swift 6 actor-isolation issues; added 17 `PlaylistViewModelTests` |

### Phase 2 — Integration (earlier iterations)

| Commit | Change |
|--------|--------|
| `bdb16b1` | Added `AddToPlaylistView` sheet, `addEpisodes(_:to:)` batch method, episode provider wiring in `ContentView` |
| `2a928c9` | Renamed `LibraryFeature.PlaylistManaging` → `BatchPlaylistManaging` to avoid protocol name collision |

### Phase 3 — Polish (this iteration series)

| Commit | Change |
|--------|--------|
| `778cd3c` | Added `totalDuration(for:)`, Play All / Shuffle buttons, duration display in `PlaylistRow`, 4 new tests |

---

## Key Files

| File | Role |
|------|------|
| `Packages/CoreModels/Sources/CoreModels/Playlist.swift` | Value-type domain model with builder API |
| `Packages/CoreModels/Sources/CoreModels/PlaylistManaging.swift` | Protocol contract |
| `Packages/CoreModels/Sources/CoreModels/InMemoryPlaylistManager.swift` | In-memory test/preview implementation |
| `Packages/PlaylistFeature/Sources/PlaylistFeature/PlaylistViewModel.swift` | `@MainActor @Observable` ViewModel |
| `Packages/PlaylistFeature/Sources/PlaylistFeature/PlaylistViews.swift` | SwiftUI views (list, detail, creation sheet) |
| `Packages/PlaylistFeature/Sources/PlaylistFeature/AddToPlaylistView.swift` | Reusable episode-to-playlist picker sheet |
| `Packages/LibraryFeature/Sources/LibraryFeature/ContentView.swift` | Wires `PlaylistTabView` with episode provider |
| `Packages/PlaylistFeature/Tests/PlaylistFeatureTests/PlaylistFeatureTests.swift` | 24 ViewModel + totalDuration tests |
| `Packages/CoreModels/Tests/CoreModelsTests/InMemoryPlaylistManagerTests.swift` | 22 manager unit tests |

---

## Test Coverage

### PlaylistFeature (24 tests)
- CRUD round-trips (create, update, delete, duplicate)
- Episode add/remove/reorder
- Batch episode addition
- `totalDuration` — basic sum, empty playlist (nil), no-duration episodes (nil), partial durations

### CoreModels/InMemoryPlaylistManagerTests (22 tests)
- All `PlaylistManaging` protocol methods
- Duplicate-ID guards, no-op on missing IDs
- `updatedAt` advances correctly after mutations
- Description field stored and retrieved

### Acceptance Criteria vs. Implementation

| AC | Status |
|----|--------|
| Playlists tab shows episode count + total duration | ✅ `PlaylistRow` shows `"N episodes • Xh Ym • Updated Z"` |
| Create playlists with name + description | ✅ `PlaylistCreationView` form |
| Edit playlist details | ✅ Same sheet, seeded with existing values |
| Drag-and-drop episode reordering | ✅ `.onMove` in `PlaylistDetailView` |
| Duplicate playlists | ✅ Context menu + `duplicatePlaylist` |
| "Add to Playlist" from episode contexts | ✅ `AddToPlaylistView` reusable sheet |
| Batch episode addition | ✅ `addEpisodes(_:to:)` |
| Play All / Shuffle buttons | ✅ Wired via `onPlayAll`/`onShuffle` callbacks |
| All package tests pass | ✅ 333/333 |
| Full regression suite | ✅ Verified (see pipeline run) |

---

## Known Limitations / Future Work

- **Artwork**: `Playlist` model has no artwork field; the issue spec mentions it as a future enhancement
- **Folders / categories**: Not in scope for 06.1.1; deferred to a later sub-issue
- **Playback integration**: `onPlayAll` / `onShuffle` are callback hooks — the actual queue hand-off to the player engine is wired at the app layer and will be driven by the playback integration issue
- **Smart suggestions**: Deferred per the issue spec (Phase 2 / separate issue)
- **SwiftData persistence**: `InMemoryPlaylistManager` is used in tests and previews; production persistence via `PlaylistEntity` in `Packages/Persistence` is a separate concern

---

## 2026-02-19

**07:15 ET** — Syntax check passed (0 errors). Targeted package tests: 333/333 passing. Full regression pipeline started.

**22:01 ET** — Full regression suite completed in 30:17. Exit 0. Results: 59 AppSmoke, 89 Integration, 862 package tests, 60 UI tests — **1,070 passed, 0 failed, 1 skipped** (pre-existing skip in CoreUINavigationTests). Issue 06.1.1 complete. PR created against `main`.
