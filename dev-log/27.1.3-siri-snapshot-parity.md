# Dev Log: 27.1.3 - Siri Snapshot Parity for InMemoryPodcastManager

## Status: In Progress
**Branch**: `feature/27.1.3-siri-snapshot-parity`
**Created**: 2026-01-17

---

## Intent

Restore Siri snapshot parity in TestSupport's `InMemoryPodcastManager` by:
1. Adding optional `SiriSnapshotRefreshing` dependency to mirror production behavior
2. Invoking `refreshAll()` after add/update/remove operations (when provided)
3. Adding unit tests to verify refresh behavior

## Design Decisions

### Protocol Location
Moving `SiriSnapshotRefreshing` protocol from `zpod/Services/SiriSnapshotCoordinator.swift` to `Packages/CoreModels/Sources/CoreModels/` so it can be shared between:
- Production code (`SwiftDataPodcastManager`)
- Test code (`InMemoryPodcastManager`)

### Spy Pattern for Testing
Creating `SpySiriSnapshotRefresher` in TestSupport to:
- Track `refreshAll()` calls without writing to app-group storage
- Enable verification of refresh behavior in unit tests

### Minimal Changes to Production Code
The `SwiftDataPodcastManager` already uses this pattern. The change is:
- Import `SiriSnapshotRefreshing` from CoreModels instead of local definition

---

## Progress

### 2026-01-17 10:00 ET - Initial Setup

Created branch and dev-log. Analyzed existing architecture:

**Current State:**
- `SiriSnapshotRefreshing` protocol defined in `zpod/Services/SiriSnapshotCoordinator.swift`
- `SwiftDataPodcastManager` already accepts optional refresher via initializer
- `InMemoryPodcastManager` lacks this capability

**Implementation Plan:**
1. Move `SiriSnapshotRefreshing` protocol to CoreModels
2. Update app imports
3. Add refresher to `InMemoryPodcastManager`
4. Create spy for testing
5. Write unit tests

---

## Files Changed

### New Files
- `Packages/CoreModels/Sources/CoreModels/SiriSnapshotRefreshing.swift` - Protocol moved here for sharing
- `Packages/TestSupport/Sources/TestSupport/SpySiriSnapshotRefresher.swift` - Spy for testing

### Modified Files
- `zpod/Services/SiriSnapshotCoordinator.swift` - Removed local protocol definition (now imports from CoreModels)
- `Packages/TestSupport/Sources/TestSupport/InMemoryPodcastManager.swift` - Added optional `siriSnapshotRefresher` parameter
- `Packages/TestSupport/Tests/TestSupportTests/ComprehensiveInMemoryPodcastManagerTests.swift` - Added 7 new tests

---

## Test Results

### TestSupportTests (2026-01-17 13:18 ET)
- **Total**: 83 tests
- **Passed**: 83
- **Failed**: 0

New Siri snapshot refresh tests:
- ✅ testSiriSnapshotRefresh_Add_CallsRefresher
- ✅ testSiriSnapshotRefresh_Update_CallsRefresher
- ✅ testSiriSnapshotRefresh_Remove_CallsRefresher
- ✅ testSiriSnapshotRefresh_AddDuplicate_DoesNotCallRefresher
- ✅ testSiriSnapshotRefresh_UpdateNonExistent_DoesNotCallRefresher
- ✅ testSiriSnapshotRefresh_RemoveNonExistent_DoesNotCallRefresher
- ✅ testSiriSnapshotRefresh_NilRefresher_DoesNotCrash
