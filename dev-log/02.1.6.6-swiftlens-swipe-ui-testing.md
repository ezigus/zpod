# Dev-Log: Issue 02.1.6.6 — SwiftLens Swipe UI Testing

## Issue Summary
Adopt SwiftLens SwiftUI testing library for swipe configuration UI testing to achieve more reliable, deterministic tests than XCUITest-only flows.

**Status**: ✅ **COMPLETE** (Infrastructure & Initial Tests)
**Branch**: `docs/swiftlens-infrastructure-setup`
**Related Issue**: [02.1.6.6-swiftlens-swipe-ui-testing.md](../Issues/02.1.6.6-swiftlens-swipe-ui-testing.md)

---

## 2025-12-21 — SwiftLens Integration Complete

### Objectives Achieved

1. ✅ SwiftLens infrastructure added to project
2. ✅ Pure SwiftLens unit tests created for swipe preset selection
3. ✅ Swift 6 concurrency compliance achieved
4. ✅ SPM package isolation maintained
5. ✅ Info.plist build error resolved

### Implementation Timeline

#### Phase 1: SwiftLens Package Integration

**Decision**: Add SwiftLens as Xcode workspace dependency, not SPM package dependency

**Rationale**:
- SwiftLens requires Swift 5.5 and has macOS platform restrictions
- SPM packages in our codebase use strict Swift 6 mode
- SwiftLens only needed in test targets (AppSmokeTests, zpodUITests), not production packages
- Xcode workspace handles multi-version Swift toolchain correctly

**Actions**:
1. Added SwiftLens to zpod app target via Xcode project
2. Added SwiftLensTestSupport to test targets (AppSmokeTests, IntegrationTests, zpodUITests)
3. Explicitly **removed** SwiftLens from `Packages/LibraryFeature/Package.swift`
   - LibraryFeature builds standalone via SPM in CI
   - SwiftLens SPM dependency would break SPM builds
   - Production views don't need SwiftLens instrumentation

**Key Finding**: SwiftLens works perfectly in Xcode workspace targets but should NOT be in SPM package dependencies.

#### Phase 2: Production Code Cleanup

**Decision**: Remove all SwiftLens imports and modifiers from production code

**Rationale**:
- SwiftLens `LensWorkBench` wraps views externally in tests
- No need for `.lensTracked()`, `.lensButton()`, etc. in production
- Keeps production code clean and framework-agnostic
- Avoids unnecessary `#if canImport(SwiftLens)` conditionals

**Actions**:
1. Removed SwiftLens imports from `SwipeActionConfigurationView.swift`
2. Removed all `.lensTracked()`, `.lensButton()` modifiers
3. Production views remain pure SwiftUI with no test infrastructure

**Key Finding**: SwiftLens is non-intrusive—tests wrap views, production code stays clean.

#### Phase 3: Swift 6 Concurrency Compliance

**Initial Problem**: Actor isolation mismatches and data race warnings

**Errors Encountered**:
```swift
// Error 1: Actor isolation on overrides
error: main actor-isolated instance method 'setUpWithError()' has different
actor isolation from nonisolated overridden declaration

// Error 2: Data race in closures
warning: capture of 'self.controller' with non-sendable type across isolation domains
```

**Solution (Auto-Linter Fixes)**:

1. **Actor-Based Mock Service**:
```swift
private actor MockSwipeConfigurationService: SwipeConfigurationServicing {
  private var currentConfiguration: SwipeConfiguration = .default
  private let continuation: AsyncStream<SwipeConfiguration>.Continuation

  func load() async -> SwipeConfiguration {
    return currentConfiguration
  }

  func save(_ configuration: SwipeConfiguration) async throws {
    currentConfiguration = configuration
    continuation.yield(configuration)
  }

  nonisolated func updatesStream() -> AsyncStream<SwipeConfiguration> {
    return AsyncStream { continuation in /* no-op for testing */ }
  }
}
```

2. **Test Fixture Isolation**:
```swift
@MainActor
final class SwipePresetSelectionSwiftLensTests: XCTestCase {
  // Use nonisolated(unsafe) for properties that XCTest manages
  nonisolated(unsafe) private var mockService: MockSwipeConfigurationService!
  nonisolated(unsafe) private var controller: SwipeConfigurationController!

  override func setUpWithError() throws {
    try super.setUpWithError()
    continueAfterFailure = false
  }

  @MainActor
  override func setUp() async throws {
    mockService = MockSwipeConfigurationService()
    controller = SwipeConfigurationController(service: mockService)
  }

  @MainActor
  override func tearDown() async throws {
    controller = nil
    mockService = nil
  }
}
```

3. **Data Race Prevention in Tests**:
```swift
@MainActor
func testDownloadPresetAppliesCorrectly_SwiftLens() async throws {
  await controller.loadBaseline()

  // CRITICAL: Create local reference to avoid data race warnings
  let testController = controller!
  let workbench = LensWorkBench { _ in
    SwipeActionConfigurationView(controller: testController)
  }

  try await workbench.observer.waitForViewVisible(
    withID: "SwipeActions.Preset.Download",
    timeout: 2.0
  )

  try await workbench.interactor.tapButton(withID: "SwipeActions.Preset.Download")
  try await Task.sleep(nanoseconds: 100_000_000)  // 100ms settle time

  XCTAssertEqual(controller.leadingActions, [.download, .markPlayed])
  XCTAssertEqual(controller.trailingActions, [.archive, .delete])
  XCTAssertTrue(controller.hasUnsavedChanges)
}
```

**Key Patterns Extracted**:
- ✅ Use async `setUp()`/`tearDown()` with `@MainActor` for actor-isolated setup
- ✅ Keep `setUpWithError()` nonisolated (XCTest requirement)
- ✅ Use `nonisolated(unsafe)` for test fixture properties
- ✅ Create local references before closures to avoid data race warnings
- ✅ Make mock services actors when they conform to `Sendable` protocols

#### Phase 4: Info.plist Build Error (Unrelated)

**Error**:
```
error: Multiple commands produce '.../zpod.app/Info.plist'
```

**Root Cause**: Info.plist in both "Copy Bundle Resources" and automatic processing

**Fix**: Removed Info.plist from "Copy Bundle Resources" build phase

**Note**: This was a pre-existing Xcode configuration issue, not related to SwiftLens adoption.

### Test Coverage Created

**File**: `AppSmokeTests/SwipePresetSelectionSwiftLensTests.swift`

**Tests Implemented** (4 total):

1. `testDownloadPresetAppliesCorrectly_SwiftLens`
   - Verifies Download preset sets correct leading/trailing actions
   - Uses `LensObserver.waitForViewVisible()` for element discovery
   - Uses `LensInteractor.tapButton()` for interaction
   - Asserts configuration state changes

2. `testOrganizationPresetAppliesCorrectly_SwiftLens`
   - Verifies Organization preset configuration
   - Tests archive + queue actions

3. `testPlaybackPresetAppliesCorrectly_SwiftLens`
   - Verifies Playback preset configuration
   - Tests skip forward/backward actions

4. `testMinimalPresetAppliesCorrectly_SwiftLens`
   - Verifies Minimal preset (no actions)
   - Tests empty action lists

**Test Pattern**:
```swift
// 1. Load baseline configuration
await controller.loadBaseline()

// 2. Create LensWorkBench with local controller reference
let testController = controller!
let workbench = LensWorkBench { _ in
  SwipeActionConfigurationView(controller: testController)
}

// 3. Wait for preset button to be visible
try await workbench.observer.waitForViewVisible(
  withID: "SwipeActions.Preset.<PresetName>",
  timeout: 2.0
)

// 4. Tap preset button
try await workbench.interactor.tapButton(
  withID: "SwipeActions.Preset.<PresetName>"
)

// 5. Allow SwiftUI update to settle
try await Task.sleep(nanoseconds: 100_000_000)

// 6. Assert expected configuration
XCTAssertEqual(controller.leadingActions, expectedLeading)
XCTAssertEqual(controller.trailingActions, expectedTrailing)
XCTAssertTrue(controller.hasUnsavedChanges)
```

### SwiftLens vs XCUITest Trade-offs

| Aspect | SwiftLens | XCUITest |
|--------|-----------|----------|
| **Process Model** | In-process (same as app) | Out-of-process (separate) |
| **State Access** | Direct model access | Only UI accessibility tree |
| **View Discovery** | `LensObserver` tracks visible views | Polls accessibility hierarchy |
| **Reliability** | Deterministic (no polling) | Timing-dependent (polling) |
| **Setup Complexity** | Requires `LensWorkBench` wrapper | Requires app launch + navigation |
| **Swift 6 Compliance** | Requires actor isolation care | Standard XCTest patterns |
| **Integration Testing** | Unit/integration hybrid | True end-to-end |
| **CI Compatibility** | Runs as unit tests (fast) | Requires simulator (slower) |

**Decision**: Use SwiftLens for swipe configuration logic tests, keep XCUITest for full user flows.

### Integration Blockers Discovered

#### Blocker 1: SPM Package Incompatibility

**Problem**: SwiftLens requires Swift 5.5, our SPM packages require Swift 6

**Impact**: Cannot add SwiftLens to `LibraryFeature/Package.swift`

**Solution**: Use SwiftLens only in Xcode workspace targets (AppSmokeTests, zpodUITests)

**Status**: ✅ Resolved by architectural decision

#### Blocker 2: Production Code Instrumentation (False Blocker)

**Initial Concern**: Need to add SwiftLens modifiers to production views

**Reality**: SwiftLens wraps views externally—no production instrumentation needed

**Status**: ✅ Not actually a blocker

#### Blocker 3: Swift 6 Concurrency Compliance

**Problem**: SwiftLens closures trigger data race warnings with actor-isolated state

**Impact**: Compilation errors in Swift 6 strict mode

**Solution**: Patterns extracted (see Phase 3 above)

**Status**: ✅ Resolved by linter + documented patterns

### Files Modified

#### New Files Created:
- `AppSmokeTests/SwipePresetSelectionSwiftLensTests.swift` (4 tests)

#### Modified Files:
- `Packages/LibraryFeature/Package.swift` (removed SwiftLens dependency)
- `Packages/LibraryFeature/Sources/LibraryFeature/SwipeActionConfigurationView.swift` (removed SwiftLens imports)

#### Deleted Files:
- `zpodUITests/SwiftLensSwipePresetTests.swift` (old placeholder)
- `Packages/LibraryFeature/Tests/LibraryFeatureTests/SwipePresetSelectionSwiftLensTests.swift` (moved to AppSmokeTests)

### Commits Made

1. `a534490` - Add SwiftLens unit tests for swipe preset selection and fix Info.plist build error
2. `58c5158` - Fix Info.plist duplication build error
3. `480e957` - Fix SwiftLens test compilation errors
4. `e1cc253` - Update SwiftLens test isolation model for Swift 6 concurrency

### Lessons Learned

#### 1. SwiftLens Doesn't Require Production Instrumentation

**Misconception**: Need to add `.lensTracked()`, `.lensButton()` to production views

**Reality**: `LensWorkBench` wraps views in test harness—production code stays clean

**Takeaway**: SwiftLens is non-intrusive for production code

#### 2. SPM vs Xcode Workspace Dependencies

**Finding**: SwiftLens works in Xcode, fails in SPM standalone builds

**Reason**:
- Xcode workspace can mix Swift versions (5.5 for SwiftLens, 6 for our code)
- SPM strict mode requires all dependencies match Swift 6

**Takeaway**: Test frameworks should only be in Xcode workspace dependencies, not SPM packages

#### 3. Swift 6 Actor Isolation in Tests

**Pattern**: XCTest requires nonisolated `setUpWithError()`, but we need `@MainActor` setup

**Solution**:
- Use regular `setUpWithError()` without `@MainActor`
- Add async `setUp()`/`tearDown()` with `@MainActor` for actor-isolated work
- Use `nonisolated(unsafe)` for test fixture properties

**Takeaway**: Swift 6 testing requires careful actor isolation management

#### 4. SwiftLens Closure Data Race Warnings

**Problem**: Capturing `self.controller` in `LensWorkBench` closure triggers warnings

**Solution**: Create local reference before closure: `let testController = controller!`

**Takeaway**: Local references prevent data race warnings in actor-isolated contexts

### Next Steps

#### Immediate (Current Branch):
- ✅ Documentation complete
- ⏳ Push to GitHub when ready
- ⏳ Create PR for review

#### Future Enhancements (Separate PRs):
1. Add SwiftLens tests for:
   - Haptic toggle/intensity persistence
   - Full-swipe toggle state
   - Action list reordering
   - Custom action selection

2. Migrate timing-dependent XCUITest flows to SwiftLens:
   - Swipe configuration sheet open/close
   - Preset selection with state verification
   - Settings persistence across launches

3. Document SwiftLens patterns in `docs/testing/SWIFTLENS_PATTERNS.md`:
   - Swift 6 concurrency compliance
   - Actor isolation in tests
   - LensWorkBench usage
   - Observable state tracking

### References

- **SwiftLens Library**: https://github.com/gahntpo/SwiftLens
- **Issue**: [02.1.6.6-swiftlens-swipe-ui-testing.md](../Issues/02.1.6.6-swiftlens-swipe-ui-testing.md)
- **Related**: Issue 02.6.3 (Swipe configuration test decomposition)
- **Tests**: `AppSmokeTests/SwipePresetSelectionSwiftLensTests.swift`

---

**Status**: Infrastructure complete, initial tests passing, ready for PR.
