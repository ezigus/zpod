# Phase 4 Design — Playback Position Suite

**Issue**: #12.3 — UI Test Infrastructure Cleanup  
**Created**: 2026-02-10 (Phase 4 kickoff)  
**Goal**: Migrate the playback position-focused UI suites to `IsolatedUITestCase`, reuse the infrastructure established in Phases 1‑3, and document the intent/questions before touching production tests.

## Intent & Constraints

- Playback position flows already exercise the player controls, progressTicker, and AVPlayer hooks, making them the natural follow-up to the high-value suites from Phase 3.
- Leverage the `PlayerScreen`/`TabBarNavigation` helpers introduced earlier; avoid reintroducing ad‑hoc waits by routing through the shared page objects and wait helpers.
- Keep the helper `PlaybackPositionTestSupport.swift` in sync: it should either remain `@MainActor` or explicitly drop isolation when calling the new base class utilities.
- Preserve `continueAfterFailure = false`/`disableWaitingForIdleIfNeeded()` behavior by overriding `setUpWithError()` only when necessary; do not add new cleanup layers now that `IsolatedUITestCase` provides the shared teardown.

## Scope of Work

1. Update `PlaybackPositionTickerTests`, `PlaybackPositionAVPlayerTests`, and `PlaybackPositionTestSupport.swift` to inherit from `IsolatedUITestCase`.
2. Replace manual tab navigation and fallback element queries with the page objects (`TabBarNavigation`, `PlayerScreen`) and shared wait helpers (`waitForAny`, `waitForContentToLoad`, `tapWhenReady`).
3. Move any playback-position-specific setup/teardown from the tests into `PlaybackPositionTestSupport` so the base class can manage isolation consistently.
4. Confirm that the tests still seed any expected state (e.g., progress ticker subscriptions) by updating `PlaybackPositionTestSupport` rather than the individual suites.

## Risks & Mitigation

- **Player focus races**: Playback position tests tap the player controls while the player is animating; reuse `PlayerScreen`’s guarded taps + `waitForPlayerReady` to avoid flakiness.
- **Helper isolation mismatch**: `PlaybackPositionTestSupport` may share state with other suites; keep its async helpers either `@MainActor` or mark them `nonisolated` only when they call actor-isolated services.
- **Regression from helper removal**: Ensure we keep the same logging/diagnostics when migrating; keep the helper's `XCTContext` activities intact.

## Verification

- Run the Phase 4 suites after implementation:
```bash
./scripts/run-xcode-tests.sh -t PlaybackPositionTickerTests,PlaybackPositionAVPlayerTests
```
- Capture logs under `TestResults/` for CI verification (matches the strategy outlined in `dev-log/12.3-ui-test-migration-plan.md`).

## Next Steps

1. Implement the design changes for the playback position suites (tests + support file).
2. Update `dev-log/` with a touchpoint summarizing implementation once the changes are complete.
3. Ensure `AGENTS.md` points to this new Phase 4 design note so future contributors know where to look for the plan.
4. Run the verification command above before pushing the Phase 4 branch for review.
