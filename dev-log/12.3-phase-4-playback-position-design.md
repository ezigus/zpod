# Phase 4 Design — Playback Position Suite

**Issue**: #12.3 — UI Test Infrastructure Cleanup  
**Created**: 2026-02-10 (Phase 4 kickoff)  
**Goal**: Migrate the playback position-focused UI suites to `IsolatedUITestCase`, reuse the infrastructure established in Phases 1‑3, and document the intent/questions before touching production tests.

## Intent & Constraints

- Playback position flows already exercise the player controls, progressTicker, and AVPlayer hooks, making them the natural follow-up to the high-value suites from Phase 3.
- Leverage the `PlayerScreen`/`TabBarNavigation` helpers introduced earlier; avoid reintroducing ad‑hoc waits by routing through the shared page objects and wait helpers.
- Keep the helper `PlaybackPositionTestSupport.swift` in sync: it should either remain `@MainActor` or explicitly drop isolation when calling the new base class utilities.
- Preserve `continueAfterFailure = false`/`disableWaitingForIdleIfNeeded()` behavior by overriding `setUpWithError()` only when necessary; do not add new cleanup layers now that `IsolatedUITestCase` provides the shared teardown.

## Scope of Work

1. Update `PlaybackPositionTickerTests`, `PlaybackPositionAVPlayerTests`, and `PlaybackPositionTestSupport.swift` to inherit from `IsolatedUITestCase`.
2. Replace manual tab navigation and fallback element queries with the page objects (`TabBarNavigation`, `PlayerScreen`) and shared wait helpers (`waitForAny`, `waitForContentToLoad`, `tapWhenReady`).
3. Move any playback-position-specific setup/teardown from the tests into `PlaybackPositionTestSupport` so the base class can manage isolation consistently.
4. Confirm that the tests still seed any expected state (e.g., progress ticker subscriptions) by updating `PlaybackPositionTestSupport` rather than the individual suites.

## Risks & Mitigation

- **Player focus races**: Playback position tests tap the player controls while the player is animating; reuse `PlayerScreen`’s guarded taps + `waitForPlayerReady` to avoid flakiness.
- **Helper isolation mismatch**: `PlaybackPositionTestSupport` may share state with other suites; keep its async helpers either `@MainActor` or mark them `nonisolated` only when they call actor-isolated services.
- **Regression from helper removal**: Ensure we keep the same logging/diagnostics when migrating; keep the helper's `XCTContext` activities intact.

## Verification

- Run the Phase 4 suites after implementation:
```bash
./scripts/run-xcode-tests.sh -t PlaybackPositionTickerTests,PlaybackPositionAVPlayerTests
```
- Capture logs under `TestResults/` for CI verification (matches the strategy outlined in `dev-log/12.3-ui-test-migration-plan.md`).

## Next Steps

1. Implement the design changes for the playback position suites (tests + support file).
2. Update `dev-log/` with a touchpoint summarizing implementation once the changes are complete.
3. Ensure `AGENTS.md` points to this new Phase 4 design note so future contributors know where to look for the plan.
4. Run the verification command above before pushing the Phase 4 branch for review.

## Implementation Log

### 2026-01-19 — CI Crash Fix: Bundle.main in UI Test Context

**Problem**: After migrating `PlaybackPositionTickerTests` and `PlaybackPositionAVPlayerTests` to `IsolatedUITestCase`, CI failures occurred with:
- Exit code 124 (timeout) for PlayerNavigation and PlaybackTicker tests
- `EXC_BAD_ACCESS` during `UIApplicationInitialize` when calling `removePersistentDomain`

**Root Cause**: The `clearUserDefaults()` function in `UITestEnvironmentalIsolation.swift` was using `Bundle.main.bundleIdentifier` to determine which UserDefaults domain to clear. In UI test context, `Bundle.main` refers to the **test runner bundle** (XCUITest infrastructure), NOT the app bundle (`us.zig.zpod`). This caused:
1. Wrong domain being cleared, or
2. `Bundle.main.bundleIdentifier` returning `nil` or crashing during early initialization

**Critical Context**: The crash only reproduced during full regression runs, not targeted test runs:
- Targeted test runs (e.g., `-t PlaybackPositionTickerTests`) appeared healthy
- Full regression runs tests back-to-back with shared isolation infrastructure
- The timing of `performPreTestCleanup()` calling `clearUserDefaults()` before app launch became problematic when multiple suites exercised this path in rapid succession
- This explains why the issue wasn't caught during initial Phase 4 implementation

**Solution**: Added an `appBundleIdentifier` parameter with a default value to `clearUserDefaults()`, matching the pattern used by `forceTerminateAppIfRunning()`:

```swift
// Updated signature
func clearUserDefaults(suiteName: String? = nil, appBundleIdentifier: String = "us.zig.zpod")

// Updated implementation
} else {
  defaults = UserDefaults.standard
  // Guard against empty bundle ID to prevent no-op or undefined behavior
  guard !appBundleIdentifier.isEmpty else {
    print("⚠️ clearUserDefaults called with empty appBundleIdentifier, skipping")
    return
  }
  // Use explicit app bundle ID - Bundle.main in UI tests refers to
  // the test runner bundle, not the app under test
  defaults.removePersistentDomain(forName: appBundleIdentifier)
}
```

**Why This Approach**:
1. Provides a sensible default for normal usage
2. Allows tests to override if needed
3. Makes the dependency explicit
4. Consistent with existing codebase patterns (`forceTerminateAppIfRunning`)
5. Backward compatible (default parameter)

**Files Modified**:
- `zpodUITests/UITestEnvironmentalIsolation.swift`:
  - Updated `clearUserDefaults()` signature (line 54)
  - Updated protocol definition (line 20)
  - Updated implementation to use explicit bundle ID (lines 64-74)

**Educational Insight**: In UI tests, `Bundle.main` refers to the test runner bundle, not the app bundle. Always use explicit bundle identifiers for app-specific operations. Default parameters allow clean call sites while supporting edge cases.
