# Issue 28.1.13: Complete Download State Seeding Test Coverage

## Overview
Complete test coverage for download state seeding infrastructure, addressing final acceptance criteria from Issue 28.1.

## Timeline

### 2026-02-15 11:40 AM EST - Investigation: DownloadFlowUITests Failures

**Problem**: All 5 DownloadFlowUITests failing in both local regression and CI:
- `testDownloadProgressIndicatorDisplays`
- `testDownloadedEpisodeShowsBadge`
- `testMultipleEpisodesShowMixedDownloadStates`
- `testPausedDownloadShowsProgress`
- `testFailedDownloadShowsRetryButton`

**Symptom**: Tests successfully find episode buttons (`Episode-st-001`), but cannot find download status indicator elements (`Episode-st-001-DownloadStatus`).

**Initial Hypothesis**: Tests were using `launchConfiguredApp()` which doesn't provide specific test podcast data.

**Fix Attempt 1**: Updated 3 tests to use `launchDownloadSwipeApp(additionalEnvironment:)`:
- `testMultipleEpisodesShowMixedDownloadStates`
- `testPausedDownloadShowsProgress`
- `testFailedDownloadShowsRetryButton`

**Result**: Tests still fail. Episodes exist but download status indicators don't render.

### Investigation: Download State Seeding Code Path

**Findings**:
1. **Episode IDs Verified**: Test data in `LibraryFeature/ContentView.swift` creates episodes with IDs "st-001", "st-002", "st-003", "st-004"  ‚úÖ
2. **Seeding Code Exists**: `EpisodeListView.swift` lines 1206-1219 check `DownloadStateSeeding.state(for:)` ‚úÖ
3. **Navigation Path Confirmed**: `EpisodeListViewWrapper` ‚Üí `createSamplePodcast` ‚Üí `EpisodeListView(podcast:)` ‚úÖ
4. **Environment Variables Set**: Tests correctly set `UITEST_DOWNLOAD_STATES` ‚úÖ
5. **Debug Logging Added**: Comprehensive logging in `DownloadStateSeeding.swift` ‚úÖ
6. **NO Runtime Output**: Debug logging never appears in test logs ‚ùå

**Critical Discovery**: Added debug logging to both:
- `DownloadStateSeeding.parseSeededStates()`
- `DownloadStateSeeding.state(for:)`
- `EpisodeRowView.body` (attempted)

Result: **ZERO debug output in test logs**, suggesting code path is not being executed.

### Investigation: Legacy Seeding Mechanism

**Test**: Modified `testDownloadedEpisodeShowsBadge` to use legacy `UITEST_DOWNLOADED_EPISODES` instead of `UITEST_DOWNLOAD_STATES`.

**Result**: Test STILL fails with same symptoms.

**Conclusion**: Problem is NOT specific to DownloadStateSeeding - the entire download status rendering system doesn't work in UI tests.

### Root Cause Hypothesis

**Architecture Mismatch**: The `EpisodeListView` rendered during UI tests may not be the same instance or code path as the production `EpisodeListView` in `LibraryFeature/Sources/LibraryFeature/EpisodeListView.swift`.

**Evidence**:
- Episode rows render (buttons found)
- Download status indicator code exists
- Seeding code exists
- Environment variables set correctly
- **But**: Code path never executes (no debug output)

**Possible Causes**:
1. Multiple `EpisodeListView` definitions (only one found via grep)
2. Test app uses different data source than `createSamplePodcast`
3. SwiftUI view rendering optimization skipping download status indicator
4. Compilation flag issue (unlikely - `#if DEBUG` should be active)

### Status: BLOCKED

**Blocker**: Download status indicators do not render in UI tests, preventing validation of download state seeding functionality.

**Impact**:
- Cannot verify download state seeding infrastructure
- Cannot complete Issue 28.1.13 acceptance criteria
- 5 UI tests failing

**Next Steps**:
1. Investigate EpisodeListView rendering architecture in UI test context
2. Add runtime logging to verify which code paths execute
3. Compare production vs. test EpisodeListView initialization
4. Consider alternative approach (e.g., integration tests instead of UI tests)

**Commit**: 50c04e8 - WIP changes with blocker documented

## Technical Details

### Test Launch Configuration

Tests use `launchDownloadSwipeApp(additionalEnvironment:)` which:
1. Sets up swipe configuration via `UITestLaunchConfiguration.swipeConfiguration`
2. Applies `SwipeConfigurationSeeding.downloadFocused` preset
3. Merges additional environment variables (e.g., `UITEST_DOWNLOAD_STATES`)
4. Launches app with `launchConfiguredApp(environmentOverrides:)`

### Download State Seeding Flow (Expected)

1. Test sets `UITEST_DOWNLOAD_STATES` environment variable with JSON-encoded states
2. App launches and `EpisodeListView` renders episode rows
3. For each row, `downloadStatusIndicator` computes `effectiveStatus`:
   - Checks `DownloadStateSeeding.state(for: episode.id)`
   - Returns seeded status if found
   - Falls back to `episode.downloadStatus` otherwise
4. Downloads status indicator renders based on `effectiveStatus`

**Actual Behavior**: Step 3 never executes - `DownloadStateSeeding.state(for:)` is never called.

### Diagnostic Logging Added

```swift
// DownloadStateSeeding.swift
public static func parseSeededStates() -> [String: SeededDownloadState] {
  print("üîç [DownloadStateSeeding] Found UITEST_DOWNLOAD_STATES: ...")
  // ... parse and print results
}

public static func state(for episodeId: String) -> SeededDownloadState? {
  print("üîç [DownloadStateSeeding] Looking for episode ID: '\(episodeId)'")
  // ... try matches and print results
}
```

**Expected**: Logs for each episode row rendered
**Actual**: No logs at all

## Open Questions

1. Why is `DownloadStateSeeding.state(for:)` never called even though code exists?
2. Is there a different `EpisodeListView` being used in tests vs. production?
3. Why does legacy `UITEST_DOWNLOADED_EPISODES` also fail?
4. Are episode rows using a different rendering path in test mode?

## References

- Issue: `Issues/28.1.13-complete-download-seeding-tests.md`
- Related: Issue 28.1 (parent issue)
- Files:
  - `zpodUITests/DownloadFlowUITests.swift` - failing tests
  - `Packages/LibraryFeature/Sources/LibraryFeature/EpisodeListView.swift` - download status rendering
  - `Packages/LibraryFeature/Sources/LibraryFeature/DownloadStateSeeding.swift` - seeding infrastructure
  - `Packages/LibraryFeature/Sources/LibraryFeature/ContentView.swift` - test data (`createSamplePodcast`)
