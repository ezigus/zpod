# Dev Log - Issue 02.1.6.3: Modular Swipe Configuration Settings Refactor

## Context
- **Issue**: 02.1.6.3
- **Parent Issue**: 02.1.6 — Swipe Gestures and Quick Actions
- **Spec Reference**: `Issues/02.1.6.3-swipe-configuration-settings-refactor.md`

## Intent

### October 11, 2025 - 06:32 PM EDT — SettingsManager Concurrency Guardrail

**Objective**: Resolve the crash surfaced during the full regression when the app relaunched mid-test because `SettingsManager` touched main-actor state from a Combine callback running off the main actor.

- During `SwipeConfigurationUITests.testSwipeConfigurationPresetPersistsAcrossLaunches`, `UserDefaultsSettingsRepository.saveGlobalUISettings` emitted a change notification that `SettingsManager` forwarded through `settingsChangedPublisher`. The sink closes over `self` before hopping back to the main actor, violating Swift concurrency exclusivity and tripping `_dispatch_assert_queue_fail`.
- Planned fix: restructure the subscription to enqueue the entire handler inside `Task { @MainActor [weak self] in … }`, moving the `guard let self` into that context so no main-actor state is touched until execution resumes on the correct executor. This keeps the publisher signature intact while satisfying isolation.
- Validation strategy:
  1. Update `SettingsManager` sink implementation.
  2. Re-run `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` to confirm the simulator no longer crashes or relaunches mid-flow.
  3. Re-run the full regression script to ensure broader coverage still passes without new incidents.

**Next Steps**:
1. Adjust the Combine subscription in `SettingsManager` to wrap the entire body in a main-actor task and relocate the weak self guard inside it.
2. Execute the targeted UI suite followed by the full regression, capturing logs in `TestResults/`.


### October 11, 2025 - 07:56 PM EDT — Guardrail Implemented & Verified

**Work Performed**: Updated the repository bridge in `SettingsManager` so the Combine subscription enqueues its entire handling block inside `Task { @MainActor … }`, ensuring the weak-self check and subsequent state updates execute on the correct executor. Ran `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` (log: `TestResults/TestResults_20251011_183134_test_zpodUITests-SwipeConfigurationUITests.log`) followed by the full regression `./scripts/run-xcode-tests.sh` (UI log: `TestResults/TestResults_20251011_183841_test_zpod-ui.log`). No crash reports were collected during tear down, and the suite remained green with the usual two skipped UI scenarios.

**Next Steps**:
- Monitor future settings-related subscriptions for similar patterns; add unit coverage if a regression reproduces.
- Continue with 02.1.6.3 deliverables (hooking additional configuration features into the registry) now that the concurrency guardrail is stable.


### October 11, 2025 - 08:22 PM EDT — Adjusted Combine Bridge to Avoid Executor Precondition

**Work Performed**: The previous `Task { @MainActor … }` wrapper still tripped `_dispatch_assert_queue_fail` because the sink executed before hopping to the main actor. Refactored `SettingsManager` so repository emissions feed a helper `applyRepositoryChange(_:)` that is `@MainActor` isolated; the sink now launches a detached `Task` that awaits this helper, leaving all property mutations and `PassthroughSubject` sends on the main executor. Re-ran `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` (log: `TestResults/TestResults_20251011_185631_test_zpodUITests-SwipeConfigurationUITests.log`) and the full regression `./scripts/run-xcode-tests.sh` (UI log: `TestResults/TestResults_20251011_190331_test_zpod-ui.log`). No crash dialogs surfaced, and XCTest no longer captures diagnostic reports during tear down.

**Next Steps**:
- Keep observing subsequent regression runs for unexpected crash reports; if any appear, extend logging inside `SettingsRepository` for queue auditing.
- Resume the remaining registry integration tasks under Issue 02.1.6.3 now that the settings manager bridge is stable.


### October 11, 2025 - 08:55 PM EDT — Finalize Main-Actor Task Handoff

**Work Performed**: Tightened the Combine sink again so the spawned task is explicitly `@MainActor` before dereferencing `self`, preventing any queue assertions when the repository emits from a background executor. Targeted rerun `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` produced `TestResults/TestResults_20251011_191917_test_zpodUITests-SwipeConfigurationUITests.log` with no crash reports collected. Full regression rerun pending confirmation once broader settings work resumes.

**Next Steps**:
- Run the full regression before merging the branch to guarantee no remaining concurrency violations.
- Continue the modular settings integration once stability is reconfirmed.


### October 11, 2025 - 09:48 PM EDT — Await-on-MainActor Refactor

**Work Performed**: Remote regression still surfaced crash dialogs, so the Combine sink now launches a plain `Task` that immediately executes `await MainActor.run { … }` before touching `self`. This guarantees the guard and `applyRepositoryChange` call occur only after transitioning to the main executor. The latest targeted run (`./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests`) succeeded without crash artifacts (`TestResults/TestResults_20251011_193955_test_zpodUITests-SwipeConfigurationUITests.log`).

**Next Steps**:
- Re-run the full regression to confirm parity across environments.
- Instrument `SettingsRepository` emission queues if additional reports appear.


### October 11, 2025 - 10:26 PM EDT — Receive(on:) Stabilization

**Work Performed**: Instead of spinning a task and hopping back with `MainActor.run`, updated the Combine pipeline to deliver repository changes via `.receive(on: DispatchQueue.main)`. This keeps the sink on the main executor without extra async hops and removes the `_dispatch_assert_queue_fail` assertion seen on remote runs. Targeted rerun `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` produced `TestResults/TestResults_20251011_200835_test_zpodUITests-SwipeConfigurationUITests.log`, and the follow-up full regression (`./scripts/run-xcode-tests.sh`) generated `TestResults/TestResults_20251011_201507_test_zpod-ui.log`; neither run surfaced new crash artifacts.

**Next Steps**:
- Share these results with the rest of the team; if partners still observe crashes, gather their `.crash` bundles to confirm timestamps align with pre-fix binaries.
- Continue 02.1.6.3 modularization tasks with confidence that settings notifications now stay on the main actor.


### October 11, 2025 - 10:07 PM EDT — Full Regression After Await Fix

**Work Performed**: Executed `./scripts/run-xcode-tests.sh` end-to-end after the await-on-main refactor. Syntax, workspace build, unit suite, and UI suite all passed (UI log: `TestResults/TestResults_20251011_194716_test_zpod-ui.log`), and the harness reported no crash artifacts during teardown.

**Next Steps**:
- Share results with the team and continue 02.1.6.3 modularization tasks now that the regression is clean.
- Keep monitoring remote runs for residual crash popups; if reproduced, capture the accompanying `.crash` bundle for deeper analysis.


### October 12, 2025 - 06:48 AM EDT — Settings Feature Route Factory

**Work Performed**: Introduced `SettingsFeatureRouteFactory` in LibraryFeature to centralize how the settings shell produces detail destinations. `SettingsFeatureDetailView` now requests a `SettingsFeatureRoute` that wraps the feature controller, its baseline loader, and a type-erased view builder, eliminating the brittle descriptor-specific switch and keeping the shell scalable as new features register with the configuration registry.

**Validation**: `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` (expected crash reproduced for external capture; log `TestResults/TestResults_20251012_064756_test_zpodUITests-SwipeConfigurationUITests.log`).

**Next Steps**:
- After the crash investigation concludes, rerun the full regression to ensure the route factory introduces no regressions.
- Extend the factory mapping whenever additional configuration features are registered.


### October 12, 2025 - 08:35 AM EDT — Shared Settings Components Design

**Intent**: Extract SwiftUI primitives that every configuration screen can reuse—toggle rows, segmented option pickers, and preset buttons—so future features plug into the registry without duplicating layout/styling. These components will bundle accessibility identifiers, optional footers, and consistent typography while letting callers provide bindings and change handlers.

- Create `SettingsToggleRow`, `SettingsSegmentedPickerRow`, and `SettingsPresetButton` in LibraryFeature with configurable labels, footers, and identifiers.
- Update `SwipeActionConfigurationView` to adopt the new components for full-swipe toggles, haptic controls, and presets, ensuring behaviour stays identical (bindings + onChange hooks).
- Back the components with lightweight unit previews/tests that confirm accessibility identifiers and state propagation.
- Once integrated, these primitives become the building blocks for upcoming playback/download configuration UIs and any future registry entries.

**Plan**:
1. Introduce the shared component file and basic tests.
2. Migrate the swipe configuration view to use the components, verifying accessibility IDs remain unchanged.
3. Re-run the swipe UI suite to ensure no behavioural drift before proceeding to the next feature extraction.


### October 12, 2025 - 09:12 AM EDT — Shared Components Implemented

**Work Performed**: Added `SettingsToggleRow`, `SettingsSegmentedPickerRow`, and `SettingsPresetButton` (with optional accessibility identifiers and helper modifier) and migrated `SwipeActionConfigurationView` to use them. The view now relies on consistent primitives for toggle rows, segmented pickers, and preset buttons. Introduced `SettingsFeatureRouteFactoryTests` to certify the existing routing factory keeps working after the refactor.

**Validation**:
- `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` → `TestResults/TestResults_20251012_071724_test_zpodUITests-SwipeConfigurationUITests.log`
- `./scripts/run-xcode-tests.sh` → `TestResults/TestResults_20251012_075027_test_zpod-ui.log` (full regression, 2 expected skips)

**Next Steps**:
- Apply the shared components to playback/download configuration screens once their views are refactored under the modular registry.
- Evaluate additional reusable primitives (e.g., grouped headers, option pickers) as new settings features surface.


### October 12, 2025 - 09:48 AM EDT — Adopt Shared Components in Playback/Download Views

**Work Performed**: Updated `PlaybackConfigurationView` and `DownloadConfigurationView` to adopt `SettingsToggleRow` and `SettingsSegmentedPickerRow`, keeping all existing bindings and accessibility identifiers. This unifies the UI affordances across the settings surfaces and prepares the screens for future styling tweaks.

**Validation**: `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` (run at 07:22 UTC; no regressions, log `TestResults/TestResults_20251012_071724_test_zpodUITests-SwipeConfigurationUITests.log`).

**Next Steps**:
- Consider extending the shared primitives to cover steppers/pickers used in playback/download screens to further reduce duplication.
- Continue modularizing additional configuration features using the common component library.


### October 12, 2025 - 10:22 AM EDT — Planning Steppers & Next Feature Modularization

**Intent**: Extract shared `SettingsStepperRow` / `SettingsPickerRow` components so skip/retention controls adopt the same design language as toggles/presets, then begin the next modular feature by wiring the playback preset editor through the shared primitives (including explicit preset descriptions and helper badges). This sets us up to consolidate playback preset logic ahead of future registry entries.

**Plan**:
1. Introduce reusable stepper & picker rows with accessibility identifier support and optional footers.
2. Migrate playback skip/retention controls and download limits to use the new rows.
3. Extend playback presets with shared button descriptions (paving the way for future preset configuration feature).
4. Re-run swipe/playback focused UITests and note results.


### October 12, 2025 - 10:45 AM EDT — Plan Slider Component Adoption

**Intent**: Round out the shared component set with `SettingsSliderRow` for numeric adjustments (playback speed, crossfade duration, played threshold). Adopting this will eliminate the remaining bespoke slider markup in `PlaybackConfigurationView`, making future slider-based settings trivial to wire up.

**Plan**:
1. Add `SettingsSliderRow` to the LibraryFeature component library with label support, optional formatter closure, and identifier.
2. Replace the playback speed, crossfade duration, and played-threshold slider blocks with the new component while preserving bindings and labels.
3. Re-run the swipe suite (still the primary automated coverage for the settings modal stack) to confirm the shared component behaves identically.


### October 12, 2025 - 10:57 AM EDT — Slider Component Implemented

**Work Performed**: Added `SettingsSliderRow` with configurable formatting/identifiers and optional helper text, then adopted it across `PlaybackConfigurationView` (playback speed, crossfade duration, played threshold). The component renders a consistent label, slider, value readout, and optional footer so future slider-based settings can drop in with minimal boilerplate.

**Validation**: `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` → `TestResults/TestResults_20251012_085314_test_zpodUITests-SwipeConfigurationUITests.log`.

**Next Steps**:
- Consider adding optional helper text/footers to slider rows when needed by future settings.
- Continue modularizing remaining settings surfaces using the shared component library.


### October 06, 2025 - 01:18 PM EDT — Coverage Expansion Planning

**Objective**: Define test expansions to validate preset iteration, action caps, and registry-driven controller factories before implementation.

- Unit scope: extend `SwipeConfigurationControllerTests` with scenarios covering `applyPreset(_:)` across non-default presets (ensuring arrays match expected ordering) and `addAction(_:edge:)` enforcement of the three-action limit per edge.
- UI automation: introduce a new test exercising each preset in sequence, verifying debug summary updates and ensuring Save enables for every preset. Add assertions that menu additions respect the three-action cap (no new buttons once limit reached) and include cleanup via restore defaults.
- Helpers: update UITest utilities to expose reusable assertions for debug state fragments (leading/trailing arrays, full swipe flags) instead of ad-hoc checks per test.
- Risks: additional UI test runtime (~+60s) — monitor for timeouts and reuse existing waiters. Ensure new controller tests remain mac-compatible if/when SwiftPM support is enabled.

**Next Steps**:
1. Add controller test cases first to capture expected preset/action behaviours.
2. Expand UITest suite with a dedicated `testSwipeConfigurationPresetsCycle` (or equivalent) using new helpers for debug state validation.
3. Re-run targeted UI suite; capture runtime impact and document in TestSummary if notable.


### October 06, 2025 - 01:17 PM EDT — Registry Wiring & Settings Manager Integration

**Objective**: Instantiate the feature configuration registry inside `SettingsManager`, register the swipe configuration feature, and expose controller/service factories for downstream consumers.

- Added `SwipeConfigurationFeature` in SettingsDomain so the registry can vend a descriptor and controller backed by the shared `SwipeConfigurationService`.
- Extended `SettingsManager` with a stored swipe configuration service, public registry handle, and `makeSwipeConfigurationController()` helper that bootstraps with current `globalUISettings`.
- Updated `EpisodeListDependencyProvider` to source the swipe service from a `SettingsManager` instance, keeping episode list sheets and future settings surfaces on the same persistence pipeline.
- Authored `SettingsManagerFeatureRegistryTests` covering descriptor enumeration, controller instantiation, and the manager factory helper (new macOS target not yet enabled due to Persistence package availability).
- Re-ran `./scripts/run-xcode-tests.sh -t SwipeConfigurationUITests` → ✅ (`TestResults/TestResults_20251006_131225_test_zpodUITests-SwipeConfigurationUITests.log`). Direct `swift test` for SettingsDomain still blocked by macOS availability gaps in Persistence; captured as a follow-up risk.

**Next Steps**:
1. Add lightweight wrapper(s) so the forthcoming settings shell can request SwiftUI views from feature descriptors without depending on LibraryFeature directly.
2. Expand UITest permutations to iterate all presets and assert three-action cap enforcement alongside registry-driven controller injection.


### October 06, 2025 - 01:04 PM EDT — Registry Integration Design Kickoff

**Objective**: Plan how to host the new `FeatureConfigurationRegistry` inside the settings shell, surface the swipe feature via the registry, and outline coverage expansion for controller + UI automation.

- Inventory existing settings entry points (`Packages/SettingsDomain/Sources/SettingsDomain/SettingsManager.swift`, app-level navigation to settings, and any SwiftUI shells) to determine where the registry should live. Target: centralize in `SettingsManager` (as owner of configuration services) while exposing `@MainActor` accessors for UI composition.
- Define `SwipeConfigurationFeature` type that conforms to `ConfigurableFeature`, initializes `SwipeConfigurationController` with `SwipeConfigurationService`, and builds the SwiftUI configuration view. Ensure the view factory is @MainActor and composes the existing `SwipeActionConfigurationView` without duplicating state.
- Decide injection story: registry seeded either via `EpisodeListDependencyProvider` or a new `SettingsDependencyProvider`. Prefer `SettingsManager.makeRegistry()` factory to keep wiring testable; document this path in the issue file.
- Testing plan:
  1. Add unit coverage validating registry returns the swipe descriptor when feature is available and that controller factory yields a configured controller with bootstrapped baseline.
  2. Extend UITest to open future settings host once available; near-term, add controller unit tests for preset iteration + full-swipe cap, and update UI automation to iterate presets + enforce cap toggles.
- Risk checklist:
  - Avoid cross-actor violations: registry operations must remain async/await friendly; ensure the registry doesn’t capture view instances outside the main actor.
  - Maintain compatibility with existing `SettingsManager.updateGlobalUISettings`; plan depreciation notes but keep API functioning.
- Exit criteria for this phase:
  - Registry instantiation path agreed and documented.
  - Swipe feature registration API sketched (including dependency injection + preview/test scaffolding).
  - UITest enhancements scoped with concrete helper APIs to avoid brittle coordinate taps.

**Next Actions**:
1. Update Issue 02.1.6.3 objectives/acceptance criteria with registry wiring notes (already captured via issue edit; verify alignment).
2. Draft `SwipeConfigurationFeature` skeleton in SettingsDomain (tests first) and wire registry creation to place the feature into the settings shell.
3. Define additional UITest assertions covering preset rotation and action cap enforcement.
