name: CI

on:
  workflow_dispatch:
    inputs:
      matrix:
        description: "Choose which matrix to run (all, packages, ui, ui-swipe, ui-playback, linux)"
        required: false
        type: choice
        default: "all"
        options:
          - all
          - preflight
          - unit-tests
          - integration-tests
          - ui
          - ui-swipe
          - ui-playback
          - packages
          - linux
  push:
    branches:
      - main
    tags-ignore:
      - "*"
  pull_request:
    branches:
      - main

jobs:
  preflight:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"
      - name: Self-check build script
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Ensure iOS Simulator runtime is installed
        run: |
          set -euo pipefail
          echo "Checking installed runtimes before download..."
          xcrun simctl list runtimes || true

          HAS_IOS_RUNTIME=$(xcrun simctl list runtimes | grep -c "iOS ") || true
          if [ "$HAS_IOS_RUNTIME" -eq 0 ]; then
            echo "No iOS runtimes found. Attempting to download iOS platform..."
            sudo xcodebuild -runFirstLaunch || true
            if xcodebuild -help | grep -q "-downloadPlatform"; then
              sudo xcodebuild -downloadPlatform iOS || true
            fi
            if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
              echo "Retrying with -downloadAllPlatforms..."
              if xcodebuild -help | grep -q "-downloadAllPlatforms"; then
                sudo xcodebuild -downloadAllPlatforms || true
              fi
            fi
            echo "Runtimes after download attempt:"
            xcrun simctl list runtimes || true
          fi

          if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
            echo "⚠️ No iOS CoreSimulator runtimes available after download attempts. Proceeding with generic simulator fallback."
          fi

      - name: Resolve shared Xcode scheme
        id: resolve-scheme
        run: |
          set -euo pipefail
          LIST_OUTPUT="$(xcodebuild -workspace zpod.xcworkspace -list)"
          SCHEME=""
          for candidate in "zpod (zpod project)" "zpod"; do
            if printf '%s\n' "$LIST_OUTPUT" | grep -F "        $candidate" >/dev/null 2>&1; then
              SCHEME="$candidate"
              break
            fi
          done
          if [ -z "$SCHEME" ]; then
            echo "Unable to locate a shared scheme in zpod.xcworkspace" >&2
            printf '%s\n' "$LIST_OUTPUT" >&2
            exit 1
          fi
          echo "Resolved scheme: $SCHEME"
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: Resolve simulator destination
        id: resolve-destination
        run: |
          set -euo pipefail
          DESTINATION="$(./scripts/resolve-simulator-destination.sh "iPhone 17 Pro" "${{ steps.resolve-scheme.outputs.scheme }}")"
          if [ -z "$DESTINATION" ]; then
            echo "Destination resolution returned empty output" >&2
            exit 1
          fi
          echo "Resolved destination: $DESTINATION"
          echo "destination=$DESTINATION" >> "$GITHUB_OUTPUT"

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/*.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve SPM Dependencies with Retry
        run: |
          set -euo pipefail
          MAX_RETRIES=3
          SCHEME="${{ steps.resolve-scheme.outputs.scheme }}"

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt/$MAX_RETRIES: Resolving SPM dependencies..."

            set +e
            xcodebuild \
              -workspace zpod.xcworkspace \
              -scheme "$SCHEME" \
              -resolvePackageDependencies
            status=$?
            set -e

            if [ $status -eq 0 ]; then
              echo "✅ Dependencies resolved successfully on attempt $attempt"
              exit 0
            fi

            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "⚠️ Resolution failed with status $status, clearing caches and retrying..."
              rm -rf .build ~/Library/Developer/Xcode/DerivedData/*/SourcePackages 2>/dev/null || true
              sleep 5
            fi
          done

          echo "❌ Failed to resolve dependencies after $MAX_RETRIES attempts"
          exit 1

      - name: Swift syntax verification
        run: |
          set -euo pipefail
          ./scripts/run-xcode-tests.sh -s
        env:
          NSUnbufferedIO: "YES"

      - name: Clean build (all targets)
        run: |
          set -euo pipefail
          ./scripts/run-xcode-tests.sh -c -b all
        env:
          NSUnbufferedIO: "YES"
          ZPOD_DERIVED_DATA_PATH: ${{ github.workspace }}/tmp_ci/DerivedData/HostPrebuild

      - name: Build host app and test bundles for reuse
        run: |
          set -euo pipefail
          DEST_PATH="$PWD/tmp_ci/DerivedData/HostPrebuild"
          DESTINATION="${{ steps.resolve-destination.outputs.destination }}"
          SCHEME="${{ steps.resolve-scheme.outputs.scheme }}"
          if [ -z "$DESTINATION" ]; then
            echo "Simulator destination not resolved" >&2
            exit 1
          fi
          if [ -z "$SCHEME" ]; then
            echo "Xcode scheme not resolved" >&2
            exit 1
          fi
          echo "Building host app (standard build) to ensure binary is produced..."
          xcodebuild \
            -workspace zpod.xcworkspace \
            -scheme "$SCHEME" \
            -sdk iphonesimulator \
            -destination "$DESTINATION" \
            -derivedDataPath "$DEST_PATH" \
            build
          echo "Building host + test bundles for testing reuse..."
          xcodebuild \
            -workspace zpod.xcworkspace \
            -scheme "$SCHEME" \
            -sdk iphonesimulator \
            -destination "$DESTINATION" \
            -derivedDataPath "$DEST_PATH" \
            build-for-testing
          HOST_APP="$DEST_PATH/Build/Products/Debug-iphonesimulator/zpod.app"
          if [ ! -f "$HOST_APP/zpod" ] && [ -f "$HOST_APP/zpod.debug.dylib" ]; then
            ln -sf zpod.debug.dylib "$HOST_APP/zpod"
          fi
          xcodebuild \
            -workspace zpod.xcworkspace \
            -scheme IntegrationTests \
            -sdk iphonesimulator \
            -destination "$DESTINATION" \
            -derivedDataPath "$DEST_PATH" \
            build-for-testing
        env:
          NSUnbufferedIO: "YES"

      - name: Verify build completeness
        run: |
          set -euo pipefail
          HOST_DIR="$PWD/tmp_ci/DerivedData/HostPrebuild/Build/Products/Debug-iphonesimulator"

          echo "Verifying host app bundle..."
          if [ ! -d "$HOST_DIR/zpod.app" ]; then
            echo "❌ Host app bundle missing at $HOST_DIR/zpod.app"
            ls -R "$HOST_DIR" || true
            exit 1
          fi

          echo "Verifying main binary..."
          if [ ! -f "$HOST_DIR/zpod.app/zpod" ] && [ ! -f "$HOST_DIR/zpod.app/zpod.debug.dylib" ]; then
            echo "❌ Main binary missing (neither zpod nor zpod.debug.dylib found)"
            ls -la "$HOST_DIR/zpod.app/" || true
            exit 1
          fi

          echo "Verifying test bundles..."
          for test_bundle in AppSmokeTests.xctest IntegrationTests.xctest zpodUITests.xctest; do
            if [ ! -d "$HOST_DIR/$test_bundle" ]; then
              echo "⚠️ Test bundle missing: $test_bundle"
            else
              echo "✅ Found test bundle: $test_bundle"
            fi
          done

          echo "✅ Build verification passed"

      - name: Package host derived data
        run: |
          set -euo pipefail
          HOST_ROOT="$PWD/tmp_ci/DerivedData/HostPrebuild"
          APP_DIR="$HOST_ROOT/Build/Products/Debug-iphonesimulator/zpod.app"

          if [ ! -f "$APP_DIR/zpod" ] && [ -f "$APP_DIR/zpod.debug.dylib" ]; then
            ln -sf zpod.debug.dylib "$APP_DIR/zpod"
          fi

          mkdir -p artifacts
          tar -czf artifacts/host-app.tar.gz -C "$HOST_ROOT" .

          # Generate checksum for integrity verification (use relative path in checksum file)
          cd artifacts
          shasum -a 256 host-app.tar.gz > host-app.tar.gz.sha256
          echo "Generated artifact checksum:"
          cat host-app.tar.gz.sha256
          cd ..

      - name: Upload Host App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: host-app
          path: |
            artifacts/host-app.tar.gz
            artifacts/host-app.tar.gz.sha256
          if-no-files-found: error
          retention-days: 1

      - name: Archive Preflight Results
        if: always()
        run: |
          set -euo pipefail
          mkdir -p artifacts/preflight
          if ls TestResults >/dev/null 2>&1; then
            find TestResults -maxdepth 1 -mindepth 1 \( -name "TestResults_*.xcresult" -o -name "TestResults_*.log" \) \
              -exec cp -R {} artifacts/preflight/ \;
          fi
      - name: Upload Preflight Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-preflight
          path: artifacts/preflight
          if-no-files-found: warn

  unit-tests:
    runs-on: macos-latest
    if: github.event_name != 'workflow_dispatch'
      || github.event.inputs.matrix == 'all'
      || github.event.inputs.matrix == 'unit-tests'
      || github.event.inputs.matrix == 'integration-tests'
      || github.event.inputs.matrix == 'ui'
      || github.event.inputs.matrix == 'ui-swipe'
      || github.event.inputs.matrix == 'ui-playback'
    needs:
      - preflight
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"
      - name: Self-check build script
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Ensure iOS Simulator runtime is installed
        run: |
          set -euo pipefail
          echo "Checking installed runtimes before download..."
          xcrun simctl list runtimes || true

          HAS_IOS_RUNTIME=$(xcrun simctl list runtimes | grep -c "iOS ") || true
          if [ "$HAS_IOS_RUNTIME" -eq 0 ]; then
            echo "No iOS runtimes found. Attempting to download iOS platform..."
            sudo xcodebuild -runFirstLaunch || true
            if xcodebuild -help | grep -q "-downloadPlatform"; then
              sudo xcodebuild -downloadPlatform iOS || true
            fi
            if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
              echo "Retrying with -downloadAllPlatforms..."
              if xcodebuild -help | grep -q "-downloadAllPlatforms"; then
                sudo xcodebuild -downloadAllPlatforms || true
              fi
            fi
            echo "Runtimes after download attempt:"
            xcrun simctl list runtimes || true
          fi

          if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
            echo "⚠️ No iOS CoreSimulator runtimes available after download attempts. Proceeding with generic simulator fallback."
          fi

      - name: Cleanup old zpod simulators from previous runs
        run: ./scripts/ci/cleanup-all-zpod-simulators.sh

      - name: Provision unit-test simulator & derived data
        id: unit-sim
        run: |
          set -euo pipefail

          SAFE_NAME="AppSmoke"
          DERIVED_PATH="$PWD/tmp_ci/DerivedData/${SAFE_NAME}"

          rm -rf "$DERIVED_PATH"
          mkdir -p "$DERIVED_PATH"
          echo "ZPOD_DERIVED_DATA_PATH=$DERIVED_PATH" >> "$GITHUB_ENV"
          echo "derived_path=$DERIVED_PATH" >> "$GITHUB_OUTPUT"

          RUNTIME_ID=$(xcrun simctl list runtimes -j | python3 -c "import json,sys; runtimes=json.load(sys.stdin).get('runtimes',[]); preferred=[r for r in runtimes if r.get('identifier','').startswith('com.apple.CoreSimulator.SimRuntime.iOS-18') and r.get('isAvailable')]; preferred = preferred or [r for r in runtimes if r.get('platform','')=='iOS' and r.get('isAvailable')]; print(preferred[0]['identifier'] if preferred else '')" || true)

          if [ -z "$RUNTIME_ID" ]; then
            echo "::warning::Unable to determine an iOS runtime; tests will fall back to default destination."
            exit 0
          fi

          SIM_NAME="zpod-${GITHUB_RUN_ID}-${SAFE_NAME}"
          DEVICE_CANDIDATES=(
            com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-16
            com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-17
            com.apple.CoreSimulator.SimDeviceType.iPhone-15-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-15
            com.apple.CoreSimulator.SimDeviceType.iPhone-14-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-14
            com.apple.CoreSimulator.SimDeviceType.iPhone-13-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-13
          )

          DEVICE_LIST=$(xcrun simctl list devicetypes)
          SELECTED_DEVICE=""
          UDID=""
          CREATE_LOG=$(mktemp)

          for candidate in "${DEVICE_CANDIDATES[@]}"; do
            if ! printf '%s' "$DEVICE_LIST" | grep -q "$candidate"; then
              continue
            fi
            echo "Attempting to create simulator ${candidate} for runtime ${RUNTIME_ID}"
            set +e
            UDID=$(xcrun simctl create "$SIM_NAME" "$candidate" "$RUNTIME_ID" 2>"$CREATE_LOG")
            status=$?
            set -e
            UDID=$(printf '%s' "$UDID" | tr -d '\r\n')
            if [ $status -eq 0 ] && [ -n "$UDID" ]; then
              SELECTED_DEVICE="$candidate"
              break
            fi
            echo "::warning::Failed to create ${candidate} – $(cat "$CREATE_LOG")"
            UDID=""
          done

          rm -f "$CREATE_LOG"

          if [ -z "$UDID" ]; then
            echo "::warning::Unable to create a dedicated simulator for runtime ${RUNTIME_ID}; tests will fall back to automatic destination."
            exit 0
          fi

          echo "Created simulator ${SIM_NAME} (${UDID}) using device ${SELECTED_DEVICE}"

          # Boot simulator with retry logic
          MAX_BOOT_RETRIES=3
          BOOT_SUCCESS=0

          for boot_attempt in $(seq 1 $MAX_BOOT_RETRIES); do
            echo "Boot attempt $boot_attempt/$MAX_BOOT_RETRIES for simulator ${SIM_NAME} (${UDID})"

            # Clean up any existing processes before retry
            if [ $boot_attempt -gt 1 ]; then
              echo "Cleaning up before retry attempt..."
              killall -9 Simulator 2>/dev/null || true
              xcrun simctl shutdown "$UDID" 2>/dev/null || true
              sleep 5
            fi

            # Attempt to boot with extended timeout
            set +e
            xcrun simctl boot "$UDID"
            boot_status=$?
            set -e

            if [ $boot_status -eq 0 ]; then
              # Verify boot completed successfully
              set +e
              xcrun simctl bootstatus "$UDID" -b
              bootstatus_status=$?
              set -e

              if [ $bootstatus_status -eq 0 ]; then
                # Final health check: verify simulator is actually responsive
                sleep 2
                if xcrun simctl list devices | grep -q "$UDID.*Booted"; then
                  echo "✅ Simulator booted successfully and is responsive"
                  BOOT_SUCCESS=1
                  break
                else
                  echo "⚠️ Simulator reported booted but not in device list"
                fi
              else
                echo "⚠️ Boot status check failed with status ${bootstatus_status}"
              fi
            else
              echo "⚠️ Boot command failed with status ${boot_status}"
            fi

            if [ $boot_attempt -lt $MAX_BOOT_RETRIES ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          done

          if [ $BOOT_SUCCESS -eq 0 ]; then
            echo "❌ Failed to boot simulator after $MAX_BOOT_RETRIES attempts"
            echo "::error::Simulator boot failed after retries. Tests will fall back to automatic destination."
            # Don't fail the step - let tests fall back to automatic destination
            echo "ZPOD_SIMULATOR_UDID=" >> "$GITHUB_ENV"
            echo "ZPOD_SIMULATOR_NAME=" >> "$GITHUB_ENV"
            echo "udid=" >> "$GITHUB_OUTPUT"
            echo "sim_name=" >> "$GITHUB_OUTPUT"
          else
            echo "ZPOD_SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
            echo "ZPOD_SIMULATOR_NAME=$SIM_NAME" >> "$GITHUB_ENV"
            echo "udid=$UDID" >> "$GITHUB_OUTPUT"
            echo "sim_name=$SIM_NAME" >> "$GITHUB_OUTPUT"
          fi

          echo "ZPOD_SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
          echo "ZPOD_SIMULATOR_NAME=$SIM_NAME" >> "$GITHUB_ENV"
          echo "udid=$UDID" >> "$GITHUB_OUTPUT"
          echo "sim_name=$SIM_NAME" >> "$GITHUB_OUTPUT"

      - name: Pre-warm simulator for unit tests
        if: steps.unit-sim.outputs.udid != ''
        run: |
          set -euo pipefail
          UDID="${{ steps.unit-sim.outputs.udid }}"

          echo "Pre-warming simulator services for faster test execution..."

          # Wait for SpringBoard to be fully ready
          echo "Waiting for SpringBoard to launch..."
          for j in {1..60}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.SpringBoard; then
              break
            fi
            sleep 0.5
          done

          # Pre-warm accessibility services (critical for UI testing)
          echo "Initializing accessibility services..."
          xcrun simctl spawn "$UDID" launchctl list com.apple.accessibility.AccessibilityUIServer 2>/dev/null || true

          # Wait for accessibility server to be ready
          for j in {1..30}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.accessibility; then
              break
            fi
            sleep 0.5
          done

          # Small delay to let services stabilize
          sleep 2

          echo "✅ Simulator pre-warming complete"

      - name: Download host app artifact
        uses: actions/download-artifact@v4
        with:
          name: host-app
          path: host-app

      - name: Restore host app bundle
        run: scripts/ci/restore-host-app.sh "${{ steps.unit-sim.outputs.derived_path }}" host-app

      - name: Run AppSmoke tests
        run: |
          set -euo pipefail
          ./scripts/run-xcode-tests.sh -t AppSmokeTests
        env:
          NSUnbufferedIO: "YES"
          ZPOD_SIMULATOR_UDID: ${{ steps.unit-sim.outputs.udid }}
          ZPOD_DERIVED_DATA_PATH: ${{ steps.unit-sim.outputs.derived_path }}
          ZPOD_TEST_WITHOUT_BUILDING: "1"

      - name: Archive Test Results
        if: always()
        run: scripts/ci/archive-test-results.sh AppSmoke
      - name: Upload Unit Test Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-AppSmoke
          path: artifacts/AppSmoke
          if-no-files-found: warn

      - name: Cleanup unit-test simulator
        if: always()
        run: scripts/ci/cleanup-simulator.sh "${{ steps.unit-sim.outputs.udid }}" "${{ steps.unit-sim.outputs.derived_path }}"

  integration-tests:
    runs-on: macos-15
    timeout-minutes: 60
    if: github.event_name != 'workflow_dispatch'
      || github.event.inputs.matrix == 'all'
      || github.event.inputs.matrix == 'integration-tests'
    needs:
      - unit-tests
      - package-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"
      - name: Self-check build script
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Ensure iOS Simulator runtime is installed
        run: |
          set -euo pipefail
          echo "Checking installed runtimes before download..."
          xcrun simctl list runtimes || true

          HAS_IOS_RUNTIME=$(xcrun simctl list runtimes | grep -c "iOS ") || true
          if [ "$HAS_IOS_RUNTIME" -eq 0 ]; then
            echo "No iOS runtimes found. Attempting to download iOS platform..."
            sudo xcodebuild -runFirstLaunch || true
            if xcodebuild -help | grep -q "-downloadPlatform"; then
              sudo xcodebuild -downloadPlatform iOS || true
            fi
            if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
              echo "Retrying with -downloadAllPlatforms..."
              if xcodebuild -help | grep -q "-downloadAllPlatforms"; then
                sudo xcodebuild -downloadAllPlatforms || true
              fi
            fi
            echo "Runtimes after download attempt:"
            xcrun simctl list runtimes || true
          fi

          if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
            echo "⚠️ No iOS CoreSimulator runtimes available after download attempts. Proceeding with generic simulator fallback."
          fi

      - name: Cleanup old zpod simulators from previous runs
        run: ./scripts/ci/cleanup-all-zpod-simulators.sh

      - name: Provision integration simulator & derived data
        id: integration-sim
        run: |
          set -euo pipefail

          SAFE_NAME="Integration"
          DERIVED_PATH="$PWD/tmp_ci/DerivedData/${SAFE_NAME}"

          rm -rf "$DERIVED_PATH"
          mkdir -p "$DERIVED_PATH"
          echo "ZPOD_DERIVED_DATA_PATH=$DERIVED_PATH" >> "$GITHUB_ENV"
          echo "derived_path=$DERIVED_PATH" >> "$GITHUB_OUTPUT"

          RUNTIME_ID=$(xcrun simctl list runtimes -j | python3 -c "import json,sys; runtimes=json.load(sys.stdin).get('runtimes',[]); preferred=[r for r in runtimes if r.get('identifier','').startswith('com.apple.CoreSimulator.SimRuntime.iOS-18') and r.get('isAvailable')]; preferred = preferred or [r for r in runtimes if r.get('platform','')=='iOS' and r.get('isAvailable')]; print(preferred[0]['identifier'] if preferred else '')" || true)

          if [ -z "$RUNTIME_ID" ]; then
            echo "::warning::Unable to determine an iOS runtime; tests will fall back to default destination."
            exit 0
          fi

          SIM_NAME="zpod-${GITHUB_RUN_ID}-${SAFE_NAME}"
          DEVICE_CANDIDATES=(
            com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-16
            com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-17
            com.apple.CoreSimulator.SimDeviceType.iPhone-15-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-15
            com.apple.CoreSimulator.SimDeviceType.iPhone-14-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-14
            com.apple.CoreSimulator.SimDeviceType.iPhone-13-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-13
          )

          DEVICE_LIST=$(xcrun simctl list devicetypes)
          SELECTED_DEVICE=""
          UDID=""
          CREATE_LOG=$(mktemp)

          for candidate in "${DEVICE_CANDIDATES[@]}"; do
            if ! printf '%s' "$DEVICE_LIST" | grep -q "$candidate"; then
              continue
            fi
            echo "Attempting to create simulator ${candidate} for runtime ${RUNTIME_ID}"
            set +e
            UDID=$(xcrun simctl create "$SIM_NAME" "$candidate" "$RUNTIME_ID" 2>"$CREATE_LOG")
            status=$?
            set -e
            UDID=$(printf '%s' "$UDID" | tr -d '\r\n')
            if [ $status -eq 0 ] && [ -n "$UDID" ]; then
              SELECTED_DEVICE="$candidate"
              break
            fi
            echo "::warning::Failed to create ${candidate} – $(cat "$CREATE_LOG")"
            UDID=""
          done

          rm -f "$CREATE_LOG"

          if [ -z "$UDID" ]; then
            echo "::warning::Unable to create a dedicated simulator for runtime ${RUNTIME_ID}; tests will fall back to automatic destination."
            exit 0
          fi

          echo "Created simulator ${SIM_NAME} (${UDID}) using device ${SELECTED_DEVICE}"

          # Boot simulator with retry logic
          MAX_BOOT_RETRIES=3
          BOOT_SUCCESS=0

          for boot_attempt in $(seq 1 $MAX_BOOT_RETRIES); do
            echo "Boot attempt $boot_attempt/$MAX_BOOT_RETRIES for simulator ${SIM_NAME} (${UDID})"

            # Clean up any existing processes before retry
            if [ $boot_attempt -gt 1 ]; then
              echo "Cleaning up before retry attempt..."
              killall -9 Simulator 2>/dev/null || true
              xcrun simctl shutdown "$UDID" 2>/dev/null || true
              sleep 5
            fi

            # Attempt to boot with extended timeout
            set +e
            xcrun simctl boot "$UDID"
            boot_status=$?
            set -e

            if [ $boot_status -eq 0 ]; then
              # Verify boot completed successfully
              set +e
              xcrun simctl bootstatus "$UDID" -b
              bootstatus_status=$?
              set -e

              if [ $bootstatus_status -eq 0 ]; then
                # Final health check: verify simulator is actually responsive
                sleep 2
                if xcrun simctl list devices | grep -q "$UDID.*Booted"; then
                  echo "✅ Simulator booted successfully and is responsive"
                  BOOT_SUCCESS=1
                  break
                else
                  echo "⚠️ Simulator reported booted but not in device list"
                fi
              else
                echo "⚠️ Boot status check failed with status ${bootstatus_status}"
              fi
            else
              echo "⚠️ Boot command failed with status ${boot_status}"
            fi

            if [ $boot_attempt -lt $MAX_BOOT_RETRIES ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          done

          if [ $BOOT_SUCCESS -eq 0 ]; then
            echo "❌ Failed to boot simulator after $MAX_BOOT_RETRIES attempts"
            echo "::error::Simulator boot failed after retries. Tests will fall back to automatic destination."
            # Don't fail the step - let tests fall back to automatic destination
            echo "ZPOD_SIMULATOR_UDID=" >> "$GITHUB_ENV"
            echo "ZPOD_SIMULATOR_NAME=" >> "$GITHUB_ENV"
            echo "udid=" >> "$GITHUB_OUTPUT"
            echo "sim_name=" >> "$GITHUB_OUTPUT"
          else
            echo "ZPOD_SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
            echo "ZPOD_SIMULATOR_NAME=$SIM_NAME" >> "$GITHUB_ENV"
            echo "udid=$UDID" >> "$GITHUB_OUTPUT"
            echo "sim_name=$SIM_NAME" >> "$GITHUB_OUTPUT"
          fi

          echo "ZPOD_SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
          echo "ZPOD_SIMULATOR_NAME=$SIM_NAME" >> "$GITHUB_ENV"
          echo "udid=$UDID" >> "$GITHUB_OUTPUT"
          echo "sim_name=$SIM_NAME" >> "$GITHUB_OUTPUT"

      - name: Download host app artifact
        uses: actions/download-artifact@v4
        with:
          name: host-app
          path: host-app

      - name: Restore host derived data
        run: scripts/ci/restore-host-app.sh "${{ steps.integration-sim.outputs.derived_path }}" host-app

      - name: Pre-warm simulator for integration tests
        if: steps.integration-sim.outputs.udid != ''
        run: |
          set -euo pipefail
          UDID="${{ steps.integration-sim.outputs.udid }}"

          echo "Pre-warming simulator services for faster test execution..."

          # Wait for SpringBoard to be fully ready
          echo "Waiting for SpringBoard to launch..."
          for j in {1..60}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.SpringBoard; then
              break
            fi
            sleep 0.5
          done

          # Pre-warm accessibility services (critical for UI testing)
          echo "Initializing accessibility services..."
          xcrun simctl spawn "$UDID" launchctl list com.apple.accessibility.AccessibilityUIServer 2>/dev/null || true

          # Wait for accessibility server to be ready
          for j in {1..30}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.accessibility; then
              break
            fi
            sleep 0.5
          done

          # Small delay to let services stabilize
          sleep 2

          echo "✅ Simulator pre-warming complete"

      - name: Run Integration Tests
        timeout-minutes: 45
        run: |
          set -euo pipefail
          ./scripts/run-xcode-tests.sh -t IntegrationTests
        env:
          NSUnbufferedIO: "YES"
          UITEST_TIMEOUT_SCALE: "1.5"
          ZPOD_SIMULATOR_UDID: ${{ steps.integration-sim.outputs.udid }}
          ZPOD_DERIVED_DATA_PATH: ${{ steps.integration-sim.outputs.derived_path }}
          ZPOD_TEST_WITHOUT_BUILDING: "1"

      - name: Archive Test Results
        if: always()
        run: scripts/ci/archive-test-results.sh Integration

      - name: Upload Integration Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-Integration
          path: artifacts/Integration
          if-no-files-found: warn

      - name: Cleanup integration simulator
        if: always()
        run: scripts/ci/cleanup-simulator.sh "${{ steps.integration-sim.outputs.udid }}" "${{ steps.integration-sim.outputs.derived_path }}"

  ui-tests:
    if: github.event_name != 'workflow_dispatch'
      || github.event.inputs.matrix == 'all'
      || github.event.inputs.matrix == 'ui'
    needs:
      - unit-tests
      - package-tests
    runs-on: macos-15
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include:
          - name: UITests-Navigation
            tests: zpodUITests/CoreUINavigationTests,zpodUITests/EpisodeListUITests
          - name: UITests-ContentDiscovery
            tests: zpodUITests/ContentDiscoveryUITests
          - name: UITests-PlayerNavigation
            tests: zpodUITests/PlayerNavigationTests,zpodUITests/PlayerPlaybackInteractionTests,zpodUITests/PlayerOrientationSnapshotTests
          - name: UITests-CorePlayback
            tests: zpodUITests/PlaybackUITests
          - name: UITests-BatchOperations
            tests: zpodUITests/BatchOperationUITests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"
      - name: Self-check build script
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Ensure iOS Simulator runtime is installed
        run: |
          set -euo pipefail
          echo "Checking installed runtimes before download..."
          xcrun simctl list runtimes || true

          HAS_IOS_RUNTIME=$(xcrun simctl list runtimes | grep -c "iOS ") || true
          if [ "$HAS_IOS_RUNTIME" -eq 0 ]; then
            echo "No iOS runtimes found. Attempting to download iOS platform..."
            sudo xcodebuild -runFirstLaunch || true
            if xcodebuild -help | grep -q "-downloadPlatform"; then
              sudo xcodebuild -downloadPlatform iOS || true
            fi
            if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
              echo "Retrying with -downloadAllPlatforms..."
              if xcodebuild -help | grep -q "-downloadAllPlatforms"; then
                sudo xcodebuild -downloadAllPlatforms || true
              fi
            fi
            echo "Runtimes after download attempt:"
            xcrun simctl list runtimes || true
          fi

          if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
            echo "⚠️ No iOS CoreSimulator runtimes available after download attempts. Proceeding with generic simulator fallback."
          fi

      - name: Cleanup old zpod simulators from previous runs
        run: ./scripts/ci/cleanup-all-zpod-simulators.sh

      - name: Provision dedicated simulator & derived data
        id: provision-sim
        run: |
          set -euo pipefail

          MATRIX_NAME="${{ matrix.name }}"
          SAFE_NAME=$(echo "$MATRIX_NAME" | tr '[:space:]/' '-' | tr -c 'A-Za-z0-9_-.' '-')
          SAFE_NAME="${SAFE_NAME%-}"
          DERIVED_PATH="$PWD/tmp_ci/DerivedData/${SAFE_NAME}"

          rm -rf "$DERIVED_PATH"
          mkdir -p "$DERIVED_PATH"
          echo "ZPOD_DERIVED_DATA_PATH=$DERIVED_PATH" >> "$GITHUB_ENV"
          echo "derived_path=$DERIVED_PATH" >> "$GITHUB_OUTPUT"

          RUNTIME_ID=$(xcrun simctl list runtimes -j | python3 -c "import json,sys; runtimes=json.load(sys.stdin).get('runtimes',[]); preferred=[r for r in runtimes if r.get('identifier','').startswith('com.apple.CoreSimulator.SimRuntime.iOS-18') and r.get('isAvailable')]; preferred = preferred or [r for r in runtimes if r.get('platform','')=='iOS' and r.get('isAvailable')]; print(preferred[0]['identifier'] if preferred else '')" || true)

          if [ -z "$RUNTIME_ID" ]; then
            echo "::warning::Unable to determine an iOS runtime; tests will fall back to default destination."
            exit 0
          fi

          SIM_NAME="zpod-${GITHUB_RUN_ID}-${SAFE_NAME}"
          DEVICE_CANDIDATES=(
            com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-16
            com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-17
            com.apple.CoreSimulator.SimDeviceType.iPhone-15-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-15
            com.apple.CoreSimulator.SimDeviceType.iPhone-14-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-14
            com.apple.CoreSimulator.SimDeviceType.iPhone-13-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-13
          )

          DEVICE_LIST=$(xcrun simctl list devicetypes)
          SELECTED_DEVICE=""
          UDID=""
          CREATE_LOG=$(mktemp)

          for candidate in "${DEVICE_CANDIDATES[@]}"; do
            if ! printf '%s' "$DEVICE_LIST" | grep -q "$candidate"; then
              continue
            fi
            echo "Attempting to create simulator ${candidate} for runtime ${RUNTIME_ID}"
            set +e
            UDID=$(xcrun simctl create "$SIM_NAME" "$candidate" "$RUNTIME_ID" 2>"$CREATE_LOG")
            status=$?
            set -e
            UDID=$(printf '%s' "$UDID" | tr -d '\r\n')
            if [ $status -eq 0 ] && [ -n "$UDID" ]; then
              SELECTED_DEVICE="$candidate"
              break
            fi
            echo "::warning::Failed to create ${candidate} – $(cat "$CREATE_LOG")"
            UDID=""
          done

          rm -f "$CREATE_LOG"

          if [ -z "$UDID" ]; then
            echo "::warning::Unable to create a dedicated simulator for runtime ${RUNTIME_ID}; tests will fall back to automatic destination."
            exit 0
          fi

          echo "Created simulator ${SIM_NAME} (${UDID}) using device ${SELECTED_DEVICE}"

          # Boot simulator with retry logic
          MAX_BOOT_RETRIES=3
          BOOT_SUCCESS=0

          for boot_attempt in $(seq 1 $MAX_BOOT_RETRIES); do
            echo "Boot attempt $boot_attempt/$MAX_BOOT_RETRIES for simulator ${SIM_NAME} (${UDID})"

            # Clean up any existing processes before retry
            if [ $boot_attempt -gt 1 ]; then
              echo "Cleaning up before retry attempt..."
              killall -9 Simulator 2>/dev/null || true
              xcrun simctl shutdown "$UDID" 2>/dev/null || true
              sleep 5
            fi

            # Attempt to boot with extended timeout
            set +e
            xcrun simctl boot "$UDID"
            boot_status=$?
            set -e

            if [ $boot_status -eq 0 ]; then
              # Verify boot completed successfully
              set +e
              xcrun simctl bootstatus "$UDID" -b
              bootstatus_status=$?
              set -e

              if [ $bootstatus_status -eq 0 ]; then
                # Final health check: verify simulator is actually responsive
                sleep 2
                if xcrun simctl list devices | grep -q "$UDID.*Booted"; then
                  echo "✅ Simulator booted successfully and is responsive"
                  BOOT_SUCCESS=1
                  break
                else
                  echo "⚠️ Simulator reported booted but not in device list"
                fi
              else
                echo "⚠️ Boot status check failed with status ${bootstatus_status}"
              fi
            else
              echo "⚠️ Boot command failed with status ${boot_status}"
            fi

            if [ $boot_attempt -lt $MAX_BOOT_RETRIES ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          done

          if [ $BOOT_SUCCESS -eq 0 ]; then
            echo "❌ Failed to boot simulator after $MAX_BOOT_RETRIES attempts"
            echo "::error::Simulator boot failed after retries. Tests will fall back to automatic destination."
            # Don't fail the step - let tests fall back to automatic destination
            echo "ZPOD_SIMULATOR_UDID=" >> "$GITHUB_ENV"
            echo "ZPOD_SIMULATOR_NAME=" >> "$GITHUB_ENV"
            echo "udid=" >> "$GITHUB_OUTPUT"
            echo "sim_name=" >> "$GITHUB_OUTPUT"
          else
            echo "ZPOD_SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
            echo "ZPOD_SIMULATOR_NAME=$SIM_NAME" >> "$GITHUB_ENV"
            echo "udid=$UDID" >> "$GITHUB_OUTPUT"
            echo "sim_name=$SIM_NAME" >> "$GITHUB_OUTPUT"
          fi

          echo "ZPOD_SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
          echo "ZPOD_SIMULATOR_NAME=$SIM_NAME" >> "$GITHUB_ENV"
          echo "udid=$UDID" >> "$GITHUB_OUTPUT"
          echo "sim_name=$SIM_NAME" >> "$GITHUB_OUTPUT"

      - name: Download host app artifact
        uses: actions/download-artifact@v4
        with:
          name: host-app
          path: host-app

      - name: Restore host derived data
        run: scripts/ci/restore-host-app.sh "${{ steps.provision-sim.outputs.derived_path }}" host-app

      - name: Pre-warm simulator for UI tests
        if: steps.provision-sim.outputs.udid != ''
        run: |
          set -euo pipefail
          UDID="${{ steps.provision-sim.outputs.udid }}"

          echo "Pre-warming simulator services for faster test execution..."

          # Wait for SpringBoard to be fully ready
          echo "Waiting for SpringBoard to launch..."
          for j in {1..60}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.SpringBoard; then
              break
            fi
            sleep 0.5
          done

          # Pre-warm accessibility services (critical for UI testing)
          echo "Initializing accessibility services..."
          xcrun simctl spawn "$UDID" launchctl list com.apple.accessibility.AccessibilityUIServer 2>/dev/null || true

          # Wait for accessibility server to be ready
          for j in {1..30}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.accessibility; then
              break
            fi
            sleep 0.5
          done

          # Enable software keyboard (critical for keyboard tests)
          echo "Configuring keyboard settings..."
          xcrun simctl spawn "$UDID" defaults write com.apple.Preferences AutomaticMinimizationEnabled -bool false 2>/dev/null || true

          # Small delay to let services stabilize
          sleep 2

          echo "✅ Simulator pre-warming complete"

      - name: Run ${{ matrix.name }} Tests
        timeout-minutes: 45
        run: |
          set -euo pipefail
          ./scripts/run-xcode-tests.sh -t ${{ matrix.tests }}
        env:
          NSUnbufferedIO: "YES"
          UITEST_TIMEOUT_SCALE: "1.5"
          ZPOD_SIMULATOR_UDID: ${{ steps.provision-sim.outputs.udid }}
          ZPOD_DERIVED_DATA_PATH: ${{ steps.provision-sim.outputs.derived_path }}
          ZPOD_TEST_WITHOUT_BUILDING: "1"
      - name: Archive Test Results
        if: always()
        run: scripts/ci/archive-test-results.sh "${{ matrix.name }}"
      - name: Upload Test Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-${{ matrix.name }}
          path: artifacts/${{ matrix.name }}
          if-no-files-found: warn

      - name: Cleanup dedicated simulator
        if: always()
        run: scripts/ci/cleanup-simulator.sh "${{ steps.provision-sim.outputs.udid }}" "${{ steps.provision-sim.outputs.derived_path }}"

  ui-tests-swipe:
    if: github.event_name != 'workflow_dispatch'
      || github.event.inputs.matrix == 'all'
      || github.event.inputs.matrix == 'ui-swipe'
    needs:
      - unit-tests
      - package-tests
    runs-on: macos-15
    timeout-minutes: 60
    strategy:
      fail-fast: false
      # Reduced from 5 to 3 due to resource contention failures
      # - 5 parallel jobs caused 30-40% failure rate (app crashes, lost connections)
      # - Tests pass reliably on retry, confirming 3-job parallelism is sufficient
      # - CI runtime increases ~2-3 minutes but reliability improves significantly
      # - Can be increased if GitHub Actions hosts gain more simulator capacity
      max-parallel: 3
      matrix:
        include:
          # Tier 1: Simple UI tests (parallel, build independently)
          - name: UITests-SwipeUIDisplay
            tests: zpodUITests/SwipeConfigurationUIDisplayTests
          - name: UITests-SwipePresetSelection
            tests: zpodUITests/SwipePresetSelectionTests
          - name: UITests-SwipeToggleInteraction
            tests: zpodUITests/SwipeToggleInteractionTests
          # Tier 2: Complex suites (now split for parallelization)
          - name: UITests-SwipeActionManagement
            tests: zpodUITests/SwipeActionManagementTests
          - name: UITests-SwipePersistence
            tests: zpodUITests/SwipePersistenceTests
          - name: UITests-SwipeExecution
            tests: zpodUITests/SwipeExecutionTests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"
      - name: Self-check build script
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Ensure iOS Simulator runtime is installed
        run: |
          set -euo pipefail
          echo "Checking installed runtimes before download..."
          xcrun simctl list runtimes || true

          HAS_IOS_RUNTIME=$(xcrun simctl list runtimes | grep -c "iOS ") || true
          if [ "$HAS_IOS_RUNTIME" -eq 0 ]; then
            echo "No iOS runtimes found. Attempting to download iOS platform..."
            sudo xcodebuild -runFirstLaunch || true
            if xcodebuild -help | grep -q "-downloadPlatform"; then
              sudo xcodebuild -downloadPlatform iOS || true
            fi
            if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
              echo "Retrying with -downloadAllPlatforms..."
              if xcodebuild -help | grep -q "-downloadAllPlatforms"; then
                sudo xcodebuild -downloadAllPlatforms || true
              fi
            fi
            echo "Runtimes after download attempt:"
            xcrun simctl list runtimes || true
          fi

          if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
            echo "⚠️ No iOS CoreSimulator runtimes available after download attempts. Proceeding with generic simulator fallback."
          fi

      - name: Cleanup old zpod simulators from previous runs
        run: ./scripts/ci/cleanup-all-zpod-simulators.sh

      - name: Provision dedicated simulator & derived data
        id: provision-sim
        run: |
          set -euo pipefail

          MATRIX_NAME="${{ matrix.name }}"
          SAFE_NAME=$(echo "$MATRIX_NAME" | tr '[:space:]/' '-' | tr -c 'A-Za-z0-9_-.' '-')
          SAFE_NAME="${SAFE_NAME%-}"
          DERIVED_PATH="$PWD/tmp_ci/DerivedData/${SAFE_NAME}"

          rm -rf "$DERIVED_PATH"
          mkdir -p "$DERIVED_PATH"
          echo "ZPOD_DERIVED_DATA_PATH=$DERIVED_PATH" >> "$GITHUB_ENV"
          echo "derived_path=$DERIVED_PATH" >> "$GITHUB_OUTPUT"

          RUNTIME_ID=$(xcrun simctl list runtimes -j | python3 -c "import json,sys; runtimes=json.load(sys.stdin).get('runtimes',[]); preferred=[r for r in runtimes if r.get('identifier','').startswith('com.apple.CoreSimulator.SimRuntime.iOS-18') and r.get('isAvailable')]; preferred = preferred or [r for r in runtimes if r.get('platform','')=='iOS' and r.get('isAvailable')]; print(preferred[0]['identifier'] if preferred else '')" || true)

          if [ -z "$RUNTIME_ID" ]; then
            echo "::warning::Unable to determine an iOS runtime; tests will fall back to default destination."
            exit 0
          fi

          # Stagger simulator creation to avoid resource contention
          # Hash the matrix name to get a deterministic delay (0-8 seconds)
          STAGGER_SEED=$(echo "$MATRIX_NAME" | cksum | awk '{print $1}')
          STAGGER_DELAY=$(( STAGGER_SEED % 9 ))
          if [ $STAGGER_DELAY -gt 0 ]; then
            echo "Staggering simulator creation by ${STAGGER_DELAY}s to avoid resource contention..."
            sleep $STAGGER_DELAY
          fi

          SIM_NAME="zpod-${GITHUB_RUN_ID}-${SAFE_NAME}"
          DEVICE_CANDIDATES=(
            com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-16
            com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-17
            com.apple.CoreSimulator.SimDeviceType.iPhone-15-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-15
            com.apple.CoreSimulator.SimDeviceType.iPhone-14-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-14
            com.apple.CoreSimulator.SimDeviceType.iPhone-13-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-13
          )

          # Check current simulator load before attempting creation
          ACTIVE_SIMS=$(xcrun simctl list devices | grep -c "Booted" || echo "0")
          echo "Currently active simulators: ${ACTIVE_SIMS}"
          if [ "$ACTIVE_SIMS" -ge 5 ]; then
            echo "::warning::System already has ${ACTIVE_SIMS} active simulators. Waiting for capacity..."
            for i in {1..30}; do
              sleep 2
              ACTIVE_SIMS=$(xcrun simctl list devices | grep -c "Booted" || echo "0")
              if [ "$ACTIVE_SIMS" -lt 5 ]; then
                echo "Simulator capacity available (${ACTIVE_SIMS}/5 active)"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "::error::Timeout waiting for simulator capacity. Current load: ${ACTIVE_SIMS}"
                exit 1
              fi
            done
          fi

          DEVICE_LIST=$(xcrun simctl list devicetypes)
          SELECTED_DEVICE=""
          UDID=""
          CREATE_LOG=$(mktemp)
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ -z "$UDID" ]; do
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "Retry attempt $RETRY_COUNT/$MAX_RETRIES after waiting for system resources..."
              sleep $(( RETRY_COUNT * 3 ))
            fi

            for candidate in "${DEVICE_CANDIDATES[@]}"; do
              if ! printf '%s' "$DEVICE_LIST" | grep -q "$candidate"; then
                continue
              fi
              echo "Attempting to create simulator ${candidate} for runtime ${RUNTIME_ID}"
              set +e
              UDID=$(xcrun simctl create "$SIM_NAME" "$candidate" "$RUNTIME_ID" 2>"$CREATE_LOG")
              status=$?
              set -e
              UDID=$(printf '%s' "$UDID" | tr -d '\r\n')
              if [ $status -eq 0 ] && [ -n "$UDID" ]; then
                SELECTED_DEVICE="$candidate"
                break 2
              fi
              
              # Check if error is resource-related
              if grep -q "resource\|limit\|busy" "$CREATE_LOG"; then
                echo "::warning::Resource contention detected for ${candidate}, will retry..."
                UDID=""
                break
              fi
              
              echo "::warning::Failed to create ${candidate} – $(cat "$CREATE_LOG")"
              UDID=""
            done
            
            RETRY_COUNT=$(( RETRY_COUNT + 1 ))
          done

          rm -f "$CREATE_LOG"

          if [ -z "$UDID" ]; then
            echo "::warning::Unable to create a dedicated simulator after $MAX_RETRIES attempts; tests will fall back to automatic destination."
            exit 0
          fi

          echo "✅ Created simulator ${SIM_NAME} (${UDID}) using device ${SELECTED_DEVICE}"
          echo "Simulator will be booted on-demand by xcodebuild during test execution"

          echo "ZPOD_SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
          echo "ZPOD_SIMULATOR_NAME=$SIM_NAME" >> "$GITHUB_ENV"
          echo "udid=$UDID" >> "$GITHUB_OUTPUT"
          echo "sim_name=$SIM_NAME" >> "$GITHUB_OUTPUT"

      - name: Download host app artifact
        uses: actions/download-artifact@v4
        with:
          name: host-app
          path: host-app

      - name: Restore host derived data
        run: scripts/ci/restore-host-app.sh "${{ steps.provision-sim.outputs.derived_path }}" host-app

      - name: Pre-warm simulator for UI tests
        if: steps.provision-sim.outputs.udid != ''
        run: |
          set -euo pipefail
          UDID="${{ steps.provision-sim.outputs.udid }}"

          echo "Pre-warming simulator services for faster test execution..."

          # Wait for SpringBoard to be fully ready
          echo "Waiting for SpringBoard to launch..."
          for j in {1..60}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.SpringBoard; then
              break
            fi
            sleep 0.5
          done

          # Pre-warm accessibility services (critical for UI testing)
          echo "Initializing accessibility services..."
          xcrun simctl spawn "$UDID" launchctl list com.apple.accessibility.AccessibilityUIServer 2>/dev/null || true

          # Wait for accessibility server to be ready
          for j in {1..30}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.accessibility; then
              break
            fi
            sleep 0.5
          done

          # Enable software keyboard (critical for keyboard tests)
          echo "Configuring keyboard settings..."
          xcrun simctl spawn "$UDID" defaults write com.apple.Preferences AutomaticMinimizationEnabled -bool false 2>/dev/null || true

          # Small delay to let services stabilize
          sleep 2

          echo "✅ Simulator pre-warming complete"

      - name: Run ${{ matrix.name }} Tests
        timeout-minutes: 45
        run: |
          set -euo pipefail
          
          MAX_ATTEMPTS=2
          ATTEMPT=1
          RETRY_DELAY=30
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "::group::Test attempt $ATTEMPT of $MAX_ATTEMPTS"
            
            # Run tests and capture output
            if ./scripts/run-xcode-tests.sh -t ${{ matrix.tests }}; then
              echo "::endgroup::"
              echo "✅ Tests passed on attempt $ATTEMPT"
              exit 0
            fi
            
            TEST_EXIT_CODE=$?
            echo "::endgroup::"
            
            # Check if failure is due to environment issues (simulator/resource contention)
            RECENT_LOG=$(ls -t TestResults/*.log 2>/dev/null | head -1)
            
            if [ -n "$RECENT_LOG" ] && [ -f "$RECENT_LOG" ]; then
              # Check for known environment failure patterns
              if grep -q "Failed to get background assertion" "$RECENT_LOG" || \
                 grep -q "Main tab bar did not appear after launch" "$RECENT_LOG" || \
                 grep -q "Process spawn via launchd failed because device is not booted" "$RECENT_LOG" || \
                 grep -q "Timeout waiting for simulator capacity" "$RECENT_LOG"; then
                
                if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                  echo "::warning::Environment failure detected (simulator overload/resource contention)"
                  echo "Waiting ${RETRY_DELAY}s before retry..."
                  sleep $RETRY_DELAY
                  
                  # Clean up simulator state before retry
                  if [ -n "${{ steps.provision-sim.outputs.udid }}" ]; then
                    echo "Resetting simulator state..."
                    xcrun simctl shutdown "${{ steps.provision-sim.outputs.udid }}" 2>/dev/null || true
                    xcrun simctl erase "${{ steps.provision-sim.outputs.udid }}" 2>/dev/null || true
                    sleep 5
                  fi
                  
                  ATTEMPT=$((ATTEMPT + 1))
                  continue
                else
                  echo "::error::Environment failure persisted after $MAX_ATTEMPTS attempts"
                  exit $TEST_EXIT_CODE
                fi
              fi
            fi
            
            # Not an environment failure, fail immediately
            echo "::error::Test failure (non-environment issue)"
            exit $TEST_EXIT_CODE
          done
        env:
          NSUnbufferedIO: "YES"
          UITEST_TIMEOUT_SCALE: "1.5"
          ZPOD_SIMULATOR_UDID: ${{ steps.provision-sim.outputs.udid }}
          ZPOD_DERIVED_DATA_PATH: ${{ steps.provision-sim.outputs.derived_path }}
          ZPOD_TEST_WITHOUT_BUILDING: "1"
      - name: Archive Test Results
        if: always()
        run: scripts/ci/archive-test-results.sh "${{ matrix.name }}"
      - name: Upload Test Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-${{ matrix.name }}
          path: artifacts/${{ matrix.name }}
          if-no-files-found: warn

      - name: Cleanup dedicated simulator
        if: always()
        run: scripts/ci/cleanup-simulator.sh "${{ steps.provision-sim.outputs.udid }}" "${{ steps.provision-sim.outputs.derived_path }}"

  ui-tests-playback:
    if: github.event_name != 'workflow_dispatch'
      || github.event.inputs.matrix == 'all'
      || github.event.inputs.matrix == 'ui'
      || github.event.inputs.matrix == 'ui-playback'
    needs:
      - unit-tests
      - package-tests
    runs-on: macos-15
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        include:
          # Dual-mode playback position tests (Issue 03.3.2.4)
          - name: UITests-PlaybackTicker
            tests: zpodUITests/PlaybackPositionTickerTests
          - name: UITests-PlaybackAVPlayer
            tests: zpodUITests/PlaybackPositionAVPlayerTests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"
      - name: Self-check build script
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Ensure iOS Simulator runtime is installed
        run: |
          set -euo pipefail
          echo "Checking installed runtimes before download..."
          xcrun simctl list runtimes || true

          HAS_IOS_RUNTIME=$(xcrun simctl list runtimes | grep -c "iOS ") || true
          if [ "$HAS_IOS_RUNTIME" -eq 0 ]; then
            echo "No iOS runtimes found. Attempting to download iOS platform..."
            sudo xcodebuild -runFirstLaunch || true
            if xcodebuild -help | grep -q "-downloadPlatform"; then
              sudo xcodebuild -downloadPlatform iOS || true
            fi
            if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
              echo "Retrying with -downloadAllPlatforms..."
              if xcodebuild -help | grep -q "-downloadAllPlatforms"; then
                sudo xcodebuild -downloadAllPlatforms || true
              fi
            fi
            echo "Runtimes after download attempt:"
            xcrun simctl list runtimes || true
          fi

          if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
            echo "⚠️ No iOS CoreSimulator runtimes available after download attempts. Proceeding with generic simulator fallback."
          fi

      - name: Cleanup old zpod simulators from previous runs
        run: ./scripts/ci/cleanup-all-zpod-simulators.sh

      - name: Provision dedicated simulator & derived data
        id: provision-sim
        run: |
          set -euo pipefail

          MATRIX_NAME="${{ matrix.name }}"
          SAFE_NAME=$(echo "$MATRIX_NAME" | tr '[:space:]/' '-' | tr -c 'A-Za-z0-9_-.' '-')
          SAFE_NAME="${SAFE_NAME%-}"
          DERIVED_PATH="$PWD/tmp_ci/DerivedData/${SAFE_NAME}"

          rm -rf "$DERIVED_PATH"
          mkdir -p "$DERIVED_PATH"
          echo "ZPOD_DERIVED_DATA_PATH=$DERIVED_PATH" >> "$GITHUB_ENV"
          echo "derived_path=$DERIVED_PATH" >> "$GITHUB_OUTPUT"

          RUNTIME_ID=$(xcrun simctl list runtimes -j | python3 -c "import json,sys; runtimes=json.load(sys.stdin).get('runtimes',[]); preferred=[r for r in runtimes if r.get('identifier','').startswith('com.apple.CoreSimulator.SimRuntime.iOS-18') and r.get('isAvailable')]; preferred = preferred or [r for r in runtimes if r.get('platform','')=='iOS' and r.get('isAvailable')]; print(preferred[0]['identifier'] if preferred else '')" || true)

          if [ -z "$RUNTIME_ID" ]; then
            echo "::warning::Unable to determine an iOS runtime; tests will fall back to default destination."
            exit 0
          fi

          SIM_NAME="zpod-${GITHUB_RUN_ID}-${SAFE_NAME}"
          DEVICE_CANDIDATES=(
            com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-16
            com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-17
            com.apple.CoreSimulator.SimDeviceType.iPhone-15-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-15
            com.apple.CoreSimulator.SimDeviceType.iPhone-14-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-14
            com.apple.CoreSimulator.SimDeviceType.iPhone-13-Pro
            com.apple.CoreSimulator.SimDeviceType.iPhone-13
          )

          create_sim() {
            local device_type="$1"
            local udid=""
            if udid=$(xcrun simctl create "$SIM_NAME" "$device_type" "$RUNTIME_ID" 2>/dev/null); then
              echo "$udid"
              return 0
            fi
            return 1
          }

          MAX_ATTEMPTS=3
          BASE_DELAY=3
          ATTEMPT=1
          UDID=""

          while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ -z "$UDID" ]; do
            ACTIVE_COUNT=$(xcrun simctl list devices -j | python3 -c "import json,sys; data=json.load(sys.stdin); devices=data.get('devices',{}); print(sum(1 for runtime in devices.values() for dev in runtime if dev.get('isAvailable')))" || true)
            if [ -n "$ACTIVE_COUNT" ] && [ "$ACTIVE_COUNT" -ge 5 ]; then
              echo "Active simulator count ($ACTIVE_COUNT) is high; waiting before provisioning."
              sleep $((BASE_DELAY * ATTEMPT))
            fi

            for candidate in "${DEVICE_CANDIDATES[@]}"; do
              if UDID=$(create_sim "$candidate"); then
                break
              fi
            done

            if [ -z "$UDID" ]; then
              echo "Simulator provisioning attempt $ATTEMPT failed; retrying."
              sleep $((BASE_DELAY * ATTEMPT))
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ -z "$UDID" ]; then
            echo "::warning::Failed to provision a simulator for $MATRIX_NAME; continuing with default destination."
            exit 0
          fi

          echo "Created simulator ${SIM_NAME} (${UDID})"

          # Boot simulator with retry logic
          MAX_BOOT_RETRIES=3
          BOOT_SUCCESS=0

          for boot_attempt in $(seq 1 $MAX_BOOT_RETRIES); do
            echo "Boot attempt $boot_attempt/$MAX_BOOT_RETRIES for simulator ${SIM_NAME} (${UDID})"

            # Clean up any existing processes before retry
            if [ $boot_attempt -gt 1 ]; then
              echo "Cleaning up before retry attempt..."
              killall -9 Simulator 2>/dev/null || true
              xcrun simctl shutdown "$UDID" 2>/dev/null || true
              sleep 5
            fi

            # Attempt to boot with extended timeout
            set +e
            xcrun simctl boot "$UDID"
            boot_status=$?
            set -e

            if [ $boot_status -eq 0 ]; then
              # Verify boot completed successfully
              set +e
              xcrun simctl bootstatus "$UDID" -b
              bootstatus_status=$?
              set -e

              if [ $bootstatus_status -eq 0 ]; then
                # Final health check: verify simulator is actually responsive
                sleep 2
                if xcrun simctl list devices | grep -q "$UDID.*Booted"; then
                  echo "✅ Simulator booted successfully and is responsive"
                  BOOT_SUCCESS=1
                  break
                else
                  echo "⚠️ Simulator reported booted but not in device list"
                fi
              else
                echo "⚠️ Boot status check failed with status ${bootstatus_status}"
              fi
            else
              echo "⚠️ Boot command failed with status ${boot_status}"
            fi

            if [ $boot_attempt -lt $MAX_BOOT_RETRIES ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          done

          if [ $BOOT_SUCCESS -eq 0 ]; then
            echo "❌ Failed to boot simulator after $MAX_BOOT_RETRIES attempts"
            echo "::error::Simulator boot failed after retries. Tests will fall back to automatic destination."
            echo "ZPOD_SIMULATOR_UDID=" >> "$GITHUB_ENV"
            echo "udid=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ZPOD_SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
          echo "udid=$UDID" >> "$GITHUB_OUTPUT"

      - name: Download host app artifact
        uses: actions/download-artifact@v4
        with:
          name: host-app
          path: host-app

      - name: Restore host derived data
        run: scripts/ci/restore-host-app.sh "${{ steps.provision-sim.outputs.derived_path }}" host-app

      - name: Pre-warm simulator for UI tests
        if: steps.provision-sim.outputs.udid != ''
        run: |
          set -euo pipefail
          UDID="${{ steps.provision-sim.outputs.udid }}"

          echo "Pre-warming simulator services for faster test execution..."

          # Wait for SpringBoard to be fully ready
          echo "Waiting for SpringBoard to launch..."
          for j in {1..60}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.SpringBoard; then
              break
            fi
            sleep 0.5
          done

          # Pre-warm accessibility services (critical for UI testing)
          echo "Initializing accessibility services..."
          xcrun simctl spawn "$UDID" launchctl list com.apple.accessibility.AccessibilityUIServer 2>/dev/null || true

          # Wait for accessibility server to be ready
          for j in {1..30}; do
            if xcrun simctl spawn $UDID launchctl list | grep -q com.apple.accessibility; then
              break
            fi
            sleep 0.5
          done

          # Enable software keyboard (critical for keyboard tests)
          echo "Configuring keyboard settings..."
          xcrun simctl spawn "$UDID" defaults write com.apple.Preferences AutomaticMinimizationEnabled -bool false 2>/dev/null || true

          # Small delay to let services stabilize
          sleep 2

          echo "✅ Simulator pre-warming complete"

      - name: Run ${{ matrix.name }} Tests
        timeout-minutes: 45
        run: |
          set -euo pipefail
          ./scripts/run-xcode-tests.sh -t ${{ matrix.tests }}
        env:
          NSUnbufferedIO: "YES"
          UITEST_TIMEOUT_SCALE: "1.5"
          ZPOD_SIMULATOR_UDID: ${{ steps.provision-sim.outputs.udid }}
          ZPOD_DERIVED_DATA_PATH: ${{ steps.provision-sim.outputs.derived_path }}
          ZPOD_TEST_WITHOUT_BUILDING: "1"

      - name: Archive Test Results
        if: always()
        run: scripts/ci/archive-test-results.sh "${{ matrix.name }}"

      - name: Upload Test Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-${{ matrix.name }}
          path: artifacts/${{ matrix.name }}
          if-no-files-found: warn

      - name: Cleanup dedicated simulator
        if: always()
        run: scripts/ci/cleanup-simulator.sh "${{ steps.provision-sim.outputs.udid }}" "${{ steps.provision-sim.outputs.derived_path }}"

  package-tests:
    runs-on: macos-15
    if: github.event_name != 'workflow_dispatch'
      || github.event.inputs.matrix == 'all'
      || github.event.inputs.matrix == 'packages'
      || github.event.inputs.matrix == 'integration-tests'
      || github.event.inputs.matrix == 'ui'
      || github.event.inputs.matrix == 'ui-swipe'
      || github.event.inputs.matrix == 'ui-playback'
    needs: preflight
    strategy:
      fail-fast: false
      matrix:
        package:
          [
            CoreModels,
            SharedUtilities,
            Persistence,
            FeedParsing,
            Networking,
            SettingsDomain,
            SearchDomain,
            RecommendationDomain,
            PlaybackEngine,
            LibraryFeature,
            PlayerFeature,
            DiscoverFeature,
            PlaylistFeature,
            TestSupport,
          ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"
      - name: Self-check build script
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Run ${{ matrix.package }} Package Tests
        run: |
          set -euo pipefail
          ./scripts/run-xcode-tests.sh -t ${{ matrix.package }}
        env:
          NSUnbufferedIO: "YES"
      - name: Archive Test Results
        if: always()
        run: scripts/ci/archive-test-results.sh "${{ matrix.package }}"
      - name: Upload Test Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-package-${{ matrix.package }}
          path: artifacts/${{ matrix.package }}
          if-no-files-found: warn

  syntax-linux:
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch'
      || github.event.inputs.matrix == 'all'
      || github.event.inputs.matrix == 'linux'
    needs: preflight
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Shell self-check
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Swift syntax verification
        run: ./scripts/run-xcode-tests.sh -s
      - name: Swift lint
        run: ./scripts/run-xcode-tests.sh -l
