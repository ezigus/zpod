name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags-ignore:
      - '*'
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'
      - name: Self-check build script
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Ensure iOS Simulator runtime is installed
        run: |
          set -euo pipefail
          echo "Checking installed runtimes before download..."
          xcrun simctl list runtimes || true

          HAS_IOS_RUNTIME=$(xcrun simctl list runtimes | grep -c "iOS ") || true
          if [ "$HAS_IOS_RUNTIME" -eq 0 ]; then
            echo "No iOS runtimes found. Attempting to download iOS platform..."
            sudo xcodebuild -runFirstLaunch || true
            if xcodebuild -help | grep -q "-downloadPlatform"; then
              sudo xcodebuild -downloadPlatform iOS || true
            fi
            if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
              echo "Retrying with -downloadAllPlatforms..."
              if xcodebuild -help | grep -q "-downloadAllPlatforms"; then
                sudo xcodebuild -downloadAllPlatforms || true
              fi
            fi
            echo "Runtimes after download attempt:"
            xcrun simctl list runtimes || true
          fi

          if [ $(xcrun simctl list runtimes | grep -c "iOS ") -eq 0 ]; then
            echo "âš ï¸ No iOS CoreSimulator runtimes available after download attempts. Proceeding with generic simulator fallback."
          fi

      - name: Create iOS Simulator device if needed
        run: |
          set -euo pipefail
          echo "Ensuring at least one iPhone simulator exists..."

          RUNTIME_ID=$(xcrun simctl list runtimes -j | python3 -c "import json,sys; r=json.load(sys.stdin).get('runtimes',[]); pref=[x for x in r if x.get('identifier','').startswith('com.apple.CoreSimulator.SimRuntime.iOS-18') and x.get('isAvailable')]; pref=pref or [x for x in r if x.get('platform','')=='iOS' and x.get('isAvailable')]; print(pref[0]['identifier'] if pref else '')")
          if [ -z "$RUNTIME_ID" ]; then
            echo "âš ï¸ Could not determine an available iOS runtime identifier. Relying on generic simulator destination."
          else
            DEVTYPE=com.apple.CoreSimulator.SimDeviceType.iPhone-16
            if ! xcrun simctl list devicetypes | grep -q "$DEVTYPE"; then
              DEVTYPE=$(\
                xcrun simctl list devicetypes | awk -F'[()]' \
                  '/iPhone 17 Pro Max/{print $2; exit} \
                   /iPhone 17 Pro/{print $2; exit} \
                   /iPhone 17/{print $2; exit} \
                   /iPhone 16 Pro Max/{print $2; exit} \
                   /iPhone 16 Pro/{print $2; exit} \
                   /iPhone 16/{print $2; exit} \
                   /iPhone 15/{print $2; exit} \
                   /iPhone 14/{print $2; exit}'
              )
            fi
            if [ -z "$DEVTYPE" ]; then
              echo "âš ï¸ Could not find an iPhone device type to create. Skipping device creation."
            else
              if ! xcrun simctl list devices | grep -q "iPhone 16 (CI)"; then
                echo "Creating simulator: name='iPhone 16 (CI)', type=$DEVTYPE, runtime=$RUNTIME_ID"
                xcrun simctl create "iPhone 16 (CI)" "$DEVTYPE" "$RUNTIME_ID" || true
              else
                echo "Simulator 'iPhone 16 (CI)' already exists"
              fi
            fi
          fi

          xcrun simctl list devices || true

      - name: Build & Test (iOS)
        run: |
          set -euo pipefail
          ./scripts/run-xcode-tests.sh --self-check
          echo "ðŸš€ Running full build and test using refactored script"
          ./scripts/run-xcode-tests.sh full_build_and_test
        env:
          NSUnbufferedIO: "YES"
      - name: Archive Test Results
        if: always()
        run: |
          set -euo pipefail
          mkdir -p artifacts
          if ls TestResults >/dev/null 2>&1; then
            find TestResults -maxdepth 1 -mindepth 1 \( -name "TestResults_*.xcresult" -o -name "TestResults_*.log" \) \
              -exec cp -R {} artifacts/ \;
          fi
          if ls ~/Library/Logs/DiagnosticReports/*.crash >/dev/null 2>&1; then
            cp ~/Library/Logs/DiagnosticReports/*.crash artifacts/
          fi
      - name: Upload Test Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: artifacts
          if-no-files-found: warn
      - name: SwiftLint (optional placeholder)
        if: always()
        run: echo "Add SwiftLint in future"

  syntax-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Shell self-check
        run: ./scripts/run-xcode-tests.sh --self-check
      - name: Swift syntax & concurrency lint
        run: ./scripts/dev-build-enhanced.sh syntax
